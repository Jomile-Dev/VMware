# VMware VM Hardware Version Inventory Report
# Requires VMware PowerCLI module

#Requires -Modules VMware.VimAutomation.Core

# Configuration
$ReportPath = "C:\VM_Hardware_Inventory_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"

# Connect to multiple vCenter servers
$vCenterServers = @("vc01", "vc02", "vc03", "vc04")  # Update with your vCenter servers
$Credential = Get-Credential -Message "Enter vCenter credentials"

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "VMware VM Hardware Version Inventory" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""

Write-Host "Connecting to vCenter servers..." -ForegroundColor Cyan
$connectedServers = @()
$connectionErrors = @()

foreach ($vCenter in $vCenterServers) {
    try {
        $connection = Connect-VIServer -Server $vCenter -Credential $Credential -ErrorAction Stop -WarningAction SilentlyContinue -Force
        if ($connection) {
            $connectedServers += $connection
            Write-Host "  Connected to $vCenter" -ForegroundColor Green
        }
    }
    catch {
        Write-Host "  FAILED: Could not connect to $vCenter - $_" -ForegroundColor Red
        $connectionErrors += "$vCenter : $_"
    }
}

# Verify we're connected to at least one vCenter
if ($connectedServers.Count -eq 0) {
    Write-Host "ERROR: No vCenter connections established. Exiting." -ForegroundColor Red
    exit
}

Write-Host "Connected to $($connectedServers.Count) vCenter(s)" -ForegroundColor Green
Write-Host ""

# Initialize results array
$results = @()
$totalVMCount = 0

# Retrieve VMs from all vCenters
Write-Host "Retrieving VM inventory from all vCenters..." -ForegroundColor Cyan

foreach ($vCenter in $connectedServers) {
    Write-Host "`nProcessing vCenter: $($vCenter.Name)" -ForegroundColor Yellow
    
    try {
        # Get all VMs at once
        $vms = Get-VM -Server $vCenter -ErrorAction Stop
        Write-Host "  Found $($vms.Count) VMs" -ForegroundColor Gray
        
        # Get all VM views in one call
        Write-Host "  Retrieving VM details..." -ForegroundColor Gray
        $vmViews = Get-View -ViewType VirtualMachine -Server $vCenter -Property Name,Config.Version,Runtime.PowerState,Network -ErrorAction Stop
        
        # Build VM view lookup hash
        $vmViewHash = @{}
        foreach ($vmView in $vmViews) {
            $vmViewHash[$vmView.MoRef.Value] = $vmView
        }
        
        # Get all VDS port groups and switches at once
        Write-Host "  Retrieving network information..." -ForegroundColor Gray
        $allVDPortGroups = Get-VDPortgroup -Server $vCenter -ErrorAction SilentlyContinue
        $portGroupHash = @{}
        foreach ($pg in $allVDPortGroups) {
            $portGroupHash[$pg.Key] = $pg
        }
        
        $allVDSwitches = Get-VDSwitch -Server $vCenter -ErrorAction SilentlyContinue
        $vdsHash = @{}
        foreach ($vds in $allVDSwitches) {
            $vdsHash[$vds.Id] = $vds.Name
        }
        
        Write-Host "  Processing VM data..." -ForegroundColor Gray
        $vmCounter = 0
        foreach ($vm in $vms) {
            $vmCounter++
            
            # Show progress every 100 VMs
            if ($vmCounter % 100 -eq 0) {
                Write-Host "    Processed $vmCounter of $($vms.Count) VMs..." -ForegroundColor Gray
            }
            
            try {
                # Lookup VM view from hash
                $vmView = $vmViewHash[$vm.Id]
                
                if (-not $vmView) {
                    throw "VM view not found"
                }
                
                # Get VDS information from network property
                $vdsList = @()
                if ($vmView.Network) {
                    foreach ($networkMoRef in $vmView.Network) {
                        $pgKey = $networkMoRef.Value
                        if ($portGroupHash.ContainsKey($pgKey)) {
                            $pg = $portGroupHash[$pgKey]
                            $vdsId = $pg.VDSwitchId
                            if ($vdsHash.ContainsKey($vdsId)) {
                                $vdsName = $vdsHash[$vdsId]
                                if ($vdsName -notin $vdsList) {
                                    $vdsList += $vdsName
                                }
                            }
                        }
                    }
                }
                $vdsNames = if ($vdsList.Count -gt 0) { $vdsList -join ", " } else { "Standard Switch" }
                
                # Create result object
                $result = [PSCustomObject]@{
                    VMName                 = $vm.Name
                    vCenter                = $vCenter.Name
                    PowerState             = $vm.PowerState
                    CurrentHardwareVersion = $vmView.Config.Version
                    VDS                    = $vdsNames
                }
                
                $results += $result
                $totalVMCount++
            }
            catch {
                # Add minimal info for failed VM
                $result = [PSCustomObject]@{
                    VMName                 = $vm.Name
                    vCenter                = $vCenter.Name
                    PowerState             = $vm.PowerState
                    CurrentHardwareVersion = "Error"
                    VDS                    = "Error"
                }
                
                $results += $result
                $totalVMCount++
            }
        }
        
        Write-Host "  Completed processing $($vms.Count) VMs from $($vCenter.Name)" -ForegroundColor Green
    }
    catch {
        Write-Host "  Error retrieving VMs from $($vCenter.Name): $_" -ForegroundColor Red
    }
}

# Generate report
Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "Generating Report..." -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan

$results | Export-Csv -Path $ReportPath -NoTypeInformation
Write-Host "Report saved to: $ReportPath" -ForegroundColor Green

# Generate statistics
Write-Host "`nInventory Statistics:" -ForegroundColor Cyan
Write-Host "  Total VMs: $totalVMCount" -ForegroundColor White

# Group by hardware version
Write-Host "`nVMs by Hardware Version:" -ForegroundColor Cyan
$versionGroups = $results | Where-Object { $_.CurrentHardwareVersion -ne "Error" } | Group-Object CurrentHardwareVersion | Sort-Object Name
foreach ($group in $versionGroups) {
    Write-Host "  $($group.Name): $($group.Count) VMs" -ForegroundColor White
}

# Group by vCenter
Write-Host "`nVMs by vCenter:" -ForegroundColor Cyan
$vcenterGroups = $results | Group-Object vCenter | Sort-Object Name
foreach ($group in $vcenterGroups) {
    Write-Host "  $($group.Name): $($group.Count) VMs" -ForegroundColor White
}

# Power state
Write-Host "`nPower State:" -ForegroundColor Cyan
$powerGroups = $results | Group-Object PowerState | Sort-Object Name
foreach ($group in $powerGroups) {
    Write-Host "  $($group.Name): $($group.Count) VMs" -ForegroundColor White
}

# Disconnect from all vCenter servers
Write-Host "`nDisconnecting from vCenter servers..." -ForegroundColor Cyan
Disconnect-VIServer -Server * -Confirm:$false -ErrorAction SilentlyContinue
Write-Host "Disconnected from all vCenter servers" -ForegroundColor Green

Write-Host "`nInventory collection complete!" -ForegroundColor Green
