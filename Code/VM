# Query Aria Operations for new VMs
    $ariaInternalURL = "https://$ariaOpsServer/suite-api/api/resources?resourceKind=VirtualMachine"
    Write-DebugLog "Querying for VMs: $ariaInternalURL" "DEBUG"
    
    $response = $null
    try {
        $response = Invoke-RestMethod -Uri $ariaInternalURL -Headers $ariaHeaders -Method Get -ErrorAction Stop
    }
    catch {
        Write-DebugLog "Failed to query VMs from Aria Operations" "ERROR"
        Write-DebugLog "Error: $($_.Exception.Message)" "ERROR"
        if ($_.Exception.Response) {
            Write-DebugLog "Status Code: $($_.Exception.Response.StatusCode.value__)" "ERROR"
        }
        throw "Cannot query Aria Operations for VMs"
    }
    
    # Validate response
    if (-not $response) {
        Write-DebugLog "Received null response from Aria Operations" "ERROR"
        throw "Null response from Aria Operations API"
    }
    
    # Debug: Show response structure
    Write-DebugLog "Response type: $($response.GetType().Name)" "DEBUG"
    if ($response.PSObject.Properties) {
        Write-DebugLog "Response properties: $($response.PSObject.Properties.Name -join ', ')" "DEBUG"
    }
    
    # Handle response - could be direct array or nested in resourceList
    $allResources = $null
    if ($response.resourceList) {
        $allResources = $response.resourceList
        Write-DebugLog "Found resourceList with $($allResources.Count) items" "DEBUG"
    }
    elseif ($response -is [Array]) {
        $allResources = $response
        Write-DebugLog "Response is direct array with $($allResources.Count) items" "DEBUG"
    }
    else {
        Write-DebugLog "Unexpected response structure!" "ERROR"
        Write-DebugLog "Response type: $($response.GetType().Name)" "ERROR"
        Write-DebugLog "Response content: $($response | ConvertTo-Json -Depth 2)" "ERROR"
        throw "Cannot parse Aria Operations response"
    }
