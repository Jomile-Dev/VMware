# vRA Deep Event & History Extractor
# This script pulls the granular "Timeline" you see in the GUI

$vraServer = "vra1.yourdomain.com"
$apiVersion = "2020-08-25"
$targetDeploymentName = "Your-VM-Name" # Leave empty to scan all deleted items

# --- Setup & Auth ---
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
Disable-SSLValidation # (Function assumed from previous scripts)
$authRes = Invoke-RestMethod -Uri "https://$vraServer/csp/gateway/am/api/login" -Method Post -Headers @{"Content-Type"="application/json"} -Body $authBody
$vraHeaders = @{ "Authorization" = "Bearer $($authRes.cspAuthToken)"; "Content-Type" = "application/json" }

# 1. Get the Deleted Deployment ID
$depUri = "https://$vraServer/deployment/api/deployments?apiVersion=$apiVersion&deleted=true&`$filter=name eq '$targetDeploymentName'"
$dep = (Invoke-RestMethod -Uri $depUri -Method Get -Headers $vraHeaders).content[0]

if (-not $dep) { Write-Error "Deployment not found"; return }

Write-Host "--- HISTORY FOR: $($dep.name) ---" -ForegroundColor Cyan

# 2. Get REQUESTS (The "History" tab in GUI)
# This shows: Who started it, what the inputs were, and the exact status of each step
$reqUri = "https://$vraServer/deployment/api/deployments/$($dep.id)/requests?apiVersion=$apiVersion"
$requests = (Invoke-RestMethod -Uri $reqUri -Method Get -Headers $vraHeaders).content

foreach ($req in $requests) {
    Write-Host "`n[Action: $($req.name)]" -ForegroundColor Yellow
    Write-Host "  Requested By: $($req.requestedBy)"
    Write-Host "  Status:       $($req.status)"
    Write-Host "  Started:      $($req.createdAt)"
    
    # 3. Get EVENTS for this specific Request (The "Log" entries)
    # This is the "terminal output" style info you see in the GUI
    $eventUri = "https://$vraServer/deployment/api/requests/$($req.id)/events?apiVersion=$apiVersion"
    $events = (Invoke-RestMethod -Uri $eventUri -Method Get -Headers $vraHeaders).content
    
    foreach ($evt in $events) {
        $timestamp = $evt.timestamp
        $message   = $evt.message
        Write-Host "    > $timestamp : $message" -ForegroundColor Gray
    }
}
