# vRA Deleted Deployments - Request-Centric Approach
# In vRA 8.x, deleted deployments cannot be queried via deployment API
# This script queries request-service API for DELETE_DEPLOYMENT requests

# Configuration
$vraServer = "vra1.yourdomain.com"
$daysBack = 1  # Past 1 day

# FILTER CONFIGURATION - Edit these to match your template names
$filterTemplateNames = @("Virtual Machine", "Database")
Write-Host "`n>>> FILTER: Looking for delete requests with templates containing: $($filterTemplateNames -join ' OR ') <<<" -ForegroundColor Yellow

# Output
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputJson = "C:\Logs\DeletedDeployments_$timestamp.json"
$outputLog = "C:\Logs\DeletedDeployments_$timestamp.log"
$outputCsv = "C:\Logs\DeletedDeployments_$timestamp.csv"

function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] [$Level] $Message"
    
    $color = switch ($Level) {
        "ERROR" { "Red" }
        "WARN" { "Yellow" }
        "SUCCESS" { "Green" }
        default { "Cyan" }
    }
    
    Write-Host $logMessage -ForegroundColor $color
    Add-Content -Path $outputLog -Value $logMessage
}

function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type @"
using System.Net;
using System.Security.Cryptography.X509Certificates;
public class TrustAllCertsPolicy : ICertificatePolicy {
    public bool CheckValidationResult(
        ServicePoint svcPoint, X509Certificate certificate,
        WebRequest request, int certificateProblem) {
        return true;
    }
}
"@
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
}

Write-Log "===== vRA Deleted Deployments - Request-Service Approach =====" "SUCCESS"
Write-Log "Note: In vRA 8.x, deleted deployments cannot be queried via deployment API" "WARN"
Write-Log "Querying request-service API for DELETE_DEPLOYMENT requests instead" "SUCCESS"
Disable-SSLValidation

# Ensure log directory exists
$logDir = Split-Path $outputJson -Parent
if (!(Test-Path $logDir)) {
    New-Item -ItemType Directory -Path $logDir -Force | Out-Null
}

# Get credentials
Write-Log "`nRequesting credentials..."
$credential = Get-Credential -Message "Enter credentials for vRA"
if (-not $credential) {
    Write-Log "Credentials not provided. Exiting." "ERROR"
    exit
}
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

# Authenticate to vRA
Write-Log "Authenticating to vRA: $vraServer"
try {
    $vraAuthUri = "https://$vraServer/csp/gateway/am/api/login"
    $vraAuthBody = @{
        username = $username
        password = $password
    } | ConvertTo-Json
    
    $vraAuthHeaders = @{
        "Content-Type" = "application/json"
        "Accept" = "application/json"
    }
    
    $vraAuthResponse = Invoke-RestMethod -Uri $vraAuthUri -Method Post -Headers $vraAuthHeaders -Body $vraAuthBody -ErrorAction Stop
    $vraToken = $vraAuthResponse.cspAuthToken
    Write-Log "Authenticated to vRA successfully" "SUCCESS"
}
catch {
    Write-Log "Failed to authenticate to vRA: $($_.Exception.Message)" "ERROR"
    exit
}

$vraHeaders = @{
    "Authorization" = "Bearer $vraToken"
    "Content-Type" = "application/json"
    "Accept" = "application/json"
}

$cutoffDate = (Get-Date).AddDays(-$daysBack)
Write-Log "Looking for delete requests from: $cutoffDate"

$deletedDeploymentDetails = @()

# MAIN APPROACH: Query request-service for DELETE requests
Write-Log "`n===== Querying Request-Service for DELETE Requests ====="

try {
    # Fetch all recent requests from request-service
    $reqSvcUri = "https://$vraServer/request-service/api/requests?`$top=5000&`$orderby=dateSubmitted desc"
    Write-Log "Fetching requests: $reqSvcUri"
    
    $reqSvcResponse = Invoke-RestMethod -Uri $reqSvcUri -Method Get -Headers $vraHeaders -ErrorAction Stop
    $allRequests = if ($reqSvcResponse.content) { $reqSvcResponse.content } else { $reqSvcResponse }
    
    Write-Log "Retrieved $($allRequests.Count) total requests from request-service" "SUCCESS"
    
    # Show sample request structure
    if ($allRequests.Count -gt 0) {
        Write-Log "`nSample request structure (first request):"
        $sample = $allRequests[0]
        $sample.PSObject.Properties | ForEach-Object {
            if ($_.Value -is [string] -or $_.Value -is [int] -or $_.Value -is [bool] -or $null -eq $_.Value) {
                Write-Log "  $($_.Name) = $($_.Value)"
            } else {
                Write-Log "  $($_.Name) = [Complex: $($_.Value.GetType().Name)]"
            }
        }
    }
    
    # Filter for DELETE requests within time range
    Write-Log "`n=== Filtering for DELETE requests ==="
    
    $deleteRequests = $allRequests | Where-Object {
        # Check if it's a delete operation
        $isDelete = (
            $_.requestType -eq "DELETE_DEPLOYMENT" -or
            $_.requestType -match "DELETE" -or
            $_.phase -match "DELETE" -or
            ($_.requestedItemName -and $_.requestedItemName -match "Delete")
        )
        
        # Check if within time range
        $withinTimeRange = $true
        if ($_.dateSubmitted) {
            try {
                $submitDate = [DateTime]$_.dateSubmitted
                $withinTimeRange = ($submitDate -ge $cutoffDate)
            } catch {
                $withinTimeRange = $true  # Include if can't parse date
            }
        }
        
        $isDelete -and $withinTimeRange
    }
    
    Write-Log "Found $($deleteRequests.Count) DELETE requests in time range" "SUCCESS"
    
    if ($deleteRequests.Count -eq 0) {
        Write-Log "No DELETE requests found. Showing all request types for debugging:" "WARN"
        $allRequests | Select-Object -First 10 | ForEach-Object {
            Write-Log "  $($_.requestType) - $($_.requestedItemName) (Date: $($_.dateSubmitted))"
        }
    }
    
    # Process each DELETE request
    $processedCount = 0
    foreach ($delReq in $deleteRequests) {
        $processedCount++
        
        Write-Log "`n========================================" "SUCCESS"
        Write-Log "[$processedCount/$($deleteRequests.Count)] DELETE REQUEST" "SUCCESS"
        Write-Log "========================================" "SUCCESS"
        
        Write-Log "Request Number: $($delReq.requestNumber)"
        Write-Log "Request ID: $($delReq.id)"
        Write-Log "Item Name: $($delReq.requestedItemName)"
        Write-Log "Request Type: $($delReq.requestType)"
        Write-Log "Phase: $($delReq.phase)"
        Write-Log "State: $($delReq.state)"
        Write-Log "Requested By: $($delReq.requestedBy)"
        Write-Log "Requested For: $($delReq.requestedFor)"
        Write-Log "Date Submitted: $($delReq.dateSubmitted)"
        Write-Log "Date Completed: $($delReq.dateCompleted)"
        
        # Get full request details
        $fullRequest = $null
        $catalogItemName = $null
        $blueprintName = $null
        
        try {
            $fullReqUri = "https://$vraServer/request-service/api/requests/$($delReq.id)"
            Write-Log "`nFetching full request details: $fullReqUri"
            $fullRequest = Invoke-RestMethod -Uri $fullReqUri -Method Get -Headers $vraHeaders -ErrorAction Stop
            
            Write-Log ">>> FULL REQUEST RETRIEVED <<<" "SUCCESS"
            
            # Extract catalog item or blueprint information
            if ($fullRequest.requestData) {
                Write-Log "`nRequest Data:"
                $fullRequest.requestData.PSObject.Properties | ForEach-Object {
                    Write-Log "  $($_.Name) = $($_.Value)"
                    
                    # Look for catalog item or blueprint references
                    if ($_.Name -match "catalogItem" -or $_.Name -match "blueprint") {
                        if ($_.Value -is [string]) {
                            # Try to resolve the ID to a name
                            try {
                                if ($_.Name -match "catalogItem") {
                                    $catItemUri = "https://$vraServer/catalog/api/items/$($_.Value)"
                                    $catItem = Invoke-RestMethod -Uri $catItemUri -Method Get -Headers $vraHeaders -ErrorAction Stop
                                    $catalogItemName = $catItem.name
                                    Write-Log "  >>> Resolved Catalog Item Name: $catalogItemName <<<" "SUCCESS"
                                }
                                elseif ($_.Name -match "blueprint") {
                                    $bpUri = "https://$vraServer/blueprint/api/blueprints/$($_.Value)"
                                    $bp = Invoke-RestMethod -Uri $bpUri -Method Get -Headers $vraHeaders -ErrorAction Stop
                                    $blueprintName = $bp.name
                                    Write-Log "  >>> Resolved Blueprint Name: $blueprintName <<<" "SUCCESS"
                                }
                            }
                            catch {
                                Write-Log "  Could not resolve ID to name: $($_.Exception.Message)" "WARN"
                            }
                        }
                    }
                }
            }
            
            if ($fullRequest.requestCompletion) {
                Write-Log "`nRequest Completion:"
                $fullRequest.requestCompletion.PSObject.Properties | ForEach-Object {
                    Write-Log "  $($_.Name) = $($_.Value)"
                }
            }
            
            # Look for resource information
            if ($fullRequest.resourceRef) {
                Write-Log "`nResource Reference:"
                $fullRequest.resourceRef.PSObject.Properties | ForEach-Object {
                    Write-Log "  $($_.Name) = $($_.Value)"
                }
            }
            
            if ($fullRequest.requestedResourceRef) {
                Write-Log "`nRequested Resource Reference:"
                $fullRequest.requestedResourceRef.PSObject.Properties | ForEach-Object {
                    Write-Log "  $($_.Name) = $($_.Value)"
                }
            }
        }
        catch {
            Write-Log "Could not fetch full request details: $($_.Exception.Message)" "ERROR"
        }
        
        # Determine template name for filtering
        $templateName = $null
        if ($catalogItemName) {
            $templateName = $catalogItemName
        } elseif ($blueprintName) {
            $templateName = $blueprintName
        } elseif ($delReq.requestedItemName) {
            # Use the requested item name as fallback
            $templateName = $delReq.requestedItemName
        }
        
        Write-Log "`nTemplate Name for filtering: $templateName"
        
        # Apply filter
        $matchesFilter = $false
        if ($templateName) {
            foreach ($filterName in $filterTemplateNames) {
                if ($templateName -match $filterName) {
                    $matchesFilter = $true
                    Write-Log ">>> MATCHES FILTER: '$filterName' <<<" "SUCCESS"
                    break
                }
            }
        }
        
        if (-not $matchesFilter) {
            Write-Log "Skipping: Template '$templateName' doesn't match filter: $($filterTemplateNames -join ', ')" "WARN"
            continue
        }
        
        # Create detailed output object
        $deleteInfo = [PSCustomObject]@{
            RequestNumber = $delReq.requestNumber
            RequestID = $delReq.id
            RequestType = $delReq.requestType
            ItemName = $delReq.requestedItemName
            TemplateName = $templateName
            CatalogItemName = $catalogItemName
            BlueprintName = $blueprintName
            Phase = $delReq.phase
            State = $delReq.state
            RequestedBy = $delReq.requestedBy
            RequestedFor = $delReq.requestedFor
            DateSubmitted = $delReq.dateSubmitted
            DateCompleted = $delReq.dateCompleted
            
            # Full request objects
            BasicRequest = $delReq
            FullRequest = $fullRequest
        }
        
        $deletedDeploymentDetails += $deleteInfo
        
        Write-Log "`n>>> ADDED TO OUTPUT <<<" "SUCCESS"
    }
    
}
catch {
    Write-Log "ERROR querying request-service: $($_.Exception.Message)" "ERROR"
    Write-Log "Stack trace: $($_.Exception.StackTrace)" "ERROR"
}

# Summary and Export
Write-Log "`n============================================" "SUCCESS"
Write-Log "===== SUMMARY =====" "SUCCESS"
Write-Log "============================================" "SUCCESS"
Write-Log "Total DELETE requests found: $($deleteRequests.Count)" 
Write-Log "DELETE requests matching filter: $($deletedDeploymentDetails.Count)" "SUCCESS"

if ($deletedDeploymentDetails.Count -gt 0) {
    # Export full JSON
    Write-Log "`nExporting detailed data..."
    $deletedDeploymentDetails | ConvertTo-Json -Depth 20 | Out-File -FilePath $outputJson -Encoding UTF8
    Write-Log "Full JSON exported to: $outputJson" "SUCCESS"
    
    # Export CSV for easy viewing
    $deletedDeploymentDetails | Select-Object RequestNumber, ItemName, TemplateName, RequestedBy, 
        RequestedFor, DateSubmitted, DateCompleted, State | 
        Export-Csv -Path $outputCsv -NoTypeInformation -Encoding UTF8
    Write-Log "CSV summary exported to: $outputCsv" "SUCCESS"
    
    # Display summary table
    Write-Log "`n=== DELETED DEPLOYMENTS SUMMARY ===" "SUCCESS"
    $deletedDeploymentDetails | ForEach-Object {
        Write-Log "`nRequest #$($_.RequestNumber): $($_.ItemName)" "SUCCESS"
        Write-Log "  Template: $($_.TemplateName)"
        Write-Log "  Deleted By: $($_.RequestedBy)"
        Write-Log "  Date: $($_.DateSubmitted)"
        Write-Log "  Status: $($_.State)"
    }
}
else {
    Write-Log "`nNO MATCHING DELETE REQUESTS FOUND!" "WARN"
    Write-Log "Possible reasons:" "WARN"
    Write-Log "  1. No deployments with matching templates were deleted in the past $daysBack day(s)" "WARN"
    Write-Log "  2. Adjust `$filterTemplateNames to match your actual template names" "WARN"
    Write-Log "  3. Increase `$daysBack variable to look further back" "WARN"
}

Write-Log "`n===== Script Completed =====" "SUCCESS"
Write-Log "JSON Output: $outputJson"
Write-Log "CSV Output: $outputCsv"
Write-Log "Log file: $outputLog"
