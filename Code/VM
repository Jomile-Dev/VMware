# vRA 8.18 Fixed History Tool
# Uses the specific URL structure you found: /deployments/{id}/requests/{id}/events

# --- Configuration ---
$vraServer = "vra1.yourdomain.com"
$outputCsv = "D:\vRA_History_Report.csv"  # <--- Set your path here
$daysBack  = 30

# --- Auth & Setup ---
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
    Add-Type "using System.Net; using System.Security.Cryptography.X509Certificates; public class TrustAllCertsPolicy : ICertificatePolicy { public bool CheckValidationResult(ServicePoint svcPoint, X509Certificate certificate, WebRequest request, int certificateProblem) { return true; } }"
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
}

$credential = Get-Credential -Message "vRA Admin Credentials"
$authBody = @{ username = $credential.UserName; password = $credential.GetNetworkCredential().Password } | ConvertTo-Json
try {
    $authRes = Invoke-RestMethod -Uri "https://$vraServer/csp/gateway/am/api/login" -Method Post -Headers @{"Content-Type"="application/json"} -Body $authBody
    $vraHeaders = @{ "Authorization" = "Bearer $($authRes.cspAuthToken)"; "Content-Type" = "application/json" }
} catch { Write-Host "Login Failed" -ForegroundColor Red; exit }

# --- Step 1: Find the "Delete" Actions ---
# We must find the Request ID and Deployment ID first to build your URL
Write-Host "Searching for 'Deployment.Delete' actions in the last $daysBack days..." -ForegroundColor Cyan

$dateStr = (Get-Date).AddDays(-$daysBack).ToString("yyyy-MM-dd")
# This filter is the most common point of failure for 400 errors. We keep it simple.
$reqUri = "https://$vraServer/deployment/api/requests?apiVersion=2020-08-25&`$filter=(actionId eq 'Deployment.Delete') and (createdAt ge '$dateStr')&`$top=1000"

try {
    $requests = (Invoke-RestMethod -Uri $reqUri -Method Get -Headers $vraHeaders).content
} catch {
    Write-Host "Error finding requests: $($_.Exception.Message)" -ForegroundColor Red
    exit
}

Write-Host "Found $($requests.Count) delete requests. Retrieving events using your URL structure..." -ForegroundColor Yellow

$results = @()

# --- Step 2: Loop and Hit Your Specific URL ---
foreach ($req in $requests) {
    
    # We need both IDs for your URL
    $depId = $req.deploymentId
    $reqId = $req.id
    
    # Optional: Skip if Deployment ID is missing (can happen on failed initial requests)
    if (-not $depId) { continue }

    Write-Host "Fetching Events for: $($req.deploymentName)" -ForegroundColor Gray

    # --- YOUR SPECIFIC URL FIX ---
    # This matches the pattern you provided:
    # /deployment/api/deployments/{deploymentId}/requests/{requestId}/events
    # We include your parameters: page=0, size=50, deleted=true
    $eventUri = "https://$vraServer/deployment/api/deployments/$depId/requests/$reqId/events?page=0&size=50&deleted=true&apiVersion=2020-08-25"

    try {
        $events = (Invoke-RestMethod -Uri $eventUri -Method Get -Headers $vraHeaders).content
        
        # If events are found, add them to our list
        if ($events) {
            foreach ($evt in $events) {
                $results += [PSCustomObject]@{
                    DeploymentName   = $req.deploymentName
                    RequestedBy      = $req.requestedBy
                    RequestStatus    = $req.status
                    # Event Details
                    EventTimestamp   = $evt.timestamp
                    ResourceType     = $evt.resourceType # (e.g., Cloud.vSphere.Machine)
                    EventStatus      = $evt.status       # (e.g., DELETE_FINISHED)
                    Message          = $evt.message
                    DeploymentID     = $depId
                    RequestID        = $reqId
                }
            }
        } else {
            # Log it even if events are empty so you know it was checked
            $results += [PSCustomObject]@{
                DeploymentName   = $req.deploymentName
                RequestedBy      = $req.requestedBy
                RequestStatus    = $req.status
                EventTimestamp   = "N/A"
                ResourceType     = "No Events Returned"
                EventStatus      = "N/A"
                Message          = "Likely purged"
                DeploymentID     = $depId
                RequestID        = $reqId
            }
        }
    } catch {
        # If this specific URL fails (404/400), we log the error in the CSV
        $err = $_.Exception.Message
        $results += [PSCustomObject]@{
            DeploymentName = $req.deploymentName
            Message        = "API Error: $err"
        }
    }
}

# --- Step 3: Save File ---
if ($results.Count -gt 0) {
    $results | Export-Csv -Path $outputCsv -NoTypeInformation -Encoding UTF8
    Write-Host "Done. File saved to: $outputCsv" -ForegroundColor Green
} else {
    Write-Host "No data found." -ForegroundColor Red
}
