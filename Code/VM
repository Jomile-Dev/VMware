# vRA Merged History Extractor
# Replicates the GUI View: Metadata + History + Logs + Resources

# --- Configuration ---
$vraServer = "vra1.yourdomain.com"
$apiVersion = "2020-08-25" 
$daysBack   = 30 
$filterKeywords = @("Virtual Machine", "Database")

# --- 1. Fix Null Path & Prep Output ---
$logDir = "C:\Logs"
if (!(Test-Path $logDir)) { 
    New-Item -ItemType Directory -Path $logDir -Force | Out-Null 
}
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputLog = "$logDir\vRA_Full_Deep_Dive_$timestamp.log"

Write-Host "Logs will be saved to: $outputLog" -ForegroundColor Cyan

# --- Setup & Auth ---
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type "using System.Net; using System.Security.Cryptography.X509Certificates; public class TrustAllCertsPolicy : ICertificatePolicy { public bool CheckValidationResult(ServicePoint svcPoint, X509Certificate certificate, WebRequest request, int certificateProblem) { return true; } }"
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
}
Disable-SSLValidation

$credential = Get-Credential -Message "vRA Admin Credentials"
$authBody = @{ username = $credential.UserName; password = $credential.GetNetworkCredential().Password } | ConvertTo-Json
$authRes = Invoke-RestMethod -Uri "https://$vraServer/csp/gateway/am/api/login" -Method Post -Headers @{"Content-Type"="application/json"} -Body $authBody
$vraHeaders = @{ "Authorization" = "Bearer $($authRes.cspAuthToken)"; "Content-Type" = "application/json" }

# --- 2. Get Deleted Deployments ---
Write-Host "Fetching deleted deployment records..." -ForegroundColor Cyan
$deployUri = "https://$vraServer/deployment/api/deployments?apiVersion=$apiVersion&deleted=true&`$top=200"
$allDeps = (Invoke-RestMethod -Uri $deployUri -Method Get -Headers $vraHeaders).content

$cutoffDate = (Get-Date).AddDays(-$daysBack)

foreach ($dep in $allDeps) {
    # Filters: Look for Deleted status + Keywords
    if ($dep.status -notmatch "DELETE" -and $dep.status -ne "ARCHIVED") { continue }
    $nameMatch = $false
    foreach ($k in $filterKeywords) { if ($dep.name -match $k) { $nameMatch = $true } }
    if (-not $nameMatch) { continue }

    # --- TOP LEVEL METADATA ---
    $header = "`n[DEPLOYMENT] Name: $($dep.name) | Status: $($dep.status) | ID: $($dep.id)"
    Write-Host $header -ForegroundColor White -Bold
    $header | Add-Content $outputLog

    # --- 3. RESOURCE SPECIFICS (IP/CPU/RAM) ---
    try {
        $resUri = "https://$vraServer/deployment/api/deployments/$($dep.id)/resources?apiVersion=$apiVersion"
        $resources = (Invoke-RestMethod -Uri $resUri -Method Get -Headers $vraHeaders).content
        if ($resources) {
            foreach ($res in $resources) {
                $specLine = "  [Resource] Name: $($res.name) | IP: $($res.properties.address) | CPU: $($res.properties.cpuCount)"
                Write-Host $specLine -ForegroundColor Cyan
                $specLine | Add-Content $outputLog
            }
        }
    } catch { 
        "  [Resource] Details purged from DB (Expected for older deletions)." | Add-Content $outputLog 
    }

    # --- 4. REQUEST HISTORY (GUI History Tab) ---
    try {
        $reqUri = "https://$vraServer/deployment/api/deployments/$($dep.id)/requests?apiVersion=$apiVersion"
        $requests = (Invoke-RestMethod -Uri $reqUri -Method Get -Headers $vraHeaders).content
        
        foreach ($req in $requests) {
            $reqLine = "  [Action] $($req.name) | User: $($req.requestedBy) | Time: $($req.completedAt)"
            Write-Host $reqLine -ForegroundColor Yellow
            $reqLine | Add-Content $outputLog

            # --- 5. GRANULAR EVENTS (Technical Logs) ---
            try {
                $eventUri = "https://$vraServer/deployment/api/requests/$($req.id)/events?apiVersion=$apiVersion"
                $events = (Invoke-RestMethod -Uri $eventUri -Method Get -Headers $vraHeaders).content
                if ($events) {
                    foreach ($evt in $events) {
                        $evtLine = "    > $($evt.timestamp): $($evt.message)"
                        Write-Host $evtLine -ForegroundColor DarkGray
                        $evtLine | Add-Content $outputLog
                    }
                }
            } catch { "    > Event logs purged." | Add-Content $outputLog }
        }
    } catch { "  [History] Request history unavailable." | Add-Content $outputLog }
}

Write-Host "`nAnalysis complete. Full report at: $outputLog" -ForegroundColor Green
