# vRA Deleted Deployments - Extract Delete Event Details
# Optimized for vRA 8.18 - Bypasses 404 errors by using Global Request Service filtering

# Configuration
$vraServer = "vra1.yourdomain.com"
$daysBack = 1  # Past 1 day

# FILTER CONFIGURATION
$filterTemplateNames = @("Virtual Machine", "Database")

# Output Setup
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$logDir = "C:\Logs"
if (!(Test-Path $logDir)) { New-Item -ItemType Directory -Path $logDir -Force | Out-Null }
$outputLog = "$logDir\DeletedDeployments_$timestamp.log"
$outputCsv = "$logDir\DeletedDeployments_$timestamp.csv"

function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    $ts = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$ts] [$Level] $Message"
    $color = switch ($Level) { "ERROR" {"Red"} "WARN" {"Yellow"} "SUCCESS" {"Green"} default {"Cyan"} }
    Write-Host $logMessage -ForegroundColor $color
    Add-Content -Path $outputLog -Value $logMessage
}

# SSL/TLS Setup
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
    Add-Type "using System.Net; using System.Security.Cryptography.X509Certificates; public class TrustAllCertsPolicy : ICertificatePolicy { public bool CheckValidationResult(ServicePoint s, X509Certificate c, WebRequest r, int p) { return true; } }"
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
}

Write-Log "===== vRA Deleted Deployments - History Extractor =====" "SUCCESS"

# 1. Authentication
$credential = Get-Credential -Message "Enter vRA Credentials"
$vraAuthBody = @{ username = $credential.UserName; password = $credential.GetNetworkCredential().Password } | ConvertTo-Json
try {
    $authRes = Invoke-RestMethod -Uri "https://$vraServer/csp/gateway/am/api/login" -Method Post -Body $vraAuthBody -Headers @{"Content-Type"="application/json"}
    $vraHeaders = @{ "Authorization" = "Bearer $($authRes.cspAuthToken)"; "Content-Type" = "application/json"; "Accept" = "application/json" }
    Write-Log "Authenticated successfully." "SUCCESS"
} catch {
    Write-Log "Auth failed: $($_.Exception.Message)" "ERROR"; exit
}

$cutoffDate = (Get-Date).AddDays(-$daysBack)
$finalResults = @()

# 2. Fetch Deleted Deployments
Write-Log "Scanning for deleted deployments..."
$page = 0
$size = 100

do {
    $depUri = "https://$vraServer/deployment/api/deployments?`$filter=deleted eq true&page=$page&size=$size"
    $depResponse = Invoke-RestMethod -Uri $depUri -Method Get -Headers $vraHeaders
    $deployments = if ($depResponse.content) { $depResponse.content } else { $depResponse.value }

    if (-not $deployments) { break }

    foreach ($dep in $deployments) {
        # Filter by Date
        $delDate = if ($dep.deletedAt) { [DateTime]$dep.deletedAt } else { [DateTime]$dep.lastUpdatedAt }
        if ($delDate -lt $cutoffDate) { continue }

        Write-Log "Processing: $($dep.name) (Deleted: $delDate)" "SUCCESS"

        # 3. THE FIX: Query the GLOBAL Request API
        # We don't use /deployments/{id}/requests because it returns 404 for deleted items.
        # We use /requests?$filter=deploymentId eq '{id}'
        $requests = $null
        try {
            $reqUri = "https://$vraServer/deployment/api/requests?`$filter=deploymentId eq '$($dep.id)'"
            $reqRes = Invoke-RestMethod -Uri $reqUri -Method Get -Headers $vraHeaders
            $requests = if ($reqRes.content) { $reqRes.content } else { $reqRes.value }
        } catch {
            Write-Log "Could not fetch history for $($dep.id): $($_.Exception.Message)" "WARN"
        }

        # 4. Find the Delete Event
        $deleteEvent = $requests | Where-Object { $_.actionId -match "delete" -or $_.name -match "Delete" } | Select-Object -First 1

        if ($deleteEvent) {
            Write-Log "  Found delete request by $($deleteEvent.requestedBy)" "SUCCESS"
            
            $finalResults += [PSCustomObject]@{
                DeploymentName = $dep.name
                DeploymentID   = $dep.id
                DeletedBy      = $deleteEvent.requestedBy
                DeletedAt      = $delDate
                Status         = $deleteEvent.status
                ProjectID      = $dep.projectId
                Blueprint      = $dep.blueprintId
                CatalogItem    = $dep.catalogItemName
            }
        } else {
            Write-Log "  No delete event found in history for this deployment." "WARN"
        }
    }
    $page++
} while ($deployments.Count -eq $size)

# 5. Export Results
if ($finalResults) {
    $finalResults | Export-Csv -Path $outputCsv -NoTypeInformation
    Write-Log "Report generated: $outputCsv" "SUCCESS"
} else {
    Write-Log "No matching deleted deployments found in the last $daysBack day(s)." "WARN"
}
