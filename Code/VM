# VMware vRA - Get ALL Deleted Deployments
# Uses the EXACT API endpoint from the vRA UI network console

# Configuration
$vraServer = "vra1.yourdomain.com"
$daysBack = 90  # How many days back to search for deleted deployments
$pageSize = 200  # Items per page for deployments
$eventsPageSize = 200  # Items per page for events (increased from 50)
$filterResourceTypes = @("Cloud.vSphere.Machine")  # Filter events by resource type (empty array = no filter)

# Output files
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputCsv = "C:\Logs\vRA_DeletedDeployments_$timestamp.csv"
$outputDetailedCsv = "C:\Logs\vRA_DeletedDeployments_Detailed_$timestamp.csv"
$outputJson = "C:\Logs\vRA_DeletedDeployments_Raw_$timestamp.json"
$outputLog = "C:\Logs\vRA_DeletedDeployments_$timestamp.log"

function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    $logTimestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$logTimestamp] [$Level] $Message"
    
    $color = switch ($Level) {
        "ERROR" { "Red" }
        "WARN" { "Yellow" }
        "SUCCESS" { "Green" }
        "DEBUG" { "Magenta" }
        default { "White" }
    }
    
    Write-Host $logMessage -ForegroundColor $color
    Add-Content -Path $outputLog -Value $logMessage -ErrorAction SilentlyContinue
}

function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type @"
using System.Net;
using System.Security.Cryptography.X509Certificates;
public class TrustAllCertsPolicy : ICertificatePolicy {
    public bool CheckValidationResult(
        ServicePoint svcPoint, X509Certificate certificate,
        WebRequest request, int certificateProblem) {
        return true;
    }
}
"@
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
}

function Test-ApiEndpoint {
    param(
        [string]$Uri,
        [hashtable]$Headers,
        [string]$Description
    )
    
    Write-Log "`n--- Testing: $Description ---" "DEBUG"
    Write-Log "URL: $Uri" "DEBUG"
    
    try {
        $response = Invoke-WebRequest -Uri $Uri -Method Get -Headers $Headers -ErrorAction Stop
        Write-Log "✓ SUCCESS - Status: $($response.StatusCode)" "SUCCESS"
        Write-Log "Response Content-Type: $($response.Headers['Content-Type'])" "DEBUG"
        
        # Try to parse JSON
        try {
            $data = $response.Content | ConvertFrom-Json
            if ($data.content) {
                Write-Log "Found 'content' property with $($data.content.Count) items" "DEBUG"
            }
            elseif ($data -is [Array]) {
                Write-Log "Response is array with $($data.Count) items" "DEBUG"
            }
            else {
                Write-Log "Response properties: $($data.PSObject.Properties.Name -join ', ')" "DEBUG"
            }
            return $data
        }
        catch {
            Write-Log "Could not parse JSON response" "WARN"
            return $null
        }
    }
    catch {
        $statusCode = $_.Exception.Response.StatusCode.value__
        $statusDesc = $_.Exception.Response.StatusDescription
        
        Write-Log "✗ FAILED - Status: $statusCode ($statusDesc)" "ERROR"
        Write-Log "Error: $($_.Exception.Message)" "ERROR"
        
        # Detailed troubleshooting
        switch ($statusCode) {
            400 { 
                Write-Log "`nTROUBLESHOOTING - 400 Bad Request:" "WARN"
                Write-Log "  - Check URL parameters (deleted=true, apiVersion, page, size)" "WARN"
                Write-Log "  - Verify parameter encoding (spaces, special chars)" "WARN"
                Write-Log "  - Check if 'deleted' parameter format is correct" "WARN"
                Write-Log "  - Try without optional parameters first" "WARN"
            }
            401 { 
                Write-Log "`nTROUBLESHOOTING - 401 Unauthorized:" "WARN"
                Write-Log "  - Token may have expired - re-authenticate" "WARN"
                Write-Log "  - Check Authorization header format" "WARN"
            }
            403 { 
                Write-Log "`nTROUBLESHOOTING - 403 Forbidden:" "WARN"
                Write-Log "  - User lacks permissions to view deleted deployments" "WARN"
                Write-Log "  - Check vRA role assignments" "WARN"
                Write-Log "  - May need 'Service Broker Administrator' role" "WARN"
            }
            404 { 
                Write-Log "`nTROUBLESHOOTING - 404 Not Found:" "WARN"
                Write-Log "  - API endpoint path may be incorrect" "WARN"
                Write-Log "  - Check vRA version - endpoint may differ" "WARN"
                Write-Log "  - Deployment or request ID may not exist" "WARN"
            }
            500 { 
                Write-Log "`nTROUBLESHOOTING - 500 Internal Server Error:" "WARN"
                Write-Log "  - vRA backend issue" "WARN"
                Write-Log "  - Check vRA logs" "WARN"
                Write-Log "  - Try again later" "WARN"
            }
            default {
                Write-Log "`nUnexpected error code: $statusCode" "ERROR"
            }
        }
        
        # Try to get response body for more details
        try {
            $reader = New-Object System.IO.StreamReader($_.Exception.Response.GetResponseStream())
            $responseBody = $reader.ReadToEnd()
            Write-Log "Response Body: $responseBody" "DEBUG"
        }
        catch {}
        
        return $null
    }
}

Write-Log "===== vRA Deleted Deployments - Network Console Method =====" "SUCCESS"
Write-Log "This script uses the EXACT API calls from the vRA UI" "SUCCESS"
Disable-SSLValidation

# Ensure output directory exists
$logDir = Split-Path $outputLog -Parent
if (!(Test-Path $logDir)) {
    New-Item -ItemType Directory -Path $logDir -Force | Out-Null
}

# Get credentials
Write-Log "`nRequesting credentials for vRA..."
$credential = Get-Credential -Message "Enter vRA credentials"
if (-not $credential) {
    Write-Log "No credentials provided. Exiting." "ERROR"
    exit
}

# Authenticate
Write-Log "`n============================================"
Write-Log "STEP 1: AUTHENTICATION"
Write-Log "============================================"
Write-Log "Authenticating to vRA: $vraServer"

try {
    $authBody = @{
        username = $credential.UserName
        password = $credential.GetNetworkCredential().Password
    } | ConvertTo-Json
    
    $authResponse = Invoke-RestMethod `
        -Uri "https://$vraServer/csp/gateway/am/api/login" `
        -Method Post `
        -Headers @{"Content-Type"="application/json"} `
        -Body $authBody `
        -ErrorAction Stop
    
    $headers = @{
        "Authorization" = "Bearer $($authResponse.cspAuthToken)"
        "Content-Type" = "application/json"
        "Accept" = "application/json"
    }
    
    Write-Log "✓ Authentication successful" "SUCCESS"
    Write-Log "Token length: $($authResponse.cspAuthToken.Length) characters" "DEBUG"
}
catch {
    Write-Log "✗ Authentication failed: $($_.Exception.Message)" "ERROR"
    exit
}

# STEP 2: Get ALL Deployments with deleted=true filter
Write-Log "`n============================================"
Write-Log "STEP 2: FETCHING DELETED DEPLOYMENTS"
Write-Log "============================================"
Write-Log "Searching for deployments deleted in the last $daysBack days" "SUCCESS"

# Calculate cutoff date
$cutoffDate = (Get-Date).AddDays(-$daysBack)
$cutoffDateStr = $cutoffDate.ToString("yyyy-MM-dd")
Write-Log "Cutoff date: $cutoffDateStr" "DEBUG"

$allDeletedDeployments = @()
$page = 0
$pageSize = 200

# Try different URL variations to find what works
$urlVariations = @(
    # Variation 1: As seen in network console (most likely)
    "https://$vraServer/deployment/api/deployments?deleted=true&apiVersion=2020-08-25&page={0}&size=$pageSize",
    
    # Variation 2: OData style with $filter
    "https://$vraServer/deployment/api/deployments?`$filter=deleted eq true&apiVersion=2020-08-25&`$top=$pageSize&`$skip={1}",
    
    # Variation 3: Simple deleted parameter
    "https://$vraServer/deployment/api/deployments?deleted=true&`$top=$pageSize&`$skip={1}",
    
    # Variation 4: Array format like the URL shows [true]
    "https://$vraServer/deployment/api/deployments?deleted=%5Btrue%5D&apiVersion=2020-08-25&page={0}&size=$pageSize"
)

$workingUrl = $null

foreach ($urlTemplate in $urlVariations) {
    $testUrl = $urlTemplate -f 0, 0
    Write-Log "`nTrying URL variation: $testUrl" "DEBUG"
    
    $result = Test-ApiEndpoint -Uri $testUrl -Headers $headers -Description "Deleted Deployments (Variation)"
    
    if ($result) {
        $workingUrl = $urlTemplate
        Write-Log "✓ This URL variation works!" "SUCCESS"
        
        # Extract deployments from response
        $deployments = if ($result.content) { $result.content } else { $result }
        
        if ($deployments -and $deployments.Count -gt 0) {
            Write-Log "Found $($deployments.Count) deleted deployments in first page" "SUCCESS"
            $allDeletedDeployments += $deployments
            break
        }
        else {
            Write-Log "No deployments returned, trying next variation..." "WARN"
        }
    }
}

if (-not $workingUrl) {
    Write-Log "`n✗ None of the URL variations worked!" "ERROR"
    Write-Log "Please check:" "ERROR"
    Write-Log "  1. vRA version and API compatibility" "ERROR"
    Write-Log "  2. User permissions for viewing deleted deployments" "ERROR"
    Write-Log "  3. Whether deleted deployments exist in the system" "ERROR"
    Write-Log "`nManual test: Try accessing https://$vraServer/deployment/api/deployments in your browser" "WARN"
    exit
}

# Continue fetching remaining pages
if ($allDeletedDeployments.Count -gt 0) {
    Write-Log "`nFetching remaining pages..." "SUCCESS"
    
    $page = 1
    do {
        $skip = $page * $pageSize
        $uri = $workingUrl -f $page, $skip
        
        Write-Log "Fetching page $page (skip=$skip)..." "DEBUG"
        
        $result = Test-ApiEndpoint -Uri $uri -Headers $headers -Description "Page $page"
        
        if ($result) {
            $deployments = if ($result.content) { $result.content } else { $result }
            
            if ($deployments -and $deployments.Count -gt 0) {
                $allDeletedDeployments += $deployments
                Write-Log "  Retrieved $($deployments.Count) deployments (Total: $($allDeletedDeployments.Count))" "SUCCESS"
                $page++
            }
            else {
                Write-Log "No more deployments to fetch" "DEBUG"
                break
            }
        }
        else {
            break
        }
        
        # Safety limit
        if ($allDeletedDeployments.Count -ge 10000) {
            Write-Log "Reached safety limit of 10000 deployments" "WARN"
            break
        }
        
    } while ($true)
}

Write-Log "`nTotal deleted deployments retrieved: $($allDeletedDeployments.Count)" "SUCCESS"

# Filter by date
Write-Log "Filtering deployments by date (last $daysBack days)..." "DEBUG"
$filteredDeployments = $allDeletedDeployments | Where-Object {
    try {
        $updateDate = [DateTime]$_.lastUpdatedAt
        $updateDate -ge $cutoffDate
    }
    catch {
        $true  # Include if can't parse date
    }
}

Write-Log "Deployments after date filter: $($filteredDeployments.Count)" "SUCCESS"

if ($filteredDeployments.Count -eq 0) {
    Write-Log "`n✗ No deleted deployments found in the last $daysBack days!" "WARN"
    Write-Log "This could mean:" "WARN"
    Write-Log "  - No deployments have been deleted" "WARN"
    Write-Log "  - Deleted deployments are purged immediately" "WARN"
    Write-Log "  - The 'deleted' filter requires different syntax" "WARN"
    Write-Log "  - Permissions issue" "WARN"
    exit
}

# STEP 3: Get detailed event history for each deleted deployment
Write-Log "`n============================================"
Write-Log "STEP 3: FETCHING EVENT HISTORY"
Write-Log "============================================"

$summaryResults = @()
$detailedResults = @()

foreach ($deployment in $filteredDeployments) {
    Write-Log "`nProcessing: $($deployment.name)" "SUCCESS"
    Write-Log "  Deployment ID: $($deployment.id)" "DEBUG"
    Write-Log "  Status: $($deployment.status)" "DEBUG"
    Write-Log "  Last Updated: $($deployment.lastUpdatedAt)" "DEBUG"
    
    # Get requests for this deployment
    try {
        $requestsUri = "https://$vraServer/deployment/api/deployments/$($deployment.id)/requests?apiVersion=2020-08-25&deleted=true"
        Write-Log "  Fetching requests..." "DEBUG"
        Write-Log "  URL: $requestsUri" "DEBUG"
        
        $requestsResult = Test-ApiEndpoint -Uri $requestsUri -Headers $headers -Description "Deployment Requests"
        
        if ($requestsResult) {
            $requests = if ($requestsResult.content) { $requestsResult.content } else { $requestsResult }
            Write-Log "  Found $($requests.Count) requests" "SUCCESS"
            
            # Get events for each request
            foreach ($request in $requests) {
                Write-Log "    Request ID: $($request.id) - Action: $($request.actionId)" "DEBUG"
                
                # Fetch ALL events with pagination
                $allEvents = @()
                $eventPage = 0
                $totalEventPages = 0
                
                do {
                    # THIS IS THE EXACT URL FROM YOUR NETWORK CONSOLE with pagination
                    $eventsUri = "https://$vraServer/deployment/api/deployments/$($deployment.id)/requests/$($request.id)/events?page=$eventPage&size=$eventsPageSize&deleted=true&apiVersion=2020-08-25"
                    Write-Log "    Fetching events page $eventPage..." "DEBUG"
                    Write-Log "    URL: $eventsUri" "DEBUG"
                    
                    $eventsResult = Test-ApiEndpoint -Uri $eventsUri -Headers $headers -Description "Request Events Page $eventPage"
                    
                    if ($eventsResult) {
                        $events = if ($eventsResult.content) { $eventsResult.content } else { $eventsResult }
                        
                        if ($events -and $events.Count -gt 0) {
                            $allEvents += $events
                            Write-Log "    Retrieved $($events.Count) events (Total: $($allEvents.Count))" "SUCCESS"
                            
                            # Check if there are more pages
                            if ($eventsResult.totalElements) {
                                $totalEventPages = [Math]::Ceiling($eventsResult.totalElements / $eventsPageSize)
                                Write-Log "    Total events available: $($eventsResult.totalElements) (Pages: $totalEventPages)" "DEBUG"
                            }
                            
                            $eventPage++
                            
                            # Stop if we got fewer items than page size (last page)
                            if ($events.Count -lt $eventsPageSize) {
                                break
                            }
                        }
                        else {
                            break
                        }
                    }
                    else {
                        break
                    }
                    
                    # Safety limit per request
                    if ($allEvents.Count -ge 1000) {
                        Write-Log "    Reached safety limit of 1000 events for this request" "WARN"
                        break
                    }
                    
                } while ($true)
                
                Write-Log "    Total events for request: $($allEvents.Count)" "SUCCESS"
                
                # Filter events by resource type if specified
                $filteredEvents = $allEvents
                if ($filterResourceTypes.Count -gt 0) {
                    $filteredEvents = $allEvents | Where-Object {
                        $eventResourceType = $_.resourceType
                        $match = $false
                        foreach ($filter in $filterResourceTypes) {
                            if ($eventResourceType -eq $filter -or $eventResourceType -like $filter) {
                                $match = $true
                                break
                            }
                        }
                        $match
                    }
                    Write-Log "    Events after resource type filter ($($filterResourceTypes -join ', ')): $($filteredEvents.Count)" "SUCCESS"
                }
                
                # Create detailed records for each event
                foreach ($event in $filteredEvents) {
                        # Extract details - could be string, object, or array
                        $detailsValue = $null
                        if ($event.details) {
                            if ($event.details -is [string]) {
                                $detailsValue = $event.details
                            }
                            else {
                                # Convert complex objects to JSON string for CSV
                                $detailsValue = ($event.details | ConvertTo-Json -Compress -Depth 5)
                            }
                        }
                        
                        $detailedResults += [PSCustomObject]@{
                            DeploymentName = $deployment.name
                            DeploymentId = $deployment.id
                            RequestId = $request.id
                            RequestAction = $request.actionId
                            RequestedBy = $request.requestedBy
                            RequestedAt = $request.createdAt
                            RequestStatus = $request.status
                            EventTimestamp = $event.timestamp
                            EventStatus = $event.status
                            EventType = $event.eventType
                            ResourceType = $event.resourceType
                            ResourceName = $event.resourceName
                            Message = $event.message
                            Details = $detailsValue  # NEW: The "Details" column from the UI
                            EventId = $event.id
                            # Additional event properties
                            EventLogLevel = $event.logLevel
                            EventSource = $event.source
                            EventCode = $event.code
                        }
                    }
                }
                
                # Create summary record
                $summaryResults += [PSCustomObject]@{
                    DeploymentName = $deployment.name
                    DeploymentId = $deployment.id
                    Status = $deployment.status
                    Owner = $deployment.ownedBy
                    CreatedBy = $deployment.createdBy
                    CreatedAt = $deployment.createdAt
                    LastUpdatedBy = $deployment.lastUpdatedBy
                    LastUpdatedAt = $deployment.lastUpdatedAt
                    ProjectId = $deployment.projectId
                    ProjectName = $deployment.projectName
                    BlueprintId = $deployment.blueprintId
                    RequestCount = $requests.Count
                    TotalEventCount = $allEvents.Count
                    FilteredEventCount = $filteredEvents.Count
                }
        }
        else {
            Write-Log "  Could not fetch requests for this deployment" "WARN"
        }
    }
    catch {
        Write-Log "  Error processing deployment: $($_.Exception.Message)" "ERROR"
    }
}

# STEP 4: Export results
Write-Log "`n============================================"
Write-Log "STEP 4: EXPORTING RESULTS"
Write-Log "============================================"

if ($summaryResults.Count -gt 0) {
    $summaryResults | Export-Csv -Path $outputCsv -NoTypeInformation -Encoding UTF8
    Write-Log "✓ Summary CSV: $outputCsv" "SUCCESS"
}

if ($detailedResults.Count -gt 0) {
    $detailedResults | Export-Csv -Path $outputDetailedCsv -NoTypeInformation -Encoding UTF8
    Write-Log "✓ Detailed events CSV: $outputDetailedCsv" "SUCCESS"
}

# Export raw JSON
$rawData = @{
    Deployments = $allDeletedDeployments
    Summary = $summaryResults
    DetailedEvents = $detailedResults
}
$rawData | ConvertTo-Json -Depth 10 | Out-File -FilePath $outputJson -Encoding UTF8
Write-Log "✓ Raw JSON: $outputJson" "SUCCESS"

# Final summary
Write-Log "`n============================================"
Write-Log "FINAL SUMMARY"
Write-Log "============================================"
Write-Log "Date range: Last $daysBack days (since $cutoffDateStr)" "SUCCESS"
Write-Log "Resource type filter: $(if ($filterResourceTypes.Count -gt 0) { $filterResourceTypes -join ', ' } else { 'None (all types)' })" "SUCCESS"
Write-Log "Deleted deployments found: $($summaryResults.Count)" "SUCCESS"
Write-Log "Total events captured: $($detailedResults.Count)" "SUCCESS"

if ($summaryResults.Count -gt 0) {
    Write-Log "`nMost recent deletions:" "SUCCESS"
    $summaryResults | Sort-Object LastUpdatedAt -Descending | Select-Object -First 5 | ForEach-Object {
        Write-Log "`n  $($_.DeploymentName)" "SUCCESS"
        Write-Log "    Last Updated: $($_.LastUpdatedAt)" "DEBUG"
        Write-Log "    Status: $($_.Status)" "DEBUG"
        Write-Log "    Owner: $($_.Owner)" "DEBUG"
    }
}

Write-Log "`n===== Script Complete =====" "SUCCESS"
Write-Log "Log file: $outputLog"
