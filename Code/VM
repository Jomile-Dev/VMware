# vRA Global Request History Extractor
# Purpose: Bypasses deployment-level API blocks by querying the Global Request Service

# Configuration
$vraServer = "vra1.yourdomain.com"
$daysBack = 14
$apiVersion = "2020-08-25" 
$filterTemplateNames = @("Virtual Machine", "Database")

# Output
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputCsv  = "C:\Logs\vRA_GlobalDeleteHistory_$timestamp.csv"

# --- Authentication (Standard) ---
Disable-SSLValidation
$credential = Get-Credential
$authBody = @{ username = $credential.UserName; password = $credential.GetNetworkCredential().Password } | ConvertTo-Json
$authRes = Invoke-RestMethod -Uri "https://$vraServer/csp/gateway/am/api/login" -Method Post -Headers @{"Content-Type"="application/json"} -Body $authBody
$vraHeaders = @{ "Authorization" = "Bearer $($authRes.cspAuthToken)"; "Content-Type" = "application/json" }

# STEP 1: Query the GLOBAL Request endpoint
# This looks at EVERY request in the system, filtered by 'Delete' actions
Write-Host "Querying Global Request Service for Delete actions..." -ForegroundColor Cyan

$cutoffDate = (Get-Date).AddDays(-$daysBack).ToString("yyyy-MM-ddTHH:mm:ss.fffZ")
$requestUri = "https://$vraServer/deployment/api/requests?apiVersion=$apiVersion&`$filter=(actionId eq 'Deployment.Delete' or actionId eq 'Cloud.AWS.EC2.Instance.Delete') and completedAt ge '$cutoffDate'&`$top=1000"

try {
    $allRequests = (Invoke-RestMethod -Uri $requestUri -Method Get -Headers $vraHeaders).content
} catch {
    Write-Host "Failed to query global requests: $($_.Exception.Message)" -ForegroundColor Red
    exit
}

$finalResults = @()

# STEP 2: Match Requests to your Filters
foreach ($req in $allRequests) {
    Write-Host "Processing Request: $($req.name) for Deployment: $($req.deploymentName)" -ForegroundColor Yellow
    
    # Check if the deployment name or template matches your filter
    # Note: Global requests usually contain the 'deploymentName' inside the object
    $match = $false
    foreach($f in $filterTemplateNames) {
        if ($req.deploymentName -match $f -or $req.name -match $f) { $match = $true }
    }

    if ($match) {
        # STEP 3: Drill into the Resources for this specific Request (The "History" Details)
        $resDetails = "No granular details"
        try {
            $resUri = "https://$vraServer/deployment/api/requests/$($req.id)/resources?apiVersion=$apiVersion"
            $resources = (Invoke-RestMethod -Uri $resUri -Method Get -Headers $vraHeaders).content
            if ($resources) {
                $resDetails = $resources | ForEach-Object { "$($_.name) [$($_.type)]: $($_.status)" } | Out-String
            }
        } catch { }

        $finalResults += [PSCustomObject]@{
            Timestamp      = $req.completedAt
            DeploymentName = $req.deploymentName
            Action         = $req.name
            Status         = $req.status
