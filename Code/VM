# vRA Total Deleted Deployment Extractor
# This script bypasses API filters to pull all available deleted metadata.

# --- Configuration ---
$vraServer = "vra1.yourdomain.com"
$apiVersion = "2020-08-25"
$daysBack = 90  # How far back to look in the local filter

# --- Output ---
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputCsv = "C:\Logs\vRA_All_Deleted_Deployments_$timestamp.csv"

# --- Setup & Auth ---
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type "using System.Net; using System.Security.Cryptography.X509Certificates; public class TrustAllCertsPolicy : ICertificatePolicy { public bool CheckValidationResult(ServicePoint svcPoint, X509Certificate certificate, WebRequest request, int certificateProblem) { return true; } }"
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
}
Disable-SSLValidation

$credential = Get-Credential -Message "Enter vRA Admin Credentials"
$authBody = @{ username = $credential.UserName; password = $credential.GetNetworkCredential().Password } | ConvertTo-Json
$authRes = Invoke-RestMethod -Uri "https://$vraServer/csp/gateway/am/api/login" -Method Post -Headers @{"Content-Type"="application/json"} -Body $authBody
$vraHeaders = @{ "Authorization" = "Bearer $($authRes.cspAuthToken)"; "Content-Type" = "application/json" }

# STEP 1: Get ALL deployments (including deleted/archived metadata)
Write-Host "Querying vRA for all deployment records..." -ForegroundColor Cyan
# We use 'deleted=true' to tell vRA to include the 'tombstone' records in the response
$deployUri = "https://$vraServer/deployment/api/deployments?apiVersion=$apiVersion&deleted=true&`$top=1000"

try {
    $response = Invoke-RestMethod -Uri $deployUri -Method Get -Headers $vraHeaders
    $allDeps = $response.content
} catch {
    Write-Host "Error: Could not retrieve deployment list. $($_.Exception.Message)" -ForegroundColor Red
    exit
}

# STEP 2: Filter for Deleted Items and Extract Details
Write-Host "Filtering $($allDeps.Count) records for DELETED status..." -ForegroundColor Yellow
$cutoffDate = (Get-Date).AddDays(-$daysBack)
$deletedList = @()

foreach ($dep in $allDeps) {
    # We look for any status that indicates the VM is gone
    $isDeleted = $dep.status -match "DELETE" -or $dep.status -eq "ARCHIVED"
    
    if ($isDeleted) {
        # Filter by date if needed
        if ($dep.lastUpdatedAt) {
            $lastUpdate = [DateTime]$dep.lastUpdatedAt
            if ($lastUpdate -lt $cutoffDate) { continue }
        }

        # Create a clean object with every available detail
        $deletedList += [PSCustomObject]@{
            DeploymentName = $dep.name
            Status         = $dep.status
            DeletedDate    = $dep.lastUpdatedAt
            DeletedBy      = $dep.lastUpdatedBy  # This is usually the user who triggered delete
            OwnedBy        = $dep.ownedBy
            Project        = $dep.projectId
            DeploymentID   = $dep.id
            BlueprintID    = $dep.blueprintId
            CatalogItemID  = $dep.catalogItemId
            Description    = $dep.description
            CreatedDate    = $dep.createdAt
            CreatedBy      = $dep.createdBy
        }
    }
}

# STEP 3: Export to CSV
if ($deletedList.Count -gt 0) {
    $deletedList | Export-Csv -Path $outputCsv -NoTypeInformation -Encoding UTF8
    Write-Host "SUCCESS: Found $($deletedList.Count) deleted deployments." -ForegroundColor Green
    Write-Host "Results saved to: $outputCsv" -ForegroundColor White
    
    # Show a quick preview in the console
    $deletedList | Select-Object DeploymentName, DeletedBy, DeletedDate -First 10 | Format-Table
} else {
    Write-Host "No deleted deployments found in the last $daysBack days." -ForegroundColor Gray
}
