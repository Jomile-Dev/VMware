# vRA Merged Deep-Dive: Metadata + Specs + GUI History Logs
# Matches the view from your provided image

# --- Configuration ---
$vraServer = "vra1.yourdomain.com"
$apiVersion = "2020-08-25" 
$daysBack   = 30 
$filterKeywords = @("Virtual Machine", "Database")

# --- Output ---
$logDir = "C:\Logs"
if (!(Test-Path $logDir)) { New-Item -ItemType Directory -Path $logDir -Force | Out-Null }
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputLog = "$logDir\vRA_GUI_History_Match_$timestamp.log"

# --- Setup & Auth ---
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type "using System.Net; using System.Security.Cryptography.X509Certificates; public class TrustAllCertsPolicy : ICertificatePolicy { public bool CheckValidationResult(ServicePoint svcPoint, X509Certificate certificate, WebRequest request, int certificateProblem) { return true; } }"
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
}
Disable-SSLValidation

$credential = Get-Credential -Message "vRA Admin Credentials"
$authBody = @{ username = $credential.UserName; password = $credential.GetNetworkCredential().Password } | ConvertTo-Json
$authRes = Invoke-RestMethod -Uri "https://$vraServer/csp/gateway/am/api/login" -Method Post -Headers @{"Content-Type"="application/json"} -Body $authBody
$vraHeaders = @{ "Authorization" = "Bearer $($authRes.cspAuthToken)"; "Content-Type" = "application/json" }

# --- Processing ---
Write-Host "Fetching Deployment Records..." -ForegroundColor Cyan
$deployUri = "https://$vraServer/deployment/api/deployments?apiVersion=$apiVersion&deleted=true&`$top=100"
$allDeps = (Invoke-RestMethod -Uri $deployUri -Method Get -Headers $vraHeaders).content
$cutoffDate = (Get-Date).AddDays(-$daysBack)

foreach ($dep in $allDeps) {
    if ($dep.status -notmatch "DELETE" -and $dep.status -ne "ARCHIVED") { continue }
    $nameMatch = $false
    foreach ($k in $filterKeywords) { if ($dep.name -match $k) { $nameMatch = $true } }
    if (-not $nameMatch) { continue }

    $header = "`n[DEPLOYMENT] $($dep.name) | DeletedBy: $($dep.lastUpdatedBy)"
    Write-Host $header -ForegroundColor White -Bold
    $header | Add-Content $outputLog

    # 1. Grab Resource Specs (CPU/IP) from the Resource Endpoint
    try {
        $resUri = "https://$vraServer/deployment/api/deployments/$($dep.id)/resources?apiVersion=$apiVersion"
        $resources = (Invoke-RestMethod -Uri $resUri -Method Get -Headers $vraHeaders).content
        foreach ($res in $resources) {
            $specLine = "  -> Resource: $($res.name) ($($res.type)) | IP: $($res.properties.address)"
            Write-Host $specLine -ForegroundColor Cyan
            $specLine | Add-Content $outputLog
        }
    } catch { "  -> Resource details purged." | Add-Content $outputLog }

    # 2. Grab GUI History (Matches your Image)
    try {
        $reqUri = "https://$vraServer/deployment/api/deployments/$($dep.id)/requests?apiVersion=$apiVersion"
        $requests = (Invoke-RestMethod -Uri $reqUri -Method Get -Headers $vraHeaders).content
        
        foreach ($req in $requests) {
            $reqLine = "  [HISTORY] Action: $($req.name) | ID: $($req.id) | Requested By: $($req.requestedBy)"
            Write-Host $reqLine -ForegroundColor Yellow
            $reqLine | Add-Content $outputLog

            # 3. Grab the specific Events inside that History item
            try {
                $eventUri = "https://$vraServer/deployment/api/requests/$($req.id)/events?apiVersion=$apiVersion"
                $events = (Invoke-RestMethod -Uri $eventUri -Method Get -Headers $vraHeaders).content
                foreach ($evt in $events) {
                    # This captures 'Cloud.vSphere.Network', 'DELETE_FINISHED', etc.
                    $evtLine = "    - $($evt.timestamp) | $($evt.status) | $($evt.resourceType) | $($evt.message)"
                    Write-Host $evtLine -ForegroundColor DarkGray
                    $evtLine | Add-Content $outputLog
                }
            } catch { "    - Events purged." | Add-Content $outputLog }
        }
    } catch { "  [HISTORY] Request history purged." | Add-Content $outputLog }
}

Write-Host "`nComplete! Check $outputLog" -ForegroundColor Green
