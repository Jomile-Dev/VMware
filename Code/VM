# vRA Deleted Deployments - Using Deployment API Only
# Working with APIs that are actually accessible

# Configuration
$vraServer = "vra1.yourdomain.com"
$daysBack = 7  # Look back 7 days

# FILTER CONFIGURATION
$filterTemplateNames = @("Virtual Machine", "Database")

# Output
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputJson = "C:\Logs\DeletedDeployments_$timestamp.json"
$outputLog = "C:\Logs\DeletedDeployments_$timestamp.log"
$outputCsv = "C:\Logs\DeletedDeployments_$timestamp.csv"

function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] [$Level] $Message"
    
    $color = switch ($Level) {
        "ERROR" { "Red" }
        "WARN" { "Yellow" }
        "SUCCESS" { "Green" }
        default { "Cyan" }
    }
    
    Write-Host $logMessage -ForegroundColor $color
    Add-Content -Path $outputLog -Value $logMessage
}

function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type @"
using System.Net;
using System.Security.Cryptography.X509Certificates;
public class TrustAllCertsPolicy : ICertificatePolicy {
    public bool CheckValidationResult(
        ServicePoint svcPoint, X509Certificate certificate,
        WebRequest request, int certificateProblem) {
        return true;
    }
}
"@
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
}

Write-Log "===== vRA Deleted Deployments - Deployment API Approach =====" "SUCCESS"
Write-Log "Looking for deployments deleted in the past $daysBack days" "INFO"
Disable-SSLValidation

# Ensure log directory exists
$logDir = Split-Path $outputJson -Parent
if (!(Test-Path $logDir)) {
    New-Item -ItemType Directory -Path $logDir -Force | Out-Null
}

# Get credentials
Write-Log "`nRequesting credentials..."
$credential = Get-Credential -Message "Enter credentials for vRA"
if (-not $credential) {
    Write-Log "Credentials not provided. Exiting." "ERROR"
    exit
}
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

# Authenticate to vRA
Write-Log "Authenticating to vRA: $vraServer"
try {
    $vraAuthUri = "https://$vraServer/csp/gateway/am/api/login"
    $vraAuthBody = @{
        username = $username
        password = $password
    } | ConvertTo-Json
    
    $vraAuthHeaders = @{
        "Content-Type" = "application/json"
        "Accept" = "application/json"
    }
    
    $vraAuthResponse = Invoke-RestMethod -Uri $vraAuthUri -Method Post -Headers $vraAuthHeaders -Body $vraAuthBody -ErrorAction Stop
    $vraToken = $vraAuthResponse.cspAuthToken
    Write-Log "Authenticated to vRA successfully" "SUCCESS"
}
catch {
    Write-Log "Failed to authenticate to vRA: $($_.Exception.Message)" "ERROR"
    exit
}

$vraHeaders = @{
    "Authorization" = "Bearer $vraToken"
    "Content-Type" = "application/json"
    "Accept" = "application/json"
}

$cutoffDate = (Get-Date).AddDays(-$daysBack)
$deletedDeploymentDetails = @()

# ===== Try different query parameters to find deleted deployments =====
Write-Log "`n===== Testing Deployment API Queries =====" "SUCCESS"

$queryVariations = @(
    @{
        Name = "Basic Query"
        Uri = "https://$vraServer/deployment/api/deployments?`$top=5"
    },
    @{
        Name = "With Expand"
        Uri = "https://$vraServer/deployment/api/deployments?`$top=5&`$expand=*"
    },
    @{
        Name = "Filter by Status DELETED"
        Uri = "https://$vraServer/deployment/api/deployments?`$filter=status eq 'DELETED'"
    },
    @{
        Name = "Filter by Status DELETE_SUCCESSFUL"
        Uri = "https://$vraServer/deployment/api/deployments?`$filter=status eq 'DELETE_SUCCESSFUL'"
    },
    @{
        Name = "Filter by Status ARCHIVED"
        Uri = "https://$vraServer/deployment/api/deployments?`$filter=status eq 'ARCHIVED'"
    },
    @{
        Name = "Include Deleted Parameter"
        Uri = "https://$vraServer/deployment/api/deployments?includeDeleted=true&`$top=5"
    },
    @{
        Name = "Show Deleted Parameter"
        Uri = "https://$vraServer/deployment/api/deployments?showDeleted=true&`$top=5"
    },
    @{
        Name = "Deleted Parameter"
        Uri = "https://$vraServer/deployment/api/deployments?deleted=true&`$top=5"
    }
)

$workingQuery = $null

foreach ($query in $queryVariations) {
    Write-Log "`nTesting: $($query.Name)"
    Write-Log "  URI: $($query.Uri)"
    
    try {
        $response = Invoke-RestMethod -Uri $query.Uri -Method Get -Headers $vraHeaders -ErrorAction Stop
        $deployments = if ($response.content) { $response.content } else { $response }
        
        Write-Log "  SUCCESS - Retrieved $($deployments.Count) deployments" "SUCCESS"
        
        if ($deployments.Count -gt 0) {
            Write-Log "`n  Sample deployment structure:"
            $sample = $deployments[0]
            $sample.PSObject.Properties | ForEach-Object {
                if ($_.Value -is [string] -or $_.Value -is [int] -or $_.Value -is [bool] -or $null -eq $_.Value) {
                    Write-Log "    $($_.Name) = $($_.Value)"
                }
            }
            
            # Check if this query returns deleted deployments
            $hasDeletedStatus = $deployments | Where-Object { 
                $_.status -match "DELETE" -or $_.status -eq "ARCHIVED" 
            }
            
            if ($hasDeletedStatus) {
                Write-Log "  >>> This query returns DELETED deployments! <<<" "SUCCESS"
                $workingQuery = $query
                break
            }
        }
    }
    catch {
        $statusCode = $_.Exception.Response.StatusCode.value__
        Write-Log "  FAILED - Status: $statusCode - $($_.Exception.Message)" "WARN"
    }
}

# If we found a working query, use it to get all deleted deployments
if ($workingQuery) {
    Write-Log "`n===== Using Working Query: $($workingQuery.Name) =====" "SUCCESS"
    
    # Modify URI to get more results
    $finalUri = $workingQuery.Uri -replace '\$top=\d+', '$top=1000'
    Write-Log "Final query: $finalUri"
    
    try {
        $response = Invoke-RestMethod -Uri $finalUri -Method Get -Headers $vraHeaders -ErrorAction Stop
        $allDeployments = if ($response.content) { $response.content } else { $response }
        
        Write-Log "Retrieved $($allDeployments.Count) total deployments" "SUCCESS"
        
        # Filter for deleted deployments within time range
        $deletedDeployments = $allDeployments | Where-Object {
            $isDeleted = (
                $_.status -match "DELETE" -or 
                $_.status -eq "ARCHIVED" -or
                $_.status -eq "DESTROY"
            )
            
            $withinTimeRange = $true
            if ($_.lastUpdatedAt) {
                try {
                    $updateDate = [DateTime]$_.lastUpdatedAt
                    $withinTimeRange = ($updateDate -ge $cutoffDate)
                } catch {}
            }
            
            $isDeleted -and $withinTimeRange
        }
        
        Write-Log "Found $($deletedDeployments.Count) deleted deployments in time range" "SUCCESS"
        
        foreach ($dep in $deletedDeployments) {
            Write-Log "`n========================================" "SUCCESS"
            Write-Log "Deleted Deployment Found" "SUCCESS"
            Write-Log "========================================" "SUCCESS"
            Write-Log "Name: $($dep.name)"
            Write-Log "ID: $($dep.id)"
            Write-Log "Status: $($dep.status)"
            Write-Log "Owner: $($dep.ownedBy)"
            Write-Log "Last Updated: $($dep.lastUpdatedAt)"
            Write-Log "Last Updated By: $($dep.lastUpdatedBy)"
            
            # Try to get blueprint/catalog item name
            $templateName = $null
            if ($dep.blueprintId) {
                Write-Log "Blueprint ID: $($dep.blueprintId)"
                try {
                    $bpUri = "https://$vraServer/blueprint/api/blueprints/$($dep.blueprintId)"
                    $bp = Invoke-RestMethod -Uri $bpUri -Method Get -Headers $vraHeaders -ErrorAction Stop
                    $templateName = $bp.name
                    Write-Log "Blueprint Name: $templateName" "SUCCESS"
                } catch {
                    Write-Log "Could not resolve blueprint name" "WARN"
                }
            }
            
            if ($dep.catalogItemId) {
                Write-Log "Catalog Item ID: $($dep.catalogItemId)"
                try {
                    $catUri = "https://$vraServer/catalog/api/items/$($dep.catalogItemId)"
                    $cat = Invoke-RestMethod -Uri $catUri -Method Get -Headers $vraHeaders -ErrorAction Stop
                    $templateName = $cat.name
                    Write-Log "Catalog Item Name: $templateName" "SUCCESS"
                } catch {
                    Write-Log "Could not resolve catalog item name" "WARN"
                }
            }
            
            # Apply template filter
            $matchesFilter = $false
            if ($templateName) {
                foreach ($filterName in $filterTemplateNames) {
                    if ($templateName -match $filterName) {
                        $matchesFilter = $true
                        Write-Log ">>> MATCHES FILTER: '$filterName' <<<" "SUCCESS"
                        break
                    }
                }
            } else {
                # If we can't determine template name, include it anyway
                Write-Log "Template name unknown - including in results" "WARN"
                $matchesFilter = $true
            }
            
            if (-not $matchesFilter) {
                Write-Log "Skipping: Template '$templateName' doesn't match filter" "WARN"
                continue
            }
            
            $deleteInfo = [PSCustomObject]@{
                DeploymentId = $dep.id
                DeploymentName = $dep.name
                Status = $dep.status
                TemplateName = $templateName
                BlueprintId = $dep.blueprintId
                CatalogItemId = $dep.catalogItemId
                Owner = $dep.ownedBy
                ProjectId = $dep.projectId
                OrgId = $dep.orgId
                LastUpdatedAt = $dep.lastUpdatedAt
                LastUpdatedBy = $dep.lastUpdatedBy
                CreatedAt = $dep.createdAt
                CreatedBy = $dep.createdBy
                FullDeployment = $dep
            }
            
            $deletedDeploymentDetails += $deleteInfo
        }
    }
    catch {
        Write-Log "Error querying deployments: $($_.Exception.Message)" "ERROR"
    }
}
else {
    Write-Log "`n===== NO WORKING QUERY FOUND =====" "ERROR"
    Write-Log "None of the tested query variations returned deleted deployments." "ERROR"
    Write-Log "`nThis means:" "WARN"
    Write-Log "  1. vRA may not expose deleted deployments via the API" "WARN"
    Write-Log "  2. Deleted deployments may be permanently removed from the database" "WARN"
    Write-Log "  3. Your vRA version may not support querying deleted deployments" "WARN"
    Write-Log "`nAlternative approaches:" "WARN"
    Write-Log "  - Check vRealize Log Insight for deletion logs" "WARN"
    Write-Log "  - Query the vRA Postgres database directly (requires DB access)" "WARN"
    Write-Log "  - Use vRealize Orchestrator to track deletions prospectively" "WARN"
    Write-Log "  - Enable external logging/monitoring before deletions occur" "WARN"
}

# ===== Summary and Export =====
Write-Log "`n============================================" "SUCCESS"
Write-Log "===== SUMMARY =====" "SUCCESS"
Write-Log "============================================" "SUCCESS"
Write-Log "Total deleted deployments found: $($deletedDeploymentDetails.Count)" "SUCCESS"

if ($deletedDeploymentDetails.Count -gt 0) {
    # Export full JSON
    $deletedDeploymentDetails | ConvertTo-Json -Depth 20 | Out-File -FilePath $outputJson -Encoding UTF8
    Write-Log "Full JSON exported to: $outputJson" "SUCCESS"
    
    # Export CSV
    $deletedDeploymentDetails | Select-Object DeploymentName, TemplateName, Status, Owner, 
        LastUpdatedBy, LastUpdatedAt, CreatedAt |
        Export-Csv -Path $outputCsv -NoTypeInformation -Encoding UTF8
    Write-Log "CSV summary exported to: $outputCsv" "SUCCESS"
    
    # Display summary table
    Write-Log "`n=== DELETED DEPLOYMENTS ===" "SUCCESS"
    $deletedDeploymentDetails | ForEach-Object {
        Write-Log "`n$($_.DeploymentName)" "SUCCESS"
        Write-Log "  Template: $($_.TemplateName)"
        Write-Log "  Status: $($_.Status)"
        Write-Log "  Owner: $($_.Owner)"
        Write-Log "  Deleted: $($_.LastUpdatedAt) by $($_.LastUpdatedBy)"
    }
}
else {
    Write-Log "`nNO DELETED DEPLOYMENTS FOUND!" "WARN"
}

Write-Log "`n===== Script Completed =====" "SUCCESS"
Write-Log "Log file: $outputLog"
