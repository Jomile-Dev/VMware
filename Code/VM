# vRA Deleted Requests Data Explorer
# This script fetches and displays detailed information about deleted deployment requests

# Configuration
$vraServer = "vra1.yourdomain.com"
$daysBack = 1

# Output
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputJson = "C:\Logs\DeletedRequests_$timestamp.json"
$outputLog = "C:\Logs\DeletedRequests_$timestamp.log"

function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] [$Level] $Message"
    
    $color = switch ($Level) {
        "ERROR" { "Red" }
        "WARN" { "Yellow" }
        "SUCCESS" { "Green" }
        default { "Cyan" }
    }
    
    Write-Host $logMessage -ForegroundColor $color
    Add-Content -Path $outputLog -Value $logMessage
}

function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type @"
using System.Net;
using System.Security.Cryptography.X509Certificates;
public class TrustAllCertsPolicy : ICertificatePolicy {
    public bool CheckValidationResult(
        ServicePoint svcPoint, X509Certificate certificate,
        WebRequest request, int certificateProblem) {
        return true;
    }
}
"@
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
}

Write-Log "===== vRA Deleted Requests Explorer Started =====" "SUCCESS"
Disable-SSLValidation

# Ensure log directory exists
$logDir = Split-Path $outputJson -Parent
if (!(Test-Path $logDir)) {
    New-Item -ItemType Directory -Path $logDir -Force | Out-Null
}

# Get credentials
Write-Log "Requesting credentials..."
$credential = Get-Credential -Message "Enter credentials for vRA"
if (-not $credential) {
    Write-Log "Credentials not provided. Exiting." "ERROR"
    exit
}
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

# Authenticate to vRA
Write-Log "Authenticating to vRA: $vraServer"
try {
    $vraAuthUri = "https://$vraServer/csp/gateway/am/api/login"
    $vraAuthBody = @{
        username = $username
        password = $password
    } | ConvertTo-Json
    
    $vraAuthHeaders = @{
        "Content-Type" = "application/json"
        "Accept" = "application/json"
    }
    
    $vraAuthResponse = Invoke-RestMethod -Uri $vraAuthUri -Method Post -Headers $vraAuthHeaders -Body $vraAuthBody -ErrorAction Stop
    $vraToken = $vraAuthResponse.cspAuthToken
    Write-Log "Authenticated to vRA successfully" "SUCCESS"
}
catch {
    Write-Log "Failed to authenticate to vRA: $($_.Exception.Message)" "ERROR"
    exit
}

$vraHeaders = @{
    "Authorization" = "Bearer $vraToken"
    "Content-Type" = "application/json"
}

# Fetch deleted deployment requests
Write-Log "`n===== Fetching DELETE_DEPLOYMENT Requests ====="
$requestsUri = "https://$vraServer/request/api/requests"
$cutoffDate = (Get-Date).AddDays(-$daysBack)
Write-Log "Looking for DELETE_DEPLOYMENT requests from: $cutoffDate"
Write-Log "Request API URL: $requestsUri"

$allDeleteRequests = @()
$page = 0
$size = 200

try {
    do {
        # Use $filter for type eq 'DELETE_DEPLOYMENT'
        $pagedUri = "$requestsUri`?`$filter=type eq 'DELETE_DEPLOYMENT'&`$skip=$($page * $size)&`$top=$size"
        Write-Log "Fetching DELETE_DEPLOYMENT requests page $($page + 1)..."
        Write-Log "  Full URL: $pagedUri"
        
        $response = Invoke-RestMethod -Uri $pagedUri -Method Get -Headers $vraHeaders -ErrorAction Stop
        
        if ($response.content) {
            $requests = $response.content
        }
        elseif ($response.value) {
            $requests = $response.value
        }
        else {
            $requests = $response
        }
        
        Write-Log "  Retrieved $($requests.Count) DELETE_DEPLOYMENT requests on page $($page + 1)" "SUCCESS"
        
        if ($requests.Count -eq 0) {
            Write-Log "  No requests found, stopping pagination"
            break
        }
        
        # Process each request
        foreach ($req in $requests) {
            Write-Log "`n  Processing DELETE_DEPLOYMENT request:"
            Write-Log "    Request ID: $($req.id)"
            Write-Log "    Name: $($req.name)"
            Write-Log "    Type: $($req.type)"
            Write-Log "    Status: $($req.status)"
            Write-Log "    Requested By: $($req.requestedBy)"
            Write-Log "    Created At: $($req.createdAt)"
            Write-Log "    Updated At: $($req.updatedAt)"
            
            # Check if within time range
            if ($req.createdAt) {
                $createdAt = [DateTime]$req.createdAt
                
                if ($createdAt -ge $cutoffDate) {
                    Write-Log "    >> Within time range (last $daysBack days)" "SUCCESS"
                    
                    # Show all properties
                    Write-Log "    All Request Properties:"
                    $req | Get-Member -MemberType NoteProperty | ForEach-Object {
                        $propName = $_.Name
                        $propValue = $req.$propName
                        if ($propValue -is [string] -or $propValue -is [int] -or $propValue -is [bool]) {
                            Write-Log "      - $propName = $propValue"
                        }
                        else {
                            Write-Log "      - $propName = [Complex Object]"
                        }
                    }
                    
                    # Check for outputs (VM details might be here)
                    if ($req.outputs) {
                        Write-Log "    Outputs:"
                        $req.outputs | Get-Member -MemberType NoteProperty | ForEach-Object {
                            $propName = $_.Name
                            $propValue = $req.outputs.$propName
                            Write-Log "      - $propName = $propValue"
                        }
                    }
                    
                    # Check for details
                    if ($req.details) {
                        Write-Log "    Details:"
                        $req.details | Get-Member -MemberType NoteProperty | ForEach-Object {
                            $propName = $_.Name
                            $propValue = $req.details.$propName
                            Write-Log "      - $propName = $propValue"
                        }
                    }
                    
                    # Check for resources
                    if ($req.resources) {
                        Write-Log "    Resources: $($req.resources.Count)"
                        foreach ($res in $req.resources) {
                            Write-Log "      Resource:"
                            $res | Get-Member -MemberType NoteProperty | ForEach-Object {
                                $propName = $_.Name
                                $propValue = $res.$propName
                                Write-Log "        - $propName = $propValue"
                            }
                        }
                    }
                    
                    # Check for blueprint
                    if ($req.blueprint) {
                        Write-Log "    Blueprint: $($req.blueprint)"
                    }
                    
                    # Check for catalog item
                    if ($req.catalogItemId) {
                        Write-Log "    Catalog Item ID: $($req.catalogItemId)"
                    }
                    
                    if ($req.catalogItemName) {
                        Write-Log "    Catalog Item Name: $($req.catalogItemName)"
                    }
                    
                    $allDeleteRequests += $req
                }
                else {
                    Write-Log "    >> Too old - before cutoff date" "WARN"
                }
            }
        }
        
        $page++
        
        # Check if more pages available
        $hasMore = ($requests.Count -eq $size)
        
        if ($hasMore) {
            Write-Log "  More pages available, continuing..."
        }
        else {
            Write-Log "  No more pages to fetch"
        }
        
    } while ($hasMore)
    
    Write-Log "`n===== Summary =====" "SUCCESS"
    Write-Log "Total DELETE_DEPLOYMENT requests found: $($allDeleteRequests.Count)" "SUCCESS"
    
    # Export to JSON for detailed inspection
    $allDeleteRequests | ConvertTo-Json -Depth 10 | Out-File -FilePath $outputJson -Encoding UTF8
    Write-Log "Detailed data exported to: $outputJson" "SUCCESS"
    
    if ($allDeleteRequests.Count -eq 0) {
        Write-Log "No DELETE_DEPLOYMENT requests found in the last $daysBack day(s)" "WARN"
        Write-Log "Try increasing `$daysBack or check if there are actually any deleted deployments" "WARN"
    }
}
catch {
    Write-Log "Error fetching requests: $($_.Exception.Message)" "ERROR"
    Write-Log "Error details: $($_.Exception)" "ERROR"
}

Write-Log "`n===== Script Completed =====" "SUCCESS"
Write-Log "DELETE requests JSON: $outputJson"
Write-Log "Log file: $outputLog"
