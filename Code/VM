# vRA 8.18 API Diagnostic & Troubleshooting Tool
# Purpose: Isolate exactly which part of the query causes the 400/404 Error.

# --- Configuration ---
$vraServer = "vra1.yourdomain.com"
$credential = Get-Credential -Message "vRA Admin Credentials"

# --- Setup & Auth (Standard) ---
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
    Add-Type "using System.Net; using System.Security.Cryptography.X509Certificates; public class TrustAllCertsPolicy : ICertificatePolicy { public bool CheckValidationResult(ServicePoint svcPoint, X509Certificate certificate, WebRequest request, int certificateProblem) { return true; } }"
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
}

Write-Host "--- TEST 1: Authentication ---" -ForegroundColor Cyan
try {
    $authBody = @{ username = $credential.UserName; password = $credential.GetNetworkCredential().Password } | ConvertTo-Json
    $authRes = Invoke-RestMethod -Uri "https://$vraServer/csp/gateway/am/api/login" -Method Post -Headers @{"Content-Type"="application/json"} -Body $authBody
    $token = $authRes.cspAuthToken
    $headers = @{ "Authorization" = "Bearer $token"; "Content-Type" = "application/json" }
    Write-Host "PASS: Authentication successful." -ForegroundColor Green
} catch {
    Write-Host "FAIL: Auth failed. Message: $($_.Exception.Message)" -ForegroundColor Red; exit
}

# --- TEST 2: Basic Connectivity (No Filters) ---
# Does the endpoint even exist in vRA 8.18?
Write-Host "`n--- TEST 2: Raw Endpoint Check (No Filters) ---" -ForegroundColor Cyan
$uri2 = "https://$vraServer/deployment/api/requests?apiVersion=2020-08-25&`$top=1"
try {
    Write-Host "Hitting: $uri2" -ForegroundColor Gray
    $res2 = Invoke-RestMethod -Uri $uri2 -Method Get -Headers $headers
    if ($res2.content.Count -ge 0) { Write-Host "PASS: Endpoint exists and returns data." -ForegroundColor Green }
} catch {
    Write-Host "FAIL: Endpoint dead or moved. Status: $($_.Exception.Message)" -ForegroundColor Red
}

# --- TEST 3: Simple Filter (Action ID) ---
# Testing if 'actionId' is the valid field name in 8.18
Write-Host "`n--- TEST 3: Filtering by Action ID ---" -ForegroundColor Cyan
$uri3 = "https://$vraServer/deployment/api/requests?apiVersion=2020-08-25&`$filter=actionId eq 'Deployment.Delete'"
try {
    Write-Host "Hitting: $uri3" -ForegroundColor Gray
    $res3 = Invoke-RestMethod -Uri $uri3 -Method Get -Headers $headers
    Write-Host "PASS: Filter syntax 'actionId' is VALID. Found $($res3.content.Count) items." -ForegroundColor Green
} catch {
    Write-Host "FAIL: 'actionId' filter rejected. vRA 8.18 might use 'name' or 'blueprintId' instead here. Error: $($_.Exception.Message)" -ForegroundColor Red
}

# --- TEST 4: Date Filter Syntax ---
# OData date filters are the #1 cause of 400 Bad Requests
Write-Host "`n--- TEST 4: Date Filter Check ---" -ForegroundColor Cyan
$dateStr = (Get-Date).AddDays(-1).ToString("yyyy-MM-dd")
# Try simplified date format first
$uri4 = "https://$vraServer/deployment/api/requests?apiVersion=2020-08-25&`$filter=createdAt ge '$dateStr'"
try {
    Write-Host "Hitting: $uri4" -ForegroundColor Gray
    $res4 = Invoke-RestMethod -Uri $uri4 -Method Get -Headers $headers
    Write-Host "PASS: Date filter syntax is valid." -ForegroundColor Green
} catch {
    Write-Host "FAIL: Date syntax rejected. Error: $($_.Exception.Message)" -ForegroundColor Red
    Write-Host "Troubleshoot: Try using full ISO format (yyyy-MM-ddTHH:mm:ss.000Z) or check if field is 'requestedAt' instead of 'createdAt'." -ForegroundColor Yellow
}

# --- TEST 5: The "All-In" Query (Combining them) ---
Write-Host "`n--- TEST 5: Combined Query (The one that was failing) ---" -ForegroundColor Cyan
$uri5 = "https://$vraServer/deployment/api/requests?apiVersion=2020-08-25&`$filter=(actionId eq 'Deployment.Delete') and (createdAt ge '$dateStr')"
try {
    Write-Host "Hitting: $uri5" -ForegroundColor Gray
    $res5 = Invoke-RestMethod -Uri $uri5 -Method Get -Headers $headers
    Write-Host "PASS: Combined query works!" -ForegroundColor Green
} catch {
    Write-Host "FAIL: Combined query failed. It's likely the 'and' operator or parentheses spacing." -ForegroundColor Red
    Write-Host "Error Details: $($_.Exception.Response.GetResponseStream() | %{ $_.ReadToEnd() })" -ForegroundColor Yellow
}
