# VMware vRA - Get All Deleted Deployments
# Simple script to retrieve all deleted deployments with full details

# Configuration
$vraServer = "vra1.yourdomain.com"

# Output files
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputCsv = "C:\Logs\vRA_DeletedDeployments_$timestamp.csv"
$outputJson = "C:\Logs\vRA_DeletedDeployments_$timestamp.json"
$outputLog = "C:\Logs\vRA_DeletedDeployments_$timestamp.log"

function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    $logTimestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$logTimestamp] [$Level] $Message"
    
    $color = switch ($Level) {
        "ERROR" { "Red" }
        "WARN" { "Yellow" }
        "SUCCESS" { "Green" }
        default { "White" }
    }
    
    Write-Host $logMessage -ForegroundColor $color
    Add-Content -Path $outputLog -Value $logMessage -ErrorAction SilentlyContinue
}

function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type @"
using System.Net;
using System.Security.Cryptography.X509Certificates;
public class TrustAllCertsPolicy : ICertificatePolicy {
    public bool CheckValidationResult(
        ServicePoint svcPoint, X509Certificate certificate,
        WebRequest request, int certificateProblem) {
        return true;
    }
}
"@
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
}

Write-Log "===== vRA Deleted Deployments Report =====" "SUCCESS"
Disable-SSLValidation

# Ensure output directory exists
$logDir = Split-Path $outputLog -Parent
if (!(Test-Path $logDir)) {
    New-Item -ItemType Directory -Path $logDir -Force | Out-Null
}

# Get credentials
Write-Log "Requesting credentials for vRA..."
$credential = Get-Credential -Message "Enter vRA credentials"
if (-not $credential) {
    Write-Log "No credentials provided. Exiting." "ERROR"
    exit
}

# Authenticate
Write-Log "Authenticating to vRA: $vraServer"
try {
    $authBody = @{
        username = $credential.UserName
        password = $credential.GetNetworkCredential().Password
    } | ConvertTo-Json
    
    $authResponse = Invoke-RestMethod `
        -Uri "https://$vraServer/csp/gateway/am/api/login" `
        -Method Post `
        -Headers @{"Content-Type"="application/json"} `
        -Body $authBody `
        -ErrorAction Stop
    
    $headers = @{
        "Authorization" = "Bearer $($authResponse.cspAuthToken)"
        "Content-Type" = "application/json"
        "Accept" = "application/json"
    }
    
    Write-Log "Authentication successful" "SUCCESS"
}
catch {
    Write-Log "Authentication failed: $($_.Exception.Message)" "ERROR"
    exit
}

# Fetch all deployments
Write-Log "`nFetching all deployments from vRA..."
$allDeployments = @()
$pageSize = 200
$skip = 0

try {
    do {
        $uri = "https://$vraServer/deployment/api/deployments?`$top=$pageSize&`$skip=$skip"
        Write-Log "Fetching page (skip=$skip, size=$pageSize)..."
        
        $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $headers -ErrorAction Stop
        $deployments = if ($response.content) { $response.content } else { $response }
        
        if ($deployments.Count -gt 0) {
            $allDeployments += $deployments
            Write-Log "  Retrieved $($deployments.Count) deployments (Total: $($allDeployments.Count))"
            $skip += $pageSize
        }
        else {
            break
        }
        
        # Safety limit
        if ($allDeployments.Count -ge 10000) {
            Write-Log "  Reached safety limit of 10000 deployments" "WARN"
            break
        }
        
    } while ($deployments.Count -eq $pageSize)
    
    Write-Log "Total deployments fetched: $($allDeployments.Count)" "SUCCESS"
}
catch {
    Write-Log "Error fetching deployments: $($_.Exception.Message)" "ERROR"
    exit
}

# Identify deleted deployments
Write-Log "`nIdentifying deleted deployments..."

$deletedDeployments = @()

foreach ($dep in $allDeployments) {
    $isDeleted = $false
    
    # Check various deletion indicators
    if ($dep.status -match "delete|destroy|removed|terminated|archived") {
        $isDeleted = $true
    }
    
    if ($dep.deleted -eq $true -or $dep.isDeleted -eq $true) {
        $isDeleted = $true
    }
    
    if ($dep.deletedAt -or $dep.destroyedAt -or $dep.terminatedAt) {
        $isDeleted = $true
    }
    
    if ($isDeleted) {
        $deletedDeployments += $dep
    }
}

Write-Log "Found $($deletedDeployments.Count) deleted deployments" "SUCCESS"

if ($deletedDeployments.Count -eq 0) {
    Write-Log "`nNo deleted deployments found!" "WARN"
    Write-Log "This could mean:" "WARN"
    Write-Log "  - No deployments have been deleted" "WARN"
    Write-Log "  - Deleted deployments are purged from the system" "WARN"
    Write-Log "  - Your user lacks permissions to see deleted deployments" "WARN"
    exit
}

# Process and export results
Write-Log "`nProcessing deleted deployment details..."

$results = @()

foreach ($dep in $deletedDeployments) {
    Write-Log "  Processing: $($dep.name)"
    
    # Get all properties
    $result = [PSCustomObject]@{
        Name = $dep.name
        Id = $dep.id
        Status = $dep.status
        Owner = $dep.ownedBy
        CreatedBy = $dep.createdBy
        CreatedAt = $dep.createdAt
        LastUpdatedBy = $dep.lastUpdatedBy
        LastUpdatedAt = $dep.lastUpdatedAt
        DeletedAt = $null
        DeletedBy = $null
        ProjectId = $dep.projectId
        ProjectName = $dep.projectName
        OrgId = $dep.orgId
        BlueprintId = $dep.blueprintId
        BlueprintName = $null
        CatalogItemId = $dep.catalogItemId
        CatalogItemName = $null
        Description = $dep.description
        LeaseExpireAt = $dep.leaseExpireAt
    }
    
    # Get deletion info
    if ($dep.deletedAt) {
        $result.DeletedAt = $dep.deletedAt
    }
    elseif ($dep.destroyedAt) {
        $result.DeletedAt = $dep.destroyedAt
    }
    elseif ($dep.terminatedAt) {
        $result.DeletedAt = $dep.terminatedAt
    }
    
    if ($dep.deletedBy) {
        $result.DeletedBy = $dep.deletedBy
    }
    
    # Try to get blueprint name
    if ($dep.blueprintId) {
        try {
            $bpResponse = Invoke-RestMethod `
                -Uri "https://$vraServer/blueprint/api/blueprints/$($dep.blueprintId)" `
                -Method Get `
                -Headers $headers `
                -ErrorAction Stop
            $result.BlueprintName = $bpResponse.name
        }
        catch {
            # Blueprint might be deleted
        }
    }
    
    # Try to get catalog item name
    if ($dep.catalogItemId) {
        try {
            $catResponse = Invoke-RestMethod `
                -Uri "https://$vraServer/catalog/api/items/$($dep.catalogItemId)" `
                -Method Get `
                -Headers $headers `
                -ErrorAction Stop
            $result.CatalogItemName = $catResponse.name
        }
        catch {
            # Catalog item might be deleted
        }
    }
    
    $results += $result
}

# Export to CSV
Write-Log "`nExporting results..."
$results | Export-Csv -Path $outputCsv -NoTypeInformation -Encoding UTF8
Write-Log "CSV exported to: $outputCsv" "SUCCESS"

# Export to JSON (full details)
$deletedDeployments | ConvertTo-Json -Depth 10 | Out-File -FilePath $outputJson -Encoding UTF8
Write-Log "JSON (full details) exported to: $outputJson" "SUCCESS"

# Display summary
Write-Log "`n============================================" "SUCCESS"
Write-Log "SUMMARY OF DELETED DEPLOYMENTS" "SUCCESS"
Write-Log "============================================" "SUCCESS"
Write-Log "Total deleted deployments: $($results.Count)" "SUCCESS"

Write-Log "`nRecent deletions:"
$results | Sort-Object DeletedAt -Descending | Select-Object -First 10 | ForEach-Object {
    Write-Log "`n  Name: $($_.Name)"
    Write-Log "    Status: $($_.Status)"
    Write-Log "    Deleted At: $($_.DeletedAt)"
    Write-Log "    Deleted By: $($_.DeletedBy)"
    Write-Log "    Owner: $($_.Owner)"
    Write-Log "    Blueprint: $($_.BlueprintName)"
    Write-Log "    Catalog Item: $($_.CatalogItemName)"
}

Write-Log "`n===== Script Complete =====" "SUCCESS"
Write-Log "Log file: $outputLog"
