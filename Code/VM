# vRA "Last Resort" History Finder
# Bypasses server-side filtering to avoid 400/404 errors.

# Configuration
$vraServer = "vra1.yourdomain.com"
$daysBack = 30
$apiVersion = "2020-08-25"
$filterKeywords = @("Virtual Machine", "Database")

# Output
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputCsv = "C:\Logs\vRA_Final_History_$timestamp.csv"

# --- Setup & Auth ---
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type "using System.Net; using System.Security.Cryptography.X509Certificates; public class TrustAllCertsPolicy : ICertificatePolicy { public bool CheckValidationResult(ServicePoint svcPoint, X509Certificate certificate, WebRequest request, int certificateProblem) { return true; } }"
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
}
Disable-SSLValidation

$credential = Get-Credential -Message "Enter vRA Credentials"
$authBody = @{ username = $credential.UserName; password = $credential.GetNetworkCredential().Password } | ConvertTo-Json
$authRes = Invoke-RestMethod -Uri "https://$vraServer/csp/gateway/am/api/login" -Method Post -Headers @{"Content-Type"="application/json"} -Body $authBody
$vraHeaders = @{ "Authorization" = "Bearer $($authRes.cspAuthToken)"; "Content-Type" = "application/json" }

# STEP 1: Get raw requests without ANY server-side filtering
Write-Host "Downloading recent requests (Unfiltered)..." -ForegroundColor Cyan
$requestUri = "https://$vraServer/deployment/api/requests?apiVersion=$apiVersion&`$top=1000"

try {
    $rawResponse = Invoke-RestMethod -Uri $requestUri -Method Get -Headers $vraHeaders
    $allRequests = $rawResponse.content
} catch {
    Write-Host "Fatal Error: Even the basic request list failed. $($_.Exception.Message)" -ForegroundColor Red
    exit
}

# STEP 2: Filter locally in PowerShell
Write-Host "Filtering $($allRequests.Count) requests locally..." -ForegroundColor Yellow
$cutoffDate = (Get-Date).AddDays(-$daysBack)
$finalResults = @()

foreach ($req in $allRequests) {
    # 1. Filter by Date
    if ($req.completedAt) {
        $compDate = [DateTime]$req.completedAt
        if ($compDate -lt $cutoffDate) { continue }
    }

    # 2. Filter by Action (Only looking for Deletes)
    if ($req.actionId -notmatch "delete" -and $req.name -notmatch "delete") { continue }

    # 3. Filter by Template/Keyword
    $isMatch = $false
    foreach ($k in $filterKeywords) {
        if ($req.deploymentName -match $k -or $req.name -match $k) { $isMatch = $true; break }
    }

    if ($isMatch) {
        Write-Host "Found: $($req.deploymentName) deleted by $($req.requestedBy)" -ForegroundColor Green
        
        $finalResults += [PSCustomObject]@{
            Date           = $req.completedAt
            DeploymentName = $req.deploymentName
            DeletedBy      = $req.requestedBy
            ActionName     = $req.name
            Status         = $req.status
            RequestID      = $req.id
        }
    }
}

# STEP 3: Export
if ($finalResults.Count -gt 0) {
    $finalResults | Export-Csv -Path $outputCsv -NoTypeInformation -Encoding UTF8
    Write-Host "SUCCESS! $outputCsv created." -ForegroundColor Green
} else {
    Write-Host "No delete requests matched your keywords in the last $daysBack days." -ForegroundColor Gray
}
