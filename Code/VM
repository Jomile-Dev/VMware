# vRA Deleted Requests Data Explorer
# This script fetches and displays detailed information about deleted deployment requests

# Configuration
$vraServer = "vra1.yourdomain.com"
$daysBack = 1

# Output
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputJson = "C:\Logs\DeletedRequests_$timestamp.json"
$outputLog = "C:\Logs\DeletedRequests_$timestamp.log"

function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] [$Level] $Message"
    
    $color = switch ($Level) {
        "ERROR" { "Red" }
        "WARN" { "Yellow" }
        "SUCCESS" { "Green" }
        default { "Cyan" }
    }
    
    Write-Host $logMessage -ForegroundColor $color
    Add-Content -Path $outputLog -Value $logMessage
}

function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type @"
using System.Net;
using System.Security.Cryptography.X509Certificates;
public class TrustAllCertsPolicy : ICertificatePolicy {
    public bool CheckValidationResult(
        ServicePoint svcPoint, X509Certificate certificate,
        WebRequest request, int certificateProblem) {
        return true;
    }
}
"@
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
}

Write-Log "===== vRA Deleted Requests Explorer Started =====" "SUCCESS"
Disable-SSLValidation

# Ensure log directory exists
$logDir = Split-Path $outputJson -Parent
if (!(Test-Path $logDir)) {
    New-Item -ItemType Directory -Path $logDir -Force | Out-Null
}

# Get credentials
Write-Log "Requesting credentials..."
$credential = Get-Credential -Message "Enter credentials for vRA"
if (-not $credential) {
    Write-Log "Credentials not provided. Exiting." "ERROR"
    exit
}
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

# Authenticate to vRA
Write-Log "Authenticating to vRA: $vraServer"
try {
    $vraAuthUri = "https://$vraServer/csp/gateway/am/api/login"
    $vraAuthBody = @{
        username = $username
        password = $password
    } | ConvertTo-Json
    
    $vraAuthHeaders = @{
        "Content-Type" = "application/json"
        "Accept" = "application/json"
    }
    
    $vraAuthResponse = Invoke-RestMethod -Uri $vraAuthUri -Method Post -Headers $vraAuthHeaders -Body $vraAuthBody -ErrorAction Stop
    $vraToken = $vraAuthResponse.cspAuthToken
    Write-Log "Authenticated to vRA successfully" "SUCCESS"
}
catch {
    Write-Log "Failed to authenticate to vRA: $($_.Exception.Message)" "ERROR"
    exit
}

$vraHeaders = @{
    "Authorization" = "Bearer $vraToken"
    "Content-Type" = "application/json"
}

# Fetch deleted deployments using the catalog/consume API
Write-Log "`n===== Fetching Deleted Deployments ====="
$deploymentsUri = "https://$vraServer/catalog/api/items"
$cutoffDate = (Get-Date).AddDays(-$daysBack)
Write-Log "Looking for deleted deployments from: $cutoffDate"

# First, let's try the deployment API with deleted filter
$deploymentApiUri = "https://$vraServer/deployment/api/deployments"
Write-Log "Deployment API URL: $deploymentApiUri"

$allDeletedDeployments = @()
$page = 0
$size = 200

# Try multiple approaches to find the right one
$apiAttempts = @(
    @{
        Name = "Deployment API with deleted=true parameter"
        Uri = "$deploymentApiUri`?deleted=true&page=$page&size=$size&expand=resources"
    },
    @{
        Name = "Deployment API with deleted filter"
        Uri = "$deploymentApiUri`?`$filter=deleted eq true&page=$page&size=$size&expand=resources"
    },
    @{
        Name = "Deployment API - fetch all and filter"
        Uri = "$deploymentApiUri`?page=$page&size=$size&expand=resources"
        FilterInCode = $true
    }
)

$successfulApi = $null

foreach ($attempt in $apiAttempts) {
    Write-Log "`n--- Trying: $($attempt.Name) ---"
    Write-Log "  URL: $($attempt.Uri)"
    
    try {
        $response = Invoke-RestMethod -Uri $attempt.Uri -Method Get -Headers $vraHeaders -ErrorAction Stop
        
        if ($response.content) {
            $deployments = $response.content
        }
        elseif ($response.value) {
            $deployments = $response.value
        }
        else {
            $deployments = $response
        }
        
        Write-Log "  SUCCESS! Retrieved $($deployments.Count) deployments" "SUCCESS"
        
        # If we need to filter in code
        if ($attempt.FilterInCode) {
            $deletedCount = ($deployments | Where-Object { $_.status -eq "DELETED" }).Count
            Write-Log "  Found $deletedCount deleted deployments in results"
        }
        else {
            Write-Log "  These should all be deleted deployments"
        }
        
        # Show sample deployment structure
        if ($deployments.Count -gt 0) {
            $sample = $deployments[0]
            Write-Log "`n  Sample Deployment Properties:"
            $sample | Get-Member -MemberType NoteProperty | ForEach-Object {
                Write-Log "    - $($_.Name)"
            }
        }
        
        $successfulApi = $attempt
        break
    }
    catch {
        Write-Log "  FAILED: $($_.Exception.Message)" "ERROR"
    }
}

if (-not $successfulApi) {
    Write-Log "`nAll API attempts failed. Cannot proceed." "ERROR"
    throw "Unable to fetch deployments from any API endpoint"
}

Write-Log "`n===== Using successful API: $($successfulApi.Name) =====" "SUCCESS"

try {
    $page = 0
    do {
        if ($successfulApi.FilterInCode) {
            $pagedUri = "$deploymentApiUri`?page=$page&size=$size&expand=resources"
        }
        else {
            $baseUri = $successfulApi.Uri -replace "page=\d+", "page=$page"
            $pagedUri = $baseUri
        }
        
        Write-Log "Fetching page $($page + 1)..."
        Write-Log "  URL: $pagedUri"
        
        $response = Invoke-RestMethod -Uri $pagedUri -Method Get -Headers $vraHeaders -ErrorAction Stop
        
        if ($response.content) {
            $deployments = $response.content
        }
        elseif ($response.value) {
            $deployments = $response.value
        }
        else {
            $deployments = $response
        }
        
        Write-Log "  Retrieved $($deployments.Count) deployments on page $($page + 1)" "SUCCESS"
        
        if ($deployments.Count -eq 0) {
            Write-Log "  No deployments found, stopping pagination"
            break
        }
        
        # Filter for deleted deployments if needed
        if ($successfulApi.FilterInCode) {
            $deployments = $deployments | Where-Object { $_.status -eq "DELETED" }
            Write-Log "  After filtering: $($deployments.Count) deleted deployments"
        }
        
        # Process each deleted deployment
        foreach ($dep in $deployments) {
            Write-Log "`n  Processing deployment:"
            Write-Log "    Name: $($dep.name)"
            Write-Log "    ID: $($dep.id)"
            Write-Log "    Status: $($dep.status)"
            Write-Log "    Last Updated: $($dep.lastUpdatedAt)"
            Write-Log "    Created By: $($dep.createdBy)"
            Write-Log "    Owned By: $($dep.ownedBy)"
            
            # Check if within time range
            if ($dep.lastUpdatedAt) {
                $lastUpdated = [DateTime]$dep.lastUpdatedAt
                
                if ($lastUpdated -ge $cutoffDate) {
                    Write-Log "    >> Within time range (last $daysBack days)" "SUCCESS"
                    
                    # Show resources
                    if ($dep.resources) {
                        Write-Log "    Resources: $($dep.resources.Count)"
                        
                        foreach ($res in $dep.resources) {
                            if ($res.type -eq "Cloud.vSphere.Machine") {
                                Write-Log "`n      Cloud.vSphere.Machine Resource:"
                                Write-Log "        Name: $($res.name)"
                                Write-Log "        ID: $($res.id)"
                                
                                if ($res.properties) {
                                    Write-Log "        Properties:"
                                    $res.properties | Get-Member -MemberType NoteProperty | ForEach-Object {
                                        $propName = $_.Name
                                        $propValue = $res.properties.$propName
                                        Write-Log "          - $propName = $propValue"
                                    }
                                }
                            }
                        }
                    }
                    
                    # Show inputs
                    if ($dep.inputs) {
                        Write-Log "    Inputs:"
                        $dep.inputs | Get-Member -MemberType NoteProperty | ForEach-Object {
                            $propName = $_.Name
                            $propValue = $dep.inputs.$propName
                            Write-Log "      - $propName = $propValue"
                        }
                    }
                    
                    # Show custom properties
                    if ($dep.customProperties) {
                        Write-Log "    Custom Properties:"
                        $dep.customProperties | Get-Member -MemberType NoteProperty | ForEach-Object {
                            $propName = $_.Name
                            $propValue = $dep.customProperties.$propName
                            Write-Log "      - $propName = $propValue"
                        }
                    }
                    
                    $allDeletedDeployments += $dep
                }
                else {
                    Write-Log "    >> Too old - before cutoff date" "WARN"
                }
            }
        }
        
        $page++
        $hasMore = $false
        
        if ($response.totalPages) { 
            $hasMore = ($page -lt $response.totalPages)
        } 
        elseif ($response.totalElements) { 
            $hasMore = (($page * $size) -lt $response.totalElements)
        } 
        else { 
            $hasMore = ($deployments.Count -eq $size)
        }
        
        if ($hasMore) {
            Write-Log "  More pages available, continuing..."
        }
        
    } while ($hasMore)
    
    Write-Log "`n===== Summary =====" "SUCCESS"
    Write-Log "Total deleted deployments found: $($allDeletedDeployments.Count)" "SUCCESS"
    
    # Export to JSON for detailed inspection
    $allDeletedDeployments | ConvertTo-Json -Depth 10 | Out-File -FilePath $outputJson -Encoding UTF8
    Write-Log "Detailed data exported to: $outputJson" "SUCCESS"
    
    if ($allDeletedDeployments.Count -eq 0) {
        Write-Log "No deleted deployments found in the last $daysBack day(s)" "WARN"
        Write-Log "Try increasing `$daysBack or check if there are actually any deleted deployments" "WARN"
    }
}
catch {
    Write-Log "Error fetching deployments: $($_.Exception.Message)" "ERROR"
    Write-Log "Error details: $($_.Exception)" "ERROR"
}

Write-Log "`n===== Script Completed =====" "SUCCESS"
Write-Log "Deleted deployments JSON: $outputJson"
Write-Log "Log file: $outputLog"
