# New Server Tracker - Aria Operations + Multi-vRA + vCenter
# PowerShell 5.1 Compatible
# Tracks servers built in the last day and sends email report

# Configuration
$ariaOpsServer = "aria-ops.yourdomain.com"
$ariaOpsDomain = "yourdomain.com"
$ariaOpsAuthSource = "localos"

$vraServers = @(
    "vra1.yourdomain.com",
    "vra2.yourdomain.com"
)

$vCenters = @(
    "vcenter1.domain.com",
    "vcenter2.domain.com",
    "vcenter3.domain.com"
)

# SMTP Configuration
$smtpServer = "smtp.yourdomain.com"
$smtpPort = 587
$smtpFrom = "vra-reports@yourdomain.com"
$smtpTo = @("admin@yourdomain.com")
$smtpCc = @("manager@yourdomain.com")
$smtpSubject = "New Server Deployment Report - $(Get-Date -Format 'yyyy-MM-dd')"

# Time range for new VMs (in days)
$daysBack = 1
$deletedDaysBack = 90
$eventsPageSize = 200

# Helper Functions
function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    
    $color = switch ($Level) {
        "ERROR" { "Red" }
        "WARN" { "Yellow" }
        "SUCCESS" { "Green" }
        default { "Cyan" }
    }
    
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    Write-Host "[$timestamp] [$Level] $Message" -ForegroundColor $color
}

function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type @"
using System.Net;
using System.Security.Cryptography.X509Certificates;
public class TrustAllCertsPolicy : ICertificatePolicy {
    public bool CheckValidationResult(
        ServicePoint svcPoint, X509Certificate certificate,
        WebRequest request, int certificateProblem) {
        return true;
    }
}
"@
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
}

function Get-DeletedDeploymentServers {
    param(
        [Parameter(Mandatory=$true)]
        [string]$VraServer,
        
        [Parameter(Mandatory=$true)]
        [hashtable]$Headers,
        
        [Parameter(Mandatory=$true)]
        [int]$DaysBack
    )
    
    Write-Log "  Searching for deleted deployments (last $DaysBack days)..."
    
    $deletedServerData = @{}
    $cutoffDate = (Get-Date).AddDays(-$DaysBack)
    $allDeletedDeployments = @()
    $page = 0
    $pageSize = 200
    
    $urlVariations = @(
        "https://$VraServer/deployment/api/deployments?deleted=true&apiVersion=2020-08-25&page={0}&size=$pageSize",
        "https://$VraServer/deployment/api/deployments?deleted=%5Btrue%5D&apiVersion=2020-08-25&page={0}&size=$pageSize"
    )
    
    $workingUrl = $null
    
    foreach ($urlTemplate in $urlVariations) {
        try {
            $testUrl = $urlTemplate -f 0
            $response = Invoke-RestMethod -Uri $testUrl -Method Get -Headers $Headers -ErrorAction Stop
            $deployments = if ($response.content) { $response.content } else { $response }
            
            if ($deployments -and $deployments.Count -gt 0) {
                $workingUrl = $urlTemplate
                $allDeletedDeployments += $deployments
                break
            }
        }
        catch {
            continue
        }
    }
    
    if (-not $workingUrl) {
        Write-Log "  No deleted deployments found or not supported" "WARN"
        return $deletedServerData
    }
    
    $page = 1
    do {
        try {
            $uri = $workingUrl -f $page
            $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $Headers -ErrorAction Stop
            $deployments = if ($response.content) { $response.content } else { $response }
            
            if ($deployments -and $deployments.Count -gt 0) {
                $allDeletedDeployments += $deployments
                $page++
            }
            else {
                break
            }
        }
        catch {
            break
        }
        
        if ($allDeletedDeployments.Count -ge 5000) { break }
        
    } while ($true)
    
    $filteredDeployments = $allDeletedDeployments | Where-Object {
        try {
            $updateDate = [DateTime]$_.lastUpdatedAt
            $updateDate -ge $cutoffDate
        }
        catch {
            $true
        }
    }
    
    Write-Log "  Processing $($filteredDeployments.Count) deleted deployments..."
    
    foreach ($deployment in $filteredDeployments) {
        try {
            $requestsUri = "https://$VraServer/deployment/api/deployments/$($deployment.id)/requests?apiVersion=2020-08-25&deleted=true"
            $requestsResponse = Invoke-RestMethod -Uri $requestsUri -Method Get -Headers $Headers -ErrorAction Stop
            $requests = if ($requestsResponse.content) { $requestsResponse.content } else { $requestsResponse }
            
            foreach ($request in $requests) {
                $eventPage = 0
                
                do {
                    $eventsUri = "https://$VraServer/deployment/api/deployments/$($deployment.id)/requests/$($request.id)/events?page=$eventPage&size=$eventsPageSize&deleted=true&apiVersion=2020-08-25"
                    
                    try {
                        $eventsResponse = Invoke-RestMethod -Uri $eventsUri -Method Get -Headers $Headers -ErrorAction Stop
                        $events = if ($eventsResponse.content) { $eventsResponse.content } else { $eventsResponse }
                        
                        if ($events -and $events.Count -gt 0) {
                            foreach ($event in $events) {
                                if ($event.resourceType -eq "Cloud.vSphere.Machine") {
                                    $serverName = $null
                                    
                                    if ($event.details) {
                                        $detailsText = if ($event.details -is [string]) { 
                                            $event.details 
                                        } else { 
                                            ($event.details | ConvertTo-Json -Compress -Depth 5)
                                        }
                                        
                                        if ($detailsText -match "Cloud Resource Name:\s*([^\s,;]+)") {
                                            $serverName = $matches[1].Trim()
                                        }
                                        elseif ($detailsText -match '"cloudResourceName"\s*:\s*"([^"]+)"') {
                                            $serverName = $matches[1].Trim()
                                        }
                                    }
                                    
                                    if (-not $serverName -and $event.resourceName) {
                                        $serverName = $event.resourceName
                                    }
                                    
                                    if ($serverName -and -not $deletedServerData.ContainsKey($serverName)) {
                                        $vraServerShort = ($VraServer -split '\.')[0]
                                        $requestedBy = if ($request.requestedBy) { $request.requestedBy } else { "N/A" }
                                        $requestor = if ($deployment.ownedBy) { $deployment.ownedBy } else { $requestedBy }
                                        $catalogItem = if ($deployment.inputs._catalogItemName) { $deployment.inputs._catalogItemName } else { "N/A" }
                                        
                                        $deletedServerData[$serverName] = @{
                                            DeploymentName = $deployment.name
                                            Description = if ($deployment.description) { $deployment.description } else { "N/A" }
                                            RequestedBy = $requestedBy
                                            Requestor = $requestor
                                            vRAServer = $vraServerShort
                                            DeploymentID = $deployment.id
                                            Status = "DELETED"
                                            CatalogItem = $catalogItem
                                            DeploymentStatus = "Decomm/Offline"
                                            DeletedAt = $deployment.lastUpdatedAt
                                        }
                                    }
                                }
                            }
                            
                            $eventPage++
                            if ($events.Count -lt $eventsPageSize) { break }
                        }
                        else {
                            break
                        }
                    }
                    catch {
                        break
                    }
                    
                    if ($eventPage -ge 10) { break }
                    
                } while ($true)
            }
        }
        catch {
            continue
        }
    }
    
    Write-Log "  Extracted $($deletedServerData.Count) servers from deleted deployments" "SUCCESS"
    return $deletedServerData
}

function Send-NewServerReport {
    param(
        [Parameter(Mandatory=$true)]
        [Array]$ReportData,
        
        [Parameter(Mandatory=$true)]
        [string]$SmtpServer,
        
        [Parameter(Mandatory=$true)]
        [int]$SmtpPort,
        
        [Parameter(Mandatory=$true)]
        [string]$From,
        
        [Parameter(Mandatory=$true)]
        [Array]$To,
        
        [Parameter(Mandatory=$false)]
        [Array]$Cc,
        
        [Parameter(Mandatory=$true)]
        [string]$Subject
    )
    
    Write-Log "Building email report..."
    
    # Sort: Online first, then Decomm/Offline, then by Source within each status
    $sortedData = $ReportData | Sort-Object @{
        Expression={
            if($_.Status -eq "Online"){"A"}
            elseif($_.Status -eq "Decomm/Offline"){"B"}
            else{"C"}
        }; 
        Ascending=$true
    }, Source
    
    $htmlRows = ""
    foreach ($record in $sortedData) {
        $rowClass = ""
        if ($record.Status -eq "Online") {
            $rowClass = " style='background-color: #e8f5e9;'"
        }
        elseif ($record.Status -eq "Decomm/Offline") {
            $rowClass = " style='background-color: #ffebee;'"
        }
        
        $htmlRows += "<tr$rowClass>"
        $htmlRows += "<td>$($record.Name)</td>"
        $htmlRows += "<td>$($record.Status)</td>"
        $htmlRows += "<td>$($record.Source)</td>"
        $htmlRows += "<td>$($record.RequestedBy)</td>"
        $htmlRows += "<td>$($record.Requestor)</td>"
        $htmlRows += "<td>$($record.DeploymentName)</td>"
        $htmlRows += "<td>$($record.CatalogItem)</td>"
        $htmlRows += "</tr>"
    }
    
    $onlineCount = ($ReportData | Where-Object { $_.Status -eq "Online" }).Count
    $decommCount = ($ReportData | Where-Object { $_.Status -eq "Decomm/Offline" }).Count
    
    $htmlBody = @"
<html>
<head>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th { background-color: #2196F3; color: white; padding: 12px; text-align: left; font-weight: bold; }
    td { border: 1px solid #ddd; padding: 10px; }
    .summary { background-color: #f9f9f9; padding: 10px 15px; border-left: 4px solid #2196F3; margin-bottom: 20px; }
</style>
</head>
<body>
<div class="summary">
    <p><strong>Total New Servers:</strong> $($ReportData.Count)</p>
    <p><strong>Online (Exists):</strong> $onlineCount | <strong>Decomm/Offline (Deleted):</strong> $decommCount</p>
</div>
<table>
<thead>
<tr>
<th>Name</th>
<th>Status</th>
<th>Source</th>
<th>Requested By</th>
<th>Requestor</th>
<th>Deployment Name</th>
<th>Catalog Item</th>
</tr>
</thead>
<tbody>
$htmlRows
</tbody>
</table>
</body>
</html>
"@
    
    Write-Log "Sending email to: $($To -join ', ')"
    if ($Cc -and $Cc.Count -gt 0) {
        Write-Log "CC: $($Cc -join ', ')"
        Send-MailMessage -To $To -From $From -Subject $Subject -Body $htmlBody -BodyAsHtml -SmtpServer $SmtpServer -Port $SmtpPort -UseSsl -Cc $Cc
    }
    else {
        Send-MailMessage -To $To -From $From -Subject $Subject -Body $htmlBody -BodyAsHtml -SmtpServer $SmtpServer -Port $SmtpPort -UseSsl
    }
    Write-Log "Email sent successfully!" "SUCCESS"
}

# Main Script
Write-Log "New Server Tracker Started" "SUCCESS"
Write-Log "PowerShell Version: $($PSVersionTable.PSVersion)"

# Load VMware PowerCLI
try {
    Import-Module VMware.PowerCLI -ErrorAction Stop
    Set-PowerCLIConfiguration -InvalidCertificateAction Ignore -Confirm:$false -Scope Session | Out-Null
    Write-Log "VMware PowerCLI loaded" "SUCCESS"
}
catch {
    Write-Log "Failed to load VMware PowerCLI: $($_.Exception.Message)" "ERROR"
    Write-Log "Please install VMware PowerCLI: Install-Module -Name VMware.PowerCLI -Scope CurrentUser" "ERROR"
    exit
}

Disable-SSLValidation

# Get credentials
Write-Log "Requesting credentials..."
$credential = Get-Credential -Message "Enter credentials for Aria Operations, vRA, and vCenter"
if (-not $credential) {
    Write-Log "Credentials not provided. Exiting." "ERROR"
    exit
}
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

# Aria Operations - Get New VMs
Write-Log "`nConnecting to Aria Operations" "SUCCESS"

try {
    # Authenticate
    $ariaUsername = "$username@$ariaOpsDomain@$ariaOpsAuthSource"
    $ariaAuthUri = "https://$ariaOpsServer/suite-api/api/auth/token/acquire"
    $ariaAuthBody = @{
        username = $ariaUsername
        password = $password
    } | ConvertTo-Json
    
    $ariaAuthResponse = Invoke-RestMethod -Uri $ariaAuthUri -Method Post -Headers @{
        "Content-Type" = "application/json"
        "Accept" = "application/json"
    } -Body $ariaAuthBody -ErrorAction Stop
    
    $ariaHeaders = @{
        "Authorization" = "vRealizeOpsToken $($ariaAuthResponse.token)"
        "Content-Type" = "application/json"
        "Accept" = "application/json"
        "X-Ops-API-use-unsupported" = "true"
    }
    
    Write-Log "Authenticated to Aria Operations successfully" "SUCCESS"
    
    # Query for new VMs
    $yesterday = [DateTimeOffset]::Now.AddDays(-$daysBack).ToUnixTimeMilliseconds()
    $ariaUri = "https://$ariaOpsServer/suite-api/api/resources?resourceKind=VirtualMachine"
    
    $response = Invoke-RestMethod -Uri $ariaUri -Headers $ariaHeaders -Method Get
    $vmIdentifiers = $response.resourceList | Where-Object { $_.creationTime -ge $yesterday } | Select-Object -ExpandProperty identifier
    
    Write-Log "Found $($vmIdentifiers.Count) VMs created in the last $daysBack day(s)"
    
    $newVMsData = @()
    
    foreach ($identifier in $vmIdentifiers) {
        $vmPropertiesURL = "https://$ariaOpsServer/suite-api/api/resources/$identifier/properties?_no_links=true"
        
        try {
            $response = Invoke-RestMethod -Uri $vmPropertiesURL -Headers $ariaHeaders -Method Get
            
            # Get VM name
            $nameProp = $response.property | Where-Object { $_.name -eq "config|name" -or $_.name -eq "summary|config|name" } | Select-Object -First 1
            if (-not $nameProp) { continue }
            $vmName = $nameProp.value
            
            # Determine status from Aria Operations
            $healthProp = $response.property | Where-Object { $_.name -eq "badge|health" -or $_.name -eq "summary|health" } | Select-Object -First 1
            $resourceStateProp = $response.property | Where-Object { $_.name -eq "summary|resourceState" } | Select-Object -First 1
            $powerStateProp = $response.property | Where-Object { $_.name -eq "summary|runtime|powerState" } | Select-Object -First 1
            
            $status = "Unknown"
            $powerState = "Unknown"
            
            # Check power state first
            if ($powerStateProp -and $powerStateProp.value) {
                $powerStateValue = $powerStateProp.value.ToString().ToUpper()
                if ($powerStateValue -eq "POWERED_ON" -or $powerStateValue -eq "1") {
                    $status = "Online"
                    $powerState = "PoweredOn"
                }
                elseif ($powerStateValue -eq "POWERED_OFF" -or $powerStateValue -eq "0") {
                    $status = "Online"  # VM exists, just powered off
                    $powerState = "PoweredOff"
                }
            }
            
            # Check resource state - this tells us if VM actually exists
            if ($resourceStateProp -and $resourceStateProp.value) {
                $resourceState = $resourceStateProp.value.ToString().ToUpper()
                if ($resourceState -in @("NOT_EXISTING", "STOPPED")) {
                    $status = "Decomm/Offline"  # VM no longer exists
                    $powerState = "NotExisting"
                }
                elseif ($resourceState -in @("STARTED", "MAINTAINED", "RUNNING")) {
                    if ($status -eq "Unknown") {
                        $status = "Online"
                    }
                }
            }
            
            # Check health badge as fallback
            if ($status -eq "Unknown" -and $healthProp -and $healthProp.value) {
                $healthValue = $healthProp.value.ToString().ToUpper()
                
                if ($healthValue -match "GREEN|YELLOW|ORANGE|RED") {
                    $status = "Online"
                }
                elseif ($healthValue -match "GREY|GRAY|NONE") {
                    $status = "Decomm/Offline"  # No health data = doesn't exist
                }
                elseif ($healthValue -match "^[1-4]$") {
                    $status = "Online"
                }
                elseif ($healthValue -eq "0") {
                    $status = "Decomm/Offline"
                }
            }
            
            $newVMsData += [PSCustomObject]@{
                Name = $vmName
                Status = $status
                PowerState = $powerState
                ResourceId = $identifier
            }
        }
        catch {
            Write-Log "  Error getting properties for VM $identifier : $($_.Exception.Message)" "WARN"
        }
    }
    
    Write-Log "Successfully retrieved $($newVMsData.Count) new VMs" "SUCCESS"
}
catch {
    Write-Log "Failed to query Aria Operations: $($_.Exception.Message)" "ERROR"
    exit
}

if ($newVMsData.Count -eq 0) {
    Write-Log "No new VMs found. Exiting." "WARN"
    exit
}

# vRA - Get Deployment Info
Write-Log "`nProcessing vRA Servers" "SUCCESS"
$deploymentData = @{}
$deletedDeploymentData = @{}

foreach ($vraServer in $vraServers) {
    Write-Log "`nConnecting to vRA: $vraServer"
    
    try {
        # Authenticate
        $vraAuthUri = "https://$vraServer/csp/gateway/am/api/login"
        $vraAuthBody = @{
            username = $username
            password = $password
        } | ConvertTo-Json
        
        $vraAuthResponse = Invoke-RestMethod -Uri $vraAuthUri -Method Post -Headers @{
            "Content-Type" = "application/json"
        } -Body $vraAuthBody -ErrorAction Stop
        
        $vraHeaders = @{
            "Authorization" = "Bearer $($vraAuthResponse.cspAuthToken)"
            "Content-Type" = "application/json"
        }
        
        Write-Log "Authenticated successfully" "SUCCESS"
        
        # Fetch active deployments
        $vraUri = "https://$vraServer/deployment/api/deployments"
        $page = 0
        $size = 1000
        $allDeployments = @()
        
        do {
            $pagedUri = "$vraUri`?page=$page&size=$size&expand=resources"
            $vraResponse = Invoke-RestMethod -Uri $pagedUri -Method Get -Headers $vraHeaders -ErrorAction Stop
            $deployments = if ($vraResponse.content) { $vraResponse.content } else { $vraResponse }
            
            $allDeployments += $deployments
            $page++
            
            $hasMore = if ($vraResponse.totalPages) { 
                $page -lt $vraResponse.totalPages
            } elseif ($vraResponse.totalElements) { 
                ($page * $size) -lt $vraResponse.totalElements
            } else { 
                $deployments.Count -eq $size
            }
            
        } while ($hasMore)
        
        Write-Log "Retrieved $($allDeployments.Count) active deployments"
        
        # Process deployments with vSphere machines
        foreach ($dep in $allDeployments) {
            if ($dep.resources) {
                $vSphereMachines = $dep.resources | Where-Object { $_.type -eq "Cloud.vSphere.Machine" }
                
                foreach ($machine in $vSphereMachines) {
                    $hostname = $null
                    
                    if ($machine.properties) {
                        $props = $machine.properties
                        
                        # PowerShell 5.1 compatible property access
                        if ($props.PSObject.Properties['hostname']) {
                            $hostname = $props.hostname
                        }
                        elseif ($props.PSObject.Properties['resourceName']) {
                            $hostname = $props.resourceName
                        }
                        elseif ($props.PSObject.Properties['name']) {
                            $hostname = $props.name
                        }
                        elseif ($props.PSObject.Properties['address']) {
                            $hostname = $props.address
                        }
                        elseif ($props.PSObject.Properties['hostName']) {
                            $hostname = $props.hostName
                        }
                    }
                    
                    if (-not $hostname -and $machine.name) {
                        $hostname = $machine.name
                    }
                    
                    if ($hostname -and -not $deploymentData.ContainsKey($hostname)) {
                        $vraServerShort = ($vraServer -split '\.')[0]
                        
                        $deploymentData[$hostname] = @{
                            DeploymentName = $dep.name
                            Description = if ($dep.description) { $dep.description } else { "N/A" }
                            RequestedBy = if ($dep.createdBy) { $dep.createdBy } else { "N/A" }
                            Requestor = if ($dep.ownedBy) { $dep.ownedBy } else { $dep.createdBy }
                            vRAServer = $vraServerShort
                            DeploymentID = $dep.id
                            Status = $dep.status
                            CatalogItem = if ($dep.inputs._catalogItemName) { $dep.inputs._catalogItemName } else { "N/A" }
                            DeploymentStatus = "Online"
                        }
                    }
                }
            }
        }
        
        Write-Log "Processed active deployments" "SUCCESS"
        
        # Fetch deleted deployments
        Write-Log "Fetching deleted deployments..."
        $deletedServers = Get-DeletedDeploymentServers -VraServer $vraServer -Headers $vraHeaders -DaysBack $deletedDaysBack
        
        foreach ($serverName in $deletedServers.Keys) {
            if (-not $deletedDeploymentData.ContainsKey($serverName)) {
                $deletedDeploymentData[$serverName] = $deletedServers[$serverName]
            }
        }
    }
    catch {
        Write-Log "Error processing vRA server $vraServer : $($_.Exception.Message)" "ERROR"
    }
}

# Merge deleted deployments
foreach ($vmName in $deletedDeploymentData.Keys) {
    if (-not $deploymentData.ContainsKey($vmName)) {
        $deploymentData[$vmName] = $deletedDeploymentData[$vmName]
    }
}

Write-Log "`nTotal deployments found: $($deploymentData.Count) (Active + Deleted)" "SUCCESS"

# vCenter - Get Creator Info for Non-vRA VMs
Write-Log "`nConnecting to vCenter" "SUCCESS"
$vCenterLookup = @{}

$vmsNeedingVCenterLookup = $newVMsData | Where-Object { -not $deploymentData.ContainsKey($_.Name) } | Select-Object -ExpandProperty Name

Write-Log "VMs needing vCenter lookup: $($vmsNeedingVCenterLookup.Count)"

if ($vmsNeedingVCenterLookup.Count -gt 0) {
    foreach ($vCenter in $vCenters) {
        Write-Log "Connecting to: $vCenter"
        
        try {
            Connect-VIServer -Server $vCenter -Credential $credential -ErrorAction Stop | Out-Null
            
            $cutoffDate = (Get-Date).AddDays(-$daysBack)
            $events = Get-VIEvent -Server $vCenter -Start $cutoffDate -MaxSamples 50000 | Where-Object {
                $_.GetType().Name -in @('VmCreatedEvent', 'VmBeingDeployedEvent', 'VmRegisteredEvent', 'VmDeployedEvent') -and
                $_.Vm.Name -in $vmsNeedingVCenterLookup
            }
            
            foreach ($event in $events) {
                $vmName = $event.Vm.Name
                
                if (-not $vCenterLookup.ContainsKey($vmName)) {
                    $vCenterShort = ($vCenter -split '\.')[0]
                    
                    $vCenterLookup[$vmName] = @{
                        CreatedBy = if ($event.UserName) { $event.UserName } else { "N/A" }
                        vCenter = $vCenterShort
                    }
                }
            }
            
            Disconnect-VIServer -Server $vCenter -Confirm:$false -ErrorAction SilentlyContinue
            Write-Log "Disconnected from $vCenter"
        }
        catch {
            Write-Log "Error with vCenter $vCenter : $($_.Exception.Message)" "ERROR"
        }
    }
}

# Build Final Report
Write-Log "`nBuilding Final Report" "SUCCESS"
$reportData = @()

# Build vCenter connection lookup for power state checks
$vCenterConnections = @{}

foreach ($vmData in $newVMsData) {
    $vmName = $vmData.Name
    $depInfo = $deploymentData[$vmName]
    
    if ($depInfo) {
        # Determine final status - Aria Operations is the source of truth for VM existence
        $finalStatus = $vmData.Status
        $finalPowerState = $vmData.PowerState
        
        # Check if vRA deployment failed
        if ($depInfo.Status -match "FAILED|ERROR") {
            $finalStatus = "Decomm/Offline"
            $finalPowerState = "NotExisting"
        }
        # If Aria Operations says it doesn't exist, trust that
        elseif ($vmData.Status -eq "Decomm/Offline") {
            $finalStatus = "Decomm/Offline"
            $finalPowerState = "NotExisting"
        }
        # Check if deployment was deleted
        elseif ($depInfo.Status -eq "DELETED" -or $depInfo.DeploymentStatus -eq "Decomm/Offline") {
            $finalStatus = "Decomm/Offline"
            $finalPowerState = "NotExisting"
        }
        elseif ($vmData.Status -eq "Unknown") {
            # Fallback: Try to determine status from vCenter for vRA VMs with Unknown status
            $finalStatus = "Online"  # Default assumption
            $finalPowerState = "Unknown"
            
            foreach ($vCenter in $vCenters) {
                try {
                    if (-not $vCenterConnections.ContainsKey($vCenter)) {
                        Connect-VIServer -Server $vCenter -Credential $credential -ErrorAction Stop | Out-Null
                        $vCenterConnections[$vCenter] = $true
                        Write-Log "  Connected to $vCenter for power state lookup"
                    }
                    
                    $vm = Get-VM -Name $vmName -Server $vCenter -ErrorAction SilentlyContinue
                    if ($vm) {
                        $finalStatus = "Online"  # VM exists
                        $finalPowerState = if ($vm.PowerState -eq "PoweredOn") { "PoweredOn" } else { "PoweredOff" }
                        Write-Log "  Found $vmName on $vCenter - PowerState: $finalPowerState"
                        break
                    }
                }
                catch {
                    # Continue to next vCenter
                }
            }
        }
        else {
            $finalStatus = "Online"
        }
        
        $reportData += [PSCustomObject]@{
            Name = $vmName
            Status = $finalStatus
            PowerState = $finalPowerState
            DeploymentName = $depInfo.DeploymentName
            CatalogItem = $depInfo.CatalogItem
            RequestedBy = $depInfo.RequestedBy
            Requestor = $depInfo.Requestor
            Source = $depInfo.vRAServer
        }
    }
    else {
        # Not in vRA, check vCenter
        $vcInfo = $vCenterLookup[$vmName]
        $finalStatus = $vmData.Status
        $finalPowerState = $vmData.PowerState
        
        # If status is Unknown, try to get actual power state from vCenter
        if ($finalStatus -eq "Unknown") {
            $finalStatus = "Online"  # Default to Online if we can't determine
            $finalPowerState = "Unknown"
            
            # Try to connect to vCenter and check power state
            foreach ($vCenter in $vCenters) {
                try {
                    if (-not $vCenterConnections.ContainsKey($vCenter)) {
                        Connect-VIServer -Server $vCenter -Credential $credential -ErrorAction Stop | Out-Null
                        $vCenterConnections[$vCenter] = $true
                        Write-Log "  Connected to $vCenter for power state lookup"
                    }
                    
                    $vm = Get-VM -Name $vmName -Server $vCenter -ErrorAction SilentlyContinue
                    if ($vm) {
                        $finalStatus = "Online"  # VM exists
                        $finalPowerState = if ($vm.PowerState -eq "PoweredOn") { "PoweredOn" } else { "PoweredOff" }
                        Write-Log "  Found $vmName on $vCenter - PowerState: $finalPowerState"
                        break
                    }
                }
                catch {
                    # Continue to next vCenter
                }
            }
        }
        
        if ($vcInfo) {
            $reportData += [PSCustomObject]@{
                Name = $vmName
                Status = $finalStatus
                PowerState = $finalPowerState
                DeploymentName = "N/A"
                CatalogItem = "N/A"
                RequestedBy = $vcInfo.CreatedBy
                Requestor = $vcInfo.CreatedBy
                Source = $vcInfo.vCenter
            }
        }
        else {
            $reportData += [PSCustomObject]@{
                Name = $vmName
                Status = $finalStatus
                PowerState = $finalPowerState
                DeploymentName = "N/A"
                CatalogItem = "N/A"
                RequestedBy = "N/A"
                Requestor = "N/A"
                Source = "Unknown"
            }
        }
    }
}

Write-Log "Report contains $($reportData.Count) records" "SUCCESS"

# Disconnect any remaining vCenter connections
foreach ($vCenter in $vCenterConnections.Keys) {
    try {
        Disconnect-VIServer -Server $vCenter -Confirm:$false -ErrorAction SilentlyContinue
        Write-Log "Disconnected from $vCenter"
    }
    catch {
        # Silent failure on disconnect
    }
}

# Send Email Report
Write-Log "`nSending Email Report" "SUCCESS"

try {
    Send-NewServerReport `
        -ReportData $reportData `
        -SmtpServer $smtpServer `
        -SmtpPort $smtpPort `
        -From $smtpFrom `
        -To $smtpTo `
        -Cc $smtpCc `
        -Subject $smtpSubject
}
catch {
    Write-Log "Failed to send email: $($_.Exception.Message)" "ERROR"
    exit
}

Write-Log "`nScript Completed Successfully" "SUCCESS"
