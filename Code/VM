# New Server Tracker - Aria Operations + Multi-vRA (Active & Deleted) + vCenter
# PowerShell 5.1 Compatible - FIXED VERSION with proper null handling

# Configuration Variables
$ariaOpsServer = "aria-ops.yourdomain.com"
$ariaOpsDomain = "yourdomain.com"
$ariaOpsAuthSource = "localos"
$vraServers = @("vra1.yourdomain.com", "vra2.yourdomain.com")
$vCenters = @("vcenter1.domain.com", "vcenter2.domain.com", "vcenter3.domain.com")

# SMTP Configuration
$smtpServer = "smtp.yourdomain.com"
$smtpPort = 587
$smtpFrom = "vra-reports@yourdomain.com"
$smtpTo = @("admin@yourdomain.com")
$smtpSubject = "New Server Deployment Report - $(Get-Date -Format 'yyyy-MM-dd')"

# Time range
$daysBack = 1
$deletedDaysBack = 90
$eventsPageSize = 200

# Output
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputLog = "C:\Logs\NewServers_$timestamp.log"
$outputCSV = "C:\Logs\NewServers_$timestamp.csv"

# Helper Functions
function Write-DebugLog {
    param([string]$Message, [string]$Level = "INFO")
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] [$Level] $Message"
    $color = switch ($Level) {
        "ERROR" { "Red" }
        "WARN" { "Yellow" }
        "SUCCESS" { "Green" }
        "DEBUG" { "Magenta" }
        default { "Cyan" }
    }
    Write-Host $logMessage -ForegroundColor $color
    Add-Content -Path $outputLog -Value $logMessage
}

function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type @"
using System.Net;
using System.Security.Cryptography.X509Certificates;
public class TrustAllCertsPolicy : ICertificatePolicy {
    public bool CheckValidationResult(ServicePoint svcPoint, X509Certificate certificate, WebRequest request, int certificateProblem) {
        return true;
    }
}
"@
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
}

function Send-NewServerReport {
    param(
        [Parameter(Mandatory=$true)][Array]$ReportData,
        [Parameter(Mandatory=$true)][string]$SmtpServer,
        [Parameter(Mandatory=$true)][int]$SmtpPort,
        [Parameter(Mandatory=$true)][string]$From,
        [Parameter(Mandatory=$true)][Array]$To,
        [Parameter(Mandatory=$true)][string]$Subject
    )
    
    Write-DebugLog "Building email report..."
    $htmlRows = ""
    foreach ($record in $ReportData) {
        $rowClass = ""
        if ($record.Source -notlike "*vRA*") { $rowClass = " style='background-color: #fff3cd;'" }
        elseif ($record.Status -eq "Decomm/Offline") { $rowClass = " style='background-color: #f8d7da;'" }
        
        $htmlRows += "<tr$rowClass>"
        $htmlRows += "<td>$($record.Name)</td><td>$($record.Status)</td><td>$($record.Source)</td>"
        $htmlRows += "<td>$($record.RequestedBy)</td><td>$($record.Requestor)</td>"
        $htmlRows += "<td>$($record.DeploymentName)</td><td>$($record.CatalogItem)</td></tr>"
    }
    
    $htmlBody = @"
<html><head><style>
body { font-family: Arial, sans-serif; margin: 20px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th { background-color: #4CAF50; color: white; padding: 12px; text-align: left; font-weight: bold; }
td { border: 1px solid #ddd; padding: 10px; }
tr:nth-child(even) { background-color: #f2f2f2; }
tr:hover { background-color: #e8e8e8; }
.summary { background-color: #f9f9f9; padding: 10px 15px; border-left: 4px solid #4CAF50; margin-bottom: 20px; }
</style></head><body>
<div class="summary"><p><strong>Total New Servers:</strong> $($ReportData.Count)</p></div>
<table><thead><tr><th>Name</th><th>Status</th><th>Source</th><th>Requested By</th><th>Requestor</th><th>Deployment Name</th><th>Catalog Item</th></tr></thead>
<tbody>$htmlRows</tbody></table></body></html>
"@
    
    Send-MailMessage -To $To -From $From -Subject $Subject -Body $htmlBody -BodyAsHtml -SmtpServer $SmtpServer -Port $SmtpPort -UseSsl
    Write-DebugLog "Email sent successfully!" "SUCCESS"
}

# Main Script
Write-DebugLog "===== Script Started =====" "SUCCESS"
Write-DebugLog "PowerShell Version: $($PSVersionTable.PSVersion)"

# Load VMware PowerCLI
try {
    Import-Module VMware.VimAutomation.Core -ErrorAction Stop
    Set-PowerCLIConfiguration -InvalidCertificateAction Ignore -Confirm:$false -Scope Session | Out-Null
    Write-DebugLog "VMware PowerCLI module loaded" "SUCCESS"
} catch {
    Write-DebugLog "Failed to load VMware PowerCLI: $($_.Exception.Message)" "ERROR"
    exit
}

# Ensure log directory exists
$logDir = Split-Path $outputCSV -Parent
if (!(Test-Path $logDir)) { New-Item -ItemType Directory -Path $logDir -Force | Out-Null }

Disable-SSLValidation

# Get credentials
Write-DebugLog "Requesting credentials..."
$credential = Get-Credential -Message "Enter credentials for Aria Operations, vRA, and vCenter"
if (-not $credential) {
    Write-DebugLog "Credentials not provided. Exiting." "ERROR"
    exit
}
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

# Connect to Aria Operations
Write-DebugLog "`n===== Connecting to Aria Operations =====" "INFO"
$newVMsData = @()

try {
    Write-DebugLog "Authenticating to Aria Operations: $ariaOpsServer"
    
    $ariaUsername = "$username@$ariaOpsDomain@$ariaOpsAuthSource"
    $ariaAuthUri = "https://$ariaOpsServer/suite-api/api/auth/token/acquire"
    $ariaAuthBody = @{ username = $ariaUsername; password = $password } | ConvertTo-Json
    
    $ariaAuthResponse = Invoke-RestMethod -Uri $ariaAuthUri -Method Post -Headers @{"Content-Type"="application/json"} -Body $ariaAuthBody -ErrorAction Stop
    
    if ($null -eq $ariaAuthResponse -or $null -eq $ariaAuthResponse.token) {
        throw "Authentication failed - no token received"
    }
    
    $ariaToken = $ariaAuthResponse.token
    Write-DebugLog "Authenticated to Aria Operations successfully" "SUCCESS"
    
    $ariaHeaders = @{
        "Authorization" = "vRealizeOpsToken $ariaToken"
        "Content-Type" = "application/json"
        "Accept" = "application/json"
    }
    
    # Calculate cutoff date
    $yesterday = [DateTimeOffset]::Now.AddDays(-$daysBack).ToUnixTimeMilliseconds()
    Write-DebugLog "Searching for VMs created after: $((Get-Date).AddDays(-$daysBack))" "DEBUG"
    Write-DebugLog "Unix timestamp (ms): $yesterday" "DEBUG"
    
    # Query Aria Operations
    Write-DebugLog "`n===== Querying Aria Operations for VMs =====" "INFO"
    $ariaURL = "https://$ariaOpsServer/suite-api/api/resources?resourceKind=VirtualMachine"
    Write-DebugLog "URL: $ariaURL" "DEBUG"
    
    try {
        $response = Invoke-RestMethod -Uri $ariaURL -Headers $ariaHeaders -Method Get -ErrorAction Stop
        Write-DebugLog "API call successful" "SUCCESS"
        
        # Extract resources from response
        $allResources = @()
        
        if ($null -eq $response) {
            Write-DebugLog "Response is null!" "ERROR"
            throw "API returned null response"
        }
        
        Write-DebugLog "Response type: $($response.GetType().Name)" "DEBUG"
        
        # Try to find resources in response
        if ($response -is [Array]) {
            Write-DebugLog "Response is an array with $($response.Count) items" "DEBUG"
            $allResources = $response
        }
        elseif ($null -ne $response.PSObject.Properties['resourceList']) {
            Write-DebugLog "Found 'resourceList' property" "DEBUG"
            $allResources = $response.resourceList
        }
        elseif ($null -ne $response.PSObject.Properties['resources']) {
            Write-DebugLog "Found 'resources' property" "DEBUG"
            $allResources = $response.resources
        }
        elseif ($null -ne $response.PSObject.Properties['content']) {
            Write-DebugLog "Found 'content' property" "DEBUG"
            $allResources = $response.content
        }
        else {
            Write-DebugLog "Could not find resources in response. Available properties:" "WARN"
            if ($null -ne $response.PSObject -and $null -ne $response.PSObject.Properties) {
                foreach ($prop in $response.PSObject.Properties) {
                    Write-DebugLog "  - $($prop.Name)" "DEBUG"
                }
            }
            Write-DebugLog "Dumping response as JSON:" "DEBUG"
            Write-DebugLog ($response | ConvertTo-Json -Depth 3) "DEBUG"
        }
        
        # Ensure we have an array
        if ($null -eq $allResources) {
            Write-DebugLog "No resources found in response" "WARN"
            $allResources = @()
        }
        elseif ($allResources -isnot [Array]) {
            Write-DebugLog "Converting single resource to array" "DEBUG"
            $allResources = @($allResources)
        }
        
        Write-DebugLog "Total resources found: $($allResources.Count)" "SUCCESS"
        
        # Filter VMs by creation time
        $vmIdentifiers = @()
        foreach ($resource in $allResources) {
            if ($null -eq $resource) { continue }
            
            # Try to get creation time
            $creationTime = $null
            if ($null -ne $resource.PSObject.Properties['creationTime']) {
                $creationTime = $resource.creationTime
            }
            elseif ($null -ne $resource.PSObject.Properties['createTime']) {
                $creationTime = $resource.createTime
            }
            
            # Check if within time range
            if ($null -ne $creationTime) {
                try {
                    $creationTimeLong = [long]$creationTime
                    if ($creationTimeLong -ge $yesterday) {
                        if ($null -ne $resource.PSObject.Properties['identifier']) {
                            $vmIdentifiers += $resource.identifier
                            Write-DebugLog "  Including VM: $($resource.identifier)" "DEBUG"
                        }
                    }
                } catch {
                    Write-DebugLog "  Error parsing creation time for resource: $($_.Exception.Message)" "WARN"
                }
            }
        }
        
        Write-DebugLog "VMs created in last $daysBack day(s): $($vmIdentifiers.Count)" "SUCCESS"
        
        # Get properties for each VM
        foreach ($identifier in $vmIdentifiers) {
            $vmPropertiesURL = "https://$ariaOpsServer/suite-api/api/resources/$identifier/properties"
            
            try {
                $vmProps = Invoke-RestMethod -Uri $vmPropertiesURL -Headers $ariaHeaders -Method Get -ErrorAction Stop
                
                # Extract VM name
                $vmName = $null
                if ($null -ne $vmProps.property) {
                    $nameProp = $vmProps.property | Where-Object { $_.name -eq "config|name" -or $_.name -eq "summary|config|name" } | Select-Object -First 1
                    if ($null -ne $nameProp -and $null -ne $nameProp.value) {
                        $vmName = $nameProp.value
                    }
                }
                
                if ([string]::IsNullOrEmpty($vmName)) {
                    Write-DebugLog "  Skipping VM $identifier - no name found" "WARN"
                    continue
                }
                
                # Get health status
                $status = "Decomm/Offline"
                if ($null -ne $vmProps.property) {
                    $healthProp = $vmProps.property | Where-Object { $_.name -eq "badge|health" -or $_.name -eq "summary|health" } | Select-Object -First 1
                    if ($null -ne $healthProp -and $null -ne $healthProp.value) {
                        $healthValue = $healthProp.value.ToString().ToUpper()
                        if ($healthValue -in @("GREEN", "YELLOW", "ORANGE", "RED")) {
                            $status = "Online"
                        }
                    }
                }
                
                $newVMsData += [PSCustomObject]@{
                    Name = $vmName
                    Status = $status
                    ResourceId = $identifier
                }
                
                Write-DebugLog "  Added VM: $vmName | Status: $status" "DEBUG"
            }
            catch {
                Write-DebugLog "  Error getting properties for VM $identifier : $($_.Exception.Message)" "WARN"
            }
        }
        
        Write-DebugLog "Successfully retrieved $($newVMsData.Count) new VMs from Aria Operations" "SUCCESS"
        
    }
    catch {
        Write-DebugLog "Error querying Aria Operations: $($_.Exception.Message)" "ERROR"
        Write-DebugLog "Stack trace: $($_.ScriptStackTrace)" "ERROR"
        throw
    }
}
catch {
    Write-DebugLog "Failed to connect to Aria Operations: $($_.Exception.Message)" "ERROR"
    exit
}

if ($newVMsData.Count -eq 0) {
    Write-DebugLog "`nNo new VMs found in Aria Operations. Exiting." "WARN"
    exit
}

# Build Final Report
Write-DebugLog "`n===== Building Final Report =====" "INFO"
$reportData = @()

foreach ($vmData in $newVMsData) {
    $reportData += [PSCustomObject]@{
        Name = $vmData.Name
        Status = $vmData.Status
        DeploymentName = "N/A"
        CatalogItem = "N/A"
        RequestedBy = "N/A"
        Requestor = "N/A"
        Source = "Aria Ops"
    }
}

# Export to CSV
Write-DebugLog "`n===== Exporting Data =====" "INFO"
$reportData | Select-Object Name, Status, Source, RequestedBy, Requestor, DeploymentName, CatalogItem | Export-Csv -Path $outputCSV -NoTypeInformation
Write-DebugLog "Exported to: $outputCSV" "SUCCESS"

# Send Email Report
Write-DebugLog "`n===== Sending Email Report =====" "INFO"
Send-NewServerReport -ReportData $reportData -SmtpServer $smtpServer -SmtpPort $smtpPort -From $smtpFrom -To $smtpTo -Subject $smtpSubject

Write-DebugLog "`n===== Script Completed Successfully =====" "SUCCESS"
Write-DebugLog "Results saved to: $outputCSV"
Write-DebugLog "Log saved to: $outputLog"
