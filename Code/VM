# vRA Deep-Dive: Specs, IPs, and Hardware for Deleted VMs/DBs
# Targets: Virtual Machines and Databases specifically.

# --- Configuration ---
$vraServer = "vra1.yourdomain.com"
$apiVersion = "2020-08-25"
$daysBack   = 30 
$filterKeywords = @("Virtual Machine", "Database", "VM", "SQL", "Instance")

# --- Output ---
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputCsv = "C:\Logs\vRA_Detailed_Specs_$timestamp.csv"

# --- Setup & Auth ---
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type "using System.Net; using System.Security.Cryptography.X509Certificates; public class TrustAllCertsPolicy : ICertificatePolicy { public bool CheckValidationResult(ServicePoint svcPoint, X509Certificate certificate, WebRequest request, int certificateProblem) { return true; } }"
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
}
Disable-SSLValidation

$credential = Get-Credential -Message "vRA Admin Credentials"
$authBody = @{ username = $credential.UserName; password = $credential.GetNetworkCredential().Password } | ConvertTo-Json
$authRes = Invoke-RestMethod -Uri "https://$vraServer/csp/gateway/am/api/login" -Method Post -Headers @{"Content-Type"="application/json"} -Body $authBody
$vraHeaders = @{ "Authorization" = "Bearer $($authRes.cspAuthToken)"; "Content-Type" = "application/json" }

# --- Processing ---
Write-Host "Fetching Deployment Records..." -ForegroundColor Cyan
$deployUri = "https://$vraServer/deployment/api/deployments?apiVersion=$apiVersion&deleted=true&`$top=1000"
$allDeps = (Invoke-RestMethod -Uri $deployUri -Method Get -Headers $vraHeaders).content

$cutoffDate = (Get-Date).AddDays(-$daysBack)
$detailedResults = @()

foreach ($dep in $allDeps) {
    # Filter for Deleted + Filter for Keywords (VM / Database)
    if ($dep.status -notmatch "DELETE" -and $dep.status -ne "ARCHIVED") { continue }
    
    $nameMatch = $false
    foreach ($k in $filterKeywords) { if ($dep.name -match $k) { $nameMatch = $true } }
    if (-not $nameMatch) { continue }

    Write-Host "Deep Scanning: $($dep.name)" -ForegroundColor Yellow

    # STEP: Query the Resources endpoint for this specific deployment
    # This is where the "Specifics" (CPU, RAM, IP) live.
    $resourceSpecs = "N/A"
    $ipAddresses = "N/A"
    $hostName = "N/A"
    
    try {
        $resUri = "https://$vraServer/deployment/api/deployments/$($dep.id)/resources?apiVersion=$apiVersion"
        $resources = (Invoke-RestMethod -Uri $resUri -Method Get -Headers $vraHeaders).content
        
        if ($resources) {
            foreach ($res in $resources) {
                # Look for properties inside the Virtual Machine or Database resource type
                if ($res.type -match "Machine" -or $res.type -match "Database") {
                    $props = $res.properties
                    $cpu = if ($props.cpuCount) { $props.cpuCount } else { $props.vcpu }
                    $ram = if ($props.totalMemoryMB) { $props.totalMemoryMB } else { $props.memoryInMB }
                    
                    $resourceSpecs = "CPU: $cpu, RAM: $ram MB"
                    $ipAddresses = ($props.address) -join ", "
                    $hostName = $props.resourceName
                }
            }
        }
    } catch {
        # If resources are already purged, we stick with the metadata we have
    }

    $detailedResults += [PSCustomObject]@{
        DeploymentName = $dep.name
        DeletedBy      = $dep.lastUpdatedBy
        DeletedAt      = $dep.lastUpdatedAt
        ProjectID      = $dep.projectId
        Owner          = $dep.ownedBy
        # --- THE SPECIFICS ---
        InternalName   = $hostName
        IP_Addresses   = $ipAddresses
        HardwareSpecs  = $resourceSpecs
        ResourceType   = $dep.catalogItemId # Shows the template used
        DeploymentID   = $dep.id
    }
}

# --- Export ---
$detailedResults | Export-Csv -Path $outputCsv -NoTypeInformation -Encoding UTF8
Write-Host "Deep Scan Complete. Results: $outputCsv" -ForegroundColor Green
$detailedResults | Select-Object DeploymentName, HardwareSpecs, IP_Addresses, DeletedBy -First 10 | Format-Table
