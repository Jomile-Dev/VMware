# vRA Global Request History Finder (404 Bypass Version)
# Purpose: Scans the global request service to find deletion history 
# without relying on potentially broken Deployment links.

# Configuration
$vraServer = "vra1.yourdomain.com"
$daysBack = 30
$apiVersion = "2020-08-25"
$filterTemplateNames = @("Virtual Machine", "Database") # Partial matches allowed

# Output
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputCsv = "C:\Logs\vRA_DeletionHistory_Global_$timestamp.csv"

function Disable-SSLValidation {
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type "using System.Net; using System.Security.Cryptography.X509Certificates; public class TrustAllCertsPolicy : ICertificatePolicy { public bool CheckValidationResult(ServicePoint svcPoint, X509Certificate certificate, WebRequest request, int certificateProblem) { return true; } }"
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
}

Disable-SSLValidation
$credential = Get-Credential -Message "Enter vRA Credentials"
$authBody = @{ username = $credential.UserName; password = $credential.GetNetworkCredential().Password } | ConvertTo-Json
$authRes = Invoke-RestMethod -Uri "https://$vraServer/csp/gateway/am/api/login" -Method Post -Headers @{"Content-Type"="application/json"} -Body $authBody
$vraHeaders = @{ "Authorization" = "Bearer $($authRes.cspAuthToken)"; "Content-Type" = "application/json" }

# STEP 1: Query Global Requests
# Instead of looking for Deployments, we look for 'Delete' Actions that finished recently
Write-Host "Searching Global Requests for Deletion actions..." -ForegroundColor Cyan

$cutoffDate = (Get-Date).AddDays(-$daysBack).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ss.fffZ")

# This URI queries the Request service directly, looking for Delete actions completed after the cutoff
$requestUri = "https://$vraServer/deployment/api/requests?apiVersion=$apiVersion&`$filter=status eq 'SUCCESSFUL' and completedAt ge '$cutoffDate'&`$top=1000"

try {
    $allRequests = (Invoke-RestMethod -Uri $requestUri -Method Get -Headers $vraHeaders).content
} catch {
    Write-Host "Global Request Query Failed: $($_.Exception.Message)" -ForegroundColor Red
    exit
}

$finalResults = @()

# STEP 2: Filter and Match
foreach ($req in $allRequests) {
    # We only care about Deletions
    if ($req.actionId -notmatch "delete") { continue }

    # Apply Template/Name Filter
    $isMatch = $false
    foreach ($f in $filterTemplateNames) {
        # Checking deploymentName and the request name for our keywords (VM/Database)
        if ($req.deploymentName -match $f -or $req.name -match $f) { $isMatch = $true; break }
    }

    if ($isMatch) {
        Write-Host "Match Found: $($req.deploymentName)" -ForegroundColor Green
        
        # STEP 3: Get Resource Details (Optional sub-drill)
        $resourceNames = "N/A"
        try {
            $resUri = "https://$vraServer/deployment/api/requests/$($req.id)/resources?apiVersion=$apiVersion"
            $resData = (Invoke-RestMethod -Uri $resUri -Method Get -Headers $vraHeaders).content
            if ($resData) {
                $resourceNames = ($resData | Select-Object -ExpandProperty name) -join ", "
            }
        } catch { 
            # If this also 404s, we still have the Request data, so we just move on
        }

        $finalResults += [PSCustomObject]@{
            DeletionTimestamp = $req.completedAt
            DeploymentName    = $req.deploymentName
            DeletedByUser     = $req.requestedBy
            RequestAction     = $req.name
            ResourcesAffected = $resourceNames
            Status            = $req.status
            RequestID         = $req.id
        }
    }
}

# Export
if ($finalResults.Count -gt 0) {
    $finalResults | Export-Csv -Path $outputCsv -NoTypeInformation -Encoding UTF8
    Write-Host "SUCCESS: $($finalResults.Count) history records exported to $outputCsv" -ForegroundColor Green
} else {
    Write-Host "No delete requests found in the last $daysBack days matching your filters." -ForegroundColor Yellow
}
