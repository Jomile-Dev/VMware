# vRA Deleted Deployments - Detailed Events and History
# This script fetches deleted deployments exactly like the vRA UI does

# Configuration
$vraServer = "vra1.yourdomain.com"
$daysBack = 30  # Look back 30 days

# Output
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputJson = "C:\Logs\DeletedDeployments_$timestamp.json"
$outputLog = "C:\Logs\DeletedDeployments_$timestamp.log"
$outputHtml = "C:\Logs\DeletedDeployments_$timestamp.html"

function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] [$Level] $Message"
    
    $color = switch ($Level) {
        "ERROR" { "Red" }
        "WARN" { "Yellow" }
        "SUCCESS" { "Green" }
        default { "Cyan" }
    }
    
    Write-Host $logMessage -ForegroundColor $color
    Add-Content -Path $outputLog -Value $logMessage
}

function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type @"
using System.Net;
using System.Security.Cryptography.X509Certificates;
public class TrustAllCertsPolicy : ICertificatePolicy {
    public bool CheckValidationResult(
        ServicePoint svcPoint, X509Certificate certificate,
        WebRequest request, int certificateProblem) {
        return true;
    }
}
"@
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
}

Write-Log "===== vRA Deleted Deployments - Detailed Explorer =====" "SUCCESS"
Disable-SSLValidation

# Ensure log directory exists
$logDir = Split-Path $outputJson -Parent
if (!(Test-Path $logDir)) {
    New-Item -ItemType Directory -Path $logDir -Force | Out-Null
}

# Get credentials
Write-Log "Requesting credentials..."
$credential = Get-Credential -Message "Enter credentials for vRA"
if (-not $credential) {
    Write-Log "Credentials not provided. Exiting." "ERROR"
    exit
}
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

# Authenticate to vRA
Write-Log "Authenticating to vRA: $vraServer"
try {
    $vraAuthUri = "https://$vraServer/csp/gateway/am/api/login"
    $vraAuthBody = @{
        username = $username
        password = $password
    } | ConvertTo-Json
    
    $vraAuthHeaders = @{
        "Content-Type" = "application/json"
        "Accept" = "application/json"
    }
    
    $vraAuthResponse = Invoke-RestMethod -Uri $vraAuthUri -Method Post -Headers $vraAuthHeaders -Body $vraAuthBody -ErrorAction Stop
    $vraToken = $vraAuthResponse.cspAuthToken
    Write-Log "Authenticated to vRA successfully" "SUCCESS"
}
catch {
    Write-Log "Failed to authenticate to vRA: $($_.Exception.Message)" "ERROR"
    exit
}

$vraHeaders = @{
    "Authorization" = "Bearer $vraToken"
    "Content-Type" = "application/json"
    "Accept" = "application/json"
}

$allDeletedDeployments = @()

# Fetch deleted deployments using the catalog API (like the UI does)
Write-Log "`n===== Fetching Deleted Deployments (Catalog API) ====="

try {
    $page = 0
    $size = 100
    
    do {
        # This is the actual API the UI uses for deleted deployments
        $uri = "https://$vraServer/catalog/api/items?deleted=true&page=$page&size=$size"
        Write-Log "Fetching page $($page + 1): $uri"
        
        $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $vraHeaders -ErrorAction Stop
        $items = if ($response.content) { $response.content } else { $response }
        
        Write-Log "Retrieved $($items.Count) deleted items" "SUCCESS"
        
        foreach ($item in $items) {
            Write-Log "`n========================================" "SUCCESS"
            Write-Log "DEPLOYMENT: $($item.name)" "SUCCESS"
            Write-Log "========================================" "SUCCESS"
            Write-Log "  ID: $($item.id)"
            Write-Log "  Catalog Item: $($item.catalogItemName)"
            Write-Log "  Status: $($item.status)"
            Write-Log "  Deployment ID: $($item.deploymentId)"
            Write-Log "  Created: $($item.createdAt)"
            Write-Log "  Last Updated: $($item.lastUpdatedAt)"
            Write-Log "  Requested By: $($item.requestedBy)"
            
            # Now fetch detailed deployment information
            if ($item.deploymentId) {
                Write-Log "`n  Fetching detailed deployment info..." "SUCCESS"
                
                try {
                    $depUri = "https://$vraServer/deployment/api/deployments/$($item.deploymentId)"
                    $deployment = Invoke-RestMethod -Uri $depUri -Method Get -Headers $vraHeaders -ErrorAction Stop
                    
                    Write-Log "  Project: $($deployment.projectId)"
                    Write-Log "  Owned By: $($deployment.ownedBy)"
                    Write-Log "  Deleted At: $($deployment.deletedAt)"
                    
                    # Get deployment resources
                    if ($deployment.resources) {
                        Write-Log "`n  === RESOURCES ($($deployment.resources.Count)) ===" "SUCCESS"
                        
                        foreach ($res in $deployment.resources) {
                            Write-Log "`n    Resource: $($res.name)"
                            Write-Log "      Type: $($res.type)"
                            Write-Log "      ID: $($res.id)"
                            Write-Log "      State: $($res.state)"
                            
                            if ($res.type -eq "Cloud.vSphere.Machine") {
                                Write-Log "      >>> VM DETAILS <<<" "SUCCESS"
                                if ($res.properties) {
                                    Write-Log "      Properties:"
                                    $res.properties.PSObject.Properties | ForEach-Object {
                                        Write-Log "        $($_.Name): $($_.Value)"
                                    }
                                }
                            }
                        }
                    }
                }
                catch {
                    Write-Log "  Could not fetch deployment details: $($_.Exception.Message)" "WARN"
                }
                
                # Fetch REQUEST HISTORY / EVENTS for this deployment
                Write-Log "`n  === FETCHING REQUEST HISTORY / EVENTS ===" "SUCCESS"
                
                try {
                    $requestsUri = "https://$vraServer/deployment/api/deployments/$($item.deploymentId)/requests"
                    $requests = Invoke-RestMethod -Uri $requestsUri -Method Get -Headers $vraHeaders -ErrorAction Stop
                    
                    $requestsList = if ($requests.content) { $requests.content } else { $requests }
                    
                    Write-Log "  Found $($requestsList.Count) requests/events" "SUCCESS"
                    
                    foreach ($req in $requestsList) {
                        Write-Log "`n    >>> EVENT: $($req.name) <<<" "SUCCESS"
                        Write-Log "      Request ID: $($req.id)"
                        Write-Log "      Action: $($req.actionId)"
                        Write-Log "      Status: $($req.status)"
                        Write-Log "      Created: $($req.createdAt)"
                        Write-Log "      Completed: $($req.completedAt)"
                        Write-Log "      Requested By: $($req.requestedBy)"
                        Write-Log "      Details: $($req.details)"
                        
                        # Get detailed event information
                        if ($req.id) {
                            try {
                                $eventUri = "https://$vraServer/deployment/api/deployments/$($item.deploymentId)/requests/$($req.id)"
                                $eventDetail = Invoke-RestMethod -Uri $eventUri -Method Get -Headers $vraHeaders -ErrorAction Stop
                                
                                if ($eventDetail.outputs) {
                                    Write-Log "      Outputs:"
                                    $eventDetail.outputs.PSObject.Properties | ForEach-Object {
                                        Write-Log "        $($_.Name): $($_.Value)"
                                    }
                                }
                                
                                if ($eventDetail.inputs) {
                                    Write-Log "      Inputs:"
                                    $eventDetail.inputs.PSObject.Properties | ForEach-Object {
                                        Write-Log "        $($_.Name): $($_.Value)"
                                    }
                                }
                            }
                            catch {
                                Write-Log "      Could not fetch event details" "WARN"
                            }
                        }
                    }
                }
                catch {
                    Write-Log "  Could not fetch request history: $($_.Exception.Message)" "WARN"
                }
                
                # Also try to get the original REQUEST details from catalog
                Write-Log "`n  === FETCHING ORIGINAL CATALOG REQUEST ===" "SUCCESS"
                
                try {
                    $catalogReqUri = "https://$vraServer/catalog/api/requests/$($item.id)"
                    $catalogReq = Invoke-RestMethod -Uri $catalogReqUri -Method Get -Headers $vraHeaders -ErrorAction Stop
                    
                    Write-Log "  Request Type: $($catalogReq.requestType)"
                    Write-Log "  Approval Status: $($catalogReq.approvalStatus)"
                    
                    if ($catalogReq.inputs) {
                        Write-Log "  Original Request Inputs:"
                        $catalogReq.inputs.PSObject.Properties | ForEach-Object {
                            Write-Log "    $($_.Name): $($_.Value)"
                        }
                    }
                    
                    if ($catalogReq.outputs) {
                        Write-Log "  Request Outputs:"
                        $catalogReq.outputs.PSObject.Properties | ForEach-Object {
                            Write-Log "    $($_.Name): $($_.Value)"
                        }
                    }
                }
                catch {
                    Write-Log "  Could not fetch catalog request: $($_.Exception.Message)" "WARN"
                }
            }
            
            # Build comprehensive object
            $deletedInfo = [PSCustomObject]@{
                ItemName = $item.name
                ItemID = $item.id
                DeploymentID = $item.deploymentId
                CatalogItemName = $item.catalogItemName
                Status = $item.status
                CreatedAt = $item.createdAt
                LastUpdatedAt = $item.lastUpdatedAt
                DeletedAt = if ($deployment) { $deployment.deletedAt } else { $null }
                RequestedBy = $item.requestedBy
                OwnedBy = if ($deployment) { $deployment.ownedBy } else { $null }
                ProjectId = if ($deployment) { $deployment.projectId } else { $null }
                Resources = if ($deployment) { $deployment.resources } else { $null }
                RequestHistory = if ($requestsList) { $requestsList } else { $null }
                FullItem = $item
                FullDeployment = $deployment
                CatalogRequest = if ($catalogReq) { $catalogReq } else { $null }
            }
            
            $allDeletedDeployments += $deletedInfo
        }
        
        $page++
        $hasMore = ($items.Count -eq $size)
        
    } while ($hasMore)
    
}
catch {
    Write-Log "Error fetching deleted deployments: $($_.Exception.Message)" "ERROR"
    Write-Log "Stack Trace: $($_.Exception.StackTrace)" "ERROR"
}

# Summary
Write-Log "`n============================================" "SUCCESS"
Write-Log "===== SUMMARY =====" "SUCCESS"
Write-Log "============================================" "SUCCESS"
Write-Log "Total deleted deployments found: $($allDeletedDeployments.Count)" "SUCCESS"

if ($allDeletedDeployments.Count -gt 0) {
    # Export full JSON
    $allDeletedDeployments | ConvertTo-Json -Depth 20 | Out-File -FilePath $outputJson -Encoding UTF8
    Write-Log "Full JSON exported to: $outputJson" "SUCCESS"
    
    # Create HTML report
    $html = @"
<!DOCTYPE html>
<html>
<head>
    <title>vRA Deleted Deployments Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        h1 { color: #333; }
        .deployment { background: white; padding: 20px; margin: 20px 0; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .deployment h2 { color: #d32f2f; margin-top: 0; }
        .info { margin: 10px 0; }
        .label { font-weight: bold; color: #666; }
        .value { color: #333; }
        .event { background: #f9f9f9; padding: 10px; margin: 10px 0; border-left: 4px solid #2196F3; }
        .resource { background: #e8f5e9; padding: 10px; margin: 10px 0; border-left: 4px solid #4CAF50; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>vRA Deleted Deployments Report</h1>
    <p>Generated: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')</p>
    <p>Total Deleted Deployments: $($allDeletedDeployments.Count)</p>
"@
    
    foreach ($dep in $allDeletedDeployments) {
        $html += @"
    <div class="deployment">
        <h2>$($dep.ItemName)</h2>
        <div class="info"><span class="label">Deployment ID:</span> <span class="value">$($dep.DeploymentID)</span></div>
        <div class="info"><span class="label">Catalog Item:</span> <span class="value">$($dep.CatalogItemName)</span></div>
        <div class="info"><span class="label">Status:</span> <span class="value">$($dep.Status)</span></div>
        <div class="info"><span class="label">Requested By:</span> <span class="value">$($dep.RequestedBy)</span></div>
        <div class="info"><span class="label">Created:</span> <span class="value">$($dep.CreatedAt)</span></div>
        <div class="info"><span class="label">Deleted:</span> <span class="value">$($dep.DeletedAt)</span></div>
        
        <h3>Resources</h3>
"@
        
        if ($dep.Resources) {
            foreach ($res in $dep.Resources) {
                $html += @"
        <div class="resource">
            <strong>$($res.name)</strong> ($($res.type))<br>
            ID: $($res.id)<br>
            State: $($res.state)
        </div>
"@
            }
        }
        
        $html += @"
        <h3>Request History</h3>
"@
        
        if ($dep.RequestHistory) {
            foreach ($req in $dep.RequestHistory) {
                $html += @"
        <div class="event">
            <strong>$($req.name)</strong><br>
            Action: $($req.actionId)<br>
            Status: $($req.status)<br>
            Created: $($req.createdAt)
        </div>
"@
            }
        }
        
        $html += "</div>"
    }
    
    $html += @"
</body>
</html>
"@
    
    $html | Out-File -FilePath $outputHtml -Encoding UTF8
    Write-Log "HTML report created: $outputHtml" "SUCCESS"
    
    # Open HTML report
    Start-Process $outputHtml
}
else {
    Write-Log "No deleted deployments found!" "WARN"
}

Write-Log "`n===== Script Completed =====" "SUCCESS"
Write-Log "JSON Output: $outputJson"
Write-Log "HTML Report: $outputHtml"
Write-Log "Log file: $outputLog"
