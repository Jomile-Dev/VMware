# vRA Deleted Deployments - Alternative API Approaches
# Since request-service API is not available, trying alternative methods

# Configuration
$vraServer = "vra1.yourdomain.com"
$daysBack = 1

# FILTER CONFIGURATION
$filterTemplateNames = @("Virtual Machine", "Database")

# Output
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputJson = "C:\Logs\DeletedDeployments_$timestamp.json"
$outputLog = "C:\Logs\DeletedDeployments_$timestamp.log"
$outputCsv = "C:\Logs\DeletedDeployments_$timestamp.csv"

function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] [$Level] $Message"
    
    $color = switch ($Level) {
        "ERROR" { "Red" }
        "WARN" { "Yellow" }
        "SUCCESS" { "Green" }
        default { "Cyan" }
    }
    
    Write-Host $logMessage -ForegroundColor $color
    Add-Content -Path $outputLog -Value $logMessage
}

function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type @"
using System.Net;
using System.Security.Cryptography.X509Certificates;
public class TrustAllCertsPolicy : ICertificatePolicy {
    public bool CheckValidationResult(
        ServicePoint svcPoint, X509Certificate certificate,
        WebRequest request, int certificateProblem) {
        return true;
    }
}
"@
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
}

Write-Log "===== vRA Deleted Deployments - Alternative API Methods =====" "SUCCESS"
Disable-SSLValidation

# Ensure log directory exists
$logDir = Split-Path $outputJson -Parent
if (!(Test-Path $logDir)) {
    New-Item -ItemType Directory -Path $logDir -Force | Out-Null
}

# Get credentials
Write-Log "`nRequesting credentials..."
$credential = Get-Credential -Message "Enter credentials for vRA"
if (-not $credential) {
    Write-Log "Credentials not provided. Exiting." "ERROR"
    exit
}
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

# Authenticate to vRA
Write-Log "Authenticating to vRA: $vraServer"
try {
    $vraAuthUri = "https://$vraServer/csp/gateway/am/api/login"
    $vraAuthBody = @{
        username = $username
        password = $password
    } | ConvertTo-Json
    
    $vraAuthHeaders = @{
        "Content-Type" = "application/json"
        "Accept" = "application/json"
    }
    
    $vraAuthResponse = Invoke-RestMethod -Uri $vraAuthUri -Method Post -Headers $vraAuthHeaders -Body $vraAuthBody -ErrorAction Stop
    $vraToken = $vraAuthResponse.cspAuthToken
    Write-Log "Authenticated to vRA successfully" "SUCCESS"
}
catch {
    Write-Log "Failed to authenticate to vRA: $($_.Exception.Message)" "ERROR"
    exit
}

$vraHeaders = @{
    "Authorization" = "Bearer $vraToken"
    "Content-Type" = "application/json"
    "Accept" = "application/json"
}

$cutoffDate = (Get-Date).AddDays(-$daysBack)
$deletedDeploymentDetails = @()

# ===== APPROACH 1: Try Deployment Events API =====
Write-Log "`n===== APPROACH 1: Trying Deployment Events API =====" "SUCCESS"
$eventsUri = "https://$vraServer/deployment/api/events?`$top=1000"
Write-Log "Testing: $eventsUri"

try {
    $eventsResponse = Invoke-RestMethod -Uri $eventsUri -Method Get -Headers $vraHeaders -ErrorAction Stop
    $allEvents = if ($eventsResponse.content) { $eventsResponse.content } else { $eventsResponse }
    
    Write-Log "SUCCESS: Events API accessible - Retrieved $($allEvents.Count) events" "SUCCESS"
    
    # Show sample event structure
    if ($allEvents.Count -gt 0) {
        Write-Log "`nSample event structure (first event):"
        $allEvents[0].PSObject.Properties | ForEach-Object {
            if ($_.Value -is [string] -or $_.Value -is [int] -or $_.Value -is [bool] -or $null -eq $_.Value) {
                Write-Log "  $($_.Name) = $($_.Value)"
            } else {
                Write-Log "  $($_.Name) = [Complex: $($_.Value.GetType().Name)]"
            }
        }
    }
    
    # Filter for delete events
    Write-Log "`nFiltering for DELETE events..."
    $deleteEvents = $allEvents | Where-Object {
        $isDelete = (
            $_.eventType -match "DELETE" -or
            $_.eventType -match "DESTROY" -or
            $_.eventType -match "REMOVE" -or
            ($_.description -and $_.description -match "delet")
        )
        
        $withinTimeRange = $true
        if ($_.createdAt) {
            try {
                $eventDate = [DateTime]$_.createdAt
                $withinTimeRange = ($eventDate -ge $cutoffDate)
            } catch {}
        }
        
        $isDelete -and $withinTimeRange
    }
    
    Write-Log "Found $($deleteEvents.Count) DELETE events" "SUCCESS"
    
    foreach ($event in $deleteEvents) {
        Write-Log "`nDelete Event Found:"
        Write-Log "  Event Type: $($event.eventType)"
        Write-Log "  Description: $($event.description)"
        Write-Log "  Created At: $($event.createdAt)"
        Write-Log "  User: $($event.user)"
        
        $deleteInfo = [PSCustomObject]@{
            Source = "Events API"
            EventType = $event.eventType
            Description = $event.description
            DeploymentId = $event.deploymentId
            DeploymentName = $event.deploymentName
            User = $event.user
            CreatedAt = $event.createdAt
            FullEvent = $event
        }
        
        $deletedDeploymentDetails += $deleteInfo
    }
}
catch {
    Write-Log "Events API not accessible: $($_.Exception.Message)" "WARN"
}

# ===== APPROACH 2: Try Deployments API with expand/filter =====
Write-Log "`n===== APPROACH 2: Trying Deployments API (checking for deleted flag) =====" "SUCCESS"
$deploymentsUri = "https://$vraServer/deployment/api/deployments?`$top=1000"
Write-Log "Testing: $deploymentsUri"

try {
    $deploymentsResponse = Invoke-RestMethod -Uri $deploymentsUri -Method Get -Headers $vraHeaders -ErrorAction Stop
    $allDeployments = if ($deploymentsResponse.content) { $deploymentsResponse.content } else { $deploymentsResponse }
    
    Write-Log "SUCCESS: Deployments API accessible - Retrieved $($allDeployments.Count) deployments" "SUCCESS"
    
    # Show sample deployment structure
    if ($allDeployments.Count -gt 0) {
        Write-Log "`nSample deployment fields:"
        $allDeployments[0].PSObject.Properties | ForEach-Object {
            Write-Log "  $($_.Name)"
        }
    }
    
    # Look for deleted/archived deployments
    Write-Log "`nLooking for deleted/archived deployments..."
    $possibleDeleted = $allDeployments | Where-Object {
        $_.status -match "DELETE" -or 
        $_.status -match "DESTROY" -or
        $_.status -eq "ARCHIVED" -or
        $_.lastUpdatedAt -and ([DateTime]$_.lastUpdatedAt -ge $cutoffDate)
    }
    
    Write-Log "Found $($possibleDeleted.Count) deployments with DELETE/DESTROY/ARCHIVED status or recent updates" "SUCCESS"
    
    foreach ($dep in $possibleDeleted) {
        Write-Log "`nDeployment: $($dep.name)"
        Write-Log "  Status: $($dep.status)"
        Write-Log "  Last Updated: $($dep.lastUpdatedAt)"
        
        # Apply template filter
        $matchesFilter = $false
        if ($dep.blueprintId -or $dep.catalogItemId) {
            # We'd need to resolve these IDs to names, but adding to output anyway
            $matchesFilter = $true
        }
        
        $deleteInfo = [PSCustomObject]@{
            Source = "Deployments API"
            DeploymentId = $dep.id
            DeploymentName = $dep.name
            Status = $dep.status
            BlueprintId = $dep.blueprintId
            CatalogItemId = $dep.catalogItemId
            Owner = $dep.ownedBy
            LastUpdatedAt = $dep.lastUpdatedAt
            LastUpdatedBy = $dep.lastUpdatedBy
            FullDeployment = $dep
        }
        
        $deletedDeploymentDetails += $deleteInfo
    }
}
catch {
    Write-Log "Deployments API query failed: $($_.Exception.Message)" "WARN"
}

# ===== APPROACH 3: Try Audit Logs API =====
Write-Log "`n===== APPROACH 3: Trying Audit/Activity Logs API =====" "SUCCESS"

$auditEndpoints = @(
    "https://$vraServer/audit/api/events?`$top=1000",
    "https://$vraServer/api/audit/events?`$top=1000",
    "https://$vraServer/deployment/api/audit/events?`$top=1000"
)

foreach ($auditUri in $auditEndpoints) {
    Write-Log "Testing: $auditUri"
    try {
        $auditResponse = Invoke-RestMethod -Uri $auditUri -Method Get -Headers $vraHeaders -ErrorAction Stop
        Write-Log "SUCCESS: Audit endpoint accessible!" "SUCCESS"
        
        $auditEvents = if ($auditResponse.content) { $auditResponse.content } else { $auditResponse }
        Write-Log "Retrieved $($auditEvents.Count) audit events" "SUCCESS"
        
        # Show sample structure
        if ($auditEvents.Count -gt 0) {
            Write-Log "`nSample audit event structure:"
            $auditEvents[0].PSObject.Properties | ForEach-Object {
                Write-Log "  $($_.Name)"
            }
        }
        
        # Filter for delete actions
        $deleteAudits = $auditEvents | Where-Object {
            ($_.action -match "DELETE" -or $_.action -match "DESTROY" -or $_.eventType -match "DELETE") -and
            ($_.timestamp -and ([DateTime]$_.timestamp -ge $cutoffDate))
        }
        
        Write-Log "Found $($deleteAudits.Count) DELETE audit events" "SUCCESS"
        
        foreach ($audit in $deleteAudits) {
            Write-Log "`nAudit Event:"
            Write-Log "  Action: $($audit.action)"
            Write-Log "  User: $($audit.user)"
            Write-Log "  Timestamp: $($audit.timestamp)"
            
            $deleteInfo = [PSCustomObject]@{
                Source = "Audit API"
                Action = $audit.action
                User = $audit.user
                Timestamp = $audit.timestamp
                ResourceId = $audit.resourceId
                ResourceName = $audit.resourceName
                FullAudit = $audit
            }
            
            $deletedDeploymentDetails += $deleteInfo
        }
        
        break  # If one endpoint works, don't try others
    }
    catch {
        Write-Log "Not accessible: $($_.Exception.Message)" "WARN"
    }
}

# ===== APPROACH 4: List available API endpoints =====
Write-Log "`n===== APPROACH 4: Discovering Available API Endpoints =====" "SUCCESS"

$discoveryEndpoints = @(
    "https://$vraServer/deployment/api",
    "https://$vraServer/catalog/api",
    "https://$vraServer/iaas/api"
)

foreach ($discUri in $discoveryEndpoints) {
    Write-Log "`nTrying: $discUri"
    try {
        $discResponse = Invoke-RestMethod -Uri $discUri -Method Get -Headers $vraHeaders -ErrorAction Stop
        Write-Log "Accessible - Response type: $($discResponse.GetType().Name)" "SUCCESS"
    }
    catch {
        Write-Log "Not accessible: $($_.Exception.Message)" "WARN"
    }
}

# ===== Summary and Export =====
Write-Log "`n============================================" "SUCCESS"
Write-Log "===== SUMMARY =====" "SUCCESS"
Write-Log "============================================" "SUCCESS"
Write-Log "Total deleted deployment records found: $($deletedDeploymentDetails.Count)" "SUCCESS"

if ($deletedDeploymentDetails.Count -gt 0) {
    # Export full JSON
    $deletedDeploymentDetails | ConvertTo-Json -Depth 20 | Out-File -FilePath $outputJson -Encoding UTF8
    Write-Log "Full JSON exported to: $outputJson" "SUCCESS"
    
    # Export CSV
    $deletedDeploymentDetails | Select-Object Source, DeploymentName, EventType, Action, User, CreatedAt, Timestamp |
        Export-Csv -Path $outputCsv -NoTypeInformation -Encoding UTF8
    Write-Log "CSV summary exported to: $outputCsv" "SUCCESS"
    
    # Display summary
    Write-Log "`n=== DELETED DEPLOYMENTS FOUND ===" "SUCCESS"
    $deletedDeploymentDetails | ForEach-Object {
        Write-Log "`n[$($_.Source)] $($_.DeploymentName)" "SUCCESS"
        if ($_.User) { Write-Log "  User: $($_.User)" }
        if ($_.CreatedAt) { Write-Log "  Date: $($_.CreatedAt)" }
        if ($_.Timestamp) { Write-Log "  Date: $($_.Timestamp)" }
    }
}
else {
    Write-Log "`nNO DELETE RECORDS FOUND!" "WARN"
    Write-Log "`nPossible reasons:" "WARN"
    Write-Log "  1. No deployments were deleted in the past $daysBack day(s)" "WARN"
    Write-Log "  2. The APIs that track deletions are not accessible" "WARN"
    Write-Log "  3. vRA may not retain deletion history in accessible APIs" "WARN"
    Write-Log "`nAlternative options:" "WARN"
    Write-Log "  - Check vRealize Log Insight for deletion logs" "WARN"
    Write-Log "  - Query vRA database directly (requires DB access)" "WARN"
    Write-Log "  - Use vRealize Orchestrator workflows/logs" "WARN"
    Write-Log "  - Contact VMware support for guidance on your vRA version" "WARN"
}

Write-Log "`n===== Script Completed =====" "SUCCESS"
Write-Log "Log file: $outputLog"
