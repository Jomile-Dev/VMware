# vRA Deleted Requests Data Explorer
# This script fetches and displays detailed information about deleted deployment requests

# Configuration
$vraServer = "vra1.yourdomain.com"
$daysBack = 1

# Output
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputJson = "C:\Logs\DeletedRequests_$timestamp.json"
$outputLog = "C:\Logs\DeletedRequests_$timestamp.log"

function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] [$Level] $Message"
    
    $color = switch ($Level) {
        "ERROR" { "Red" }
        "WARN" { "Yellow" }
        "SUCCESS" { "Green" }
        default { "Cyan" }
    }
    
    Write-Host $logMessage -ForegroundColor $color
    Add-Content -Path $outputLog -Value $logMessage
}

function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type @"
using System.Net;
using System.Security.Cryptography.X509Certificates;
public class TrustAllCertsPolicy : ICertificatePolicy {
    public bool CheckValidationResult(
        ServicePoint svcPoint, X509Certificate certificate,
        WebRequest request, int certificateProblem) {
        return true;
    }
}
"@
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
}

Write-Log "===== vRA Deleted Requests Explorer Started =====" "SUCCESS"
Disable-SSLValidation

# Ensure log directory exists
$logDir = Split-Path $outputJson -Parent
if (!(Test-Path $logDir)) {
    New-Item -ItemType Directory -Path $logDir -Force | Out-Null
}

# Get credentials
Write-Log "Requesting credentials..."
$credential = Get-Credential -Message "Enter credentials for vRA"
if (-not $credential) {
    Write-Log "Credentials not provided. Exiting." "ERROR"
    exit
}
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

# Authenticate to vRA
Write-Log "Authenticating to vRA: $vraServer"
try {
    $vraAuthUri = "https://$vraServer/csp/gateway/am/api/login"
    $vraAuthBody = @{
        username = $username
        password = $password
    } | ConvertTo-Json
    
    $vraAuthHeaders = @{
        "Content-Type" = "application/json"
        "Accept" = "application/json"
    }
    
    $vraAuthResponse = Invoke-RestMethod -Uri $vraAuthUri -Method Post -Headers $vraAuthHeaders -Body $vraAuthBody -ErrorAction Stop
    $vraToken = $vraAuthResponse.cspAuthToken
    Write-Log "Authenticated to vRA successfully" "SUCCESS"
}
catch {
    Write-Log "Failed to authenticate to vRA: $($_.Exception.Message)" "ERROR"
    exit
}

$vraHeaders = @{
    "Authorization" = "Bearer $vraToken"
    "Content-Type" = "application/json"
}

# Fetch deployment requests
Write-Log "`n===== Fetching Deployment Requests ====="
$requestsUri = "https://$vraServer/deployment/api/deployments/requests"
$cutoffDate = (Get-Date).AddDays(-$daysBack)
Write-Log "Looking for requests from: $cutoffDate"
Write-Log "Request API URL: $requestsUri"

$allDeleteRequests = @()
$allRequests = @()
$page = 0
$size = 100

try {
    do {
        $pagedUri = "$requestsUri`?page=$page&size=$size"
        Write-Log "Fetching requests page $($page + 1)..."
        Write-Log "  Full URL: $pagedUri"
        
        $response = Invoke-RestMethod -Uri $pagedUri -Method Get -Headers $vraHeaders -ErrorAction Stop
        
        if ($response.content) {
            $requests = $response.content
        } 
        else {
            $requests = $response
        }
        
        Write-Log "  Retrieved $($requests.Count) requests on page $($page + 1)" "SUCCESS"
        
        # Store all requests for inspection
        $allRequests += $requests
        
        # Show ALL action types found
        $actionTypes = $requests | Select-Object -ExpandProperty actionId -Unique
        Write-Log "  Action types on this page: $($actionTypes -join ', ')"
        
        # Show counts by action type
        $actionCounts = $requests | Group-Object -Property actionId | Select-Object Name, Count
        foreach ($ac in $actionCounts) {
            Write-Log "    $($ac.Name): $($ac.Count)"
        }
        
        # Filter for DELETE requests
        foreach ($req in $requests) {
            Write-Log "`n  Processing request:"
            Write-Log "    Action: $($req.actionId)"
            Write-Log "    Status: $($req.status)"
            Write-Log "    Deployment: $($req.deploymentName)"
            Write-Log "    Requested By: $($req.requestedBy)"
            Write-Log "    Completed At: $($req.completedAt)"
            
            if ($req.actionId -eq "Deployment.Delete") {
                Write-Log "    >> This is a DELETE action" "SUCCESS"
                
                if ($req.status -eq "SUCCESSFUL") {
                    Write-Log "    >> DELETE was SUCCESSFUL" "SUCCESS"
                    
                    if ($req.completedAt) {
                        $completedAt = [DateTime]$req.completedAt
                        Write-Log "    >> Completed at: $completedAt"
                        Write-Log "    >> Cutoff date: $cutoffDate"
                        
                        if ($completedAt -ge $cutoffDate) {
                            Write-Log "    >> MATCHES TIME CRITERIA - Including in results" "SUCCESS"
                            
                            # Fetch request details
                            try {
                                $requestId = $req.id
                                $requestDetailUri = "https://$vraServer/deployment/api/deployments/requests/$requestId"
                                Write-Log "    >> Fetching details from: $requestDetailUri"
                                
                                $requestDetail = Invoke-RestMethod -Uri $requestDetailUri -Method Get -Headers $vraHeaders -ErrorAction Stop
                                
                                # Create detailed object
                                $deleteInfo = [PSCustomObject]@{
                                    RequestId = $req.id
                                    DeploymentId = $req.deploymentId
                                    DeploymentName = $req.deploymentName
                                    ActionId = $req.actionId
                                    Status = $req.status
                                    RequestedBy = $req.requestedBy
                                    CompletedAt = $req.completedAt
                                    RequestDetails = $requestDetail
                                }
                                
                                $allDeleteRequests += $deleteInfo
                                Write-Log "    >> Successfully added to results" "SUCCESS"
                                
                            }
                            catch {
                                Write-Log "    >> ERROR fetching details: $($_.Exception.Message)" "ERROR"
                            }
                        }
                        else {
                            Write-Log "    >> TOO OLD - Skipping" "WARN"
                        }
                    }
                    else {
                        Write-Log "    >> No completedAt timestamp - Skipping" "WARN"
                    }
                }
                else {
                    Write-Log "    >> DELETE status is: $($req.status) - Skipping" "WARN"
                }
            }
        }
        
        $page++
        $hasMore = $false
        
        if ($response.totalPages) { 
            $hasMore = ($page -lt $response.totalPages)
            Write-Log "`n  Page $page of $($response.totalPages) total pages"
        } 
        elseif ($response.totalElements) { 
            $hasMore = (($page * $size) -lt $response.totalElements)
            Write-Log "`n  Retrieved $($page * $size) of $($response.totalElements) total elements"
        } 
        else { 
            $hasMore = ($requests.Count -eq $size)
        }
        
        if ($hasMore) {
            Write-Log "  More pages available, continuing..."
        }
        else {
            Write-Log "  No more pages to fetch"
        }
        
    } while ($hasMore)
    
    Write-Log "`n===== Summary =====" "SUCCESS"
    Write-Log "Total requests fetched: $($allRequests.Count)" "SUCCESS"
    Write-Log "Total DELETE requests found: $($allDeleteRequests.Count)" "SUCCESS"
    
    # Save all requests too for debugging
    $allRequestsJson = "C:\Logs\AllRequests_$timestamp.json"
    $allRequests | ConvertTo-Json -Depth 10 | Out-File -FilePath $allRequestsJson -Encoding UTF8
    Write-Log "All requests exported to: $allRequestsJson" "SUCCESS"
    
    # Export to JSON for detailed inspection
    $allDeleteRequests | ConvertTo-Json -Depth 10 | Out-File -FilePath $outputJson -Encoding UTF8
    Write-Log "Detailed data exported to: $outputJson" "SUCCESS"
    
    # Display summary of what's in the request details
    Write-Log "`n===== Analyzing Request Structure ====="
    
    if ($allDeleteRequests.Count -gt 0) {
        $sampleRequest = $allDeleteRequests[0]
        
        Write-Log "`nSample Request Structure:"
        Write-Log "Request ID: $($sampleRequest.RequestId)"
        Write-Log "Deployment Name: $($sampleRequest.DeploymentName)"
        
        if ($sampleRequest.RequestDetails) {
            $details = $sampleRequest.RequestDetails
            
            Write-Log "`nRequest Details Properties:"
            $details | Get-Member -MemberType NoteProperty | ForEach-Object {
                Write-Log "  - $($_.Name)"
            }
            
            if ($details.details) {
                Write-Log "`nDetails.details Properties:"
                $details.details | Get-Member -MemberType NoteProperty | ForEach-Object {
                    Write-Log "    - $($_.Name)"
                }
                
                if ($details.details.resources) {
                    Write-Log "`n  Resources found: $($details.details.resources.Count)"
                    
                    foreach ($resource in $details.details.resources) {
                        Write-Log "`n  Resource Type: $($resource.type)"
                        Write-Log "  Resource Name: $($resource.name)"
                        
                        if ($resource.properties) {
                            Write-Log "  Resource Properties:"
                            $resource.properties | Get-Member -MemberType NoteProperty | ForEach-Object {
                                $propName = $_.Name
                                $propValue = $resource.properties.$propName
                                Write-Log "    - $propName = $propValue"
                            }
                        }
                    }
                }
            }
            
            if ($details.inputs) {
                Write-Log "`nInputs Properties:"
                $details.inputs | Get-Member -MemberType NoteProperty | ForEach-Object {
                    $propName = $_.Name
                    $propValue = $details.inputs.$propName
                    Write-Log "  - $propName = $propValue"
                }
            }
        }
    }
    else {
        Write-Log "No deleted requests found in the last $daysBack day(s)" "WARN"
    }
}
catch {
    Write-Log "Error fetching requests: $($_.Exception.Message)" "ERROR"
    Write-Log "Error details: $($_.Exception)" "ERROR"
}

Write-Log "`n===== Script Completed =====" "SUCCESS"
Write-Log "All requests JSON: $allRequestsJson"
Write-Log "Deleted requests JSON: $outputJson"
Write-Log "Log file: $outputLog"
