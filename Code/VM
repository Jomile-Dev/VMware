# vRA Deep-Dive: Metadata + History + Logs
# Fixed: Null Path Error & Purge Handling

# --- Configuration ---
$vraServer = "vra1.yourdomain.com"
$apiVersion = "2020-08-25" 
$daysBack   = 30 
$filterKeywords = @("Virtual Machine", "Database")

# --- 1. Fix: Ensure Log Path Exists ---
$logDir = "C:\Logs"
if (!(Test-Path $logDir)) { New-Item -ItemType Directory -Path $logDir }
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputFile = "$logDir\vRA_Full_History_$timestamp.log"

# --- Setup & Auth ---
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
# (Disable-SSLValidation function assumed)
$authRes = Invoke-RestMethod -Uri "https://$vraServer/csp/gateway/am/api/login" -Method Post -Headers @{"Content-Type"="application/json"} -Body $authBody
$vraHeaders = @{ "Authorization" = "Bearer $($authRes.cspAuthToken)"; "Content-Type" = "application/json" }

# --- 2. Get Records ---
Write-Host "Searching for deleted records..." -ForegroundColor Cyan
$deployUri = "https://$vraServer/deployment/api/deployments?apiVersion=$apiVersion&deleted=true&`$top=100"
$allDeps = (Invoke-RestMethod -Uri $deployUri -Method Get -Headers $vraHeaders).content

foreach ($dep in $allDeps) {
    # Filters
    if ($dep.status -notmatch "DELETE" -and $dep.status -ne "ARCHIVED") { continue }
    
    Write-Host "`nDEPLOYMENT: $($dep.name)" -ForegroundColor White
    "--- DEPLOYMENT: $($dep.name) (ID: $($dep.id)) ---" | Add-Content $outputFile

    # --- 3. The "GUI History" (Requests) ---
    # This is almost ALWAYS available, even if resources are purged.
    try {
        $reqUri = "https://$vraServer/deployment/api/deployments/$($dep.id)/requests?apiVersion=$apiVersion"
        $requests = (Invoke-RestMethod -Uri $reqUri -Method Get -Headers $vraHeaders).content
        
        foreach ($req in $requests) {
            $msg = "  [Action] $($req.name) | By: $($req.requestedBy) | Status: $($req.status)"
            Write-Host $msg -ForegroundColor Yellow
            $msg | Add-Content $outputFile

            # --- 4. The "Events" (Granular Logs) ---
            try {
                $eventUri = "https://$vraServer/deployment/api/requests/$($req.id)/events?apiVersion=$apiVersion"
                $events = (Invoke-RestMethod -Uri $eventUri -Method Get -Headers $vraHeaders).content
                foreach ($evt in $events) {
                    $logLine = "    > $($evt.timestamp): $($evt.message)"
                    Write-Host $logLine -ForegroundColor DarkGray
                    $logLine | Add-Content $outputFile
                }
            } catch { "    > Technical logs were purged." | Add-Content $outputFile }
        }
    } catch { "  [History] No request history found in DB." | Add-Content $outputFile }
}

Write-Host "`nComplete! Check $outputFile" -ForegroundColor Green
