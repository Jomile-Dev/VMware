# vRA Deleted Requests Data Explorer
# This script fetches and displays detailed information about deleted deployment requests

# Configuration
$vraServer = "vra1.yourdomain.com"
$daysBack = 1

# Output
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputJson = "C:\Logs\DeletedRequests_$timestamp.json"
$outputLog = "C:\Logs\DeletedRequests_$timestamp.log"

function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] [$Level] $Message"
    
    $color = switch ($Level) {
        "ERROR" { "Red" }
        "WARN" { "Yellow" }
        "SUCCESS" { "Green" }
        default { "Cyan" }
    }
    
    Write-Host $logMessage -ForegroundColor $color
    Add-Content -Path $outputLog -Value $logMessage
}

function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type @"
using System.Net;
using System.Security.Cryptography.X509Certificates;
public class TrustAllCertsPolicy : ICertificatePolicy {
    public bool CheckValidationResult(
        ServicePoint svcPoint, X509Certificate certificate,
        WebRequest request, int certificateProblem) {
        return true;
    }
}
"@
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
}

Write-Log "===== vRA Deleted Requests Explorer Started =====" "SUCCESS"
Disable-SSLValidation

# Ensure log directory exists
$logDir = Split-Path $outputJson -Parent
if (!(Test-Path $logDir)) {
    New-Item -ItemType Directory -Path $logDir -Force | Out-Null
}

# Get credentials
Write-Log "Requesting credentials..."
$credential = Get-Credential -Message "Enter credentials for vRA"
if (-not $credential) {
    Write-Log "Credentials not provided. Exiting." "ERROR"
    exit
}
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

# Authenticate to vRA
Write-Log "Authenticating to vRA: $vraServer"
try {
    $vraAuthUri = "https://$vraServer/csp/gateway/am/api/login"
    $vraAuthBody = @{
        username = $username
        password = $password
    } | ConvertTo-Json
    
    $vraAuthHeaders = @{
        "Content-Type" = "application/json"
        "Accept" = "application/json"
    }
    
    $vraAuthResponse = Invoke-RestMethod -Uri $vraAuthUri -Method Post -Headers $vraAuthHeaders -Body $vraAuthBody -ErrorAction Stop
    $vraToken = $vraAuthResponse.cspAuthToken
    Write-Log "Authenticated to vRA successfully" "SUCCESS"
}
catch {
    Write-Log "Failed to authenticate to vRA: $($_.Exception.Message)" "ERROR"
    exit
}

$vraHeaders = @{
    "Authorization" = "Bearer $vraToken"
    "Content-Type" = "application/json"
}

# Fetch deleted deployments directly
Write-Log "`n===== Fetching Deleted Deployments ====="
$deploymentsUri = "https://$vraServer/deployment/api/deployments"
$cutoffDate = (Get-Date).AddDays(-$daysBack)
Write-Log "Looking for deleted deployments from: $cutoffDate"
Write-Log "Deployments API URL: $deploymentsUri"

$allDeletedDeployments = @()
$page = 0
$size = 200

try {
    do {
        # Fetch all deployments, we'll filter in PowerShell
        $pagedUri = "$deploymentsUri`?page=$page&size=$size&expand=resources"
        Write-Log "Fetching deployments page $($page + 1)..."
        Write-Log "  Full URL: $pagedUri"
        
        $response = Invoke-RestMethod -Uri $pagedUri -Method Get -Headers $vraHeaders -ErrorAction Stop
        
        if ($response.content) {
            $deployments = $response.content
        } 
        else {
            $deployments = $response
        }
        
        Write-Log "  Retrieved $($deployments.Count) deployments on page $($page + 1)" "SUCCESS"
        
        if ($deployments.Count -eq 0) {
            Write-Log "  No deployments found, stopping pagination"
            break
        }
        
        # Filter for DELETED status
        $deletedOnPage = 0
        foreach ($dep in $deployments) {
            if ($dep.status -eq "DELETED") {
                Write-Log "`n  Found DELETED deployment:"
                Write-Log "    Name: $($dep.name)"
                Write-Log "    ID: $($dep.id)"
                Write-Log "    Status: $($dep.status)"
                Write-Log "    Last Updated: $($dep.lastUpdatedAt)"
                Write-Log "    Created By: $($dep.createdBy)"
                Write-Log "    Owned By: $($dep.ownedBy)"
                
                # Check if recently deleted
                if ($dep.lastUpdatedAt) {
                    $lastUpdated = [DateTime]$dep.lastUpdatedAt
                    
                    if ($lastUpdated -ge $cutoffDate) {
                        Write-Log "    >> Recently deleted (within $daysBack days)" "SUCCESS"
                        
                        # Check for resources
                        if ($dep.resources) {
                            Write-Log "    >> Has $($dep.resources.Count) resources" "SUCCESS"
                            
                            foreach ($res in $dep.resources) {
                                if ($res.type -eq "Cloud.vSphere.Machine") {
                                    Write-Log "      Resource Type: $($res.type)"
                                    Write-Log "      Resource Name: $($res.name)"
                                    
                                    if ($res.properties) {
                                        Write-Log "      Properties:"
                                        $res.properties | Get-Member -MemberType NoteProperty | ForEach-Object {
                                            $propName = $_.Name
                                            $propValue = $res.properties.$propName
                                            Write-Log "        - $propName = $propValue"
                                        }
                                    }
                                }
                            }
                        }
                        else {
                            Write-Log "    >> No resources found - deployment may be fully deleted" "WARN"
                        }
                        
                        # Check custom properties
                        if ($dep.customProperties) {
                            Write-Log "    Custom Properties:"
                            $dep.customProperties | Get-Member -MemberType NoteProperty | ForEach-Object {
                                $propName = $_.Name
                                $propValue = $dep.customProperties.$propName
                                Write-Log "      - $propName = $propValue"
                            }
                        }
                        
                        # Check inputs
                        if ($dep.inputs) {
                            Write-Log "    Inputs:"
                            $dep.inputs | Get-Member -MemberType NoteProperty | ForEach-Object {
                                $propName = $_.Name
                                $propValue = $dep.inputs.$propName
                                Write-Log "      - $propName = $propValue"
                            }
                        }
                        
                        $allDeletedDeployments += $dep
                        $deletedOnPage++
                    }
                    else {
                        Write-Log "    >> Too old - deleted before cutoff date" "WARN"
                    }
                }
            }
        }
        
        Write-Log "  Found $deletedOnPage recently deleted deployments on this page"
        
        $page++
        $hasMore = $false
        
        if ($response.totalPages) { 
            $hasMore = ($page -lt $response.totalPages)
            Write-Log "`n  Page $page of $($response.totalPages) total pages"
        } 
        elseif ($response.totalElements) { 
            $hasMore = (($page * $size) -lt $response.totalElements)
            Write-Log "`n  Retrieved $($page * $size) of $($response.totalElements) total elements"
        } 
        else { 
            $hasMore = ($deployments.Count -eq $size)
        }
        
        if ($hasMore) {
            Write-Log "  More pages available, continuing..."
        }
        else {
            Write-Log "  No more pages to fetch"
        }
        
    } while ($hasMore)
    
    Write-Log "`n===== Summary =====" "SUCCESS"
    Write-Log "Total recently deleted deployments found: $($allDeletedDeployments.Count)" "SUCCESS"
    
    # Export to JSON for detailed inspection
    $allDeletedDeployments | ConvertTo-Json -Depth 10 | Out-File -FilePath $outputJson -Encoding UTF8
    Write-Log "Detailed data exported to: $outputJson" "SUCCESS"
    
    if ($allDeletedDeployments.Count -eq 0) {
        Write-Log "No recently deleted deployments found in the last $daysBack day(s)" "WARN"
    }
}
catch {
    Write-Log "Error fetching deployments: $($_.Exception.Message)" "ERROR"
    Write-Log "Error details: $($_.Exception)" "ERROR"
}

Write-Log "`n===== Script Completed =====" "SUCCESS"
Write-Log "Deleted deployments JSON: $outputJson"
Write-Log "Log file: $outputLog"
