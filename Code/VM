# vRA Request-Service API Validation Script
# First validates that request-service endpoint is accessible before proceeding

# Configuration
$vraServer = "vra1.yourdomain.com"
$daysBack = 1

# FILTER CONFIGURATION
$filterTemplateNames = @("Virtual Machine", "Database")

# Output
$timestamp = Get-Date -Format 'yyyyMMdd_HHmmss'
$outputJson = "C:\Logs\DeletedDeployments_$timestamp.json"
$outputLog = "C:\Logs\DeletedDeployments_$timestamp.log"
$outputCsv = "C:\Logs\DeletedDeployments_$timestamp.csv"

function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] [$Level] $Message"
    
    $color = switch ($Level) {
        "ERROR" { "Red" }
        "WARN" { "Yellow" }
        "SUCCESS" { "Green" }
        default { "Cyan" }
    }
    
    Write-Host $logMessage -ForegroundColor $color
    Add-Content -Path $outputLog -Value $logMessage
}

function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type @"
using System.Net;
using System.Security.Cryptography.X509Certificates;
public class TrustAllCertsPolicy : ICertificatePolicy {
    public bool CheckValidationResult(
        ServicePoint svcPoint, X509Certificate certificate,
        WebRequest request, int certificateProblem) {
        return true;
    }
}
"@
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
}

Write-Log "===== vRA Request-Service API Validation =====" "SUCCESS"
Disable-SSLValidation

# Ensure log directory exists
$logDir = Split-Path $outputJson -Parent
if (!(Test-Path $logDir)) {
    New-Item -ItemType Directory -Path $logDir -Force | Out-Null
}

# Get credentials
Write-Log "`nRequesting credentials..."
$credential = Get-Credential -Message "Enter credentials for vRA"
if (-not $credential) {
    Write-Log "Credentials not provided. Exiting." "ERROR"
    exit
}
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

# Authenticate to vRA
Write-Log "Authenticating to vRA: $vraServer"
try {
    $vraAuthUri = "https://$vraServer/csp/gateway/am/api/login"
    $vraAuthBody = @{
        username = $username
        password = $password
    } | ConvertTo-Json
    
    $vraAuthHeaders = @{
        "Content-Type" = "application/json"
        "Accept" = "application/json"
    }
    
    $vraAuthResponse = Invoke-RestMethod -Uri $vraAuthUri -Method Post -Headers $vraAuthHeaders -Body $vraAuthBody -ErrorAction Stop
    $vraToken = $vraAuthResponse.cspAuthToken
    Write-Log "Authenticated to vRA successfully" "SUCCESS"
}
catch {
    Write-Log "Failed to authenticate to vRA: $($_.Exception.Message)" "ERROR"
    exit
}

$vraHeaders = @{
    "Authorization" = "Bearer $vraToken"
    "Content-Type" = "application/json"
    "Accept" = "application/json"
}

# ===== VALIDATION STEP =====
Write-Log "`n===== VALIDATING REQUEST-SERVICE API ENDPOINT =====" "SUCCESS"

$testEndpoint = "https://$vraServer/request-service/api/requests?`$top=5"
Write-Log "Testing endpoint: $testEndpoint"

try {
    $testResponse = Invoke-RestMethod -Uri $testEndpoint -Method Get -Headers $vraHeaders -ErrorAction Stop
    Write-Log "SUCCESS: request-service API is accessible!" "SUCCESS"
    Write-Log "Response contains $($testResponse.content.Count) requests" "SUCCESS"
    
    # Show sample request structure
    if ($testResponse.content -and $testResponse.content.Count -gt 0) {
        Write-Log "`nSample request fields available:"
        $testResponse.content[0].PSObject.Properties | ForEach-Object {
            Write-Log "  - $($_.Name)"
        }
    }
    
    Write-Log "`nValidation passed - proceeding with main script..." "SUCCESS"
}
catch {
    $statusCode = $_.Exception.Response.StatusCode.value__
    Write-Log "FAILED: request-service API returned error" "ERROR"
    Write-Log "Status Code: $statusCode" "ERROR"
    Write-Log "Error Message: $($_.Exception.Message)" "ERROR"
    
    Write-Log "`n===== ENDPOINT NOT AVAILABLE =====" "ERROR"
    Write-Log "The request-service API is not exposed/accessible in your vRA environment." "ERROR"
    Write-Log "`nAlternative approaches to find deleted deployments:" "WARN"
    Write-Log "  1. Check vRA audit logs/events API" "WARN"
    Write-Log "  2. Use deployment API with includeDeleted parameter (if supported)" "WARN"
    Write-Log "  3. Query vRO workflows that handle deletions" "WARN"
    Write-Log "  4. Check vRA database directly (if you have access)" "WARN"
    Write-Log "  5. Use vRealize Log Insight for deletion events" "WARN"
    
    Write-Log "`nWould you like me to create a script using an alternative API?" "WARN"
    exit
}

# ===== MAIN SCRIPT LOGIC (only runs if validation passed) =====

$cutoffDate = (Get-Date).AddDays(-$daysBack)
Write-Log "`n===== Querying for DELETE Requests ====="
Write-Log "Looking for delete requests from: $cutoffDate"
Write-Log "Filter: Templates containing: $($filterTemplateNames -join ' OR ')" "WARN"

$deletedDeploymentDetails = @()

try {
    # Fetch all recent requests
    $reqSvcUri = "https://$vraServer/request-service/api/requests?`$top=5000&`$orderby=dateSubmitted desc"
    Write-Log "Fetching requests: $reqSvcUri"
    
    $reqSvcResponse = Invoke-RestMethod -Uri $reqSvcUri -Method Get -Headers $vraHeaders -ErrorAction Stop
    $allRequests = if ($reqSvcResponse.content) { $reqSvcResponse.content } else { $reqSvcResponse }
    
    Write-Log "Retrieved $($allRequests.Count) total requests" "SUCCESS"
    
    # Filter for DELETE requests
    $deleteRequests = $allRequests | Where-Object {
        $isDelete = (
            $_.requestType -eq "DELETE_DEPLOYMENT" -or
            $_.requestType -match "DELETE" -or
            $_.phase -match "DELETE" -or
            ($_.requestedItemName -and $_.requestedItemName -match "Delete")
        )
        
        $withinTimeRange = $true
        if ($_.dateSubmitted) {
            try {
                $submitDate = [DateTime]$_.dateSubmitted
                $withinTimeRange = ($submitDate -ge $cutoffDate)
            } catch {
                $withinTimeRange = $true
            }
        }
        
        $isDelete -and $withinTimeRange
    }
    
    Write-Log "Found $($deleteRequests.Count) DELETE requests in time range" "SUCCESS"
    
    if ($deleteRequests.Count -eq 0) {
        Write-Log "No DELETE requests found." "WARN"
        Write-Log "Showing sample of available request types:" "WARN"
        $allRequests | Select-Object -First 10 | ForEach-Object {
            Write-Log "  $($_.requestType) - $($_.requestedItemName) (Date: $($_.dateSubmitted))"
        }
    }
    
    # Process each DELETE request
    $processedCount = 0
    foreach ($delReq in $deleteRequests) {
        $processedCount++
        
        Write-Log "`n[$processedCount/$($deleteRequests.Count)] Processing: $($delReq.requestedItemName)" "SUCCESS"
        
        # Get full request details
        $fullRequest = $null
        $catalogItemName = $null
        $blueprintName = $null
        
        try {
            $fullReqUri = "https://$vraServer/request-service/api/requests/$($delReq.id)"
            $fullRequest = Invoke-RestMethod -Uri $fullReqUri -Method Get -Headers $vraHeaders -ErrorAction Stop
            
            # Extract catalog item or blueprint information
            if ($fullRequest.requestData) {
                $fullRequest.requestData.PSObject.Properties | ForEach-Object {
                    if ($_.Name -match "catalogItem" -or $_.Name -match "blueprint") {
                        if ($_.Value -is [string]) {
                            try {
                                if ($_.Name -match "catalogItem") {
                                    $catItemUri = "https://$vraServer/catalog/api/items/$($_.Value)"
                                    $catItem = Invoke-RestMethod -Uri $catItemUri -Method Get -Headers $vraHeaders -ErrorAction Stop
                                    $catalogItemName = $catItem.name
                                    Write-Log "  Catalog Item: $catalogItemName"
                                }
                                elseif ($_.Name -match "blueprint") {
                                    $bpUri = "https://$vraServer/blueprint/api/blueprints/$($_.Value)"
                                    $bp = Invoke-RestMethod -Uri $bpUri -Method Get -Headers $vraHeaders -ErrorAction Stop
                                    $blueprintName = $bp.name
                                    Write-Log "  Blueprint: $blueprintName"
                                }
                            }
                            catch {
                                Write-Log "  Could not resolve template name" "WARN"
                            }
                        }
                    }
                }
            }
        }
        catch {
            Write-Log "  Could not fetch full request details: $($_.Exception.Message)" "WARN"
        }
        
        # Determine template name for filtering
        $templateName = $catalogItemName ?? $blueprintName ?? $delReq.requestedItemName
        
        # Apply filter
        $matchesFilter = $false
        if ($templateName) {
            foreach ($filterName in $filterTemplateNames) {
                if ($templateName -match $filterName) {
                    $matchesFilter = $true
                    Write-Log "  >>> MATCHES FILTER: '$filterName' <<<" "SUCCESS"
                    break
                }
            }
        }
        
        if (-not $matchesFilter) {
            Write-Log "  Skipping: Template '$templateName' doesn't match filter" "WARN"
            continue
        }
        
        # Create detailed output object
        $deleteInfo = [PSCustomObject]@{
            RequestNumber = $delReq.requestNumber
            RequestID = $delReq.id
            RequestType = $delReq.requestType
            ItemName = $delReq.requestedItemName
            TemplateName = $templateName
            CatalogItemName = $catalogItemName
            BlueprintName = $blueprintName
            Phase = $delReq.phase
            State = $delReq.state
            RequestedBy = $delReq.requestedBy
            RequestedFor = $delReq.requestedFor
            DateSubmitted = $delReq.dateSubmitted
            DateCompleted = $delReq.dateCompleted
            BasicRequest = $delReq
            FullRequest = $fullRequest
        }
        
        $deletedDeploymentDetails += $deleteInfo
        Write-Log "  Added to output" "SUCCESS"
    }
    
}
catch {
    Write-Log "ERROR querying request-service: $($_.Exception.Message)" "ERROR"
}

# Summary and Export
Write-Log "`n===== SUMMARY =====" "SUCCESS"
Write-Log "Total DELETE requests found: $($deleteRequests.Count)" 
Write-Log "DELETE requests matching filter: $($deletedDeploymentDetails.Count)" "SUCCESS"

if ($deletedDeploymentDetails.Count -gt 0) {
    # Export full JSON
    $deletedDeploymentDetails | ConvertTo-Json -Depth 20 | Out-File -FilePath $outputJson -Encoding UTF8
    Write-Log "Full JSON exported to: $outputJson" "SUCCESS"
    
    # Export CSV
    $deletedDeploymentDetails | Select-Object RequestNumber, ItemName, TemplateName, RequestedBy, 
        RequestedFor, DateSubmitted, DateCompleted, State | 
        Export-Csv -Path $outputCsv -NoTypeInformation -Encoding UTF8
    Write-Log "CSV summary exported to: $outputCsv" "SUCCESS"
    
    # Display summary
    Write-Log "`n=== DELETED DEPLOYMENTS ===" "SUCCESS"
    $deletedDeploymentDetails | ForEach-Object {
        Write-Log "`nRequest #$($_.RequestNumber): $($_.ItemName)" "SUCCESS"
        Write-Log "  Template: $($_.TemplateName)"
        Write-Log "  Deleted By: $($_.RequestedBy)"
        Write-Log "  Date: $($_.DateSubmitted)"
        Write-Log "  Status: $($_.State)"
    }
}
else {
    Write-Log "`nNO MATCHING DELETE REQUESTS FOUND!" "WARN"
    Write-Log "Adjust `$filterTemplateNames or `$daysBack to broaden search" "WARN"
}

Write-Log "`n===== Script Completed =====" "SUCCESS"
Write-Log "Log file: $outputLog"
