# ============================================================================
# DELETED VM TRACKER - ARIA OPERATIONS + MULTI-VRA + VCENTER
# Version 2.3.0 - PowerShell 5.1 Compatible
# New: CREATE_FAILED deployments now pull FULL request history (create, delete, all actions)
# New: Cloud Resource Name extracted across ALL requests in history, not just CREATE
# New: Match-FailedVMsWithVCenter does explicit name compare between extracted CRN and vCenter events
# New: Each failed VM object carries full RequestHistory timeline for debugging/reporting
# ============================================================================

# ============================================================================
# CONFIGURATION SECTION
# ============================================================================

$ariaOpsServer = "aria-ops.yourdomain.com"
$ariaOpsDomain = "yourdomain.com"
$ariaOpsAuthSource = "localos"

$vraServers = @(
    "vra1.yourdomain.com",
    "vra2.yourdomain.com"
)

$vCenters = @(
    "vcenter1.domain.com",
    "vcenter2.domain.com",
    "vcenter3.domain.com"
)

# EMAIL CONFIGURATION - CRITICAL: Update these values!
$script:smtpServer = "smtp.yourdomain.com"  # CHANGE THIS
$script:smtpPort = 587
$script:smtpFrom = "vra-reports@yourdomain.com"  # CHANGE THIS
$script:smtpTo = @("test.test@email.com")  # CHANGE THIS - Must be an array with at least one email
$script:smtpCc = @("manager@yourdomain.com")  # CHANGE THIS or use @() for none
$script:smtpSubject = "Deleted VM Report - $(Get-Date -Format 'dd-MM-yyyy')"

$daysBack = 1
$eventsPageSize = 200

# PERFORMANCE TUNING: Days to look back for deployment updates (reduces dataset for 10k+ deployments)
# Only deployments updated within this window will be checked for decommissions
# Recommended: 30 days (checks deployments updated in last month)
# Set to 365 to check all deployments from the last year (slower but more thorough)
$deploymentLookbackDays = 30

$debugOutputFile = "DeletedVMs_Debug_$(Get-Date -Format 'yyyyMMdd_HHmmss').txt"

# VERIFY EMAIL CONFIGURATION
Write-Host "=== EMAIL CONFIGURATION CHECK ===" -ForegroundColor Cyan
Write-Host "smtpServer: $script:smtpServer" -ForegroundColor Yellow
Write-Host "smtpPort: $script:smtpPort" -ForegroundColor Yellow
Write-Host "smtpFrom: $script:smtpFrom" -ForegroundColor Yellow
Write-Host "smtpTo: $($script:smtpTo -join ', ')" -ForegroundColor Yellow
Write-Host "smtpTo Type: $($script:smtpTo.GetType().Name)" -ForegroundColor Yellow
Write-Host "smtpTo Count: $($script:smtpTo.Count)" -ForegroundColor Yellow
Write-Host "smtpCc: $($script:smtpCc -join ', ')" -ForegroundColor Yellow
Write-Host "=================================" -ForegroundColor Cyan

if (-not $script:smtpTo -or $script:smtpTo.Count -eq 0) {
    Write-Host "ERROR: Email recipient (smtpTo) is not configured!" -ForegroundColor Red
    Write-Host "Please edit the configuration section at the top of the script." -ForegroundColor Red
    Write-Host "The smtpTo variable must be an array with at least one email address." -ForegroundColor Red
    Write-Host "Example: `$script:smtpTo = @('your.email@domain.com')" -ForegroundColor Red
    exit
}

# Validate email addresses have proper format
foreach ($email in $script:smtpTo) {
    if ($email -notmatch '^[\w\.-]+@[\w\.-]+\.\w+$') {
        Write-Host "ERROR: Invalid email format detected: $email" -ForegroundColor Red
        Write-Host "Please use valid email addresses in the smtpTo array." -ForegroundColor Red
        exit
    }
}

# ============================================================================
# HELPER FUNCTIONS
# ============================================================================

function Write-Log {
    param(
        [string]$Message,
        [string]$Level = "INFO"
    )
    
    $color = switch ($Level) {
        "ERROR" { "Red" }
        "WARN" { "Yellow" }
        "SUCCESS" { "Green" }
        "DEBUG" { "Magenta" }
        default { "Cyan" }
    }
    
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] [$Level] $Message"
    Write-Host $logMessage -ForegroundColor $color
    Add-Content -Path $debugOutputFile -Value $logMessage
}

function Write-DebugSection {
    param([string]$Title)
    
    $separator = "`n" + ("=" * 80) + "`n"
    $header = "$separator$Title$separator"
    Write-Host $header -ForegroundColor Cyan
    Add-Content -Path $debugOutputFile -Value $header
}

function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type @"
using System.Net;
using System.Security.Cryptography.X509Certificates;
public class TrustAllCertsPolicy : ICertificatePolicy {
    public bool CheckValidationResult(
        ServicePoint svcPoint, X509Certificate certificate,
        WebRequest request, int certificateProblem) {
        return true;
    }
}
"@
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
}

function Convert-ToSydneyTime {
    param(
        [string]$DateTimeString
    )
    
    if ([string]::IsNullOrWhiteSpace($DateTimeString) -or $DateTimeString -eq "N/A") {
        return "N/A"
    }
    
    try {
        $utcTime = [DateTime]::Parse($DateTimeString).ToUniversalTime()
        $sydneyTZ = [System.TimeZoneInfo]::FindSystemTimeZoneById("AUS Eastern Standard Time")
        $sydneyTime = [System.TimeZoneInfo]::ConvertTimeFromUtc($utcTime, $sydneyTZ)
        return $sydneyTime.ToString("dd-MM-yyyy HH:mm:ss")
    }
    catch {
        Write-Log "Error converting time '$DateTimeString': $($_.Exception.Message)" "WARN"
        return $DateTimeString
    }
}

# ============================================================================
# SHARED HELPER: Extract Cloud Resource Name from an event's details
# Centralised so every caller uses the exact same priority chain.
# Returns $null if nothing usable is found.
# ============================================================================
function Extract-CloudResourceName {
    param(
        [Parameter(Mandatory=$true)]
        [PSObject]$Event
    )

    $serverName = $null

    # ---------- PRIORITY 1: parse event.details text/JSON ----------
    if ($Event.details) {
        $detailsText = if ($Event.details -is [string]) {
            $Event.details
        } else {
            ($Event.details | ConvertTo-Json -Compress -Depth 5)
        }

        # 1a  "Cloud Resource Name: <name>"  (plain-text label)
        if ($detailsText -match "Cloud Resource Name:\s*([^\s,;]+)") {
            $serverName = $matches[1].Trim()
            Write-Log "      [CRN] Extracted via 'Cloud Resource Name:' pattern: $serverName" "SUCCESS"
        }
        # 1b  JSON property  "cloudResourceName":"<name>"
        elseif ($detailsText -match '"cloudResourceName"\s*:\s*"([^"]+)"') {
            $candidate = $matches[1].Trim()
            if ($candidate -notmatch "Cloud_vSphere_Machine_\d+") {
                $serverName = $candidate
                Write-Log "      [CRN] Extracted via 'cloudResourceName' JSON: $serverName" "SUCCESS"
            }
        }
        # 1c  JSON property  "hostname":"<name>"
        elseif ($detailsText -match '"hostname"\s*:\s*"([^"]+)"') {
            $serverName = $matches[1].Trim()
            Write-Log "      [CRN] Extracted via 'hostname' JSON: $serverName" "SUCCESS"
        }
        # 1d  JSON property  "address":"<name>"
        elseif ($detailsText -match '"address"\s*:\s*"([^"]+)"') {
            $serverName = $matches[1].Trim()
            Write-Log "      [CRN] Extracted via 'address' JSON: $serverName" "SUCCESS"
        }
    }

    # ---------- PRIORITY 2: event.resourceName (if not a generic vRA ID) ----------
    if (-not $serverName -and $Event.resourceName) {
        if ($Event.resourceName -notmatch "Cloud_vSphere_Machine_\d+") {
            $serverName = $Event.resourceName
            Write-Log "      [CRN] Extracted via event.resourceName: $serverName" "SUCCESS"
        }
    }

    return $serverName
}

# ============================================================================
# SHARED HELPER: Fetch ALL paginated events for a single request.
# Returns an array of event objects.
# ============================================================================
function Get-AllEventsForRequest {
    param(
        [Parameter(Mandatory=$true)][string]$VraServer,
        [Parameter(Mandatory=$true)][hashtable]$Headers,
        [Parameter(Mandatory=$true)][string]$DeploymentId,
        [Parameter(Mandatory=$true)][string]$RequestId,
        [switch]$IncludeDeleted   # adds &deleted=true to the URL
    )

    $allEvents = @()
    $eventPage = 0
    $deletedParam = if ($IncludeDeleted) { "&deleted=true" } else { "" }

    do {
        $eventsUri = "https://$VraServer/deployment/api/deployments/$DeploymentId/requests/$RequestId/events?page=$eventPage&size=$eventsPageSize$deletedParam&apiVersion=2020-08-25"

        try {
            $eventsResponse = Invoke-RestMethod -Uri $eventsUri -Method Get -Headers $Headers -ErrorAction Stop
            $events = if ($eventsResponse.content) { $eventsResponse.content } else { $eventsResponse }

            if ($events -and $events.Count -gt 0) {
                $allEvents += $events
                $eventPage++
                if ($events.Count -lt $eventsPageSize) { break }
            }
            else { break }
        }
        catch {
            Write-Log "      Error fetching events (page $eventPage): $($_.Exception.Message)" "ERROR"
            break
        }

        if ($eventPage -ge 20) { break }   # safety cap

    } while ($true)

    return $allEvents
}

# ============================================================================
# MAIN FUNCTIONS
# ============================================================================

function Get-ActiveDeploymentsWithDecommission {
    param(
        [Parameter(Mandatory=$true)]
        [string]$VraServer,
        
        [Parameter(Mandatory=$true)]
        [hashtable]$Headers
    )
    
    Write-DebugSection "Checking Active Deployments with Decommission Requests: $VraServer"
    
    $decommissionData = New-Object System.Collections.ArrayList
    
    Write-Log "Fetching ACTIVE deployments with recent updates (performance optimized)..." "DEBUG"
    
    # PERFORMANCE OPTIMIZATION: Filter by lastUpdated date to reduce dataset
    $cutoffDate = (Get-Date).AddDays(-$deploymentLookbackDays).ToString("yyyy-MM-dd")
    Write-Log "Only checking deployments updated since: $cutoffDate (last $deploymentLookbackDays days)" "DEBUG"
    
    $vraUri = "https://$VraServer/deployment/api/deployments"
    $page = 0
    $size = 1000
    $allDeployments = @()
    
    do {
        # Add filter for recently updated deployments to reduce API load
        $pagedUri = "$vraUri`?page=$page&size=$size&expand=resources&`$filter=lastUpdatedAt ge '$cutoffDate'"
        Write-Log "  Fetching page $page from: $pagedUri" "DEBUG"
        
        try {
            $vraResponse = Invoke-RestMethod -Uri $pagedUri -Method Get -Headers $Headers -ErrorAction Stop
            $deployments = if ($vraResponse.content) { $vraResponse.content } else { $vraResponse }
            
            if ($deployments -and $deployments.Count -gt 0) {
                $allDeployments += $deployments
                Write-Log "  Page $page : Found $($deployments.Count) deployments" "DEBUG"
                $page++
            }
            else {
                break
            }
            
            $hasMore = if ($vraResponse.totalPages) {
                $page -lt $vraResponse.totalPages
            } elseif ($vraResponse.totalElements) { 
                ($page * $size) -lt $vraResponse.totalElements
            } else { 
                $deployments.Count -eq $size
            }
        }
        catch {
            Write-Log "  Error fetching page $page : $($_.Exception.Message)" "ERROR"
            Write-Log "  Falling back to unfiltered query..." "WARN"
            
            # Fallback: Try without filter if filtered query fails
            try {
                $pagedUri = "$vraUri`?page=$page&size=$size&expand=resources"
                $vraResponse = Invoke-RestMethod -Uri $pagedUri -Method Get -Headers $Headers -ErrorAction Stop
                $deployments = if ($vraResponse.content) { $vraResponse.content } else { $vraResponse }
                
                if ($deployments -and $deployments.Count -gt 0) {
                    $allDeployments += $deployments
                    $page++
                }
                else {
                    break
                }
            }
            catch {
                Write-Log "  Fallback also failed. Moving to next page." "ERROR"
                break
            }
        }
        
        # PERFORMANCE: Limit to 20 pages (20k deployments) to prevent excessive API calls
        if ($page -ge 20) {
            Write-Log "  WARNING: Reached 20 page limit (20,000 deployments). Consider narrowing date range." "WARN"
            break
        }
        
    } while ($hasMore)
    
    Write-Log "Total active deployments retrieved: $($allDeployments.Count)" "DEBUG"
    
    Write-Log "`n--- PERFORMANCE: Quick-filtering for VM-containing deployments ---" "DEBUG"
    
    # PERFORMANCE OPTIMIZATION: Use faster array filtering
    $filteredDeployments = @($allDeployments | Where-Object {
        $_.resources -and ($_.resources | Where-Object { $_.type -eq "Cloud.vSphere.Machine" })
    })
    
    Write-Log "`nDeployments containing VMs: $($filteredDeployments.Count)" "SUCCESS"
    Write-Log "Deployments filtered out (no VMs): $(($allDeployments.Count - $filteredDeployments.Count))" "WARN"
    
    # PERFORMANCE OPTIMIZATION: Process only deployments with decommission-related status or recent updates
    Write-Log "`n--- Pre-filtering for likely decommission candidates ---" "DEBUG"
    $candidateDeployments = @($filteredDeployments | Where-Object {
        $_.status -match "DELETE|DELETING|DECOMMISSION" -or
        $_.lastUpdatedAt -ge $cutoffDate
    })
    
    if ($candidateDeployments.Count -lt $filteredDeployments.Count) {
        Write-Log "Narrowed to $($candidateDeployments.Count) candidate deployments (skipped $($filteredDeployments.Count - $candidateDeployments.Count) unlikely candidates)" "SUCCESS"
        $allDeployments = $candidateDeployments
    }
    else {
        Write-Log "No filtering applied - checking all $($filteredDeployments.Count) deployments" "DEBUG"
        $allDeployments = $filteredDeployments
    }
    
    foreach ($deployment in $allDeployments) {
        $deploymentIndex = [array]::IndexOf($allDeployments, $deployment) + 1
        $percentComplete = [math]::Round(($deploymentIndex / $allDeployments.Count) * 100, 1)
        
        # Show progress every 10 deployments
        if ($deploymentIndex % 10 -eq 0 -or $deploymentIndex -eq 1 -or $deploymentIndex -eq $allDeployments.Count) {
            Write-Log "Progress: Processing deployment $deploymentIndex of $($allDeployments.Count) ($percentComplete%)" "DEBUG"
        }
        
        Write-Log "`n--- Active Deployment: $($deployment.name) (ID: $($deployment.id)) ---" "DEBUG"
        Write-Log "  Status: $($deployment.status)" "DEBUG"
        Write-Log "  Created: $($deployment.createdAt)" "DEBUG"
        Write-Log "  Last Updated: $($deployment.lastUpdatedAt)" "DEBUG"
        Write-Log "  Owned By: $($deployment.ownedBy)" "DEBUG"
        Write-Log "  Created By: $($deployment.createdBy)" "DEBUG"
        Write-Log "  Project: $($deployment.projectId)" "DEBUG"
        
        if ($deployment.resources) {
            Write-Log "  Resources in deployment:" "DEBUG"
            foreach ($resource in $deployment.resources) {
                if ($resource.type -eq "Cloud.vSphere.Machine") {
                    Write-Log "    - Type: $($resource.type), Name: $($resource.name), ID: $($resource.id)" "DEBUG"
                }
            }
        }
        
        try {
            $requestsUri = "https://$VraServer/deployment/api/deployments/$($deployment.id)/requests?apiVersion=2020-08-25"
            Write-Log "  Fetching requests from: $requestsUri" "DEBUG"
            
            $requestsResponse = Invoke-RestMethod -Uri $requestsUri -Method Get -Headers $Headers -ErrorAction Stop
            $requests = if ($requestsResponse.content) { $requestsResponse.content } else { $requestsResponse }
            
            Write-Log "  Found $($requests.Count) requests for this deployment" "DEBUG"
            
            foreach ($request in $requests) {
                Write-Log "    ╔══════════════════════════════════════════════════════════════" "DEBUG"
                Write-Log "    ║ Request ID: $($request.id)" "DEBUG"
                Write-Log "    ║ Name: $($request.name)" "DEBUG"
                Write-Log "    ║ Action ID: $($request.actionId)" "DEBUG"
                Write-Log "    ║ Status: $($request.status)" "DEBUG"
                Write-Log "    ║ Requested By: $($request.requestedBy)" "DEBUG"
                Write-Log "    ║ Initiated At (RAW UTC): $($request.initiatedAt)" "DEBUG"
                Write-Log "    ║ Initiated At (Sydney Time): $(if ($request.initiatedAt) { Convert-ToSydneyTime -DateTimeString $request.initiatedAt } else { 'N/A' })" "WARN"
                Write-Log "    ║ Completed At (RAW UTC): $($request.completedAt)" "DEBUG"
                Write-Log "    ║ Completed At (Sydney Time): $(if ($request.completedAt) { Convert-ToSydneyTime -DateTimeString $request.completedAt } else { 'N/A' })" "DEBUG"
                
                $isDecommission = $false
                $matchedBy = "None"
                $expirationDate = $null
                
                Write-Log "    ║ Checking if this is a decommission request..." "DEBUG"
                Write-Log "    ║   Request Name: '$($request.name)'" "DEBUG"
                Write-Log "    ║   Action ID: '$($request.actionId)'" "DEBUG"
                
                $nameMatch = $false
                if ($request.name -match "Initiate server decommission|decommission") {
                    $nameMatch = $true
                    Write-Log "    ║   ✓ Name matches decommission pattern" "WARN"
                }
                else {
                    Write-Log "    ║   ✗ Name does NOT match decommission pattern" "DEBUG"
                }
                
                $actionMatch = $false
                if ($request.actionId -match "Deployment.Delete|Resource.Delete|Cloud.vSphere.Machine.Delete|Deployment.custom.initiate_server_decommission") {
                    $actionMatch = $true
                    Write-Log "    ║   ✓ Action ID matches decommission pattern" "WARN"
                }
                else {
                    Write-Log "    ║   ✗ Action ID does NOT match decommission pattern" "DEBUG"
                }
                
                if ($nameMatch -or $actionMatch) {
                    Write-Log "    ║   >>> Pattern matched! This is a decommission request <<<" "WARN"
                    $isDecommission = $true
                    $matchedBy = if ($nameMatch) { "Request Name" } else { "Action ID" }
                    
                    Write-Log "    ║" "WARN"
                    Write-Log "    ║   ╔════════════════ DECOMMISSION TIMING INFO ════════════════╗" "WARN"
                    Write-Log "    ║   ║ Request Initiated At (UTC): $($request.initiatedAt)" "WARN"
                    Write-Log "    ║   ║ Request Initiated At (Sydney): $(if ($request.initiatedAt) { Convert-ToSydneyTime -DateTimeString $request.initiatedAt } else { 'N/A' })" "WARN"
                    
                    if ($deployment.leaseExpireAt) {
                        $expirationDate = $deployment.leaseExpireAt
                        Write-Log "    ║   ║ Deployment Expires At (UTC): $expirationDate" "WARN"
                        Write-Log "    ║   ║ Deployment Expires At (Sydney): $(Convert-ToSydneyTime -DateTimeString $expirationDate)" "WARN"
                    }
                    else {
                        Write-Log "    ║   ║ WARNING: No lease expiration date found" "WARN"
                        $expirationDate = "N/A"
                    }
                    Write-Log "    ║   ╚═══════════════════════════════════════════════════════════╝" "WARN"
                    Write-Log "    ║" "WARN"
                }
                else {
                    Write-Log "    ║   >>> NOT a decommission request (no pattern match)" "DEBUG"
                }
                
                if ($isDecommission) {
                    Write-Log "    ║   >>> DECOMMISSION CONFIRMED - Extracting VM details from deployment resources <<<" "WARN"
                    
                    # FIRST: Try to get VM names from deployment resources (more reliable)
                    $foundVMs = @{}
                    
                    if ($deployment.resources) {
                        Write-Log "    ║   >>> Checking deployment resources for VMs <<<" "DEBUG"
                        foreach ($resource in $deployment.resources) {
                            if ($resource.type -eq "Cloud.vSphere.Machine") {
                                Write-Log "    ║   >>> Found vSphere Machine resource <<<" "DEBUG"
                                Write-Log "    ║   >>> Resource ID: $($resource.id) <<<" "DEBUG"
                                Write-Log "    ║   >>> Resource Name: $($resource.name) <<<" "DEBUG"
                                
                                $hostname = $null
                                
                                # Try to get from properties.resourceName
                                if ($resource.properties -and $resource.properties.resourceName) {
                                    $hostname = $resource.properties.resourceName
                                    Write-Log "    ║   >>> Found hostname from properties.resourceName: $hostname <<<" "SUCCESS"
                                }
                                # Try resource.name if not generic
                                elseif ($resource.name -and $resource.name -notmatch "Cloud_vSphere_Machine_\d+") {
                                    $hostname = $resource.name
                                    Write-Log "    ║   >>> Found hostname from resource.name: $hostname <<<" "SUCCESS"
                                }
                                
                                if ($hostname -and -not $foundVMs.ContainsKey($hostname.ToLower())) {
                                    $foundVMs[$hostname.ToLower()] = $hostname
                                    Write-Log "    ║   >>> Added VM to decommission list: $hostname <<<" "SUCCESS"
                                }
                            }
                        }
                    }
                    
                    # SECOND: If no VMs found in resources, fall back to events
                    if ($foundVMs.Count -eq 0) {
                        Write-Log "    ║   >>> No VMs found in resources, fetching events as fallback <<<" "WARN"
                        
                        $allEvents = Get-AllEventsForRequest -VraServer $VraServer -Headers $Headers -DeploymentId $deployment.id -RequestId $request.id
                        
                        Write-Log "    ║   >>> Found $($allEvents.Count) events for this decommission request <<<" "DEBUG"
                    }
                    else {
                        Write-Log "    ║   >>> Found $($foundVMs.Count) VMs from deployment resources <<<" "SUCCESS"
                        $allEvents = @() # Skip event processing if we found VMs
                    }
                    
                    # Process events (only if we didn't find VMs in resources)
                    foreach ($event in $allEvents) {
                        if ($event.resourceType -eq "Cloud.vSphere.Machine") {
                            Write-Log "    ║" "DEBUG"
                            Write-Log "    ║   >>> Processing Event for vSphere Machine (fallback) <<<" "DEBUG"
                            Write-Log "    ║   >>> Event Type: $($event.eventType) <<<" "DEBUG"
                            Write-Log "    ║   >>> Resource Name: $($event.resourceName) <<<" "DEBUG"
                            
                            $hostname = Extract-CloudResourceName -Event $event
                            
                            if (-not $hostname) {
                                Write-Log "    ║   >>> WARNING: Could not extract hostname from event! <<<" "WARN"
                                Write-Log "    ║   >>> Event dump: $($event | ConvertTo-Json -Depth 2 -Compress) <<<" "DEBUG"
                            }
                            
                            # Store unique VMs (avoid duplicates from multiple events)
                            if ($hostname -and -not $foundVMs.ContainsKey($hostname.ToLower())) {
                                $foundVMs[$hostname.ToLower()] = $hostname
                            }
                        }
                    }
                    
                    # Now create the decommission objects for all found VMs
                    Write-Log "    ║   >>> Total unique VMs found: $($foundVMs.Count) <<<" "SUCCESS"
                    
                    foreach ($vmEntry in $foundVMs.GetEnumerator()) {
                        $hostname = $vmEntry.Value
                        
                        # DEDUPLICATION CHECK: Skip if this VM is already in the decommission list
                        $existingVM = $decommissionData | Where-Object { 
                            $_.VMName.ToLower() -eq $hostname.ToLower() -and 
                            $_.DeploymentID -eq $deployment.id 
                        }
                        
                        if ($existingVM) {
                            Write-Log "      >>> DUPLICATE DETECTED: VM '$hostname' already exists in decommission list for this deployment <<<" "WARN"
                            Write-Log "      >>> Existing request: $($existingVM.RequestAction)" "WARN"
                            Write-Log "      >>> Current request: $($request.name)" "WARN"
                            
                            # Only keep the most relevant request (prefer "Initiate server decommission" over generic "Delete")
                            if ($request.name -match "Initiate server decommission" -and $existingVM.RequestAction -notmatch "Initiate server decommission") {
                                Write-Log "      >>> Updating to use more specific 'Initiate server decommission' request <<<" "WARN"
                                # Remove the old entry
                                $decommissionData.Remove($existingVM)
                            }
                            elseif ($existingVM.RequestAction -match "Initiate server decommission" -and $request.name -notmatch "Initiate server decommission") {
                                Write-Log "      >>> Keeping existing 'Initiate server decommission' request, skipping generic delete <<<" "WARN"
                                continue  # Skip this duplicate
                            }
                            else {
                                Write-Log "      >>> Skipping duplicate - keeping first occurrence <<<" "WARN"
                                continue  # Skip this duplicate
                            }
                        }
                        
                        Write-Log "      >>> VM in Decommission: $hostname <<<" "WARN"
                        Write-Log "      >>> Matched decommission by: $matchedBy <<<" "DEBUG"
                        Write-Log "      >>> Deployment Name: $($deployment.name) <<<" "DEBUG"
                        Write-Log "      >>> Deployment Status: $($deployment.status) <<<" "DEBUG"
                        Write-Log "      >>> Request Action: $($request.name) <<<" "DEBUG"
                        Write-Log "      >>> Requested By: $($request.requestedBy) <<<" "DEBUG"
                        Write-Log "      >>>" "WARN"
                        Write-Log "      >>> ⏰ TIMING INFORMATION ⏰" "WARN"
                        Write-Log "      >>> Request Initiated At (RAW): $($request.initiatedAt)" "WARN"
                        Write-Log "      >>> Request Initiated At (Sydney): $(if ($request.initiatedAt) { Convert-ToSydneyTime -DateTimeString $request.initiatedAt } else { 'N/A' })" "WARN"
                        Write-Log "      >>> Deployment Expires At (RAW): $expirationDate" "WARN"
                        Write-Log "      >>> Deployment Expires At (Sydney): $(if ($expirationDate -and $expirationDate -ne 'N/A') { Convert-ToSydneyTime -DateTimeString $expirationDate } else { 'N/A' })" "WARN"
                        Write-Log "      >>>" "WARN"
                        
                        $vraServerShort = ($VraServer -split '\.')[0]
                        $catalogItem = if ($deployment.inputs._catalogItemName) { $deployment.inputs._catalogItemName } else { "N/A" }
                        
                        # Convert times to Sydney timezone
                        $initiatedAtValue = if ($request.initiatedAt) { 
                            Convert-ToSydneyTime -DateTimeString $request.initiatedAt
                        } else { 
                            "N/A" 
                        }
                        
                        $expirationDateValue = if ($expirationDate -and $expirationDate -ne "N/A") {
                            Convert-ToSydneyTime -DateTimeString $expirationDate
                        } else {
                            "N/A"
                        }
                        
                        Write-Log "      >>> Creating decommission object... <<<" "DEBUG"
                        Write-Log "      >>> RAW initiatedAt from request: '$($request.initiatedAt)'" "DEBUG"
                        Write-Log "      >>> RAW expirationDate: '$expirationDate'" "DEBUG"
                        
                        # Get the actual deletion date from deployment
                        $deletionDate = "N/A"
                        if ($deployment.lastUpdatedAt) {
                            $deletionDate = Convert-ToSydneyTime -DateTimeString $deployment.lastUpdatedAt
                            Write-Log "      >>> Found deletion date from lastUpdatedAt: $deletionDate <<<" "DEBUG"
                        }
                        elseif ($deployment.deletedAt) {
                            $deletionDate = Convert-ToSydneyTime -DateTimeString $deployment.deletedAt
                            Write-Log "      >>> Found deletion date from deletedAt: $deletionDate <<<" "DEBUG"
                        }

                        $vmObject = New-Object PSObject -Property @{
                            VMName = $hostname
                            ResourceType = "Cloud.vSphere.Machine"
                            DeploymentName = $deployment.name
                            DeploymentID = $deployment.id
                            DeploymentStatus = $deployment.status
                            RequestID = $request.id
                            RequestAction = $request.name
                            RequestStatus = $request.status
                            RequestedBy = $request.requestedBy
                            Requestor = if ($deployment.ownedBy) { $deployment.ownedBy } else { $request.requestedBy }
                            CatalogItem = $catalogItem
                            InitiatedAt = $expirationDateValue  # Shows expiration date
                            CompletedAt = if ($request.completedAt) { Convert-ToSydneyTime -DateTimeString $request.completedAt } else { "N/A" }
                            DeletionDate = $deletionDate  # Shows actual deletion/update date
                            vRAServer = $vraServerShort
                            Source = "vRA-Decommission-InProgress"
                            IsStillActive = $true
                        }
                        
                        Write-Log "      >>> Object created. Properties: <<<" "DEBUG"
                        Write-Log "          VMName: $($vmObject.VMName)" "SUCCESS"
                        Write-Log "          DeploymentName: $($vmObject.DeploymentName)" "DEBUG"
                        Write-Log "          RequestAction: $($vmObject.RequestAction)" "DEBUG"
                        Write-Log "          RequestStatus: $($vmObject.RequestStatus)" "DEBUG"
                        Write-Log "          InitiatedAt (CONVERTED): $($vmObject.InitiatedAt)" "WARN"
                        Write-Log "          DeletionDate (CONVERTED): $($vmObject.DeletionDate)" "WARN"
                        Write-Log "          Source: $($vmObject.Source)" "DEBUG"
                        Write-Log "          vRAServer: $($vmObject.vRAServer)" "DEBUG"
                        
                        [void]$decommissionData.Add($vmObject)
                        
                        Write-Log "      >>> Added to decommission list successfully. Total count: $($decommissionData.Count) <<<" "SUCCESS"
                    }
                    
                    Write-Log "    ║   >>> Processing complete for this decommission request <<<" "SUCCESS"
                }
                Write-Log "    ╚══════════════════════════════════════════════════════════════" "DEBUG"
            }
        }
        catch {
            Write-Log "  Error processing deployment requests: $($_.Exception.Message)" "ERROR"
            Write-Log "  Full error: $($_.Exception)" "ERROR"
        }
    }
    
    Write-Log "`n╔════════════════════════════════════════════════════════════════════════════════" "SUCCESS"
    Write-Log "║ DECOMMISSION SUMMARY for $VraServer" "SUCCESS"
    Write-Log "╠════════════════════════════════════════════════════════════════════════════════" "SUCCESS"
    Write-Log "║ Total Active Deployments Checked: $($allDeployments.Count)" "SUCCESS"
    Write-Log "║ VMs with Decommission Requests Found (before dedup): $($decommissionData.Count)" "SUCCESS"
    
    # FINAL DEDUPLICATION PASS: Remove any duplicates that might have slipped through
    Write-Log "║" "SUCCESS"
    Write-Log "║ Running final deduplication check..." "DEBUG"
    
    $uniqueVMs = @{}
    $finalDecommissionData = New-Object System.Collections.ArrayList
    
    foreach ($vm in $decommissionData) {
        $vmKey = "$($vm.VMName.ToLower())_$($vm.DeploymentID)"
        
        if ($uniqueVMs.ContainsKey($vmKey)) {
            $existingVM = $uniqueVMs[$vmKey]
            Write-Log "║   DUPLICATE FOUND: $($vm.VMName) in deployment $($vm.DeploymentName)" "WARN"
            Write-Log "║     Existing: $($existingVM.RequestAction)" "DEBUG"
            Write-Log "║     Duplicate: $($vm.RequestAction)" "DEBUG"
            
            # Prefer "Initiate server decommission" over generic "Delete"
            if ($vm.RequestAction -match "Initiate server decommission" -and $existingVM.RequestAction -notmatch "Initiate server decommission") {
                Write-Log "║     Replacing with more specific 'Initiate server decommission' request" "WARN"
                $finalDecommissionData.Remove($existingVM)
                [void]$finalDecommissionData.Add($vm)
                $uniqueVMs[$vmKey] = $vm
            }
            else {
                Write-Log "║     Keeping first occurrence, skipping duplicate" "DEBUG"
            }
        }
        else {
            $uniqueVMs[$vmKey] = $vm
            [void]$finalDecommissionData.Add($vm)
        }
    }
    
    $duplicatesRemoved = $decommissionData.Count - $finalDecommissionData.Count
    if ($duplicatesRemoved -gt 0) {
        Write-Log "║ Duplicates removed: $duplicatesRemoved" "WARN"
    }
    
    Write-Log "║ VMs with Decommission Requests Found (after dedup): $($finalDecommissionData.Count)" "SUCCESS"
    
    if ($finalDecommissionData.Count -gt 0) {
        Write-Log "║" "SUCCESS"
        Write-Log "║ VMs Found in Decommission:" "SUCCESS"
        foreach ($vm in $finalDecommissionData) {
            Write-Log "║   - $($vm.VMName) (Deployment: $($vm.DeploymentName))" "SUCCESS"
            Write-Log "║     Action: $($vm.RequestAction), Status: $($vm.RequestStatus)" "SUCCESS"
        }
    }
    else {
        Write-Log "║ WARNING: No VMs with decommission requests found!" "WARN"
    }
    Write-Log "╚════════════════════════════════════════════════════════════════════════════════" "SUCCESS"
    
    return @($finalDecommissionData)
}

function Get-DeletedVMsFromVRA {
    param(
        [Parameter(Mandatory=$true)]
        [string]$VraServer,
        
        [Parameter(Mandatory=$true)]
        [hashtable]$Headers,
        
        [Parameter(Mandatory=$true)]
        [int]$DaysBack
    )
    
    Write-DebugSection "Processing Deleted Deployments from vRA: $VraServer"
    
    $deletedVMData = @()
    $cutoffDate = (Get-Date).AddDays(-$DaysBack)
    
    Write-Log "Cutoff date: $cutoffDate" "DEBUG"
    Write-Log "Searching for deleted deployments..." "DEBUG"
    
    $urlVariations = @(
        "https://$VraServer/deployment/api/deployments?deleted=true&expand=resources&apiVersion=2020-08-25&page={0}&size=$eventsPageSize",
        "https://$VraServer/deployment/api/deployments?deleted=%5Btrue%5D&expand=resources&apiVersion=2020-08-25&page={0}&size=$eventsPageSize"
    )
    
    $workingUrl = $null
    $allDeletedDeployments = @()
    
    foreach ($urlTemplate in $urlVariations) {
        try {
            $testUrl = $urlTemplate -f 0
            Write-Log "  Testing URL: $testUrl" "DEBUG"
            $response = Invoke-RestMethod -Uri $testUrl -Method Get -Headers $Headers -ErrorAction Stop
            $deployments = if ($response.content) { $response.content } else { $response }
            
            if ($deployments -and $deployments.Count -gt 0) {
                $workingUrl = $urlTemplate
                $allDeletedDeployments += $deployments
                Write-Log "  URL works! Found $($deployments.Count) deployments on page 0" "SUCCESS"
                break
            }
        }
        catch {
            Write-Log "  URL failed: $($_.Exception.Message)" "DEBUG"
            continue
        }
    }
    
    if (-not $workingUrl) {
        Write-Log "No deleted deployments found or API not supported" "WARN"
        return $deletedVMData
    }
    
    $page = 1
    do {
        try {
            $uri = $workingUrl -f $page
            $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $Headers -ErrorAction Stop
            $deployments = if ($response.content) { $response.content } else { $response }
            
            if ($deployments -and $deployments.Count -gt 0) {
                $allDeletedDeployments += $deployments
                Write-Log "  Page $page : Found $($deployments.Count) deployments" "DEBUG"
                $page++
            }
            else {
                break
            }
        }
        catch {
            Write-Log "  Error on page $page : $($_.Exception.Message)" "DEBUG"
            break
        }
        
        if ($allDeletedDeployments.Count -ge 5000) { break }
        
    } while ($true)
    
    Write-Log "Total deleted deployments retrieved: $($allDeletedDeployments.Count)" "SUCCESS"
    
    Write-Log "`n--- Filtering by date range ---" "DEBUG"
    Write-Log "Cutoff date (UTC): $cutoffDate" "DEBUG"
    Write-Log "Current date (UTC): $(Get-Date -Format 'yyyy-MM-ddTHH:mm:ss')" "DEBUG"
    
    $filteredDeployments = $allDeletedDeployments | Where-Object {
        try {
            if ($_.lastUpdatedAt) {
                $updateDate = [DateTime]::Parse($_.lastUpdatedAt)
                $updateDateUTC = $updateDate.ToUniversalTime()
                $cutoffDateUTC = $cutoffDate.ToUniversalTime()
                
                $isInRange = $updateDateUTC -ge $cutoffDateUTC
                
                if ($isInRange) {
                    Write-Log "  ✓ Including: $($_.name) - Updated: $($_.lastUpdatedAt) (within range)" "DEBUG"
                }
                else {
                    Write-Log "  ✗ Excluding: $($_.name) - Updated: $($_.lastUpdatedAt) (too old)" "DEBUG"
                }
                
                return $isInRange
            }
            else {
                Write-Log "  ⚠ Including: $($_.name) - No lastUpdatedAt (including by default)" "WARN"
                return $true
            }
        }
        catch {
            Write-Log "  ⚠ Including: $($_.name) - Date parse error (including by default)" "WARN"
            return $true
        }
    }
    
    Write-Log "Deployments within time range: $($filteredDeployments.Count)" "SUCCESS"
    
    # Log some examples of what was filtered
    if ($filteredDeployments.Count -gt 0) {
        Write-Log "`nSample of deployments in range:" "DEBUG"
        $sampleCount = [Math]::Min(5, $filteredDeployments.Count)
        for ($i = 0; $i -lt $sampleCount; $i++) {
            $dep = $filteredDeployments[$i]
            Write-Log "  - $($dep.name) (Updated: $($dep.lastUpdatedAt))" "DEBUG"
        }
    }
    
    Write-Log "`n--- Checking for VM resources in deployments ---" "DEBUG"
    
    # Don't filter by name - check actual resources instead
    $vmDeployments = @()
    foreach ($dep in $filteredDeployments) {
        $hasVM = $false
        
        # Check if deployment has VM resources
        if ($dep.resources) {
            foreach ($resource in $dep.resources) {
                if ($resource.type -eq "Cloud.vSphere.Machine") {
                    $hasVM = $true
                    break
                }
            }
        }
        
        # If no resources in deployment object, assume it might have VMs (we'll check later)
        if (-not $dep.resources) {
            Write-Log "  Deployment '$($dep.name)' has no resource data - including for inspection" "WARN"
            $hasVM = $true
        }
        
        if ($hasVM) {
            $vmDeployments += $dep
            Write-Log "  ✓ Including deployment: $($dep.name)" "DEBUG"
        }
        else {
            Write-Log "  ✗ Skipping deployment (no VMs): $($dep.name)" "DEBUG"
        }
    }
    
    Write-Log "`nDeployments with potential VMs: $($vmDeployments.Count)" "SUCCESS"
    $filteredDeployments = $vmDeployments
    
    foreach ($deployment in $filteredDeployments) {
        Write-Log "`n--- Deleted Deployment: $($deployment.name) (ID: $($deployment.id)) ---" "DEBUG"
        Write-Log "  Status: $($deployment.status)" "DEBUG"
        Write-Log "  Last Updated: $($deployment.lastUpdatedAt)" "DEBUG"
        Write-Log "  Owned By: $($deployment.ownedBy)" "DEBUG"
        
        # FIRST: Try to extract VM names directly from deployment resources (more reliable)
        $foundVMs = @{}
        
        if ($deployment.resources) {
            Write-Log "  Checking deployment resources for VM names..." "DEBUG"
            foreach ($resource in $deployment.resources) {
                if ($resource.type -eq "Cloud.vSphere.Machine") {
                    Write-Log "    Found vSphere Machine resource" "DEBUG"
                    Write-Log "    Resource ID: $($resource.id)" "DEBUG"
                    Write-Log "    Resource Name: $($resource.name)" "DEBUG"
                    
                    $serverName = $null
                    
                    # Try to get from properties.resourceName (most reliable)
                    if ($resource.properties -and $resource.properties.resourceName) {
                        $serverName = $resource.properties.resourceName
                        Write-Log "    Found server name from properties.resourceName: $serverName" "SUCCESS"
                    }
                    # Try resource.name if not generic
                    elseif ($resource.name -and $resource.name -notmatch "Cloud_vSphere_Machine_\d+") {
                        $serverName = $resource.name
                        Write-Log "    Found server name from resource.name: $serverName" "SUCCESS"
                    }
                    # Try properties.address
                    elseif ($resource.properties -and $resource.properties.address) {
                        $serverName = $resource.properties.address
                        Write-Log "    Found server name from properties.address: $serverName" "SUCCESS"
                    }
                    
                    if ($serverName) {
                        $vmKey = $serverName.ToLower()
                        if (-not $foundVMs.ContainsKey($vmKey)) {
                            $foundVMs[$vmKey] = $serverName
                            Write-Log "    Added VM to extraction list: $serverName" "SUCCESS"
                        }
                    }
                }
            }
        }
        
        Write-Log "  VMs found from deployment resources: $($foundVMs.Count)" "DEBUG"
        
        # SECOND: If no VMs found in resources, fall back to events
        if ($foundVMs.Count -eq 0) {
            Write-Log "  No VMs in resources, checking deletion events..." "WARN"
            
            try {
                $requestsUri = "https://$VraServer/deployment/api/deployments/$($deployment.id)/requests?apiVersion=2020-08-25&deleted=true"
                Write-Log "  Fetching requests from: $requestsUri" "DEBUG"
                
                $requestsResponse = Invoke-RestMethod -Uri $requestsUri -Method Get -Headers $Headers -ErrorAction Stop
                $requests = if ($requestsResponse.content) { $requestsResponse.content } else { $requestsResponse }
                
                Write-Log "  Found $($requests.Count) requests" "DEBUG"
                
                foreach ($request in $requests) {
                    Write-Log "    ╔══════════════════════════════════════════════════════════════" "DEBUG"
                    Write-Log "    ║ Request ID: $($request.id)" "DEBUG"
                    Write-Log "    ║ Action: $($request.name)" "DEBUG"
                    Write-Log "    ║ Status: $($request.status)" "DEBUG"
                    
                    $allEvents = Get-AllEventsForRequest -VraServer $VraServer -Headers $Headers -DeploymentId $deployment.id -RequestId $request.id -IncludeDeleted
                    
                    Write-Log "    ║ Total Events: $($allEvents.Count)" "DEBUG"
                    Write-Log "    ╠══════════════════════════════════════════════════════════════" "DEBUG"
                    
                    foreach ($event in $allEvents) {
                        if ($event.resourceType -eq "Cloud.vSphere.Machine") {
                            Write-Log "    ║     >>> Processing Deleted VM Event <<<" "DEBUG"
                            Write-Log "    ║     >>> Event Type: $($event.eventType) <<<" "DEBUG"
                            Write-Log "    ║     >>> Resource Name: $($event.resourceName) <<<" "DEBUG"
                            
                            $serverName = Extract-CloudResourceName -Event $event
                            
                            if (-not $serverName) {
                                Write-Log "    ║     >>> WARNING: Could not extract hostname from event! <<<" "WARN"
                                Write-Log "    ║     >>> Event dump: $($event | ConvertTo-Json -Depth 2 -Compress) <<<" "DEBUG"
                            }
                            else {
                                $vmKey = $serverName.ToLower()
                                if (-not $foundVMs.ContainsKey($vmKey)) {
                                    $foundVMs[$vmKey] = $serverName
                                    Write-Log "    ║     >>> Added VM from event: $serverName <<<" "SUCCESS"
                                }
                            }
                        }
                    }
                    
                    Write-Log "    ╚══════════════════════════════════════════════════════════════" "DEBUG"
                }
            }
            catch {
                Write-Log "  Error processing deployment requests: $($_.Exception.Message)" "ERROR"
            }
        }
        
        # NOW: Create VM objects for all found VMs - WITH FIX TO GET ACTUAL DELETER
        Write-Log "  Total unique VMs found for this deployment: $($foundVMs.Count)" "SUCCESS"
        
        # ========================================================================
        # CRITICAL FIX: Get the actual deleter from deletion request
        # ========================================================================
        $deletedBy = "N/A"
        $deletionRequestId = "N/A"
        $deletionRequestStatus = "Deleted"
        
        try {
            $requestsUri = "https://$VraServer/deployment/api/deployments/$($deployment.id)/requests?apiVersion=2020-08-25&deleted=true"
            Write-Log "  Fetching deletion requests to find who deleted it..." "DEBUG"
            
            $requestsResponse = Invoke-RestMethod -Uri $requestsUri -Method Get -Headers $Headers -ErrorAction Stop
            $requests = if ($requestsResponse.content) { $requestsResponse.content } else { $requestsResponse }
            
            Write-Log "  Found $($requests.Count) requests for this deleted deployment" "DEBUG"
            
            # Look for the deletion request
            foreach ($request in $requests) {
                Write-Log "    Checking request: $($request.name) (Action: $($request.actionId))" "DEBUG"
                
                if ($request.actionId -match "Deployment.Delete|Resource.Delete" -or 
                    $request.name -match "Delete|Remove") {
                    $deletedBy = if ($request.requestedBy) { $request.requestedBy } else { "N/A" }
                    $deletionRequestId = $request.id
                    $deletionRequestStatus = $request.status
                    Write-Log "    ✓ Found deletion request by: $deletedBy (Request ID: $deletionRequestId)" "SUCCESS"
                    break  # Use the first deletion request found
                }
            }
            
            # If no specific deletion request found, fall back to deployment owner
            if ($deletedBy -eq "N/A" -and $deployment.ownedBy) {
                $deletedBy = "$($deployment.ownedBy) (deployment owner - actual deleter unknown)"
                Write-Log "    No deletion request found, using deployment owner: $deletedBy" "WARN"
            }
        }
        catch {
            Write-Log "  Error fetching deletion requests: $($_.Exception.Message)" "ERROR"
            # Fall back to deployment owner if request fetch fails
            $deletedBy = if ($deployment.ownedBy) { 
                "$($deployment.ownedBy) (deployment owner - request fetch failed)" 
            } else { 
                "N/A" 
            }
        }
        # ========================================================================
        # END OF FIX
        # ========================================================================
        
        foreach ($vmEntry in $foundVMs.GetEnumerator()) {
            $serverName = $vmEntry.Value
            
            Write-Log "    ║     >>> FOUND DELETED VM: $serverName <<<" "SUCCESS"
            Write-Log "    ║     >>> Deleted By: $deletedBy <<<" "SUCCESS"
            
            $vmKey = $serverName.ToLower()
            $existingVM = $deletedVMData | Where-Object { $_.VMName.ToLower() -eq $vmKey }
            
            if ($existingVM) {
                Write-Log "    ║     >>> WARNING: VM '$serverName' already exists - SKIPPING <<<" "WARN"
            }
            else {
                $vraServerShort = ($VraServer -split '\.')[0]
                $catalogItem = if ($deployment.inputs._catalogItemName) { $deployment.inputs._catalogItemName } else { "N/A" }
                
                $deletedVMData += New-Object PSObject -Property @{
                    VMName = $serverName
                    ResourceType = "Cloud.vSphere.Machine"
                    DeploymentName = $deployment.name
                    DeploymentID = $deployment.id
                    DeploymentStatus = $deployment.status
                    RequestID = $deletionRequestId  # ✅ FIXED - Actual deletion request ID
                    RequestAction = "Deployment.Delete"
                    RequestStatus = $deletionRequestStatus  # ✅ FIXED - Actual request status
                    RequestedBy = $deletedBy  # ✅ FIXED - Who actually deleted it
                    Requestor = $deletedBy    # ✅ FIXED - Who actually deleted it
                    CatalogItem = $catalogItem
                    DeletedAt = Convert-ToSydneyTime -DateTimeString $deployment.lastUpdatedAt
                    InitiatedAt = if ($deployment.createdAt) { Convert-ToSydneyTime -DateTimeString $deployment.createdAt } else { "N/A" }
                    vRAServer = $vraServerShort
                    EventType = "Deployment.Delete"
                    EventStatus = $deletionRequestStatus
                    EventMessage = "Deleted by $deletedBy"
                    Source = "vRA-Deleted"
                    IsStillActive = $false
                }
                
                Write-Log "    ║     >>> Successfully added VM '$serverName' <<<" "SUCCESS"
            }
        }
    }
    
    Write-Log "`nExtracted $($deletedVMData.Count) deleted VMs from vRA server $VraServer" "SUCCESS"
    return $deletedVMData
}

function Get-DeletedVMsFromVCenter {
    param(
        [Parameter(Mandatory=$true)]
        [string]$VCenter,
        
        [Parameter(Mandatory=$true)]
        [PSCredential]$Credential,
        
        [Parameter(Mandatory=$true)]
        [int]$DaysBack
    )
    
    Write-DebugSection "Processing vCenter: $VCenter"
    
    $deletedVMs = @()
    
    try {
        Write-Log "Connecting to vCenter..." "DEBUG"
        Connect-VIServer -Server $VCenter -Credential $Credential -ErrorAction Stop | Out-Null
        Write-Log "Connected successfully" "SUCCESS"
        
        $cutoffDate = (Get-Date).AddDays(-$DaysBack)
        Write-Log "Fetching deletion events since: $cutoffDate" "DEBUG"
        
        $events = Get-VIEvent -Server $VCenter -Start $cutoffDate -MaxSamples 50000 | Where-Object {
            $_.GetType().Name -in @('VmRemovedEvent', 'VmBeingDeletedEvent', 'VmUnregisteredEvent')
        }
        
        Write-Log "Found $($events.Count) deletion events" "SUCCESS"
        
        foreach ($event in $events) {
            Write-Log "`n--- Deletion Event ---" "DEBUG"
            Write-Log "  VM Name: $($event.Vm.Name)" "DEBUG"
            Write-Log "  Event Type: $($event.GetType().Name)" "DEBUG"
            Write-Log "  Created Time: $($event.CreatedTime)" "DEBUG"
            Write-Log "  User: $($event.UserName)" "DEBUG"
            
            $vCenterShort = ($VCenter -split '\.')[0]
            
            $deletedVMs += New-Object PSObject -Property @{
                VMName = $event.Vm.Name
                DeletedAt = Convert-ToSydneyTime -DateTimeString $event.CreatedTime.ToString("yyyy-MM-ddTHH:mm:ss")
                DeletedBy = if ($event.UserName) { $event.UserName } else { "N/A" }
                EventType = $event.GetType().Name
                Message = $event.FullFormattedMessage
                vCenter = $vCenterShort
                Source = "vCenter-Deleted"
            }
        }
        
        Disconnect-VIServer -Server $VCenter -Confirm:$false -ErrorAction SilentlyContinue
        Write-Log "Disconnected from vCenter" "DEBUG"
    }
    catch {
        Write-Log "Error with vCenter $VCenter : $($_.Exception.Message)" "ERROR"
    }
    
    Write-Log "Extracted $($deletedVMs.Count) deleted VMs from vCenter $VCenter" "SUCCESS"
    return $deletedVMs
}

# ============================================================================
# REWRITTEN: Get-FailedDeploymentsFromVRA
# - Pulls ALL requests in history (not just CREATE/PROVISION)
# - Walks every request's events looking for Cloud Resource Name
# - Attaches full RequestHistory array to each output object
# ============================================================================
function Get-FailedDeploymentsFromVRA {
    param(
        [Parameter(Mandatory=$true)]
        [string]$VraServer,
        
        [Parameter(Mandatory=$true)]
        [hashtable]$Headers,
        
        [Parameter(Mandatory=$true)]
        [int]$DaysBack
    )
    
    Write-DebugSection "Processing FAILED Deployments from vRA: $VraServer"
    
    $failedDeploymentData = @()
    $cutoffDate = (Get-Date).AddDays(-$DaysBack).ToString("yyyy-MM-dd")
    
    Write-Log "Cutoff date: $cutoffDate" "DEBUG"
    Write-Log "Searching for FAILED deployments..." "DEBUG"
    
    # ---- PAGE THROUGH ALL DEPLOYMENTS UPDATED WITHIN THE WINDOW ----
    $vraUri = "https://$VraServer/deployment/api/deployments"
    $page = 0
    $size = 1000
    $allDeployments = @()
    
    do {
        $pagedUri = "$vraUri`?page=$page&size=$size&expand=resources&`$filter=lastUpdatedAt ge '$cutoffDate'"
        Write-Log "  Fetching page $page from: $pagedUri" "DEBUG"
        
        try {
            $vraResponse = Invoke-RestMethod -Uri $pagedUri -Method Get -Headers $Headers -ErrorAction Stop
            $deployments = if ($vraResponse.content) { $vraResponse.content } else { $vraResponse }
            
            if ($deployments -and $deployments.Count -gt 0) {
                $allDeployments += $deployments
                Write-Log "  Page $page : Found $($deployments.Count) deployments" "DEBUG"
                $page++
            }
            else { break }
            
            $hasMore = if ($vraResponse.totalPages) {
                $page -lt $vraResponse.totalPages
            } elseif ($vraResponse.totalElements) { 
                ($page * $size) -lt $vraResponse.totalElements
            } else { 
                $deployments.Count -eq $size
            }
        }
        catch {
            Write-Log "  Error fetching page $page : $($_.Exception.Message)" "ERROR"
            break
        }
        
        if ($page -ge 20) {
            Write-Log "  WARNING: Reached 20 page limit" "WARN"
            break
        }
        
    } while ($hasMore)
    
    Write-Log "Total deployments retrieved: $($allDeployments.Count)" "DEBUG"
    
    # ---- FILTER: keep only deployments whose top-level status is already FAILED,
    #      OR whose requests contain a FAILED create/provision (checked below) ----
    Write-Log "`n--- Filtering for FAILED deployments ---" "DEBUG"
    
    $failedDeployments = @($allDeployments | Where-Object {
        $_.status -match "FAILED|CREATE_FAILED|UPDATE_FAILED"
    })
    
    Write-Log "Deployments with FAILED top-level status: $($failedDeployments.Count)" "SUCCESS"
    
    # Also scan remaining deployments for failed CREATE/PROVISION requests
    $alreadyFailedIds = @{}
    foreach ($fd in $failedDeployments) { $alreadyFailedIds[$fd.id] = $true }
    
    foreach ($deployment in $allDeployments) {
        if ($alreadyFailedIds.ContainsKey($deployment.id)) { continue }
        
        try {
            $requestsUri = "https://$VraServer/deployment/api/deployments/$($deployment.id)/requests?apiVersion=2020-08-25"
            $requestsResponse = Invoke-RestMethod -Uri $requestsUri -Method Get -Headers $Headers -ErrorAction Stop
            $requests = if ($requestsResponse.content) { $requestsResponse.content } else { $requestsResponse }
            
            foreach ($request in $requests) {
                if ($request.status -match "FAILED|ABORTED|REJECTED") {
                    if ($request.actionId -match "Deployment.Create|Cloud.vSphere.Machine.Provision|Deployment.Provision") {
                        Write-Log "  Found deployment with FAILED create request: $($deployment.name)" "WARN"
                        $failedDeployments += $deployment
                        $alreadyFailedIds[$deployment.id] = $true
                        break
                    }
                }
            }
        }
        catch { }   # silently skip – we only care about the ones we can reach
    }
    
    Write-Log "`nTotal FAILED deployments to process: $($failedDeployments.Count)" "SUCCESS"
    
    # ================================================================
    # PER-DEPLOYMENT: pull FULL request history, walk every event,
    # extract Cloud Resource Name, build timeline.
    # ================================================================
    foreach ($deployment in $failedDeployments) {
        Write-Log "`n╔══════════════════════════════════════════════════════════════════════" "WARN"
        Write-Log "║ FAILED Deployment: $($deployment.name)  (ID: $($deployment.id))" "WARN"
        Write-Log "║ Status: $($deployment.status)  |  LastUpdated: $($deployment.lastUpdatedAt)" "WARN"
        Write-Log "║ OwnedBy: $($deployment.ownedBy)" "WARN"
        Write-Log "╠══════════════════════════════════════════════════════════════════════" "WARN"
        
        $foundVMs = @{}                  # key = lowercase name  →  value = original-case name
        # RequestHistory stores one entry per request so we have a full timeline later
        # Each entry: [PSObject] { RequestId, Name, ActionId, Status, RequestedBy, InitiatedAt, CompletedAt, Events[] }
        $requestHistory = @()
        
        # ---- FIRST: quick check on deployment.resources (may already have the name) ----
        if ($deployment.resources) {
            Write-Log "  Checking deployment.resources for VM names..." "DEBUG"
            foreach ($resource in $deployment.resources) {
                if ($resource.type -eq "Cloud.vSphere.Machine") {
                    $serverName = $null
                    if ($resource.properties -and $resource.properties.resourceName) {
                        $serverName = $resource.properties.resourceName
                    } elseif ($resource.name -and $resource.name -notmatch "Cloud_vSphere_Machine_\d+") {
                        $serverName = $resource.name
                    } elseif ($resource.properties -and $resource.properties.address) {
                        $serverName = $resource.properties.address
                    }
                    
                    if ($serverName -and -not $foundVMs.ContainsKey($serverName.ToLower())) {
                        $foundVMs[$serverName.ToLower()] = $serverName
                        Write-Log "    [resources] Found VM: $serverName" "SUCCESS"
                    }
                }
            }
        }
        
        # ---- MAIN: fetch ALL requests (the full history)
        # Use &deleted=true first (same pattern as Get-DeletedVMsFromVRA) — vRA
        # marks request records as deleted after a failed deployment is cleaned up,
        # so without this flag the VM name inside those events is invisible.
        # Then merge in the non-deleted query to catch anything still live.
        # ----
        Write-Log "  Fetching FULL request history (trying &deleted=true first, like deleted deployments do)..." "DEBUG"
        
        $requests = @()
        
        try {
            # ATTEMPT 1: with &deleted=true  — picks up requests vRA already cleaned up
            $requestsUri = "https://$VraServer/deployment/api/deployments/$($deployment.id)/requests?apiVersion=2020-08-25&deleted=true"
            Write-Log "    Trying: $requestsUri" "DEBUG"
            $requestsResponse = Invoke-RestMethod -Uri $requestsUri -Method Get -Headers $Headers -ErrorAction Stop
            $requests = if ($requestsResponse.content) { $requestsResponse.content } else { $requestsResponse }
            Write-Log "    &deleted=true returned $($requests.Count) requests" "DEBUG"
        }
        catch {
            Write-Log "    &deleted=true failed: $($_.Exception.Message) — trying without it" "WARN"
        }
        
        # ATTEMPT 2: without &deleted=true  — always run and merge in anything new
        try {
            $requestsUri2 = "https://$VraServer/deployment/api/deployments/$($deployment.id)/requests?apiVersion=2020-08-25"
            Write-Log "    Trying: $requestsUri2" "DEBUG"
            $requestsResponse2 = Invoke-RestMethod -Uri $requestsUri2 -Method Get -Headers $Headers -ErrorAction Stop
            $requests2 = if ($requestsResponse2.content) { $requestsResponse2.content } else { $requestsResponse2 }
            Write-Log "    without &deleted=true returned $($requests2.Count) requests" "DEBUG"
            
            # Merge: add any request IDs from attempt 2 that aren't already in attempt 1
            $existingIds = @{}
            foreach ($r in $requests) { $existingIds[$r.id] = $true }
            foreach ($r in $requests2) {
                if (-not $existingIds.ContainsKey($r.id)) {
                    $requests += $r
                    Write-Log "    Merged in request from non-deleted query: $($r.id) ($($r.name))" "DEBUG"
                }
            }
        }
        catch {
            Write-Log "    Non-deleted request fetch failed: $($_.Exception.Message)" "WARN"
        }
        
        Write-Log "  Total requests in history (merged): $($requests.Count)" "DEBUG"
        
        try {
            foreach ($request in $requests) {
                Write-Log "    ┌── Request: $($request.name)  |  ActionId: $($request.actionId)  |  Status: $($request.status)  |  By: $($request.requestedBy)" "DEBUG"
                Write-Log "    │   InitiatedAt: $($request.initiatedAt)  |  CompletedAt: $($request.completedAt)" "DEBUG"
                
                # ---- fetch every event for THIS request
                # Use &deleted=true here too — events inside a failed-then-cleaned-up
                # request disappear without it.  Retry without the flag if empty.
                # ----
                $allEvents = Get-AllEventsForRequest -VraServer $VraServer -Headers $Headers -DeploymentId $deployment.id -RequestId $request.id -IncludeDeleted
                
                if ($allEvents.Count -eq 0) {
                    Write-Log "    │   &deleted=true events empty, retrying without..." "DEBUG"
                    $allEvents = Get-AllEventsForRequest -VraServer $VraServer -Headers $Headers -DeploymentId $deployment.id -RequestId $request.id
                }
                
                Write-Log "    │   Events fetched: $($allEvents.Count)" "DEBUG"
                
                # Accumulator for this request's vSphere events (stored in history)
                $requestEvents = @()
                
                foreach ($event in $allEvents) {
                    # Log every event type so the full timeline shows up in debug
                    Write-Log "    │     event: type=$($event.eventType)  status=$($event.eventStatus)  resourceType=$($event.resourceType)  resourceName=$($event.resourceName)" "DEBUG"
                    
                    if ($event.resourceType -eq "Cloud.vSphere.Machine") {
                        # Dump full details for the vSphere machine events
                        $detailsSnippet = "N/A"
                        if ($event.details) {
                            $detailsSnippet = if ($event.details -is [string]) {
                                $event.details.Substring(0, [Math]::Min(300, $event.details.Length))
                            } else {
                                ($event.details | ConvertTo-Json -Compress -Depth 5).Substring(0, 300)
                            }
                        }
                        Write-Log "    │     [vSphere event] details snippet: $detailsSnippet" "DEBUG"
                        
                        # --- Extract Cloud Resource Name using the shared helper ---
                        $serverName = Extract-CloudResourceName -Event $event
                        
                        if ($serverName -and -not $foundVMs.ContainsKey($serverName.ToLower())) {
                            $foundVMs[$serverName.ToLower()] = $serverName
                            Write-Log "    │     ✓✓✓ NEW VM extracted: $serverName  (from request '$($request.name)') ✓✓✓" "SUCCESS"
                        }
                        elseif ($serverName) {
                            Write-Log "    │     (VM $serverName already recorded)" "DEBUG"
                        }
                        else {
                            Write-Log "    │     ✗ Could not extract VM name from this vSphere event" "WARN"
                        }
                        
                        # Store event summary for the history timeline
                        $requestEvents += New-Object PSObject -Property @{
                            EventType     = $event.eventType
                            EventStatus   = $event.eventStatus
                            ResourceName  = $event.resourceName
                            ExtractedName = $serverName
                            Details       = $detailsSnippet
                        }
                    }
                }
                
                # Store this request in the history timeline
                $requestHistory += New-Object PSObject -Property @{
                    RequestId    = $request.id
                    Name         = $request.name
                    ActionId     = $request.actionId
                    Status       = $request.status
                    RequestedBy  = $request.requestedBy
                    InitiatedAt  = if ($request.initiatedAt) { Convert-ToSydneyTime -DateTimeString $request.initiatedAt } else { "N/A" }
                    CompletedAt  = if ($request.completedAt) { Convert-ToSydneyTime -DateTimeString $request.completedAt } else { "N/A" }
                    Events       = $requestEvents
                }
                
                Write-Log "    └── done  ($($requestEvents.Count) vSphere events in this request)" "DEBUG"
            }
        }
        catch {
            Write-Log "  ERROR fetching requests/events: $($_.Exception.Message)" "ERROR"
        }
        
        # ---- SUMMARY for this deployment ----
        Write-Log "║  VMs extracted from full history: $($foundVMs.Count)" "WARN"
        if ($foundVMs.Count -eq 0) {
            Write-Log "║  WARNING: No VMs found – skipping this deployment" "WARN"
            Write-Log "╚══════════════════════════════════════════════════════════════════════" "WARN"
            continue
        }
        
        foreach ($vmKey in $foundVMs.Keys) {
            Write-Log "║    - $($foundVMs[$vmKey])" "WARN"
        }
        Write-Log "╚══════════════════════════════════════════════════════════════════════" "WARN"
        
        # ---- Determine who initiated the failed deployment ----
        $initiatedBy = if ($deployment.ownedBy) { $deployment.ownedBy } else { "N/A" }
        $failureReason = $deployment.status
        
        # Walk history to find the first FAILED request and its requestedBy
        foreach ($histEntry in $requestHistory) {
            if ($histEntry.Status -match "FAILED|ABORTED|REJECTED") {
                if ($histEntry.RequestedBy) { $initiatedBy = $histEntry.RequestedBy }
                $failureReason = $histEntry.Status
                break
            }
        }
        
        # ---- Create one output object per extracted VM ----
        $vraServerShort = ($VraServer -split '\.')[0]
        $catalogItem = if ($deployment.inputs._catalogItemName) { $deployment.inputs._catalogItemName } else { "N/A" }
        
        foreach ($vmEntry in $foundVMs.GetEnumerator()) {
            $serverName = $vmEntry.Value
            
            $failedDeploymentData += New-Object PSObject -Property @{
                VMName            = $serverName
                ResourceType      = "Cloud.vSphere.Machine"
                DeploymentName    = $deployment.name
                DeploymentID      = $deployment.id
                DeploymentStatus  = $deployment.status
                RequestStatus     = $failureReason
                RequestedBy       = $initiatedBy
                Requestor         = $initiatedBy
                CatalogItem       = $catalogItem
                FailedAt          = Convert-ToSydneyTime -DateTimeString $deployment.lastUpdatedAt
                vRAServer         = $vraServerShort
                Source            = "vRA-Failed"
                # ★ NEW: full timeline attached for debugging and reporting
                RequestHistory    = $requestHistory
            }
            
            Write-Log "    ✓✓✓ Added FAILED deployment VM: $serverName  (history entries: $($requestHistory.Count)) ✓✓✓" "SUCCESS"
        }
    }
    
    Write-Log "`nExtracted $($failedDeploymentData.Count) VMs from FAILED deployments on $VraServer" "SUCCESS"
    return $failedDeploymentData
}

# ============================================================================
# NEW: Match-FailedVMsWithVCenter
# Takes the failed-VM list from vRA and the vCenter deletion list.
# For each failed VM it does a case-insensitive name compare against every
# vCenter deletion event.  Returns an enriched array where each item has a
# MatchedVCenterEvent property (or $null if nothing matched).
# ============================================================================
function Match-FailedVMsWithVCenter {
    param(
        [Parameter(Mandatory=$true)]
        [Array]$FailedVMs,       # output of Get-FailedDeploymentsFromVRA (all servers combined)
        
        [Parameter(Mandatory=$true)]
        [Array]$VCenterEvents    # output of Get-DeletedVMsFromVCenter (all vCenters combined)
    )
    
    Write-DebugSection "Match-FailedVMsWithVCenter: comparing Cloud Resource Names vs vCenter deletions"
    
    # ---- build a fast lookup from vCenter events: lowercase name → event object ----
    $vcLookup = @{}
    foreach ($vcEvent in $VCenterEvents) {
        $key = $vcEvent.VMName.ToLower()
        if (-not $vcLookup.ContainsKey($key)) {
            $vcLookup[$key] = $vcEvent
            Write-Log "  [lookup] vCenter event indexed: '$key'  (vCenter=$($vcEvent.vCenter), DeletedAt=$($vcEvent.DeletedAt))" "DEBUG"
        }
    }
    Write-Log "  vCenter lookup table built: $($vcLookup.Count) unique VM names" "DEBUG"
    
    # ---- walk every failed VM and compare ----
    $enriched = @()
    
    foreach ($fvm in $FailedVMs) {
        $fvmKey = $fvm.VMName.ToLower()
        Write-Log "`n  Comparing failed VM: '$($fvm.VMName)'  (key='$fvmKey')" "DEBUG"
        Write-Log "    Deployment: $($fvm.DeploymentName)  |  Status: $($fvm.RequestStatus)  |  vRA: $($fvm.vRAServer)" "DEBUG"
        
        $matchedEvent = $null
        
        if ($vcLookup.ContainsKey($fvmKey)) {
            $matchedEvent = $vcLookup[$fvmKey]
            Write-Log "    ✓✓✓ MATCH FOUND ✓✓✓" "SUCCESS"
            Write-Log "      vCenter: $($matchedEvent.vCenter)" "SUCCESS"
            Write-Log "      DeletedAt: $($matchedEvent.DeletedAt)" "SUCCESS"
            Write-Log "      DeletedBy: $($matchedEvent.DeletedBy)" "SUCCESS"
            Write-Log "      EventType: $($matchedEvent.EventType)" "SUCCESS"
        }
        else {
            Write-Log "    ✗ No matching vCenter deletion event found" "WARN"
            Write-Log "      (VM may still exist in vCenter or was deleted outside the time window)" "DEBUG"
        }
        
        # Clone the failed-VM object and attach the match result
        $enrichedVM = New-Object PSObject -Property @{
            VMName             = $fvm.VMName
            ResourceType       = $fvm.ResourceType
            DeploymentName     = $fvm.DeploymentName
            DeploymentID       = $fvm.DeploymentID
            DeploymentStatus   = $fvm.DeploymentStatus
            RequestStatus      = $fvm.RequestStatus
            RequestedBy        = $fvm.RequestedBy
            Requestor          = $fvm.Requestor
            CatalogItem        = $fvm.CatalogItem
            FailedAt           = $fvm.FailedAt
            vRAServer          = $fvm.vRAServer
            Source             = $fvm.Source
            RequestHistory     = $fvm.RequestHistory
            # ★ NEW: the matched vCenter event (or $null)
            MatchedVCenterEvent = $matchedEvent
        }
        
        $enriched += $enrichedVM
    }
    
    # ---- summary ----
    $matchCount = ($enriched | Where-Object { $_.MatchedVCenterEvent -ne $null }).Count
    Write-Log "`n  ══ Match summary: $matchCount of $($enriched.Count) failed VMs matched a vCenter deletion event ══" "SUCCESS"
    
    return $enriched
}

function Send-DeletedVMReport {
    param(
        [Parameter(Mandatory=$false)]
        [Array]$VraDeletedData = @(),
        
        [Parameter(Mandatory=$false)]
        [Array]$VraDecommissionData = @(),
        
        [Parameter(Mandatory=$false)]
        [Array]$VraFailedData = @(),          # ← now the ENRICHED array from Match-FailedVMsWithVCenter
        
        [Parameter(Mandatory=$false)]
        [Array]$VCenterData = @(),
        
        [Parameter(Mandatory=$true)]
        [string]$SmtpServer,
        
        [Parameter(Mandatory=$true)]
        [int]$SmtpPort,
        
        [Parameter(Mandatory=$true)]
        [string]$From,
        
        [Parameter(Mandatory=$true)]
        [Array]$To,
        
        [Parameter(Mandatory=$false)]
        [Array]$Cc = @(),
        
        [Parameter(Mandatory=$true)]
        [string]$Subject
    )
    
    Write-Log "=== EMAIL FUNCTION - PARAMETER VALIDATION ===" "DEBUG"
    Write-Log "SmtpServer: $SmtpServer" "DEBUG"
    Write-Log "SmtpPort: $SmtpPort" "DEBUG"
    Write-Log "From: $From" "DEBUG"
    Write-Log "To: $($To -join ', ')" "DEBUG"
    Write-Log "To Type: $($To.GetType().Name)" "DEBUG"
    Write-Log "To Count: $($To.Count)" "DEBUG"
    Write-Log "Cc: $($Cc -join ', ')" "DEBUG"
    Write-Log "Subject: $Subject" "DEBUG"
    Write-Log "=============================================" "DEBUG"
    
    # Validate email parameters
    if (-not $To -or $To.Count -eq 0) {
        Write-Log "CRITICAL ERROR: Email To parameter is null or empty!" "ERROR"
        Write-Log "Cannot send email without recipient address." "ERROR"
        return
    }
    
    if ([string]::IsNullOrWhiteSpace($From)) {
        Write-Log "CRITICAL ERROR: Email From parameter is null or empty!" "ERROR"
        return
    }
    
    if ([string]::IsNullOrWhiteSpace($SmtpServer)) {
        Write-Log "CRITICAL ERROR: SMTP Server parameter is null or empty!" "ERROR"
        return
    }
    
    Write-Log "Building HTML email report..." "DEBUG"
    
    Write-Log "VraFailedData count received: $($VraFailedData.Count)" "DEBUG"
    Write-Log "VraDecommissionData count received: $($VraDecommissionData.Count)" "DEBUG"
    if ($VraDecommissionData.Count -gt 0) {
        Write-Log "First decommission VM details:" "DEBUG"
        $firstVM = $VraDecommissionData[0]
        Write-Log "  Type: $($firstVM.GetType().Name)" "DEBUG"
        Write-Log "  VMName: $($firstVM.VMName)" "DEBUG"
        Write-Log "  vRAServer: $($firstVM.vRAServer)" "DEBUG"
        Write-Log "  InitiatedAt: $($firstVM.InitiatedAt)" "DEBUG"
        Write-Log "  DeletionDate: $($firstVM.DeletionDate)" "DEBUG"
    }
    
    # ---- Build a set of VM names already accounted for by vRA (deleted + decommission + failed)
    #      so we don't double-report them from vCenter ----
    $vraVMNames = @{}
    foreach ($vm in $VraDeletedData)      { $vraVMNames[$vm.VMName.ToLower()] = $true }
    foreach ($vm in $VraDecommissionData) { $vraVMNames[$vm.VMName.ToLower()] = $true }
    foreach ($vm in $VraFailedData)       { $vraVMNames[$vm.VMName.ToLower()] = $true }
    
    Write-Log "VMs covered by vRA (for dedup): $($vraVMNames.Count)" "DEBUG"
    
    $deletedVMs       = @()
    $decommissionVMs  = @()
    
    # ---- 1. vRA successfully-deleted deployments ----
    foreach ($vm in $VraDeletedData) {
        if ($vm.RequestStatus -match "FAILED|ABORTED|REJECTED|FAILURE") {
            Write-Log "  Skipping vRA-deleted entry '$($vm.VMName)' – it's a failure, handled in failed section" "DEBUG"
            continue
        }
        
        $deletedVMs += New-Object PSObject -Property @{
            VMName         = $vm.VMName
            RequestedBy    = $vm.RequestedBy
            DeletedAt      = $vm.DeletedAt
            DeploymentName = $vm.DeploymentName
            RequestAction  = $vm.RequestAction
            RequestStatus  = $vm.RequestStatus
            Source         = $vm.vRAServer
        }
    }
    
    # ---- 2. Failed vRA deployments (already enriched with vCenter match) ----
    # Build an explicit set of all failed-VM names (lowercase) so the vCenter
    # section can skip them reliably — even if extraction partially failed and
    # the name never made it into $vraVMNames.
    $failedVMNames = @{}
    
    Write-Log "Processing enriched failed vRA deployments..." "DEBUG"
    foreach ($vm in $VraFailedData) {
        $vmLower = $vm.VMName.ToLower()
        $failedVMNames[$vmLower] = $true   # always register, matched or not
        
        $deletionTime = "N/A"
        $source       = $vm.vRAServer      # just the vRA server short name
        $status       = $vm.RequestStatus
        
        if ($vm.MatchedVCenterEvent) {
            # Confirmed: vRA CREATE_FAILED → partial VM built in vCenter → vCenter cleaned it up
            $deletionTime = $vm.MatchedVCenterEvent.DeletedAt
            $source       = $vm.vRAServer
            $status       = "Create Failed (cleaned up in vCenter)"
            Write-Log "  [failed+matched] $($vm.VMName): vRA=$($vm.vRAServer) → vCenter=$($vm.MatchedVCenterEvent.vCenter)" "SUCCESS"
        }
        else {
            # Failed in vRA, no vCenter cleanup event found in the time window
            $deletionTime = $vm.FailedAt
            $status       = "$($vm.RequestStatus) (no vCenter cleanup found)"
            Write-Log "  [failed, no match] $($vm.VMName): vRA=$($vm.vRAServer)" "WARN"
        }
        
        $deletedVMs += New-Object PSObject -Property @{
            VMName         = $vm.VMName
            RequestedBy    = $vm.RequestedBy
            DeletedAt      = $deletionTime
            DeploymentName = "$($vm.DeploymentName) (Create Failed)"
            RequestAction  = "Deployment (Create Failed)"
            RequestStatus  = $status
            Source         = $source
        }
    }
    
    Write-Log "  failedVMNames set built: $($failedVMNames.Count) names" "DEBUG"
    
    # ---- 3. Pure vCenter deletions (not already covered by vRA) ----
    # Skip if the name is in $vraVMNames (deleted/decommission) OR $failedVMNames
    # (CREATE_FAILED partial builds).  The $failedVMNames check is the critical
    # one: it prevents the false-info scenario where vCenter cleans up a VM that
    # vRA partially built during a failed deployment, and it shows up here as
    # "who deleted this random VM?"
    foreach ($vm in $VCenterData) {
        $vmLower = $vm.VMName.ToLower()
        
        if ($vraVMNames.ContainsKey($vmLower)) {
            Write-Log "SKIPPING vCenter VM (already in vRA deleted/decommission): $($vm.VMName)" "WARN"
        }
        elseif ($failedVMNames.ContainsKey($vmLower)) {
            Write-Log "SKIPPING vCenter VM (matched to CREATE_FAILED deployment): $($vm.VMName)" "WARN"
        }
        else {
            Write-Log "Adding pure vCenter deletion: $($vm.VMName) from $($vm.vCenter)" "DEBUG"
            $deletedVMs += New-Object PSObject -Property @{
                VMName         = $vm.VMName
                RequestedBy    = $vm.DeletedBy
                DeletedAt      = $vm.DeletedAt
                DeploymentName = "N/A"
                RequestAction  = $vm.EventType
                RequestStatus  = "Deleted"
                Source         = $vm.vCenter
            }
        }
    }
    
    # ---- 4. Decommissions ----
    foreach ($vm in $VraDecommissionData) {
        $decommissionVMs += New-Object PSObject -Property @{
            VMName         = if ($vm.VMName)           { $vm.VMName }           else { "N/A" }
            RequestedBy    = if ($vm.RequestedBy)      { $vm.RequestedBy }      else { "N/A" }
            InitiatedAt    = if ($vm.InitiatedAt)      { $vm.InitiatedAt }      else { "N/A" }
            DeletionDate   = if ($vm.DeletionDate)     { $vm.DeletionDate }     else { "N/A" }
            DeploymentName = if ($vm.DeploymentName)   { $vm.DeploymentName }   else { "N/A" }
            RequestAction  = if ($vm.RequestAction)    { $vm.RequestAction }    else { "N/A" }
            RequestStatus  = if ($vm.RequestStatus)    { $vm.RequestStatus }    else { "N/A" }
            Source         = if ($vm.vRAServer)        { $vm.vRAServer }        else { "N/A" }
        }
    }
    
    Write-Log "Total Deleted VMs for report: $($deletedVMs.Count)" "DEBUG"
    Write-Log "Total Decommission VMs for report: $($decommissionVMs.Count)" "DEBUG"
    
    # ---- Build HTML table rows ----
    $deletedTableRows = ""
    foreach ($vm in ($deletedVMs | Sort-Object VMName)) {
        $deletedTableRows += "<tr>"
        $deletedTableRows += "<td>$($vm.VMName)</td>"
        $deletedTableRows += "<td>$($vm.DeploymentName)</td>"
        $deletedTableRows += "<td>$($vm.RequestAction)</td>"
        $deletedTableRows += "<td>$($vm.RequestStatus)</td>"
        $deletedTableRows += "<td>$($vm.RequestedBy)</td>"
        $deletedTableRows += "<td>$($vm.DeletedAt)</td>"
        $deletedTableRows += "<td>$($vm.Source)</td>"
        $deletedTableRows += "</tr>"
    }
    
    $decommissionTableRows = ""
    foreach ($vm in ($decommissionVMs | Sort-Object VMName)) {
        $decommissionTableRows += "<tr style='background-color: #fff9c4;'>"
        $decommissionTableRows += "<td>$($vm.VMName)</td>"
        $decommissionTableRows += "<td>$($vm.DeploymentName)</td>"
        $decommissionTableRows += "<td>$($vm.RequestAction)</td>"
        $decommissionTableRows += "<td>$($vm.RequestStatus)</td>"
        $decommissionTableRows += "<td>$($vm.RequestedBy)</td>"
        $decommissionTableRows += "<td>$($vm.InitiatedAt)</td>"
        $decommissionTableRows += "<td>$($vm.DeletionDate)</td>"
        $decommissionTableRows += "<td>$($vm.Source)</td>"
        $decommissionTableRows += "</tr>"
    }
    
    $htmlBody = @"
<html>
<head>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #d32f2f; border-bottom: 3px solid #f44336; padding-bottom: 10px; }
    h2 { color: #1976D2; border-bottom: 2px solid #2196F3; padding-bottom: 5px; margin-top: 30px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; margin-bottom: 30px; }
    th { background-color: #2196F3; color: white; padding: 12px; text-align: left; font-weight: bold; }
    td { border: 1px solid #ddd; padding: 10px; }
    .no-data { padding: 15px; background-color: #e8f5e9; color: #2e7d32; border-left: 4px solid #4caf50; }
</style>
</head>
<body>
<h1>VM Deletion and Decommission Report</h1>

<h2>Deleted Virtual Machines</h2>
$(if($deletedVMs.Count -gt 0) {
"<table>
<thead>
<tr>
<th>VM Name</th>
<th>Deployment Name</th>
<th>Action</th>
<th>Status</th>
<th>Deleted By</th>
<th>Deleted At</th>
<th>Source</th>
</tr>
</thead>
<tbody>
$deletedTableRows
</tbody>
</table>"
} else {
"<p class='no-data'>No deleted VMs found in this time period</p>"
})

<h2>Decommissions In Progress</h2>
$(if($decommissionVMs.Count -gt 0) {
"<table>
<thead>
<tr style='background-color: #ff9800;'>
<th>VM Name</th>
<th>Deployment Name</th>
<th>Request Action</th>
<th>Request Status</th>
<th>Requested By</th>
<th>Initiated At</th>
<th>Deletion Date</th>
<th>Source</th>
</tr>
</thead>
<tbody>
$decommissionTableRows
</tbody>
</table>"
} else {
"<p class='no-data'>No decommissions currently scheduled</p>"
})

</body>
</html>
"@
    
    Write-Log "Sending email to: $($To -join ', ')" "DEBUG"
    Write-Log "Email subject: $Subject" "DEBUG"
    
    try {
        # Build Send-MailMessage parameters explicitly
        $mailParams = @{
            To = $To
            From = $From
            Subject = $Subject
            Body = $htmlBody
            BodyAsHtml = $true
            SmtpServer = $SmtpServer
            Port = $SmtpPort
            UseSsl = $true
        }
        
        # Only add Cc if it has values
        if ($Cc -and $Cc.Count -gt 0) {
            $mailParams['Cc'] = $Cc
            Write-Log "Adding Cc recipients: $($Cc -join ', ')" "DEBUG"
        }
        
        Write-Log "Calling Send-MailMessage with parameters..." "DEBUG"
        Send-MailMessage @mailParams
        Write-Log "Email sent successfully!" "SUCCESS"
    }
    catch {
        Write-Log "Failed to send email: $($_.Exception.Message)" "ERROR"
        Write-Log "Full error details: $($_.Exception)" "ERROR"
        Write-Log "Error type: $($_.Exception.GetType().FullName)" "ERROR"
    }
}

# ============================================================================
# MAIN SCRIPT EXECUTION
# ============================================================================

Write-DebugSection "DELETED VM TRACKER - STARTED"
Write-Log "Script Version: 2.3.0 - Full request history + CRN matching for CREATE_FAILED" "SUCCESS"
Write-Log "PowerShell Version: $($PSVersionTable.PSVersion)"
Write-Log "Debug output file: $debugOutputFile" "SUCCESS"

try {
    # NOTE: VMware PowerCLI is being transitioned to VMware.VCF.PowerCLI
    # For now, VMware.PowerCLI still works but consider migrating to VMware.VCF.PowerCLI in the future
    # To install VCF module: Install-Module -Name VMware.VCF.PowerCLI -Scope CurrentUser
    
    Write-Log "Attempting to load VMware PowerCLI module..." "DEBUG"
    
    # Try to import the newer VCF module first, fall back to traditional PowerCLI
    $moduleLoaded = $false
    
    if (Get-Module -ListAvailable -Name VMware.VCF.PowerCLI) {
        Import-Module VMware.VCF.PowerCLI -ErrorAction Stop
        Write-Log "VMware.VCF.PowerCLI loaded (newer module)" "SUCCESS"
        $moduleLoaded = $true
    }
    elseif (Get-Module -ListAvailable -Name VMware.PowerCLI) {
        Import-Module VMware.PowerCLI -ErrorAction Stop
        Write-Log "VMware.PowerCLI loaded (legacy module - consider upgrading to VMware.VCF.PowerCLI)" "SUCCESS"
        $moduleLoaded = $true
    }
    else {
        throw "Neither VMware.VCF.PowerCLI nor VMware.PowerCLI modules are installed"
    }
    
    if ($moduleLoaded) {
        Set-PowerCLIConfiguration -InvalidCertificateAction Ignore -Confirm:$false -Scope Session | Out-Null
        Write-Log "PowerCLI configuration set" "SUCCESS"
    }
}
catch {
    Write-Log "Failed to load VMware PowerCLI: $($_.Exception.Message)" "ERROR"
    Write-Log "Please install VMware PowerCLI or VMware.VCF.PowerCLI:" "ERROR"
    Write-Log "  Option 1 (Recommended): Install-Module -Name VMware.VCF.PowerCLI -Scope CurrentUser" "ERROR"
    Write-Log "  Option 2 (Legacy): Install-Module -Name VMware.PowerCLI -Scope CurrentUser" "ERROR"
    exit
}

Disable-SSLValidation

Write-Log "Requesting credentials..." "DEBUG"
$credential = Get-Credential -Message "Enter credentials for Aria Operations, vRA, and vCenter"
if (-not $credential) {
    Write-Log "Credentials not provided. Exiting." "ERROR"
    exit
}
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

# ============================================================================
# VRA - GET ACTIVE DEPLOYMENTS WITH DECOMMISSION REQUESTS
# ============================================================================

Write-DebugSection "vRA - PROCESSING ACTIVE DEPLOYMENTS WITH DECOMMISSION REQUESTS"

$allVraDecommissionVMs = @()

foreach ($vraServer in $vraServers) {
    try {
        Write-Log "`nConnecting to vRA: $vraServer" "DEBUG"
        
        $vraAuthUri = "https://$vraServer/csp/gateway/am/api/login"
        $vraAuthBody = @{
            username = $username
            password = $password
        } | ConvertTo-Json
        
        $vraAuthResponse = Invoke-RestMethod -Uri $vraAuthUri -Method Post -Headers @{
            "Content-Type" = "application/json"
        } -Body $vraAuthBody -ErrorAction Stop
        
        $vraHeaders = @{
            "Authorization" = "Bearer $($vraAuthResponse.cspAuthToken)"
            "Content-Type" = "application/json"
        }
        
        Write-Log "Authenticated successfully" "SUCCESS"
        
        $decommVMs = Get-ActiveDeploymentsWithDecommission -VraServer $vraServer -Headers $vraHeaders
        $allVraDecommissionVMs += $decommVMs
        
    }
    catch {
        Write-Log "Error with vRA server $vraServer : $($_.Exception.Message)" "ERROR"
    }
}

Write-Log "`nvRA Decommission Total: Found $($allVraDecommissionVMs.Count) VMs with active decommission requests" "SUCCESS"

# ============================================================================
# VRA - GET FAILED DEPLOYMENTS
# ============================================================================

Write-DebugSection "vRA - PROCESSING FAILED DEPLOYMENTS"

$allVraFailedVMs = @()

foreach ($vraServer in $vraServers) {
    try {
        Write-Log "`nConnecting to vRA: $vraServer" "DEBUG"
        
        $vraAuthUri = "https://$vraServer/csp/gateway/am/api/login"
        $vraAuthBody = @{
            username = $username
            password = $password
        } | ConvertTo-Json
        
        $vraAuthResponse = Invoke-RestMethod -Uri $vraAuthUri -Method Post -Headers @{
            "Content-Type" = "application/json"
        } -Body $vraAuthBody -ErrorAction Stop
        
        $vraHeaders = @{
            "Authorization" = "Bearer $($vraAuthResponse.cspAuthToken)"
            "Content-Type" = "application/json"
        }
        
        Write-Log "Authenticated successfully" "SUCCESS"
        
        $failedVMs = Get-FailedDeploymentsFromVRA -VraServer $vraServer -Headers $vraHeaders -DaysBack $daysBack
        $allVraFailedVMs += $failedVMs
        
    }
    catch {
        Write-Log "Error with vRA server $vraServer : $($_.Exception.Message)" "ERROR"
    }
}

Write-Log "`nvRA Failed Deployments Total: Found $($allVraFailedVMs.Count) VMs from failed deployments across all servers" "SUCCESS"

# ============================================================================
# VRA - GET DELETED DEPLOYMENTS
# ============================================================================

Write-DebugSection "vRA - PROCESSING DELETED DEPLOYMENTS"

$allVraDeletedVMs = @()

foreach ($vraServer in $vraServers) {
    try {
        Write-Log "`nConnecting to vRA: $vraServer" "DEBUG"
        
        $vraAuthUri = "https://$vraServer/csp/gateway/am/api/login"
        $vraAuthBody = @{
            username = $username
            password = $password
        } | ConvertTo-Json
        
        $vraAuthResponse = Invoke-RestMethod -Uri $vraAuthUri -Method Post -Headers @{
            "Content-Type" = "application/json"
        } -Body $vraAuthBody -ErrorAction Stop
        
        $vraHeaders = @{
            "Authorization" = "Bearer $($vraAuthResponse.cspAuthToken)"
            "Content-Type" = "application/json"
        }
        
        Write-Log "Authenticated successfully" "SUCCESS"
        
        $deletedVMs = Get-DeletedVMsFromVRA -VraServer $vraServer -Headers $vraHeaders -DaysBack $daysBack
        $allVraDeletedVMs += $deletedVMs
        
    }
    catch {
        Write-Log "Error with vRA server $vraServer : $($_.Exception.Message)" "ERROR"
    }
}

Write-Log "`nvRA Deleted Total: Found $($allVraDeletedVMs.Count) deleted VMs across all servers" "SUCCESS"

# ============================================================================
# VCENTER - GET DIRECT DELETIONS
# ============================================================================

Write-DebugSection "vCENTER - CHECKING DIRECT VM DELETIONS"

$allVCenterDeletedVMs = @()

foreach ($vCenter in $vCenters) {
    $deletedVMs = Get-DeletedVMsFromVCenter -VCenter $vCenter -Credential $credential -DaysBack $daysBack
    $allVCenterDeletedVMs += $deletedVMs
}

Write-Log "`nvCenter Total: Found $($allVCenterDeletedVMs.Count) deleted VMs across all servers" "SUCCESS"

# ============================================================================
# ★ NEW: MATCH failed vRA VMs against vCenter deletions by Cloud Resource Name
# ============================================================================

Write-DebugSection "MATCHING FAILED vRA VMs vs vCenter DELETIONS"

$allVraFailedVMs = Match-FailedVMsWithVCenter -FailedVMs $allVraFailedVMs -VCenterEvents $allVCenterDeletedVMs

Write-Log "Enriched failed VM list ready: $($allVraFailedVMs.Count) entries" "SUCCESS"

# ============================================================================
# SUMMARY AND REPORT
# ============================================================================

Write-DebugSection "SUMMARY AND REPORTING"

Write-Log "vRA Decommission In Progress: $($allVraDecommissionVMs.Count)" "SUCCESS"
Write-Log "vRA Failed Deployments: $($allVraFailedVMs.Count)" "SUCCESS"
Write-Log "vRA Deleted Deployments: $($allVraDeletedVMs.Count)" "SUCCESS"
Write-Log "vCenter Direct Deletions: $($allVCenterDeletedVMs.Count)" "SUCCESS"

$vraVCenterTotal = $allVraDeletedVMs.Count + $allVraDecommissionVMs.Count + $allVraFailedVMs.Count + $allVCenterDeletedVMs.Count

Write-Log "Total (vRA + vCenter): $vraVCenterTotal" "DEBUG"

# Validate email configuration before attempting to send
Write-Log "=== PRE-SEND EMAIL VALIDATION ===" "DEBUG"
Write-Log "script:smtpTo = $($script:smtpTo -join ', ')" "DEBUG"
Write-Log "script:smtpTo Type = $($script:smtpTo.GetType().Name)" "DEBUG"
Write-Log "script:smtpTo Count = $($script:smtpTo.Count)" "DEBUG"
Write-Log "script:smtpFrom = $script:smtpFrom" "DEBUG"
Write-Log "script:smtpServer = $script:smtpServer" "DEBUG"
Write-Log "=================================" "DEBUG"

if ($vraVCenterTotal -eq 0) {
    Write-Log "No deleted or decommissioned VMs found. Sending notification email..." "WARN"
    
    $noDeletedVMsHtml = @"
<html>
<head>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .info-box { background-color: #e8f5e9; padding: 20px; border-left: 4px solid #4caf50; margin: 20px 0; }
    .info-box h2 { margin-top: 0; color: #2e7d32; }
    .info-box p { color: #424242; font-size: 14px; line-height: 1.6; }
</style>
</head>
<body>
<div class="info-box">
    <h2>No VM Deletions Detected</h2>
    <p>No virtual machines were deleted or decommissioned in the last $daysBack day(s).</p>
</div>
</body>
</html>
"@
    
    $noVMSubject = "No VM Deletions - $(Get-Date -Format 'dd-MM-yyyy')"
    
    try {
        $mailParams = @{
            To = $script:smtpTo
            From = $script:smtpFrom
            Subject = $noVMSubject
            Body = $noDeletedVMsHtml
            BodyAsHtml = $true
            SmtpServer = $script:smtpServer
            Port = $script:smtpPort
            UseSsl = $true
        }
        
        if ($script:smtpCc -and $script:smtpCc.Count -gt 0) {
            $mailParams['Cc'] = $script:smtpCc
        }
        
        Send-MailMessage @mailParams
        Write-Log "Notification email sent successfully!" "SUCCESS"
    }
    catch {
        Write-Log "Failed to send notification email: $($_.Exception.Message)" "ERROR"
        Write-Log "Full error details: $($_.Exception)" "ERROR"
    }
}
else {
    Write-Log "Found VMs to report. Sending detailed report..." "DEBUG"
    Send-DeletedVMReport `
        -VraDeletedData $allVraDeletedVMs `
        -VraDecommissionData $allVraDecommissionVMs `
        -VraFailedData $allVraFailedVMs `
        -VCenterData $allVCenterDeletedVMs `
        -SmtpServer $script:smtpServer `
        -SmtpPort $script:smtpPort `
        -From $script:smtpFrom `
        -To $script:smtpTo `
        -Cc $script:smtpCc `
        -Subject $script:smtpSubject
}

Write-DebugSection "SCRIPT COMPLETED"
Write-Log "Script Version: 2.3.0" "SUCCESS"
Write-Log "Debug log saved to: $debugOutputFile" "SUCCESS"
Write-Log "`nScript finished. Check the debug file for detailed logs." "SUCCESS"
