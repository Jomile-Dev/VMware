# Deleted VM Tracker - Aria Operations + Multi-vRA + vCenter
# Version 2.0.0
# PowerShell 5.1 Compatible
# Tracks VMs deleted in the last 24 hours with extensive debugging

# Configuration
$ariaOpsServer = "aria-ops.yourdomain.com"
$ariaOpsDomain = "yourdomain.com"
$ariaOpsAuthSource = "localos"

$vraServers = @(
    "vra1.yourdomain.com",
    "vra2.yourdomain.com"
)

$vCenters = @(
    "vcenter1.domain.com",
    "vcenter2.domain.com",
    "vcenter3.domain.com"
)

# SMTP Configuration
$smtpServer = "smtp.yourdomain.com"
$smtpPort = 587
$smtpFrom = "vra-reports@yourdomain.com"
$smtpTo = @("admin@yourdomain.com")
$smtpCc = @("manager@yourdomain.com")
$smtpSubject = "Deleted VM Report - $(Get-Date -Format 'yyyy-MM-dd')"

# Time range (in days)
$daysBack = 1
$eventsPageSize = 200

# Output file for debugging
$debugOutputFile = "DeletedVMs_Debug_$(Get-Date -Format 'yyyyMMdd_HHmmss').txt"

# Helper Functions
function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    
    $color = switch ($Level) {
        "ERROR" { "Red" }
        "WARN" { "Yellow" }
        "SUCCESS" { "Green" }
        "DEBUG" { "Magenta" }
        default { "Cyan" }
    }
    
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] [$Level] $Message"
    Write-Host $logMessage -ForegroundColor $color
    
    # Also write to debug file
    Add-Content -Path $debugOutputFile -Value $logMessage
}

function Write-DebugSection {
    param([string]$Title)
    
    $separator = "`n" + ("=" * 80) + "`n"
    $header = "$separator$Title$separator"
    Write-Host $header -ForegroundColor Cyan
    Add-Content -Path $debugOutputFile -Value $header
}

function Disable-SSLValidation {
    if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
        Add-Type @"
using System.Net;
using System.Security.Cryptography.X509Certificates;
public class TrustAllCertsPolicy : ICertificatePolicy {
    public bool CheckValidationResult(
        ServicePoint svcPoint, X509Certificate certificate,
        WebRequest request, int certificateProblem) {
        return true;
    }
}
"@
        [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
    }
    [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
}

function Get-ActiveDeploymentsWithDecommission {
    param(
        [Parameter(Mandatory=$true)]
        [string]$VraServer,
        
        [Parameter(Mandatory=$true)]
        [hashtable]$Headers
    )
    
    Write-DebugSection "Checking Active Deployments with Decommission Requests: $VraServer"
    
    $decommissionData = @()
    $cutoffDate = (Get-Date).AddDays(-$script:daysBack)
    
    Write-Log "Cutoff date for decommission filter: $cutoffDate" "WARN"
    Write-Log "NOTE: Checking ALL active deployments but only including decommissions initiated within last $script:daysBack days" "WARN"
    Write-Log "Fetching ALL active deployments..." "DEBUG"
    
    # Get all active deployments with resource expansion
    $vraUri = "https://$VraServer/deployment/api/deployments"
    $page = 0
    $size = 1000
    $allDeployments = @()
    
    do {
        $pagedUri = "$vraUri`?page=$page&size=$size&expand=resources"
        Write-Log "  Fetching page $page from: $pagedUri" "DEBUG"
        
        try {
            $vraResponse = Invoke-RestMethod -Uri $pagedUri -Method Get -Headers $Headers -ErrorAction Stop
            $deployments = if ($vraResponse.content) { $vraResponse.content } else { $vraResponse }
            
            if ($deployments -and $deployments.Count -gt 0) {
                $allDeployments += $deployments
                Write-Log "  Page $page : Found $($deployments.Count) deployments" "DEBUG"
                $page++
            }
            else {
                break
            }
            
            $hasMore = if ($vraResponse.totalPages) { 
                $page -lt $vraResponse.totalPages
            } elseif ($vraResponse.totalElements) { 
                ($page * $size) -lt $vraResponse.totalElements
            } else { 
                $deployments.Count -eq $size
            }
        }
        catch {
            Write-Log "  Error fetching page $page : $($_.Exception.Message)" "ERROR"
            break
        }
        
    } while ($hasMore)
    
    Write-Log "Total active deployments retrieved: $($allDeployments.Count)" "DEBUG"
    
    # Filter for deployments containing VMs only
    Write-Log "`n--- Filtering for VM-containing deployments ---" "DEBUG"
    $filteredDeployments = $allDeployments | Where-Object {
        $hasVM = $false
        if ($_.resources) {
            foreach ($resource in $_.resources) {
                if ($resource.type -eq "Cloud.vSphere.Machine") {
                    $hasVM = $true
                    break
                }
            }
        }
        if ($hasVM) {
            Write-Log "  ‚úì Deployment '$($_.name)' has VMs - KEEPING" "DEBUG"
        }
        else {
            Write-Log "  ‚úó Deployment '$($_.name)' has NO VMs - FILTERING OUT" "DEBUG"
        }
        $hasVM
    }
    
    Write-Log "`nDeployments containing VMs: $($filteredDeployments.Count)" "SUCCESS"
    Write-Log "Deployments filtered out (no VMs): $(($allDeployments.Count - $filteredDeployments.Count))" "WARN"
    $allDeployments = $filteredDeployments
    
    # Process each deployment looking for decommission requests
    foreach ($deployment in $allDeployments) {
        Write-Log "`n--- Active Deployment: $($deployment.name) (ID: $($deployment.id)) ---" "DEBUG"
        Write-Log "  Status: $($deployment.status)" "DEBUG"
        Write-Log "  Created: $($deployment.createdAt)" "DEBUG"
        Write-Log "  Last Updated: $($deployment.lastUpdatedAt)" "DEBUG"
        Write-Log "  Owned By: $($deployment.ownedBy)" "DEBUG"
        Write-Log "  Created By: $($deployment.createdBy)" "DEBUG"
        Write-Log "  Project: $($deployment.projectId)" "DEBUG"
        
        # Log resources in deployment (VMs only)
        if ($deployment.resources) {
            Write-Log "  Resources in deployment:" "DEBUG"
            foreach ($resource in $deployment.resources) {
                if ($resource.type -eq "Cloud.vSphere.Machine") {
                    Write-Log "    - Type: $($resource.type), Name: $($resource.name), ID: $($resource.id)" "DEBUG"
                    if ($resource.properties) {
                        Write-Log "      Properties:" "DEBUG"
                        $resource.properties.PSObject.Properties | ForEach-Object {
                            Write-Log "        $($_.Name): $($_.Value)" "DEBUG"
                        }
                    }
                }
            }
        }
        
        # Get deployment requests with expanded details
        try {
            $requestsUri = "https://$VraServer/deployment/api/deployments/$($deployment.id)/requests?apiVersion=2020-08-25"
            Write-Log "  Fetching requests from: $requestsUri" "DEBUG"
            
            $requestsResponse = Invoke-RestMethod -Uri $requestsUri -Method Get -Headers $Headers -ErrorAction Stop
            $requests = if ($requestsResponse.content) { $requestsResponse.content } else { $requestsResponse }
            
            Write-Log "  Found $($requests.Count) requests for this deployment" "DEBUG"
            
            foreach ($request in $requests) {
                Write-Log "    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" "DEBUG"
                Write-Log "    ‚ïë Request ID: $($request.id)" "DEBUG"
                Write-Log "    ‚ïë Name: $($request.name)" "DEBUG"
                Write-Log "    ‚ïë Action ID: $($request.actionId)" "DEBUG"
                Write-Log "    ‚ïë Status: $($request.status)" "DEBUG"
                Write-Log "    ‚ïë Requested By: $($request.requestedBy)" "DEBUG"
                Write-Log "    ‚ïë Initiated At: $($request.initiatedAt)" "DEBUG"
                Write-Log "    ‚ïë Completed At: $($request.completedAt)" "DEBUG"
                
                # DUMP ALL REQUEST PROPERTIES TO FIND TIMESTAMPS
                Write-Log "    ‚ïë" "DEBUG"
                Write-Log "    ‚ïë >>> FULL REQUEST OBJECT DUMP (ALL PROPERTIES) <<<" "WARN"
                Write-Log "    ‚ïë" "DEBUG"
                if ($request) {
                    $request.PSObject.Properties | ForEach-Object {
                        $propName = $_.Name
                        $propValue = $_.Value
                        if ($propValue -eq $null) {
                            Write-Log "    ‚ïë   $propName = NULL" "WARN"
                        }
                        elseif ($propValue -is [string] -and [string]::IsNullOrWhiteSpace($propValue)) {
                            Write-Log "    ‚ïë   $propName = [EMPTY STRING]" "WARN"
                        }
                        else {
                            Write-Log "    ‚ïë   $propName = $propValue" "DEBUG"
                        }
                    }
                }
                else {
                    Write-Log "    ‚ïë   REQUEST OBJECT IS NULL!" "ERROR"
                }
                Write-Log "    ‚ïë" "DEBUG"
                Write-Log "    ‚ïë >>> END REQUEST OBJECT DUMP <<<" "WARN"
                Write-Log "    ‚ïë" "DEBUG"
                
                # Get ALL events for this request for troubleshooting
                $eventPage = 0
                $allRequestEvents = @()
                
                do {
                    $eventsUri = "https://$VraServer/deployment/api/deployments/$($deployment.id)/requests/$($request.id)/events?page=$eventPage&size=$script:eventsPageSize&apiVersion=2020-08-25"
                    
                    try {
                        $eventsResponse = Invoke-RestMethod -Uri $eventsUri -Method Get -Headers $Headers -ErrorAction Stop
                        $events = if ($eventsResponse.content) { $eventsResponse.content } else { $eventsResponse }
                        
                        if ($events -and $events.Count -gt 0) {
                            $allRequestEvents += $events
                            $eventPage++
                            if ($events.Count -lt $script:eventsPageSize) { break }
                        }
                        else {
                            break
                        }
                    }
                    catch {
                        Write-Log "      Error fetching events page $eventPage : $($_.Exception.Message)" "ERROR"
                        break
                    }
                    
                    if ($eventPage -ge 20) { break }
                    
                } while ($true)
                
                Write-Log "    ‚ïë Total Events: $($allRequestEvents.Count)" "DEBUG"
                Write-Log "    ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" "DEBUG"
                
                # Log all events for troubleshooting
                $eventNum = 1
                foreach ($event in $allRequestEvents) {
                    Write-Log "    ‚ïë   Event #$eventNum" "DEBUG"
                    Write-Log "    ‚ïë     Event Type: $($event.eventType)" "DEBUG"
                    Write-Log "    ‚ïë     Resource Type: $($event.resourceType)" "DEBUG"
                    Write-Log "    ‚ïë     Resource Name: $($event.resourceName)" "DEBUG"
                    Write-Log "    ‚ïë     Status: $($event.status)" "DEBUG"
                    Write-Log "    ‚ïë     Timestamp: $($event.timestamp)" "DEBUG"
                    Write-Log "    ‚ïë     Message: $($event.message)" "DEBUG"
                    
                    if ($event.details) {
                        $detailsText = if ($event.details -is [string]) { 
                            $event.details 
                        } else { 
                            ($event.details | ConvertTo-Json -Compress -Depth 10)
                        }
                        Write-Log "    ‚ïë     Details: $detailsText" "DEBUG"
                    }
                    
                    Write-Log "    ‚ïë   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" "DEBUG"
                    $eventNum++
                }
                
                Write-Log "    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" "DEBUG"
                
                # Check if this is a decommission request (still active, not deleted)
                $isDecommission = $false
                $matchedBy = "None"
                
                Write-Log "    ‚ïë Checking if this is a decommission request..." "DEBUG"
                Write-Log "    ‚ïë   Request Name: '$($request.name)'" "DEBUG"
                Write-Log "    ‚ïë   Action ID: '$($request.actionId)'" "DEBUG"
                Write-Log "    ‚ïë   Initiated At: $($request.initiatedAt)" "DEBUG"
                
                # Check name pattern
                $nameMatch = $false
                if ($request.name -match "Initiate server decommission|decommission") {
                    $nameMatch = $true
                    Write-Log "    ‚ïë   ‚úì Name matches decommission pattern" "WARN"
                }
                else {
                    Write-Log "    ‚ïë   ‚úó Name does NOT match decommission pattern" "DEBUG"
                }
                
                # Check action ID pattern
                $actionMatch = $false
                if ($request.actionId -match "Deployment.Delete|Resource.Delete|Cloud.vSphere.Machine.Delete|Deployment.custom.initiate_server_decommission") {
                    $actionMatch = $true
                    Write-Log "    ‚ïë   ‚úì Action ID matches decommission pattern" "WARN"
                }
                else {
                    Write-Log "    ‚ïë   ‚úó Action ID does NOT match decommission pattern" "DEBUG"
                }
                
                # Check if either name or action matches
                if ($nameMatch -or $actionMatch) {
                    Write-Log "    ‚ïë   >>> Pattern matched! Checking date filter..." "WARN"
                    
                    # BUGFIX: Add null check for initiatedAt
                    if ($request.initiatedAt) {
                        try {
                            $initiatedDate = [DateTime]$request.initiatedAt
                            Write-Log "    ‚ïë   >>> Initiated Date: $initiatedDate" "DEBUG"
                            Write-Log "    ‚ïë   >>> Cutoff Date: $cutoffDate" "DEBUG"
                            Write-Log "    ‚ïë   >>> Days difference: $(($initiatedDate - $cutoffDate).Days) days" "DEBUG"
                            
                            if ($initiatedDate -ge $cutoffDate) {
                                $isDecommission = $true
                                $matchedBy = if ($nameMatch) { "Request Name" } else { "Action ID" }
                                Write-Log "    ‚ïë   >>> ‚úì‚úì‚úì DECOMMISSION REQUEST CONFIRMED ‚úì‚úì‚úì" "WARN"
                                Write-Log "    ‚ïë   >>> Matched by: $matchedBy" "WARN"
                                Write-Log "    ‚ïë   >>> This deployment will be included in the report" "WARN"
                            }
                            else {
                                Write-Log "    ‚ïë   >>> ‚úó REJECTED: Initiated date is BEFORE cutoff date" "ERROR"
                                Write-Log "    ‚ïë   >>> This decommission is TOO OLD (> $script:daysBack days)" "ERROR"
                            }
                        }
                        catch {
                            Write-Log "    ‚ïë   >>> ‚úó ERROR: Cannot convert initiatedAt to DateTime: $($_.Exception.Message)" "ERROR"
                        }
                    }
                    else {
                        Write-Log "    ‚ïë   >>> ‚úó ERROR: initiatedAt is NULL - cannot verify date" "ERROR"
                        Write-Log "    ‚ïë   >>> Skipping date check - assuming recent decommission" "WARN"
                        # Still mark as decommission if pattern matches, even without date
                        $isDecommission = $true
                        $matchedBy = if ($nameMatch) { "Request Name" } else { "Action ID" }
                    }
                }
                else {
                    Write-Log "    ‚ïë   >>> NOT a decommission request (no pattern match)" "DEBUG"
                }
                
                if ($isDecommission) {
                    # Get VMs from this deployment
                    $vSphereMachines = $deployment.resources | Where-Object { 
                        $_.type -eq "Cloud.vSphere.Machine"
                    }
                    
                    foreach ($machine in $vSphereMachines) {
                        $hostname = $null
                        
                        if ($machine.properties) {
                            $props = $machine.properties
                            
                            # Prioritize actual hostname over resource name
                            if ($props.PSObject.Properties['hostname']) {
                                $hostname = $props.hostname
                            }
                            elseif ($props.PSObject.Properties['address']) {
                                $hostname = $props.address
                            }
                            elseif ($props.PSObject.Properties['resourceName']) {
                                # Only use resourceName if it doesn't look like Cloud_vSphere_Machine_X
                                if ($props.resourceName -notmatch "Cloud_vSphere_Machine_\d+") {
                                    $hostname = $props.resourceName
                                }
                            }
                            elseif ($props.PSObject.Properties['name']) {
                                # Only use name if it doesn't look like Cloud_vSphere_Machine_X
                                if ($props.name -notmatch "Cloud_vSphere_Machine_\d+") {
                                    $hostname = $props.name
                                }
                            }
                        }
                        
                        # Fall back to machine.name only if it's not a generic resource name
                        if (-not $hostname -and $machine.name -and $machine.name -notmatch "Cloud_vSphere_Machine_\d+") {
                            $hostname = $machine.name
                        }
                        
                        if ($hostname) {
                            Write-Log "      >>> VM in Decommission: $hostname <<<" "WARN"
                            Write-Log "      >>> Matched decommission by: $matchedBy <<<" "DEBUG"
                            Write-Log "      >>> Request Name: $($request.name) <<<" "DEBUG"
                            Write-Log "      >>> Action ID: $($request.actionId) <<<" "DEBUG"
                            
                            $vraServerShort = ($VraServer -split '\.')[0]
                            $catalogItem = if ($deployment.inputs._catalogItemName) { $deployment.inputs._catalogItemName } else { "N/A" }
                            
                            # BUGFIX: Handle null initiatedAt
                            $initiatedAtValue = if ($request.initiatedAt) { $request.initiatedAt } else { "N/A" }
                            $completedAtValue = if ($request.completedAt) { $request.completedAt } else { "N/A" }
                            
                            $decommissionData += [PSCustomObject]@{
                                VMName = $hostname
                                ResourceType = $machine.type
                                DeploymentName = $deployment.name
                                DeploymentID = $deployment.id
                                DeploymentStatus = $deployment.status
                                RequestID = $request.id
                                RequestAction = $request.name
                                RequestStatus = $request.status
                                RequestedBy = $request.requestedBy
                                Requestor = if ($deployment.ownedBy) { $deployment.ownedBy } else { $request.requestedBy }
                                CatalogItem = $catalogItem
                                InitiatedAt = $initiatedAtValue
                                CompletedAt = $completedAtValue
                                vRAServer = $vraServerShort
                                Source = "vRA-Decommission-InProgress"
                                IsStillActive = $true
                                TotalEvents = $allRequestEvents.Count
                            }
                        }
                    }
                }
            }
        }
        catch {
            Write-Log "  Error processing deployment requests: $($_.Exception.Message)" "ERROR"
            Write-Log "  Full error: $($_.Exception)" "ERROR"
        }
    }
    
    Write-Log "`n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" "SUCCESS"
    Write-Log "‚ïë DECOMMISSION SUMMARY for $VraServer" "SUCCESS"
    Write-Log "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" "SUCCESS"
    Write-Log "‚ïë Total Active Deployments Checked: $($allDeployments.Count)" "SUCCESS"
    Write-Log "‚ïë VMs with Decommission Requests Found: $($decommissionData.Count)" "SUCCESS"
    if ($decommissionData.Count -gt 0) {
        Write-Log "‚ïë" "SUCCESS"
        Write-Log "‚ïë VMs Found in Decommission:" "SUCCESS"
        foreach ($vm in $decommissionData) {
            Write-Log "‚ïë   - $($vm.VMName) (Deployment: $($vm.DeploymentName))" "SUCCESS"
            Write-Log "‚ïë     Status: $($vm.RequestStatus), Initiated: $($vm.InitiatedAt)" "SUCCESS"
        }
    }
    else {
        Write-Log "‚ïë ‚ö† WARNING: No VMs with decommission requests found!" "WARN"
        Write-Log "‚ïë Possible reasons:" "WARN"
        Write-Log "‚ïë   1. No decommissions were initiated in the last $script:daysBack days" "WARN"
        Write-Log "‚ïë   2. Decommissions already completed and deployments deleted" "WARN"
        Write-Log "‚ïë   3. Request names/action IDs don't match expected patterns" "WARN"
    }
    Write-Log "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" "SUCCESS"
    
    return $decommissionData
}

function Get-DeletedVMsFromVRA {
    param(
        [Parameter(Mandatory=$true)]
        [string]$VraServer,
        
        [Parameter(Mandatory=$true)]
        [hashtable]$Headers,
        
        [Parameter(Mandatory=$true)]
        [int]$DaysBack
    )
    
    Write-DebugSection "Processing Deleted Deployments from vRA: $VraServer"
    
    $deletedVMData = @()
    $cutoffDate = (Get-Date).AddDays(-$DaysBack)
    
    Write-Log "Cutoff date: $cutoffDate" "DEBUG"
    
    # Get deleted deployments
    Write-Log "Searching for deleted deployments..." "DEBUG"
    
    $urlVariations = @(
        "https://$VraServer/deployment/api/deployments?deleted=true&apiVersion=2020-08-25&page={0}&size=$script:eventsPageSize",
        "https://$VraServer/deployment/api/deployments?deleted=%5Btrue%5D&apiVersion=2020-08-25&page={0}&size=$script:eventsPageSize"
    )
    
    $workingUrl = $null
    $allDeletedDeployments = @()
    
    foreach ($urlTemplate in $urlVariations) {
        try {
            $testUrl = $urlTemplate -f 0
            Write-Log "  Testing URL: $testUrl" "DEBUG"
            $response = Invoke-RestMethod -Uri $testUrl -Method Get -Headers $Headers -ErrorAction Stop
            $deployments = if ($response.content) { $response.content } else { $response }
            
            if ($deployments -and $deployments.Count -gt 0) {
                $workingUrl = $urlTemplate
                $allDeletedDeployments += $deployments
                Write-Log "  URL works! Found $($deployments.Count) deployments on page 0" "SUCCESS"
                break
            }
        }
        catch {
            Write-Log "  URL failed: $($_.Exception.Message)" "DEBUG"
            continue
        }
    }
    
    if (-not $workingUrl) {
        Write-Log "No deleted deployments found or API not supported" "WARN"
        return $deletedVMData
    }
    
    # Get remaining pages
    $page = 1
    do {
        try {
            $uri = $workingUrl -f $page
            $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $Headers -ErrorAction Stop
            $deployments = if ($response.content) { $response.content } else { $response }
            
            if ($deployments -and $deployments.Count -gt 0) {
                $allDeletedDeployments += $deployments
                Write-Log "  Page $page : Found $($deployments.Count) deployments" "DEBUG"
                $page++
            }
            else {
                break
            }
        }
        catch {
            Write-Log "  Error on page $page : $($_.Exception.Message)" "DEBUG"
            break
        }
        
        if ($allDeletedDeployments.Count -ge 5000) { break }
        
    } while ($true)
    
    Write-Log "Total deleted deployments retrieved: $($allDeletedDeployments.Count)" "SUCCESS"
    
    # Filter by date
    $filteredDeployments = $allDeletedDeployments | Where-Object {
        try {
            $updateDate = [DateTime]$_.lastUpdatedAt
            $updateDate -ge $cutoffDate
        }
        catch {
            $true
        }
    }
    
    Write-Log "Deployments within time range: $($filteredDeployments.Count)" "SUCCESS"
    
    # Filter for deployments containing VMs only
    $vmDeployments = $filteredDeployments | Where-Object {
        $hasVM = $false
        # Check if deployment name suggests VM deployment
        if ($_.name -match "VM|Virtual|Server|Machine") {
            $hasVM = $true
        }
        $hasVM
    }
    
    Write-Log "Deleted deployments with VMs: $($vmDeployments.Count)" "SUCCESS"
    $filteredDeployments = $vmDeployments
    
    # Process each deleted deployment
    foreach ($deployment in $filteredDeployments) {
        Write-Log "`n--- Deleted Deployment: $($deployment.name) (ID: $($deployment.id)) ---" "DEBUG"
        Write-Log "  Status: $($deployment.status)" "DEBUG"
        Write-Log "  Last Updated: $($deployment.lastUpdatedAt)" "DEBUG"
        Write-Log "  Owned By: $($deployment.ownedBy)" "DEBUG"
        Write-Log "  Created By: $($deployment.createdBy)" "DEBUG"
        
        # Get deployment requests with expanded event details
        try {
            $requestsUri = "https://$VraServer/deployment/api/deployments/$($deployment.id)/requests?apiVersion=2020-08-25&deleted=true"
            Write-Log "  Fetching requests from: $requestsUri" "DEBUG"
            
            $requestsResponse = Invoke-RestMethod -Uri $requestsUri -Method Get -Headers $Headers -ErrorAction Stop
            $requests = if ($requestsResponse.content) { $requestsResponse.content } else { $requestsResponse }
            
            Write-Log "  Found $($requests.Count) requests" "DEBUG"
            
            foreach ($request in $requests) {
                Write-Log "    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" "DEBUG"
                Write-Log "    ‚ïë Request ID: $($request.id)" "DEBUG"
                Write-Log "    ‚ïë Action: $($request.name)" "DEBUG"
                Write-Log "    ‚ïë Action ID: $($request.actionId)" "DEBUG"
                Write-Log "    ‚ïë Status: $($request.status)" "DEBUG"
                Write-Log "    ‚ïë Requested By: $($request.requestedBy)" "DEBUG"
                Write-Log "    ‚ïë Initiated At: $($request.initiatedAt)" "DEBUG"
                
                # Get ALL events for this request for troubleshooting
                $eventPage = 0
                $allEvents = @()
                
                do {
                    $eventsUri = "https://$VraServer/deployment/api/deployments/$($deployment.id)/requests/$($request.id)/events?page=$eventPage&size=$script:eventsPageSize&deleted=true&apiVersion=2020-08-25"
                    
                    try {
                        $eventsResponse = Invoke-RestMethod -Uri $eventsUri -Method Get -Headers $Headers -ErrorAction Stop
                        $events = if ($eventsResponse.content) { $eventsResponse.content } else { $eventsResponse }
                        
                        if ($events -and $events.Count -gt 0) {
                            $allEvents += $events
                            $eventPage++
                            if ($events.Count -lt $script:eventsPageSize) { break }
                        }
                        else {
                            break
                        }
                    }
                    catch {
                        Write-Log "      Error fetching events: $($_.Exception.Message)" "ERROR"
                        break
                    }
                    
                    if ($eventPage -ge 20) { break }
                    
                } while ($true)
                
                Write-Log "    ‚ïë Total Events: $($allEvents.Count)" "DEBUG"
                Write-Log "    ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" "DEBUG"
                
                # Log all events for troubleshooting
                $eventNum = 1
                foreach ($event in $allEvents) {
                    Write-Log "    ‚ïë   Event #$eventNum" "DEBUG"
                    Write-Log "    ‚ïë     Event Type: $($event.eventType)" "DEBUG"
                    Write-Log "    ‚ïë     Resource Type: $($event.resourceType)" "DEBUG"
                    Write-Log "    ‚ïë     Resource Name: $($event.resourceName)" "DEBUG"
                    Write-Log "    ‚ïë     Status: $($event.status)" "DEBUG"
                    Write-Log "    ‚ïë     Timestamp: $($event.timestamp)" "DEBUG"
                    Write-Log "    ‚ïë     Message: $($event.message)" "DEBUG"
                    
                    if ($event.details) {
                        $detailsText = if ($event.details -is [string]) { 
                            $event.details 
                        } else { 
                            ($event.details | ConvertTo-Json -Compress -Depth 10)
                        }
                        Write-Log "    ‚ïë     Details: $detailsText" "DEBUG"
                    }
                    
                    # Check if this is a VM resource
                    if ($event.resourceType -eq "Cloud.vSphere.Machine") {
                        $serverName = $null
                        
                        # Extract server name from details - prioritize actual VM name
                        if ($event.details) {
                            $detailsText = if ($event.details -is [string]) { 
                                $event.details 
                            } else { 
                                ($event.details | ConvertTo-Json -Compress -Depth 5)
                            }
                            
                            # Look for hostname or VM name in details
                            if ($detailsText -match '"hostname"\s*:\s*"([^"]+)"') {
                                $serverName = $matches[1].Trim()
                            }
                            elseif ($detailsText -match '"address"\s*:\s*"([^"]+)"') {
                                $serverName = $matches[1].Trim()
                            }
                            elseif ($detailsText -match 'Cloud Resource Name:\s*([^\s,;]+)') {
                                $potentialName = $matches[1].Trim()
                                # Only use if not a generic resource name
                                if ($potentialName -notmatch "Cloud_vSphere_Machine_\d+") {
                                    $serverName = $potentialName
                                }
                            }
                            elseif ($detailsText -match '"cloudResourceName"\s*:\s*"([^"]+)"') {
                                $potentialName = $matches[1].Trim()
                                # Only use if not a generic resource name
                                if ($potentialName -notmatch "Cloud_vSphere_Machine_\d+") {
                                    $serverName = $potentialName
                                }
                            }
                        }
                        
                        # Fall back to event.resourceName only if not generic
                        if (-not $serverName -and $event.resourceName) {
                            if ($event.resourceName -notmatch "Cloud_vSphere_Machine_\d+") {
                                $serverName = $event.resourceName
                            }
                        }
                        
                        if ($serverName) {
                            Write-Log "    ‚ïë     >>> FOUND DELETED VM: $serverName <<<" "SUCCESS"
                            Write-Log "    ‚ïë     >>> Adding to deleted VMs list <<<" "DEBUG"
                            
                            # Check if we already have this VM (case-insensitive)
                            $vmKey = $serverName.ToLower()
                            $existingVM = $deletedVMData | Where-Object { $_.VMName.ToLower() -eq $vmKey }
                            
                            if ($existingVM) {
                                Write-Log "    ‚ïë     >>> WARNING: VM '$serverName' already exists in deleted list - SKIPPING DUPLICATE <<<" "WARN"
                            }
                            else {
                                $vraServerShort = ($VraServer -split '\.')[0]
                                $requestedBy = if ($request.requestedBy) { $request.requestedBy } else { "N/A" }
                                $requestor = if ($deployment.ownedBy) { $deployment.ownedBy } else { $requestedBy }
                                $catalogItem = if ($deployment.inputs._catalogItemName) { $deployment.inputs._catalogItemName } else { "N/A" }
                                
                                $deletedVMData += [PSCustomObject]@{
                                    VMName = $serverName
                                    ResourceType = $event.resourceType
                                    DeploymentName = $deployment.name
                                    DeploymentID = $deployment.id
                                    DeploymentStatus = $deployment.status
                                    RequestID = $request.id
                                    RequestAction = $request.name
                                    RequestStatus = $request.status
                                    RequestedBy = $requestedBy
                                    Requestor = $requestor
                                    CatalogItem = $catalogItem
                                    DeletedAt = $deployment.lastUpdatedAt
                                    InitiatedAt = $request.initiatedAt
                                    vRAServer = $vraServerShort
                                    EventType = $event.eventType
                                    EventStatus = $event.status
                                    EventMessage = $event.message
                                    Source = "vRA-Deleted"
                                    IsStillActive = $false
                                    TotalEvents = $allEvents.Count
                                }
                                
                                Write-Log "    ‚ïë     >>> Successfully added VM '$serverName' to deleted list <<<" "SUCCESS"
                            }
                        }
                    }
                    
                    Write-Log "    ‚ïë   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" "DEBUG"
                    $eventNum++
                }
                
                Write-Log "    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" "DEBUG"
            }
        }
        catch {
            Write-Log "  Error processing deployment requests: $($_.Exception.Message)" "ERROR"
        }
    }
    
    Write-Log "`nExtracted $($deletedVMData.Count) deleted VMs from vRA server $VraServer" "SUCCESS"
    return $deletedVMData
}

function Get-DeletedVMsFromVCenter {
    param(
        [Parameter(Mandatory=$true)]
        [string]$VCenter,
        
        [Parameter(Mandatory=$true)]
        [PSCredential]$Credential,
        
        [Parameter(Mandatory=$true)]
        [int]$DaysBack
    )
    
    Write-DebugSection "Processing vCenter: $VCenter"
    
    $deletedVMs = @()
    
    try {
        Write-Log "Connecting to vCenter..." "DEBUG"
        Connect-VIServer -Server $VCenter -Credential $Credential -ErrorAction Stop | Out-Null
        Write-Log "Connected successfully" "SUCCESS"
        
        $cutoffDate = (Get-Date).AddDays(-$DaysBack)
        Write-Log "Fetching deletion events since: $cutoffDate" "DEBUG"
        
        # Get VM deletion events
        $events = Get-VIEvent -Server $VCenter -Start $cutoffDate -MaxSamples 50000 | Where-Object {
            $_.GetType().Name -in @('VmRemovedEvent', 'VmBeingDeletedEvent', 'VmUnregisteredEvent')
        }
        
        Write-Log "Found $($events.Count) deletion events" "SUCCESS"
        
        foreach ($event in $events) {
            Write-Log "`n--- Deletion Event ---" "DEBUG"
            Write-Log "  VM Name: $($event.Vm.Name)" "DEBUG"
            Write-Log "  Event Type: $($event.GetType().Name)" "DEBUG"
            Write-Log "  Created Time: $($event.CreatedTime)" "DEBUG"
            Write-Log "  User: $($event.UserName)" "DEBUG"
            Write-Log "  Message: $($event.FullFormattedMessage)" "DEBUG"
            
            $vCenterShort = ($VCenter -split '\.')[0]
            
            $deletedVMs += [PSCustomObject]@{
                VMName = $event.Vm.Name
                DeletedAt = $event.CreatedTime
                DeletedBy = if ($event.UserName) { $event.UserName } else { "N/A" }
                EventType = $event.GetType().Name
                Message = $event.FullFormattedMessage
                vCenter = $vCenterShort
                Source = "vCenter-Deleted"
            }
        }
        
        Disconnect-VIServer -Server $VCenter -Confirm:$false -ErrorAction SilentlyContinue
        Write-Log "Disconnected from vCenter" "DEBUG"
    }
    catch {
        Write-Log "Error with vCenter $VCenter : $($_.Exception.Message)" "ERROR"
    }
    
    Write-Log "Extracted $($deletedVMs.Count) deleted VMs from vCenter $VCenter" "SUCCESS"
    return $deletedVMs
}

function Send-DeletedVMReport {
    param(
        [Parameter(Mandatory=$false)]
        [Array]$AriaOpsData = @(),
        
        [Parameter(Mandatory=$false)]
        [Array]$VraDeletedData = @(),
        
        [Parameter(Mandatory=$false)]
        [Array]$VraDecommissionData = @(),
        
        [Parameter(Mandatory=$false)]
        [Array]$VCenterData = @(),
        
        [Parameter(Mandatory=$true)]
        [string]$SmtpServer,
        
        [Parameter(Mandatory=$true)]
        [int]$SmtpPort,
        
        [Parameter(Mandatory=$true)]
        [string]$From,
        
        [Parameter(Mandatory=$true)]
        [Array]$To,
        
        [Parameter(Mandatory=$false)]
        [Array]$Cc,
        
        [Parameter(Mandatory=$true)]
        [string]$Subject
    )
    
    Write-Log "Building HTML email report..." "DEBUG"
    
    # Build lookup of VMs in vRA (both deleted and decommission) for deduplication
    $vraVMNames = @{}
    foreach ($vm in $VraDeletedData) {
        $vraVMNames[$vm.VMName.ToLower()] = $true
    }
    foreach ($vm in $VraDecommissionData) {
        $vraVMNames[$vm.VMName.ToLower()] = $true
    }
    
    Write-Log "VMs found in vRA (for deduplication): $($vraVMNames.Count)" "DEBUG"
    
    # Separate deleted VMs and decommission VMs into different sections
    $deletedVMs = @()
    $decommissionVMs = @()
    
    # Add vRA Deleted VMs to deleted section
    foreach ($vm in $VraDeletedData) {
        Write-Log "Adding vRA deleted VM to report: $($vm.VMName) from $($vm.vRAServer)" "DEBUG"
        $deletedVMs += [PSCustomObject]@{
            VMName = $vm.VMName
            RequestedBy = $vm.RequestedBy
            DeletedAt = $vm.DeletedAt
            DeploymentName = $vm.DeploymentName
            RequestAction = $vm.RequestAction
            RequestStatus = $vm.RequestStatus
            Source = $vm.vRAServer
        }
    }
    
    # Add vCenter VMs to deleted section ONLY if NOT found in vRA
    foreach ($vm in $VCenterData) {
        $vmLower = $vm.VMName.ToLower()
        if ($vraVMNames.ContainsKey($vmLower)) {
            Write-Log "SKIPPING vCenter VM (already in vRA): $($vm.VMName) from $($vm.vCenter)" "WARN"
        }
        else {
            Write-Log "Adding vCenter deleted VM to report: $($vm.VMName) from $($vm.vCenter)" "DEBUG"
            $deletedVMs += [PSCustomObject]@{
                VMName = $vm.VMName
                RequestedBy = $vm.DeletedBy
                DeletedAt = $vm.DeletedAt
                DeploymentName = "N/A"
                RequestAction = $vm.EventType
                RequestStatus = "Deleted"
                Source = $vm.vCenter
            }
        }
    }
    
    # Add vRA Decommission VMs to separate decommission section
    foreach ($vm in $VraDecommissionData) {
        Write-Log "Adding decommission VM to report: $($vm.VMName) from $($vm.vRAServer)" "DEBUG"
        $decommissionVMs += [PSCustomObject]@{
            VMName = $vm.VMName
            RequestedBy = $vm.RequestedBy
            InitiatedAt = $vm.InitiatedAt
            DeploymentName = $vm.DeploymentName
            DeploymentStatus = $vm.DeploymentStatus
            RequestAction = $vm.RequestAction
            RequestStatus = $vm.RequestStatus
            Source = $vm.vRAServer
            TotalEvents = $vm.TotalEvents
        }
    }
    
    Write-Log "Total Deleted VMs for report: $($deletedVMs.Count)" "DEBUG"
    Write-Log "Total Decommission VMs for report: $($decommissionVMs.Count)" "DEBUG"
    Write-Log "vCenter VMs excluded (duplicates in vRA): $(($VCenterData.Count - ($deletedVMs | Where-Object { $_.Source -match 'vcenter' }).Count))" "DEBUG"
    
    # Build deleted VMs table rows
    $deletedTableRows = ""
    foreach ($vm in ($deletedVMs | Sort-Object VMName)) {
        $deletedTableRows += "<tr>"
        $deletedTableRows += "<td>$($vm.VMName)</td>"
        $deletedTableRows += "<td>$($vm.DeploymentName)</td>"
        $deletedTableRows += "<td>$($vm.RequestAction)</td>"
        $deletedTableRows += "<td>$($vm.RequestStatus)</td>"
        $deletedTableRows += "<td>$($vm.RequestedBy)</td>"
        $deletedTableRows += "<td>$($vm.DeletedAt)</td>"
        $deletedTableRows += "<td>$($vm.Source)</td>"
        $deletedTableRows += "</tr>"
    }
    
    # Build decommission VMs table rows
    $decommissionTableRows = ""
    foreach ($vm in ($decommissionVMs | Sort-Object VMName)) {
        $decommissionTableRows += "<tr style='background-color: #fff9c4;'>"
        $decommissionTableRows += "<td>$($vm.VMName)</td>"
        $decommissionTableRows += "<td>$($vm.DeploymentName)</td>"
        $decommissionTableRows += "<td>$($vm.DeploymentStatus)</td>"
        $decommissionTableRows += "<td>$($vm.RequestAction)</td>"
        $decommissionTableRows += "<td>$($vm.RequestStatus)</td>"
        $decommissionTableRows += "<td>$($vm.RequestedBy)</td>"
        $decommissionTableRows += "<td>$($vm.InitiatedAt)</td>"
        $decommissionTableRows += "<td>$($vm.Source)</td>"
        $decommissionTableRows += "</tr>"
    }
    
    $htmlBody = @"
<html>
<head>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #d32f2f; border-bottom: 3px solid #f44336; padding-bottom: 10px; }
    h2 { color: #1976D2; border-bottom: 2px solid #2196F3; padding-bottom: 5px; margin-top: 30px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; margin-bottom: 30px; }
    th { background-color: #2196F3; color: white; padding: 12px; text-align: left; font-weight: bold; }
    td { border: 1px solid #ddd; padding: 10px; }
    .summary { background-color: #f9f9f9; padding: 15px; border-left: 4px solid #2196F3; margin-bottom: 20px; }
    .summary-item { margin: 5px 0; }
    .no-data { padding: 15px; background-color: #e8f5e9; color: #2e7d32; border-left: 4px solid #4caf50; }
    .section-header { background-color: #ffecb3; padding: 10px; margin-top: 20px; border-left: 4px solid #ff9800; }
    .decom-warning { background-color: #fff9c4; padding: 10px; margin-top: 10px; border-left: 4px solid #ffc107; }
</style>
</head>
<body>
<h1>üî¥ VM Deletion & Decommission Report</h1>
<p><strong>Report Date:</strong> $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')</p>
<p><strong>Time Range:</strong> Last $($daysBack) day(s)</p>

<div class="summary">
    <h3>Executive Summary</h3>
    <div class="summary-item"><strong>Total Deleted VMs:</strong> $($deletedVMs.Count)</div>
    <div class="summary-item"><strong>Total Decommissions In Progress:</strong> $($decommissionVMs.Count)</div>
    <div class="summary-item"><strong>Grand Total:</strong> $(($deletedVMs.Count + $decommissionVMs.Count))</div>
    <hr style="margin: 10px 0;">
    <div class="summary-item"><strong>vRA Deleted Deployments:</strong> $($VraDeletedData.Count)</div>
    <div class="summary-item"><strong>vCenter Direct Deletions:</strong> $(($deletedVMs | Where-Object { $_.Source -match 'vcenter' }).Count)</div>
    <div class="summary-item"><strong>vRA Decommissions (Active):</strong> $($VraDecommissionData.Count)</div>
</div>

<h2>üìã Section 1: Deleted Virtual Machines</h2>
<p><em>VMs that have been completely deleted from vRA and/or vCenter</em></p>
$(if($deletedVMs.Count -gt 0) {
"<table>
<thead>
<tr>
<th>VM Name</th>
<th>Deployment Name</th>
<th>Action</th>
<th>Status</th>
<th>Requested/Deleted By</th>
<th>Deleted At</th>
<th>Source</th>
</tr>
</thead>
<tbody>
$deletedTableRows
</tbody>
</table>"
} else {
"<p class='no-data'>‚úì No deleted VMs found in this time period</p>"
})

<h2>‚ö†Ô∏è Section 2: Decommissions In Progress</h2>
<p><em>VMs currently undergoing decommission process (deployments still active in vRA)</em></p>
$(if($decommissionVMs.Count -gt 0) {
"<div class='decom-warning'>
<strong>‚ö†Ô∏è Warning:</strong> These VMs are currently being decommissioned but the process is not yet complete.
</div>
<table>
<thead>
<tr style='background-color: #ff9800;'>
<th>VM Name</th>
<th>Deployment Name</th>
<th>Deployment Status</th>
<th>Request Action</th>
<th>Request Status</th>
<th>Requested By</th>
<th>Initiated At</th>
<th>Source</th>
</tr>
</thead>
<tbody>
$decommissionTableRows
</tbody>
</table>"
} else {
"<p class='no-data'>‚úì No decommissions currently in progress</p>"
})

<hr style="margin: 30px 0;">
<p style="font-size: 12px; color: #666;">
<strong>Legend:</strong><br>
‚Ä¢ <span style="background-color: #fff9c4; padding: 2px 5px;">Yellow highlight</span> = Decommission in progress<br>
‚Ä¢ vRA = VMware Aria Automation (formerly vRealize Automation)<br>
‚Ä¢ vCenter = Direct deletion from vCenter (bypassing vRA)<br>
‚Ä¢ Note: VMs deleted through vRA will only show in the vRA section, not vCenter, to avoid duplicates
</p>

</body>
</html>
"@
    
    Write-Log "Sending email to: $($To -join ', ')" "DEBUG"
    Write-Log "Email subject: $Subject" "DEBUG"
    Write-Log "Total sections in email - Deleted: $($deletedVMs.Count), Decommission: $($decommissionVMs.Count)" "DEBUG"
    
    try {
        if ($Cc -and $Cc.Count -gt 0) {
            Send-MailMessage -To $To -From $From -Subject $Subject -Body $htmlBody -BodyAsHtml -SmtpServer $SmtpServer -Port $SmtpPort -UseSsl -Cc $Cc
        }
        else {
            Send-MailMessage -To $To -From $From -Subject $Subject -Body $htmlBody -BodyAsHtml -SmtpServer $SmtpServer -Port $SmtpPort -UseSsl
        }
        Write-Log "Email sent successfully!" "SUCCESS"
    }
    catch {
        Write-Log "Failed to send email: $($_.Exception.Message)" "ERROR"
        Write-Log "Full error details: $($_.Exception)" "ERROR"
    }
}

# Main Script
Write-DebugSection "DELETED VM TRACKER - STARTED"
Write-Log "Script Version: 2.0.0" "SUCCESS"
Write-Log "PowerShell Version: $($PSVersionTable.PSVersion)"
Write-Log "Debug output file: $debugOutputFile" "SUCCESS"

# Load VMware PowerCLI
try {
    Import-Module VMware.PowerCLI -ErrorAction Stop
    Set-PowerCLIConfiguration -InvalidCertificateAction Ignore -Confirm:$false -Scope Session | Out-Null
    Write-Log "VMware PowerCLI loaded" "SUCCESS"
}
catch {
    Write-Log "Failed to load VMware PowerCLI: $($_.Exception.Message)" "ERROR"
    Write-Log "Please install VMware PowerCLI: Install-Module -Name VMware.PowerCLI -Scope CurrentUser" "ERROR"
    exit
}

Disable-SSLValidation

# Get credentials
Write-Log "Requesting credentials..." "DEBUG"
$credential = Get-Credential -Message "Enter credentials for Aria Operations, vRA, and vCenter"
if (-not $credential) {
    Write-Log "Credentials not provided. Exiting." "ERROR"
    exit
}
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

# ================================================================================
# ARIA OPERATIONS - Get Deleted/Status Changed VMs
# ================================================================================
Write-DebugSection "ARIA OPERATIONS - CHECKING FOR DELETED/CHANGED VMs"

$ariaDeletedVMs = @()

try {
    # Authenticate
    $ariaUsername = "$username@$ariaOpsDomain@$ariaOpsAuthSource"
    $ariaAuthUri = "https://$ariaOpsServer/suite-api/api/auth/token/acquire"
    $ariaAuthBody = @{
        username = $ariaUsername
        password = $password
    } | ConvertTo-Json
    
    Write-Log "Authenticating to Aria Operations..." "DEBUG"
    Write-Log "Auth URI: $ariaAuthUri" "DEBUG"
    
    $ariaAuthResponse = Invoke-RestMethod -Uri $ariaAuthUri -Method Post -Headers @{
        "Content-Type" = "application/json"
        "Accept" = "application/json"
    } -Body $ariaAuthBody -ErrorAction Stop
    
    $ariaHeaders = @{
        "Authorization" = "vRealizeOpsToken $($ariaAuthResponse.token)"
        "Content-Type" = "application/json"
        "Accept" = "application/json"
        "X-Ops-API-use-unsupported" = "true"
    }
    
    Write-Log "Authenticated successfully" "SUCCESS"
    
    # Query all VMs
    $ariaUri = "https://$ariaOpsServer/suite-api/api/resources?resourceKind=VirtualMachine"
    Write-Log "Querying VMs from: $ariaUri" "DEBUG"
    
    $response = Invoke-RestMethod -Uri $ariaUri -Headers $ariaHeaders -Method Get
    $allVMs = $response.resourceList
    
    Write-Log "Total VMs found: $($allVMs.Count)" "DEBUG"
    
    $cutoffDate = (Get-Date).AddDays(-$daysBack)
    Write-Log "Checking for status changes since: $cutoffDate" "DEBUG"
    
    foreach ($vm in $allVMs) {
        try {
            $vmPropertiesURL = "https://$ariaOpsServer/suite-api/api/resources/$($vm.identifier)/properties?_no_links=true"
            $propsResponse = Invoke-RestMethod -Uri $vmPropertiesURL -Headers $ariaHeaders -Method Get
            
            # Get VM name
            $nameProp = $propsResponse.property | Where-Object { $_.name -eq "config|name" -or $_.name -eq "summary|config|name" } | Select-Object -First 1
            if (-not $nameProp) { continue }
            $vmName = $nameProp.value
            
            # Check resource state
            $resourceStateProp = $propsResponse.property | Where-Object { $_.name -eq "summary|resourceState" } | Select-Object -First 1
            $powerStateProp = $propsResponse.property | Where-Object { $_.name -eq "summary|runtime|powerState" } | Select-Object -First 1
            
            if ($resourceStateProp -and $resourceStateProp.value) {
                $resourceState = $resourceStateProp.value.ToString().ToUpper()
                
                # Check if VM is marked as not existing or stopped
                if ($resourceState -in @("NOT_EXISTING", "STOPPED")) {
                    Write-Log "  Found deleted/stopped VM: $vmName (State: $resourceState)" "WARN"
                    
                    $ariaDeletedVMs += [PSCustomObject]@{
                        VMName = $vmName
                        ResourceState = $resourceState
                        PowerState = if ($powerStateProp) { $powerStateProp.value } else { "N/A" }
                        LastStatusChange = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
                        ResourceId = $vm.identifier
                        Source = "Aria Operations"
                    }
                }
            }
        }
        catch {
            Write-Log "  Error checking VM $($vm.identifier): $($_.Exception.Message)" "DEBUG"
        }
    }
    
    Write-Log "Aria Operations: Found $($ariaDeletedVMs.Count) deleted/changed VMs" "SUCCESS"
}
catch {
    Write-Log "Failed to query Aria Operations: $($_.Exception.Message)" "ERROR"
}

# ================================================================================
# vRA - Get Active Deployments with Decommission Requests
# ================================================================================
Write-DebugSection "vRA - PROCESSING ACTIVE DEPLOYMENTS WITH DECOMMISSION REQUESTS"

$allVraDecommissionVMs = @()

foreach ($vraServer in $vraServers) {
    try {
        Write-Log "`nConnecting to vRA: $vraServer" "DEBUG"
        
        # Authenticate
        $vraAuthUri = "https://$vraServer/csp/gateway/am/api/login"
        $vraAuthBody = @{
            username = $username
            password = $password
        } | ConvertTo-Json
        
        $vraAuthResponse = Invoke-RestMethod -Uri $vraAuthUri -Method Post -Headers @{
            "Content-Type" = "application/json"
        } -Body $vraAuthBody -ErrorAction Stop
        
        $vraHeaders = @{
            "Authorization" = "Bearer $($vraAuthResponse.cspAuthToken)"
            "Content-Type" = "application/json"
        }
        
        Write-Log "Authenticated successfully" "SUCCESS"
        
        # Get active deployments with decommission requests (NO TIME LIMIT)
        $decommVMs = Get-ActiveDeploymentsWithDecommission -VraServer $vraServer -Headers $vraHeaders
        $allVraDecommissionVMs += $decommVMs
        
    }
    catch {
        Write-Log "Error with vRA server $vraServer : $($_.Exception.Message)" "ERROR"
    }
}

Write-Log "`nvRA Decommission Total: Found $($allVraDecommissionVMs.Count) VMs with active decommission requests" "SUCCESS"

# ================================================================================
# vRA - Get Deleted Deployments
# ================================================================================
Write-DebugSection "vRA - PROCESSING DELETED DEPLOYMENTS"

$allVraDeletedVMs = @()

foreach ($vraServer in $vraServers) {
    try {
        Write-Log "`nConnecting to vRA: $vraServer" "DEBUG"
        
        # Authenticate
        $vraAuthUri = "https://$vraServer/csp/gateway/am/api/login"
        $vraAuthBody = @{
            username = $username
            password = $password
        } | ConvertTo-Json
        
        $vraAuthResponse = Invoke-RestMethod -Uri $vraAuthUri -Method Post -Headers @{
            "Content-Type" = "application/json"
        } -Body $vraAuthBody -ErrorAction Stop
        
        $vraHeaders = @{
            "Authorization" = "Bearer $($vraAuthResponse.cspAuthToken)"
            "Content-Type" = "application/json"
        }
        
        Write-Log "Authenticated successfully" "SUCCESS"
        
        # Get deleted VMs from this vRA server
        $deletedVMs = Get-DeletedVMsFromVRA -VraServer $vraServer -Headers $vraHeaders -DaysBack $daysBack
        $allVraDeletedVMs += $deletedVMs
        
    }
    catch {
        Write-Log "Error with vRA server $vraServer : $($_.Exception.Message)" "ERROR"
    }
}

Write-Log "`nvRA Deleted Total: Found $($allVraDeletedVMs.Count) deleted VMs across all servers" "SUCCESS"

# ================================================================================
# vCENTER - Get Direct Deletions
# ================================================================================
Write-DebugSection "vCENTER - CHECKING DIRECT VM DELETIONS"

$allVCenterDeletedVMs = @()

foreach ($vCenter in $vCenters) {
    $deletedVMs = Get-DeletedVMsFromVCenter -VCenter $vCenter -Credential $credential -DaysBack $daysBack
    $allVCenterDeletedVMs += $deletedVMs
}

Write-Log "`nvCenter Total: Found $($allVCenterDeletedVMs.Count) deleted VMs across all servers" "SUCCESS"

# ================================================================================
# SUMMARY AND REPORT
# ================================================================================
Write-DebugSection "SUMMARY AND REPORTING"

Write-Log "Aria Operations Deleted/Changed: $($ariaDeletedVMs.Count)" "SUCCESS"
Write-Log "vRA Decommission In Progress: $($allVraDecommissionVMs.Count)" "SUCCESS"
Write-Log "vRA Deleted Deployments: $($allVraDeletedVMs.Count)" "SUCCESS"
Write-Log "vCenter Direct Deletions: $($allVCenterDeletedVMs.Count)" "SUCCESS"

$totalDeleted = $ariaDeletedVMs.Count + $allVraDeletedVMs.Count + $allVCenterDeletedVMs.Count + $allVraDecommissionVMs.Count
Write-Log "TOTAL (before deduplication): $totalDeleted" "SUCCESS"

# Cross-reference analysis
Write-DebugSection "CROSS-REFERENCE ANALYSIS"

Write-Log "Analyzing VM deletions across all sources..." "DEBUG"

# Create a combined list for analysis
$allVMNames = @()
$allVMNames += $ariaDeletedVMs | Select-Object -ExpandProperty VMName
$allVMNames += $allVraDecommissionVMs | Select-Object -ExpandProperty VMName
$allVMNames += $allVraDeletedVMs | Select-Object -ExpandProperty VMName
$allVMNames += $allVCenterDeletedVMs | Select-Object -ExpandProperty VMName
$uniqueVMNames = $allVMNames | Select-Object -Unique

Write-Log "Unique VM names across all sources: $($uniqueVMNames.Count)" "DEBUG"

foreach ($vmName in $uniqueVMNames) {
    $inAria = $ariaDeletedVMs | Where-Object { $_.VMName -eq $vmName }
    $inVraDecomm = $allVraDecommissionVMs | Where-Object { $_.VMName -eq $vmName }
    $inVraDel = $allVraDeletedVMs | Where-Object { $_.VMName -eq $vmName }
    $inVC = $allVCenterDeletedVMs | Where-Object { $_.VMName -eq $vmName }
    
    Write-Log "`nVM: $vmName" "DEBUG"
    Write-Log "  In Aria Operations: $(if($inAria){'YES'}else{'NO'})" "DEBUG"
    Write-Log "  In vRA Decommission (Active): $(if($inVraDecomm){'YES'}else{'NO'})" "DEBUG"
    Write-Log "  In vRA Deleted: $(if($inVraDel){'YES'}else{'NO'})" "DEBUG"
    Write-Log "  In vCenter: $(if($inVC){'YES'}else{'NO'})" "DEBUG"
    
    if ($inVraDecomm) {
        Write-Log "  vRA Decommission Details:" "DEBUG"
        Write-Log "    Deployment: $($inVraDecomm.DeploymentName)" "DEBUG"
        Write-Log "    Request Action: $($inVraDecomm.RequestAction)" "DEBUG"
        Write-Log "    Request Status: $($inVraDecomm.RequestStatus)" "DEBUG"
        Write-Log "    Requested By: $($inVraDecomm.RequestedBy)" "DEBUG"
    }
    
    if ($inVraDel) {
        Write-Log "  vRA Deleted Details:" "DEBUG"
        Write-Log "    Deployment: $($inVraDel.DeploymentName)" "DEBUG"
        Write-Log "    Request Action: $($inVraDel.RequestAction)" "DEBUG"
        Write-Log "    Requested By: $($inVraDel.RequestedBy)" "DEBUG"
    }
}

# Send Email Report
Write-DebugSection "SENDING EMAIL REPORT"

# Check if there are any deleted or decommissioned VMs from vRA and vCenter only
$vraVCenterTotal = $allVraDeletedVMs.Count + $allVraDecommissionVMs.Count + $allVCenterDeletedVMs.Count

Write-Log "vRA Deleted VMs: $($allVraDeletedVMs.Count)" "DEBUG"
Write-Log "vRA Decommission VMs: $($allVraDecommissionVMs.Count)" "DEBUG"
Write-Log "vCenter Deleted VMs: $($allVCenterDeletedVMs.Count)" "DEBUG"
Write-Log "Total (vRA + vCenter): $vraVCenterTotal" "DEBUG"

if ($vraVCenterTotal -eq 0) {
    Write-Log "No deleted or decommissioned VMs found in vRA or vCenter. Sending notification email..." "WARN"
    
    $noDeletedVMsHtml = @"
<html>
<head>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .info-box { background-color: #e8f5e9; padding: 20px; border-left: 4px solid #4caf50; margin: 20px 0; }
    .info-box h2 { margin-top: 0; color: #2e7d32; }
    .info-box p { color: #424242; font-size: 14px; line-height: 1.6; }
    .details { background-color: #f5f5f5; padding: 10px; margin-top: 15px; border-radius: 4px; }
</style>
</head>
<body>
<div class="info-box">
    <h2>‚úì No VM Deletions Detected</h2>
    <p><strong>Good news!</strong> No virtual machines were deleted or decommissioned in the last $daysBack day(s).</p>
    
    <div class="details">
        <p><strong>Sources Checked:</strong></p>
        <ul>
            <li>vRA Deleted Deployments: 0</li>
            <li>vRA Decommission In Progress: 0</li>
            <li>vCenter Direct Deletions: 0</li>
        </ul>
        <p><strong>Report Generated:</strong> $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')</p>
        <p><strong>Debug Log File:</strong> $debugOutputFile</p>
    </div>
</div>
</body>
</html>
"@
    
    $noVMSubject = "No VM Deletions - $(Get-Date -Format 'yyyy-MM-dd')"
    
    try {
        if ($smtpCc -and $smtpCc.Count -gt 0) {
            Send-MailMessage -To $smtpTo -From $smtpFrom -Subject $noVMSubject -Body $noDeletedVMsHtml -BodyAsHtml -SmtpServer $smtpServer -Port $smtpPort -UseSsl -Cc $smtpCc
        }
        else {
            Send-MailMessage -To $smtpTo -From $smtpFrom -Subject $noVMSubject -Body $noDeletedVMsHtml -BodyAsHtml -SmtpServer $smtpServer -Port $smtpPort -UseSsl
        }
        Write-Log "Notification email sent successfully!" "SUCCESS"
    }
    catch {
        Write-Log "Failed to send notification email: $($_.Exception.Message)" "ERROR"
    }
}
else {
    Write-Log "Found VMs to report. Sending detailed report..." "DEBUG"
    Send-DeletedVMReport `
        -AriaOpsData $ariaDeletedVMs `
        -VraDeletedData $allVraDeletedVMs `
        -VraDecommissionData $allVraDecommissionVMs `
        -VCenterData $allVCenterDeletedVMs `
        -SmtpServer $smtpServer `
        -SmtpPort $smtpPort `
        -From $smtpFrom `
        -To $smtpTo `
        -Cc $smtpCc `
        -Subject $smtpSubject
}

Write-DebugSection "SCRIPT COMPLETED"
Write-Log "Script Version: 2.0.0" "SUCCESS"
Write-Log "Debug log saved to: $debugOutputFile" "SUCCESS"
Write-Log "`nScript finished. Check the debug file for detailed logs." "SUCCESS"
