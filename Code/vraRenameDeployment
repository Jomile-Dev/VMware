# VMware Aria Deep Inspection Tool
# This script examines the exact structure of deployments to understand how to search

$vraServer = "vra.yourdomain.com"
$testServerName = "WSPO000110"  # Replace with a server you KNOW exists in the UI

# Disable SSL validation
if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
    Add-Type @"
    using System.Net;
    using System.Security.Cryptography.X509Certificates;
    public class TrustAllCertsPolicy : ICertificatePolicy {
        public bool CheckValidationResult(
            ServicePoint svcPoint, X509Certificate certificate,
            WebRequest request, int certificateProblem) {
            return true;
        }
    }
"@
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
}
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# Authenticate
Write-Host "=== AUTHENTICATION ===" -ForegroundColor Cyan
$credential = Get-Credential -Message "Enter VMware Aria Automation credentials"
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

$uri = "https://$vraServer/csp/gateway/am/api/login"
$body = @{
    username = $username
    password = $password
} | ConvertTo-Json

$authHeaders = @{
    "Content-Type" = "application/json"
    "Accept" = "application/json"
}

$response = Invoke-RestMethod -Uri $uri -Method Post -Headers $authHeaders -Body $body
$token = $response.cspAuthToken
Write-Host "✓ Authenticated`n" -ForegroundColor Green

$headers = @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
}

# Get deployments
Write-Host "=== FETCHING DEPLOYMENTS ===" -ForegroundColor Cyan
$uri = "https://$vraServer/deployment/api/deployments"
Write-Host "Calling: $uri`n" -ForegroundColor Gray

try {
    $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $headers
    $deployments = if ($response.content) { $response.content } else { $response }
    
    Write-Host "Retrieved $($deployments.Count) deployments`n" -ForegroundColor Green
    
    # Show first 5 deployments with full detail
    Write-Host "=== FIRST 5 DEPLOYMENTS (DETAILED) ===" -ForegroundColor Cyan
    for ($i = 0; $i -lt [Math]::Min(5, $deployments.Count); $i++) {
        $dep = $deployments[$i]
        Write-Host "`n[$($i+1)] Deployment:" -ForegroundColor Yellow
        Write-Host "  Name: $($dep.name)" -ForegroundColor White
        Write-Host "  ID: $($dep.id)" -ForegroundColor Gray
        
        Write-Host "  All Properties:" -ForegroundColor Cyan
        $dep.PSObject.Properties.Name | ForEach-Object {
            $value = $dep.$_
            if ($value -ne $null) {
                if ($value -is [array]) {
                    Write-Host "    - $_  [Array with $($value.Count) items]" -ForegroundColor Gray
                }
                elseif ($value -is [PSCustomObject]) {
                    Write-Host "    - $_  [Object]" -ForegroundColor Gray
                }
                else {
                    Write-Host "    - $_  = $value" -ForegroundColor Gray
                }
            }
        }
        
        # Deep dive into resources if they exist
        if ($dep.resources) {
            Write-Host "`n  Resources ($($dep.resources.Count)):" -ForegroundColor Cyan
            foreach ($res in $dep.resources) {
                Write-Host "    Resource:" -ForegroundColor Yellow
                $res.PSObject.Properties.Name | ForEach-Object {
                    $value = $res.$_
                    if ($value -ne $null -and $value -ne "") {
                        Write-Host "      - $_  = $value" -ForegroundColor Gray
                    }
                }
            }
        }
        else {
            Write-Host "  NO RESOURCES PROPERTY" -ForegroundColor Red
        }
    }
    
    # Try to find your specific server
    Write-Host "`n`n=== SEARCHING FOR YOUR SERVER: $testServerName ===" -ForegroundColor Cyan
    
    $found = $false
    foreach ($dep in $deployments) {
        # Check deployment name
        if ($dep.name -eq $testServerName) {
            Write-Host "`n✓ FOUND AS DEPLOYMENT NAME!" -ForegroundColor Green
            Write-Host "  Deployment ID: $($dep.id)" -ForegroundColor White
            $found = $true
            break
        }
        
        # Check if name contains server name
        if ($dep.name -like "*$testServerName*") {
            Write-Host "`n✓ FOUND IN DEPLOYMENT NAME (partial match)!" -ForegroundColor Green
            Write-Host "  Deployment Name: $($dep.name)" -ForegroundColor White
            Write-Host "  Deployment ID: $($dep.id)" -ForegroundColor White
            $found = $true
            break
        }
        
        # Check resources
        if ($dep.resources) {
            foreach ($res in $dep.resources) {
                if ($res.name -eq $testServerName) {
                    Write-Host "`n✓ FOUND AS RESOURCE NAME!" -ForegroundColor Green
                    Write-Host "  In Deployment: $($dep.name)" -ForegroundColor White
                    Write-Host "  Deployment ID: $($dep.id)" -ForegroundColor White
                    Write-Host "  Resource Type: $($res.type)" -ForegroundColor White
                    $found = $true
                    break
                }
                
                # Check all resource properties for the server name
                $res.PSObject.Properties | ForEach-Object {
                    if ($_.Value -eq $testServerName) {
                        Write-Host "`n✓ FOUND IN RESOURCE PROPERTY!" -ForegroundColor Green
                        Write-Host "  In Deployment: $($dep.name)" -ForegroundColor White
                        Write-Host "  Property: $($_.Name)" -ForegroundColor White
                        Write-Host "  Resource Type: $($res.type)" -ForegroundColor White
                        $found = $true
                    }
                }
            }
        }
        
        if ($found) { break }
    }
    
    if (-not $found) {
        Write-Host "`n✗ NOT FOUND in any deployment or resource" -ForegroundColor Red
        Write-Host "`nPossible reasons:" -ForegroundColor Yellow
        Write-Host "  1. Server name is incorrect or has different casing" -ForegroundColor Gray
        Write-Host "  2. Server exists in a different API endpoint" -ForegroundColor Gray
        Write-Host "  3. Pagination - server is beyond the first page" -ForegroundColor Gray
        
        # Show sample names for comparison
        Write-Host "`nSample deployment names (first 10):" -ForegroundColor Yellow
        $deployments | Select-Object -First 10 | ForEach-Object {
            Write-Host "  - $($_.name)" -ForegroundColor Gray
        }
        
        Write-Host "`nSample resource names (first 10):" -ForegroundColor Yellow
        $count = 0
        foreach ($dep in $deployments) {
            if ($dep.resources) {
                foreach ($res in $dep.resources) {
                    Write-Host "  - $($res.name) (in deployment: $($dep.name))" -ForegroundColor Gray
                    $count++
                    if ($count -ge 10) { break }
                }
            }
            if ($count -ge 10) { break }
        }
    }
    
    # Check pagination
    Write-Host "`n`n=== PAGINATION INFO ===" -ForegroundColor Cyan
    if ($response.PSObject.Properties.Name -contains "totalElements") {
        Write-Host "Total Elements: $($response.totalElements)" -ForegroundColor White
        Write-Host "Elements Retrieved: $($deployments.Count)" -ForegroundColor White
        
        if ($response.totalElements -gt $deployments.Count) {
            Write-Host "⚠ WARNING: More deployments exist! You need pagination." -ForegroundColor Yellow
            Write-Host "  Try: ?page=0&size=100" -ForegroundColor Gray
        }
    }
    else {
        Write-Host "Response properties:" -ForegroundColor Gray
        $response.PSObject.Properties.Name | ForEach-Object {
            Write-Host "  - $_" -ForegroundColor Gray
        }
    }
    
}
catch {
    Write-Host "ERROR: $($_.Exception.Message)" -ForegroundColor Red
}

Write-Host "`n=== COMPLETE ===" -ForegroundColor Cyan
