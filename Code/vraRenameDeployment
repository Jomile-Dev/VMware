# VMware Aria Automation Troubleshooting Script
$vraServer = "vra.yourdomain.com"  # Replace with your Aria Automation FQDN
$testServerName = "WSPO000110"     # Replace with a server name you know exists

# Prompt for credentials
$credential = Get-Credential -Message "Enter VMware Aria Automation credentials"
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

# Disable SSL certificate validation
if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
    Add-Type @"
    using System.Net;
    using System.Security.Cryptography.X509Certificates;
    public class TrustAllCertsPolicy : ICertificatePolicy {
        public bool CheckValidationResult(
            ServicePoint svcPoint, X509Certificate certificate,
            WebRequest request, int certificateProblem) {
            return true;
        }
    }
"@
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
}
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# Get token
Write-Host "=== AUTHENTICATION ===" -ForegroundColor Cyan
$uri = "https://$vraServer/csp/gateway/am/api/login"
$body = @{
    username = $username
    password = $password
} | ConvertTo-Json

$headers = @{
    "Content-Type" = "application/json"
    "Accept" = "application/json"
}

try {
    $response = Invoke-RestMethod -Uri $uri -Method Post -Headers $headers -Body $body
    $token = $response.cspAuthToken
    Write-Host "Authentication successful!`n" -ForegroundColor Green
}
catch {
    Write-Host "Authentication failed: $_" -ForegroundColor Red
    exit
}

$headers = @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
}

# Test 1: Check available API endpoints
Write-Host "=== TEST 1: Available Endpoints ===" -ForegroundColor Cyan
$endpoints = @(
    "https://$vraServer/iaas/api/machines",
    "https://$vraServer/iaas/api/deployments",
    "https://$vraServer/deployment/api/deployments",
    "https://$vraServer/catalog/api/deployments"
)

foreach ($endpoint in $endpoints) {
    Write-Host "Testing: $endpoint" -ForegroundColor Yellow
    try {
        $response = Invoke-RestMethod -Uri "$endpoint`?`$top=1" -Method Get -Headers $headers -ErrorAction Stop
        Write-Host "  ✓ SUCCESS - Endpoint is accessible" -ForegroundColor Green
    }
    catch {
        Write-Host "  ✗ FAILED - $($_.Exception.Message)" -ForegroundColor Red
    }
}

# Test 2: Sample a deployment to see its structure
Write-Host "`n=== TEST 2: Deployment Structure ===" -ForegroundColor Cyan
try {
    $response = Invoke-RestMethod -Uri "https://$vraServer/iaas/api/deployments?`$top=5" -Method Get -Headers $headers
    $deployments = if ($response.content) { $response.content } else { $response }
    
    Write-Host "Found $($deployments.Count) sample deployments" -ForegroundColor Green
    
    $sampleDep = $deployments[0]
    Write-Host "`nSample Deployment:" -ForegroundColor Yellow
    Write-Host "  Name: $($sampleDep.name)"
    Write-Host "  ID: $($sampleDep.id)"
    Write-Host "  Has Resources: $(if ($sampleDep.resources) { 'YES' } else { 'NO' })"
    
    if ($sampleDep.resources) {
        Write-Host "`n  Resources in this deployment:"
        foreach ($res in $sampleDep.resources) {
            Write-Host "    - Name: $($res.name)"
            Write-Host "      Type: $($res.type)"
            Write-Host "      ID: $($res.id)"
        }
    }
    
    Write-Host "`nAll available properties on deployment:"
    $sampleDep.PSObject.Properties.Name | ForEach-Object { Write-Host "  - $_" -ForegroundColor Gray }
}
catch {
    Write-Host "Failed to get deployment structure: $_" -ForegroundColor Red
}

# Test 3: Try machines API
Write-Host "`n=== TEST 3: Machines API ===" -ForegroundColor Cyan
try {
    $response = Invoke-RestMethod -Uri "https://$vraServer/iaas/api/machines?`$top=5" -Method Get -Headers $headers
    $machines = if ($response.content) { $response.content } else { $response }
    
    Write-Host "Found $($machines.Count) sample machines" -ForegroundColor Green
    
    if ($machines.Count -gt 0) {
        $sampleMachine = $machines[0]
        Write-Host "`nSample Machine:" -ForegroundColor Yellow
        Write-Host "  Name: $($sampleMachine.name)"
        Write-Host "  Type: $($sampleMachine.type)"
        Write-Host "  ID: $($sampleMachine.id)"
        Write-Host "  Deployment ID: $($sampleMachine.deploymentId)"
        
        Write-Host "`nAll available properties on machine:"
        $sampleMachine.PSObject.Properties.Name | ForEach-Object { Write-Host "  - $_" -ForegroundColor Gray }
    }
}
catch {
    Write-Host "Machines API failed: $_" -ForegroundColor Red
}

# Test 4: Try different search methods for your specific server
Write-Host "`n=== TEST 4: Searching for '$testServerName' ===" -ForegroundColor Cyan

# Method 1: Search machines by name
Write-Host "`nMethod 1: Machines API with filter" -ForegroundColor Yellow
try {
    $uri = "https://$vraServer/iaas/api/machines?`$filter=name eq '$testServerName'"
    Write-Host "  URI: $uri" -ForegroundColor Gray
    $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $headers
    $machines = if ($response.content) { $response.content } else { $response }
    
    if ($machines.Count -gt 0) {
        Write-Host "  ✓ FOUND via machines API!" -ForegroundColor Green
        Write-Host "    Machine: $($machines[0].name)"
        Write-Host "    Deployment ID: $($machines[0].deploymentId)"
    } else {
        Write-Host "  ✗ Not found" -ForegroundColor Red
    }
}
catch {
    Write-Host "  ✗ Failed: $($_.Exception.Message)" -ForegroundColor Red
}

# Method 2: Search all machines without filter
Write-Host "`nMethod 2: Browse first 100 machines" -ForegroundColor Yellow
try {
    $response = Invoke-RestMethod -Uri "https://$vraServer/iaas/api/machines?`$top=100" -Method Get -Headers $headers
    $machines = if ($response.content) { $response.content } else { $response }
    
    $found = $machines | Where-Object { $_.name -eq $testServerName }
    if ($found) {
        Write-Host "  ✓ FOUND in first 100 machines!" -ForegroundColor Green
        Write-Host "    Machine: $($found.name)"
        Write-Host "    Deployment ID: $($found.deploymentId)"
    } else {
        Write-Host "  ✗ Not in first 100 machines" -ForegroundColor Yellow
        Write-Host "    Sample machine names found:"
        $machines | Select-Object -First 5 | ForEach-Object { Write-Host "      - $($_.name)" -ForegroundColor Gray }
    }
}
catch {
    Write-Host "  ✗ Failed: $($_.Exception.Message)" -ForegroundColor Red
}

# Method 3: Search deployments
Write-Host "`nMethod 3: Search deployments by name" -ForegroundColor Yellow
try {
    $uri = "https://$vraServer/iaas/api/deployments?`$filter=name eq '$testServerName'"
    $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $headers
    $deployments = if ($response.content) { $response.content } else { $response }
    
    if ($deployments.Count -gt 0) {
        Write-Host "  ✓ FOUND deployment with that name!" -ForegroundColor Green
        Write-Host "    Deployment: $($deployments[0].name)"
    } else {
        Write-Host "  ✗ No deployment with that exact name" -ForegroundColor Red
    }
}
catch {
    Write-Host "  ✗ Failed: $($_.Exception.Message)" -ForegroundColor Red
}

# Method 4: Manual search through deployments
Write-Host "`nMethod 4: Manual search in first 50 deployments" -ForegroundColor Yellow
try {
    $response = Invoke-RestMethod -Uri "https://$vraServer/iaas/api/deployments?`$top=50" -Method Get -Headers $headers
    $deployments = if ($response.content) { $response.content } else { $response }
    
    $foundInDeployment = $false
    foreach ($dep in $deployments) {
        if ($dep.resources) {
            $matchingResource = $dep.resources | Where-Object { $_.name -eq $testServerName }
            if ($matchingResource) {
                Write-Host "  ✓ FOUND as resource in deployment!" -ForegroundColor Green
                Write-Host "    Deployment Name: $($dep.name)"
                Write-Host "    Deployment ID: $($dep.id)"
                Write-Host "    Resource Name: $($matchingResource.name)"
                Write-Host "    Resource Type: $($matchingResource.type)"
                $foundInDeployment = $true
                break
            }
        }
    }
    
    if (-not $foundInDeployment) {
        Write-Host "  ✗ Not found in first 50 deployments" -ForegroundColor Yellow
    }
}
catch {
    Write-Host "  ✗ Failed: $($_.Exception.Message)" -ForegroundColor Red
}

Write-Host "`n=== Troubleshooting Complete ===" -ForegroundColor Cyan
Write-Host "Review the results above to determine the best search method." -ForegroundColor White
