# VMware Aria Automation Debug Script
$vraServer = "vra.yourdomain.com"  # Replace with your Aria Automation FQDN
$serverToFind = "WSPO000110"       # The server you're looking for

# Prompt for credentials
$credential = Get-Credential -Message "Enter VMware Aria Automation credentials"
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

# Disable SSL certificate validation
if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
    Add-Type @"
    using System.Net;
    using System.Security.Cryptography.X509Certificates;
    public class TrustAllCertsPolicy : ICertificatePolicy {
        public bool CheckValidationResult(
            ServicePoint svcPoint, X509Certificate certificate,
            WebRequest request, int certificateProblem) {
            return true;
        }
    }
"@
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
}
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# Get token
Write-Host "Authenticating..." -ForegroundColor Cyan
$uri = "https://$vraServer/csp/gateway/am/api/login"
$body = @{
    username = $username
    password = $password
} | ConvertTo-Json

$headers = @{
    "Content-Type" = "application/json"
    "Accept" = "application/json"
}

try {
    $response = Invoke-RestMethod -Uri $uri -Method Post -Headers $headers -Body $body
    $token = $response.cspAuthToken
    Write-Host "Authentication successful!" -ForegroundColor Green
}
catch {
    Write-Host "Authentication failed: $_" -ForegroundColor Red
    exit
}

# Search for the specific server
$headers = @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
}

$uri = "https://$vraServer/catalog/api/deployments"
Write-Host "`nFetching first 10 deployments to inspect structure..." -ForegroundColor Cyan

try {
    $response = Invoke-RestMethod -Uri "$uri`?`$top=10" -Method Get -Headers $headers
    $deployments = if ($response.content) { $response.content } else { $response }
    
    Write-Host "Sample Deployment Structure:" -ForegroundColor Yellow
    $sampleDeployment = $deployments[0]
    Write-Host "Deployment Name: $($sampleDeployment.name)" -ForegroundColor Cyan
    Write-Host "Deployment ID: $($sampleDeployment.id)" -ForegroundColor Cyan
    
    if ($sampleDeployment.resources) {
        Write-Host "`nResources in this deployment:" -ForegroundColor Yellow
        foreach ($resource in $sampleDeployment.resources) {
            Write-Host "  - Resource Name: $($resource.name)" -ForegroundColor White
            Write-Host "    Resource Type: $($resource.type)" -ForegroundColor Gray
            Write-Host "    Resource ID: $($resource.id)" -ForegroundColor Gray
        }
    } else {
        Write-Host "No resources property found!" -ForegroundColor Red
        Write-Host "Available properties:" -ForegroundColor Yellow
        $sampleDeployment.PSObject.Properties.Name | ForEach-Object { Write-Host "  - $_" }
    }
    
    # Now try to find your specific server
    Write-Host "`n`n=== Searching for server: $serverToFind ===" -ForegroundColor Cyan
    
    $page = 0
    $pageSize = 100
    $found = $false
    
    while ($page -lt 10 -and -not $found) {  # Limit to first 1000 deployments for testing
        $uri = "https://$vraServer/catalog/api/deployments?`$skip=$($page * $pageSize)&`$top=$pageSize"
        $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $headers
        $deployments = if ($response.content) { $response.content } else { $response }
        
        Write-Host "Checking page $($page + 1) ($($deployments.Count) deployments)..." -ForegroundColor Gray
        
        foreach ($deployment in $deployments) {
            if ($deployment.resources) {
                foreach ($resource in $deployment.resources) {
                    if ($resource.name -eq $serverToFind) {
                        Write-Host "`n*** FOUND IT! ***" -ForegroundColor Green
                        Write-Host "Deployment Name: $($deployment.name)" -ForegroundColor Cyan
                        Write-Host "Deployment ID: $($deployment.id)" -ForegroundColor Cyan
                        Write-Host "Resource Name: $($resource.name)" -ForegroundColor Cyan
                        Write-Host "Resource Type: $($resource.type)" -ForegroundColor Cyan
                        Write-Host "Resource ID: $($resource.id)" -ForegroundColor Cyan
                        $found = $true
                        break
                    }
                }
            }
            if ($found) { break }
        }
        
        if ($deployments.Count -lt $pageSize) { break }
        $page++
    }
    
    if (-not $found) {
        Write-Host "`nServer not found in first 1000 deployments." -ForegroundColor Yellow
        Write-Host "Please verify the exact server name in VRA UI." -ForegroundColor Yellow
    }
}
catch {
    Write-Host "Error: $_" -ForegroundColor Red
    Write-Host $_.Exception.Message -ForegroundColor Red
}
