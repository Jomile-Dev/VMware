# VMware Aria Automation Configuration
$vraServer = "vra.yourdomain.com"  # Replace with your Aria Automation FQDN
$csvFile = "C:\Temp\serverList.csv"

# Prompt for credentials
$credential = Get-Credential -Message "Enter VMware Aria Automation credentials"
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

# Disable SSL certificate validation (only for self-signed certs)
if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
    Add-Type @"
    using System.Net;
    using System.Security.Cryptography.X509Certificates;
    public class TrustAllCertsPolicy : ICertificatePolicy {
        public bool CheckValidationResult(
            ServicePoint svcPoint, X509Certificate certificate,
            WebRequest request, int certificateProblem) {
            return true;
        }
    }
"@
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
}
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# Function to get authentication token
function Get-vRAToken {
    param(
        [string]$Server,
        [string]$Username,
        [string]$Password
    )
    
    # Try the standard vRA API endpoint first
    $uri = "https://$Server/csp/gateway/am/api/login"
    $body = @{
        username = $Username
        password = $Password
    } | ConvertTo-Json
    
    $headers = @{
        "Content-Type" = "application/json"
        "Accept" = "application/json"
    }
    
    try {
        Write-Host "Attempting authentication to: $uri" -ForegroundColor Cyan
        $response = Invoke-RestMethod -Uri $uri -Method Post -Headers $headers -Body $body
        Write-Host "Successfully authenticated to VMware Aria Automation" -ForegroundColor Green
        return $response.cspAuthToken
    }
    catch {
        Write-Host "CSP endpoint failed, trying legacy vRA endpoint..." -ForegroundColor Yellow
        
        # Try legacy vRA authentication endpoint
        $uri = "https://$Server/iaas/api/login"
        try {
            $response = Invoke-RestMethod -Uri $uri -Method Post -Headers $headers -Body $body
            Write-Host "Successfully authenticated using legacy endpoint" -ForegroundColor Green
            return $response.token
        }
        catch {
            Write-Host "Failed to authenticate: $_" -ForegroundColor Red
            Write-Host "Error Details: $($_.Exception.Message)" -ForegroundColor Red
            return $null
        }
    }
}

# Function to get deployment by name
function Get-vRADeployment {
    param(
        [string]$Server,
        [string]$Token,
        [string]$DeploymentName
    )
    
    # Service Broker uses catalog API endpoints
    $endpoints = @(
        "https://$Server/catalog/api/deployments",
        "https://$Server/iaas/api/deployments"
    )
    
    $headers = @{
        "Authorization" = "Bearer $Token"
        "Content-Type" = "application/json"
    }
    
    foreach ($baseUri in $endpoints) {
        try {
            Write-Host "Trying endpoint: $baseUri" -ForegroundColor Cyan
            
            # Paginate through all deployments
            $allDeployments = @()
            $page = 0
            $pageSize = 100
            $hasMore = $true
            
            while ($hasMore) {
                $uri = "$baseUri`?`$skip=$($page * $pageSize)&`$top=$pageSize"
                Write-Host "Fetching page $($page + 1)..." -ForegroundColor Cyan
                
                $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $headers -ErrorAction Stop
                
                # Check if response has content or items
                $deployments = if ($response.content) { $response.content } elseif ($response.items) { $response.items } else { $response }
                
                if ($deployments.Count -eq 0) {
                    $hasMore = $false
                } else {
                    $allDeployments += $deployments
                    $page++
                    
                    # Check if there are more pages
                    if ($deployments.Count -lt $pageSize) {
                        $hasMore = $false
                    }
                }
            }
            
            Write-Host "Found $($allDeployments.Count) total deployments" -ForegroundColor Green
            
            # Search for machine resources with the server name
            Write-Host "Searching for machine: $DeploymentName" -ForegroundColor Cyan
            
            foreach ($deployment in $allDeployments) {
                # Check if deployment has resources
                if ($deployment.resources) {
                    # Look for Cloud.vSphere.Machine or similar machine types
                    $machineResource = $deployment.resources | Where-Object { 
                        ($_.type -like "*Machine*" -or $_.type -eq "Cloud.vSphere.Machine" -or $_.type -eq "Cloud.Machine") -and
                        ($_.name -eq $DeploymentName -or $_.name -like "*$DeploymentName*")
                    }
                    
                    if ($machineResource) {
                        Write-Host "Found machine '$DeploymentName' in deployment: $($deployment.name)" -ForegroundColor Green
                        Write-Host "  Machine Type: $($machineResource.type)" -ForegroundColor Cyan
                        Write-Host "  Machine ID: $($machineResource.id)" -ForegroundColor Cyan
                        return @{
                            deployment = $deployment
                            endpoint = $baseUri
                            machine = $machineResource
                        }
                    }
                }
            }
            
            Write-Host "Machine '$DeploymentName' not found in this endpoint" -ForegroundColor Yellow
        }
        catch {
            Write-Host "Endpoint failed: $baseUri - $($_.Exception.Message)" -ForegroundColor Yellow
            continue
        }
    }
    
    Write-Host "All endpoints failed. Unable to find machine: $DeploymentName" -ForegroundColor Red
    return $null
}

# Function to update deployment name
function Update-vRADeploymentName {
    param(
        [string]$Server,
        [string]$Token,
        [string]$DeploymentId,
        [string]$NewName,
        [string]$Description,
        [string]$Endpoint
    )
    
    # Determine the correct update endpoint based on where we found the deployment
    $baseEndpoint = $Endpoint -replace "/deployments.*", "/deployments"
    $uri = "$baseEndpoint/$DeploymentId"
    
    $headers = @{
        "Authorization" = "Bearer $Token"
        "Content-Type" = "application/json"
    }
    
    $body = @{
        name = $NewName
        description = $Description
    } | ConvertTo-Json
    
    try {
        Write-Host "Updating deployment at: $uri" -ForegroundColor Cyan
        $response = Invoke-RestMethod -Uri $uri -Method Patch -Headers $headers -Body $body
        Write-Host "Successfully updated deployment to '$NewName'" -ForegroundColor Green
        return $true
    }
    catch {
        Write-Host "Failed to update deployment: $_" -ForegroundColor Red
        Write-Host "Error Details: $($_.Exception.Message)" -ForegroundColor Red
        return $false
    }
}

# Main Script
Write-Host "=== VMware Aria Automation Deployment Update ===" -ForegroundColor Cyan

# Get authentication token
$token = Get-vRAToken -Server $vraServer -Username $username -Password $password

if ($null -eq $token) {
    Write-Host "Exiting due to authentication failure" -ForegroundColor Red
    exit
}

# Import CSV file
if (-not (Test-Path $csvFile)) {
    Write-Host "CSV file not found: $csvFile" -ForegroundColor Red
    exit
}

$servers = Import-Csv -Path $csvFile
Write-Host "`nProcessing $($servers.Count) servers from CSV..." -ForegroundColor Cyan

# Process each server
foreach ($server in $servers) {
    Write-Host "`n--- Processing: $($server.Name) ---" -ForegroundColor Yellow
    
    # Get the deployment
    $result = Get-vRADeployment -Server $vraServer -Token $token -DeploymentName $server.Name
    
    if ($null -ne $result -and $null -ne $result.deployment) {
        # Update deployment with description
        $newDescription = if ($server.Description) { $server.Description } else { "Updated from CSV" }
        Update-vRADeploymentName -Server $vraServer -Token $token -DeploymentId $result.deployment.id -NewName $server.Name -Description $newDescription -Endpoint $result.endpoint
    }
    else {
        Write-Host "Deployment not found for: $($server.Name)" -ForegroundColor Red
    }
}

Write-Host "`n=== Update Process Complete ===" -ForegroundColor Cyan
