# VMware Aria Automation Configuration
$vraServer = "vra.yourdomain.com"  # Replace with your Aria Automation FQDN
$csvFile = "C:\Temp\serverList.csv"

# Prompt for credentials
$credential = Get-Credential -Message "Enter VMware Aria Automation credentials"
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

# Disable SSL certificate validation (only for self-signed certs)
if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
    Add-Type @"
    using System.Net;
    using System.Security.Cryptography.X509Certificates;
    public class TrustAllCertsPolicy : ICertificatePolicy {
        public bool CheckValidationResult(
            ServicePoint svcPoint, X509Certificate certificate,
            WebRequest request, int certificateProblem) {
            return true;
        }
    }
"@
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
}
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# Function to get authentication token
function Get-vRAToken {
    param(
        [string]$Server,
        [string]$Username,
        [string]$Password
    )
    
    # Try the standard vRA API endpoint first
    $uri = "https://$Server/csp/gateway/am/api/login"
    $body = @{
        username = $Username
        password = $Password
    } | ConvertTo-Json
    
    $headers = @{
        "Content-Type" = "application/json"
        "Accept" = "application/json"
    }
    
    try {
        Write-Host "Attempting authentication to: $uri" -ForegroundColor Cyan
        $response = Invoke-RestMethod -Uri $uri -Method Post -Headers $headers -Body $body
        Write-Host "Successfully authenticated to VMware Aria Automation" -ForegroundColor Green
        return $response.cspAuthToken
    }
    catch {
        Write-Host "CSP endpoint failed, trying legacy vRA endpoint..." -ForegroundColor Yellow
        
        # Try legacy vRA authentication endpoint
        $uri = "https://$Server/iaas/api/login"
        try {
            $response = Invoke-RestMethod -Uri $uri -Method Post -Headers $headers -Body $body
            Write-Host "Successfully authenticated using legacy endpoint" -ForegroundColor Green
            return $response.token
        }
        catch {
            Write-Host "Failed to authenticate: $_" -ForegroundColor Red
            Write-Host "Error Details: $($_.Exception.Message)" -ForegroundColor Red
            return $null
        }
    }
}

# Function to get deployment by machine name
function Get-vRADeployment {
    param(
        [string]$Server,
        [string]$Token,
        [string]$MachineName
    )
    
    $headers = @{
        "Authorization" = "Bearer $Token"
        "Content-Type" = "application/json"
    }
    
    try {
        Write-Host "Searching for machine: $MachineName" -ForegroundColor Cyan
        
        # First, try to find the machine using the machines API endpoint
        $machineUri = "https://$Server/iaas/api/machines?`$filter=name eq '$MachineName'"
        
        Write-Host "  Searching machines API..." -ForegroundColor Gray
        try {
            $machineResponse = Invoke-RestMethod -Uri $machineUri -Method Get -Headers $headers -ErrorAction Stop
            $machines = if ($machineResponse.content) { $machineResponse.content } else { $machineResponse }
            
            if ($machines -and $machines.Count -gt 0) {
                $machine = $machines[0]
                Write-Host "  Found machine!" -ForegroundColor Green
                
                # Get the deployment ID from the machine
                if ($machine.deploymentId) {
                    $deploymentId = $machine.deploymentId
                    Write-Host "  Getting deployment details..." -ForegroundColor Gray
                    
                    # Get the full deployment
                    $deploymentUri = "https://$Server/iaas/api/deployments/$deploymentId"
                    $deployment = Invoke-RestMethod -Uri $deploymentUri -Method Get -Headers $headers
                    
                    Write-Host "  Deployment: $($deployment.name)" -ForegroundColor Cyan
                    Write-Host "  Machine ID: $($machine.id)" -ForegroundColor Gray
                    
                    return @{
                        deployment = $deployment
                        endpoint = "https://$Server/iaas/api/deployments"
                        resource = $machine
                    }
                }
            }
        }
        catch {
            Write-Host "  Machines API search failed: $($_.Exception.Message)" -ForegroundColor Yellow
        }
        
        # Fallback: Search deployments with simple name filter
        Write-Host "  Trying deployments API..." -ForegroundColor Gray
        $deploymentUri = "https://$Server/iaas/api/deployments?`$filter=name eq '$MachineName'"
        
        try {
            $response = Invoke-RestMethod -Uri $deploymentUri -Method Get -Headers $headers -ErrorAction Stop
            $deployments = if ($response.content) { $response.content } else { $response }
            
            if ($deployments -and $deployments.Count -gt 0) {
                Write-Host "  Found deployment: $($deployments[0].name)" -ForegroundColor Green
                return @{
                    deployment = $deployments[0]
                    endpoint = "https://$Server/iaas/api/deployments"
                    resource = $null
                }
            }
        }
        catch {
            Write-Host "  Deployment filter failed: $($_.Exception.Message)" -ForegroundColor Yellow
        }
        
        Write-Host "  Machine '$MachineName' not found" -ForegroundColor Red
        return $null
    }
    catch {
        Write-Host "  Error: $($_.Exception.Message)" -ForegroundColor Red
        return $null
    }
}

# Function to update deployment name
function Update-vRADeploymentName {
    param(
        [string]$Server,
        [string]$Token,
        [string]$DeploymentId,
        [string]$NewName,
        [string]$Description,
        [string]$Endpoint
    )
    
    # Determine the correct update endpoint based on where we found the deployment
    $baseEndpoint = $Endpoint -replace "/deployments.*", "/deployments"
    $uri = "$baseEndpoint/$DeploymentId"
    
    $headers = @{
        "Authorization" = "Bearer $Token"
        "Content-Type" = "application/json"
    }
    
    $body = @{
        name = $NewName
        description = $Description
    } | ConvertTo-Json
    
    try {
        Write-Host "Updating deployment at: $uri" -ForegroundColor Cyan
        $response = Invoke-RestMethod -Uri $uri -Method Patch -Headers $headers -Body $body
        Write-Host "Successfully updated deployment to '$NewName'" -ForegroundColor Green
        return $true
    }
    catch {
        Write-Host "Failed to update deployment: $_" -ForegroundColor Red
        Write-Host "Error Details: $($_.Exception.Message)" -ForegroundColor Red
        return $false
    }
}

# Main Script
Write-Host "=== VMware Aria Automation Deployment Update ===" -ForegroundColor Cyan

# Get authentication token
$token = Get-vRAToken -Server $vraServer -Username $username -Password $password

if ($null -eq $token) {
    Write-Host "Exiting due to authentication failure" -ForegroundColor Red
    exit
}

# Import CSV file
if (-not (Test-Path $csvFile)) {
    Write-Host "CSV file not found: $csvFile" -ForegroundColor Red
    exit
}

$servers = Import-Csv -Path $csvFile
Write-Host "`nProcessing $($servers.Count) servers from CSV..." -ForegroundColor Cyan

# Process each server
foreach ($server in $servers) {
    Write-Host "`n--- Processing: $($server.Name) ---" -ForegroundColor Yellow
    
    # Get the deployment
    $result = Get-vRADeployment -Server $vraServer -Token $token -DeploymentName $server.Name
    
    if ($null -ne $result -and $null -ne $result.deployment) {
        # Update deployment with description
        $newDescription = if ($server.Description) { $server.Description } else { "Updated from CSV" }
        Update-vRADeploymentName -Server $vraServer -Token $token -DeploymentId $result.deployment.id -NewName $server.Name -Description $newDescription -Endpoint $result.endpoint
    }
    else {
        Write-Host "Deployment not found for: $($server.Name)" -ForegroundColor Red
    }
}

Write-Host "`n=== Update Process Complete ===" -ForegroundColor Cyan
