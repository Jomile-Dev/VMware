# VMware Aria Automation - Bulk Deployment Renamer (Service Broker API)
# This script reads server names from a CSV and renames their deployments
# Uses the Catalog/Service Broker API (same as the UI)

# Configuration
$vraServer = "vra.yourdomain.com"  # Replace with your Aria Automation FQDN
$csvPath = "C:\Path\To\Servers.csv"  # Replace with your CSV file path
$logPath = "C:\Logs\DeploymentRename_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"

# Create log directory if it doesn't exist
$logDir = Split-Path $logPath -Parent
if (-not (Test-Path $logDir)) {
    New-Item -ItemType Directory -Path $logDir -Force | Out-Null
}

# Function to write to console and log
function Write-Log {
    param($Message, $Color = "White")
    Write-Host $Message -ForegroundColor $Color
    Add-Content -Path $logPath -Value "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $Message"
}

# Disable SSL certificate validation
if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
    Add-Type @"
    using System.Net;
    using System.Security.Cryptography.X509Certificates;
    public class TrustAllCertsPolicy : ICertificatePolicy {
        public bool CheckValidationResult(
            ServicePoint svcPoint, X509Certificate certificate,
            WebRequest request, int certificateProblem) {
            return true;
        }
    }
"@
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
}
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# Verify CSV exists
if (-not (Test-Path $csvPath)) {
    Write-Log "ERROR: CSV file not found at $csvPath" -Color Red
    exit
}

# Import CSV
try {
    $servers = Import-Csv -Path $csvPath
    if (-not $servers -or $servers.Count -eq 0) {
        Write-Log "ERROR: CSV file is empty or invalid" -Color Red
        exit
    }
    
    # Check for Name column
    if (-not ($servers[0].PSObject.Properties.Name -contains "Name")) {
        Write-Log "ERROR: CSV must have a 'Name' column" -Color Red
        exit
    }
    
    Write-Log "Successfully loaded $($servers.Count) servers from CSV" -Color Green
}
catch {
    Write-Log "ERROR: Failed to read CSV: $_" -Color Red
    exit
}

# Authenticate
Write-Log "`n=== AUTHENTICATION ===" -Color Cyan
$credential = Get-Credential -Message "Enter VMware Aria Automation credentials"
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

$uri = "https://$vraServer/csp/gateway/am/api/login"
$body = @{
    username = $username
    password = $password
} | ConvertTo-Json

$authHeaders = @{
    "Content-Type" = "application/json"
    "Accept" = "application/json"
}

try {
    $response = Invoke-RestMethod -Uri $uri -Method Post -Headers $authHeaders -Body $body
    $token = $response.cspAuthToken
    Write-Log "Authentication successful!" -Color Green
}
catch {
    Write-Log "ERROR: Authentication failed: $_" -Color Red
    exit
}

$headers = @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
}

# Function to find deployment by server name using Service Broker API
function Find-Deployment {
    param($ServerName)
    
    Write-Log "  Searching Service Broker API for: $ServerName" -Color Gray
    
    # Method 1: Use the Catalog API search (same as UI)
    try {
        # This is the same search the UI uses
        $searchUri = "https://$vraServer/catalog/api/deployments?search=$ServerName"
        Write-Log "    Trying: $searchUri" -Color Gray
        
        $response = Invoke-RestMethod -Uri $searchUri -Method Get -Headers $headers -ErrorAction Stop
        $deployments = if ($response.content) { $response.content } else { $response }
        
        if ($deployments.Count -gt 0) {
            # Look for exact match
            $exactMatch = $deployments | Where-Object { $_.name -eq $ServerName }
            if ($exactMatch) {
                Write-Log "    ✓ Found exact match" -Color Green
                return @{
                    DeploymentId = $exactMatch.id
                    CurrentName = $exactMatch.name
                    Method = "Catalog Search (Exact)"
                    AlreadyNamed = $true
                }
            }
            
            # Look for deployment containing the server name
            foreach ($dep in $deployments) {
                Write-Log "    Checking deployment: $($dep.name)" -Color Gray
                # The deployment might have the server as a resource inside it
                return @{
                    DeploymentId = $dep.id
                    CurrentName = $dep.name
                    Method = "Catalog Search"
                }
            }
        }
    }
    catch {
        Write-Log "    Warning: Catalog search failed: $($_.Exception.Message)" -Color Yellow
    }
    
    # Method 2: Try deployment/api endpoint (alternative Service Broker API)
    try {
        $searchUri = "https://$vraServer/deployment/api/deployments?search=$ServerName"
        Write-Log "    Trying: $searchUri" -Color Gray
        
        $response = Invoke-RestMethod -Uri $searchUri -Method Get -Headers $headers -ErrorAction Stop
        $deployments = if ($response.content) { $response.content } else { $response }
        
        if ($deployments.Count -gt 0) {
            $exactMatch = $deployments | Where-Object { $_.name -eq $ServerName }
            if ($exactMatch) {
                Write-Log "    ✓ Found exact match" -Color Green
                return @{
                    DeploymentId = $exactMatch.id
                    CurrentName = $exactMatch.name
                    Method = "Deployment API (Exact)"
                    AlreadyNamed = $true
                }
            }
            
            return @{
                DeploymentId = $deployments[0].id
                CurrentName = $deployments[0].name
                Method = "Deployment API"
            }
        }
    }
    catch {
        Write-Log "    Warning: Deployment API search failed: $($_.Exception.Message)" -Color Yellow
    }
    
    # Method 3: Fallback to IaaS API with filter
    try {
        $uri = "https://$vraServer/iaas/api/machines?`$filter=name eq '$ServerName'"
        Write-Log "    Trying: $uri" -Color Gray
        
        $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $headers -ErrorAction Stop
        $machines = if ($response.content) { $response.content } else { $response }
        
        if ($machines.Count -gt 0 -and $machines[0].deploymentId) {
            # Now get the deployment details from catalog
            $depId = $machines[0].deploymentId
            $depUri = "https://$vraServer/catalog/api/deployments/$depId"
            $depResponse = Invoke-RestMethod -Uri $depUri -Method Get -Headers $headers -ErrorAction Stop
            
            return @{
                DeploymentId = $depResponse.id
                CurrentName = $depResponse.name
                Method = "IaaS Machine Lookup"
            }
        }
    }
    catch {
        Write-Log "    Warning: IaaS API failed: $($_.Exception.Message)" -Color Yellow
    }
    
    return $null
}

# Function to rename deployment using Service Broker API
function Rename-Deployment {
    param($DeploymentId, $NewName, $CurrentName)
    
    Write-Log "    Attempting rename..." -Color Gray
    
    # Try catalog API first
    $uri = "https://$vraServer/catalog/api/deployments/$DeploymentId"
    $body = @{
        name = $NewName
    } | ConvertTo-Json
    
    try {
        Write-Log "      Trying: PATCH $uri" -Color Gray
        $response = Invoke-RestMethod -Uri $uri -Method Patch -Headers $headers -Body $body -ErrorAction Stop
        Write-Log "      ✓ Success via Catalog API" -Color Green
        return $true
    }
    catch {
        Write-Log "      Warning: Catalog API failed: $($_.Exception.Message)" -Color Yellow
    }
    
    # Try deployment API as fallback
    $uri = "https://$vraServer/deployment/api/deployments/$DeploymentId"
    try {
        Write-Log "      Trying: PATCH $uri" -Color Gray
        $response = Invoke-RestMethod -Uri $uri -Method Patch -Headers $headers -Body $body -ErrorAction Stop
        Write-Log "      ✓ Success via Deployment API" -Color Green
        return $true
    }
    catch {
        Write-Log "      Warning: Deployment API failed: $($_.Exception.Message)" -Color Yellow
    }
    
    # Try IaaS API as last resort
    $uri = "https://$vraServer/iaas/api/deployments/$DeploymentId"
    try {
        Write-Log "      Trying: PATCH $uri" -Color Gray
        $response = Invoke-RestMethod -Uri $uri -Method Patch -Headers $headers -Body $body -ErrorAction Stop
        Write-Log "      ✓ Success via IaaS API" -Color Green
        return $true
    }
    catch {
        Write-Log "      ERROR: All rename methods failed. Last error: $($_.Exception.Message)" -Color Red
        return $false
    }
}

# Process each server
Write-Log "`n=== PROCESSING SERVERS ===" -Color Cyan
$results = @()

$counter = 0
foreach ($server in $servers) {
    $counter++
    $serverName = $server.Name.Trim()
    
    Write-Log "`n[$counter/$($servers.Count)] Processing: $serverName" -Color Yellow
    
    # Find deployment
    $deployment = Find-Deployment -ServerName $serverName
    
    if (-not $deployment) {
        Write-Log "  ✗ FAILED: Could not find deployment" -Color Red
        $results += [PSCustomObject]@{
            ServerName = $serverName
            Status = "Not Found"
            DeploymentId = "N/A"
            CurrentName = "N/A"
            Method = "N/A"
        }
        continue
    }
    
    Write-Log "  ✓ Found deployment via $($deployment.Method)" -Color Green
    Write-Log "    Deployment ID: $($deployment.DeploymentId)" -Color Gray
    Write-Log "    Current Name: $($deployment.CurrentName)" -Color Gray
    
    if ($deployment.AlreadyNamed) {
        Write-Log "  ℹ Deployment already named correctly - skipping" -Color Cyan
        $results += [PSCustomObject]@{
            ServerName = $serverName
            Status = "Already Named"
            DeploymentId = $deployment.DeploymentId
            CurrentName = $deployment.CurrentName
            Method = $deployment.Method
        }
        continue
    }
    
    # Rename deployment
    Write-Log "  Renaming: '$($deployment.CurrentName)' → '$serverName'" -Color Yellow
    $success = Rename-Deployment -DeploymentId $deployment.DeploymentId -NewName $serverName -CurrentName $deployment.CurrentName
    
    if ($success) {
        Write-Log "  ✓ SUCCESS: Deployment renamed!" -Color Green
        $results += [PSCustomObject]@{
            ServerName = $serverName
            Status = "Renamed"
            DeploymentId = $deployment.DeploymentId
            CurrentName = $deployment.CurrentName
            Method = $deployment.Method
        }
    }
    else {
        $results += [PSCustomObject]@{
            ServerName = $serverName
            Status = "Rename Failed"
            DeploymentId = $deployment.DeploymentId
            CurrentName = $deployment.CurrentName
            Method = $deployment.Method
        }
    }
    
    # Small delay to avoid rate limiting
    Start-Sleep -Milliseconds 200
}

# Summary
Write-Log "`n=== SUMMARY ===" -Color Cyan
$successCount = ($results | Where-Object { $_.Status -eq "Renamed" }).Count
$alreadyNamedCount = ($results | Where-Object { $_.Status -eq "Already Named" }).Count
$notFoundCount = ($results | Where-Object { $_.Status -eq "Not Found" }).Count
$failedCount = ($results | Where-Object { $_.Status -eq "Rename Failed" }).Count

Write-Log "Total Servers: $($servers.Count)" -Color White
Write-Log "Successfully Renamed: $successCount" -Color Green
Write-Log "Already Named Correctly: $alreadyNamedCount" -Color Cyan
Write-Log "Not Found: $notFoundCount" -Color Red
Write-Log "Failed to Rename: $failedCount" -Color Red

# Export results
$resultsPath = Join-Path (Split-Path $logPath -Parent) "RenameResults_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"
$results | Export-Csv -Path $resultsPath -NoTypeInformation
Write-Log "`nResults exported to: $resultsPath" -Color Green
Write-Log "Full log saved to: $logPath" -Color Green

Write-Log "`n=== COMPLETE ===" -Color Cyan
