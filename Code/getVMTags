# Requires: VMware.PowerCLI

# 1. Prompt once for credentials
$cred = Get-Credential -Message "Enter vCenter credentials"

# 2. List all vCenters you want to connect to
$vcenters = @(
    "vcsa1.example.local",
    "vcsa2.example.local",
    "vcsa3.example.local"
)

# 3. Connect to each vCenter
foreach ($vc in $vcenters) {
    Write-Host "Connecting to $vc..." -ForegroundColor Cyan
    try {
        Connect-VIServer -Server $vc -Credential $cred -WarningAction SilentlyContinue -ErrorAction Stop
        Write-Host "✅ Connected to $vc" -ForegroundColor Green
    }
    catch {
        Write-Host "❌ Failed to connect to $vc : $_" -ForegroundColor Red
    }
}

# 4. Get all VMs and their VEEAM category tags
$results = @()

Write-Host "`nRetrieving VMs and VEEAM tags..." -ForegroundColor Cyan

# Get all connected vCenter servers
$connectedVCs = $global:DefaultVIServers

foreach ($vcServer in $connectedVCs) {
    Write-Host "Processing VMs from $($vcServer.Name)..." -ForegroundColor Yellow
    
    # Get VMs from this specific vCenter
    $vms = Get-VM -Server $vcServer
    
    foreach ($vm in $vms) {
    # Get tag assignments for this VM
    $tagAssignments = Get-TagAssignment -Entity $vm -ErrorAction SilentlyContinue
    
    # Filter only tags from VEEAM category
    $veeamTags = if ($tagAssignments) {
        $tagAssignments | Where-Object { 
            $_.Tag.Category.Name -eq "VEEAM" 
        } | Select-Object -ExpandProperty Tag | Select-Object -ExpandProperty Name
    } else {
        $null
    }
    
    $veeamTagNames = if ($veeamTags) {
        $veeamTags -join ", "
    } else {
        ""  # blank if no VEEAM tags
    }

    # Build result object
    $results += [PSCustomObject]@{
        VMName       = $vm.Name
        PowerState   = $vm.PowerState
        Cluster      = $vm.VMHost.Parent.Name
        vCenter      = $vcServer.Name
        VEEAM_Tags   = $veeamTagNames
    }
    }
}

# 5. Output results
Write-Host "`nAll VMs with VEEAM Category Tags:" -ForegroundColor Yellow
$results | Format-Table -AutoSize

# 6. Show summary
$taggedCount = ($results | Where-Object { $_.VEEAM_Tags -ne "" }).Count
$totalCount = $results.Count
Write-Host "`nSummary: $taggedCount out of $totalCount VMs have VEEAM tags" -ForegroundColor Cyan

# 7. Export to CSV
$results | Export-Csv -Path ".\VMs_VEEAM_Tags.csv" -NoTypeInformation
Write-Host "✅ Exported to VMs_VEEAM_Tags.csv" -ForegroundColor Green

# 8. Disconnect from all vCenters
Write-Host "`nDisconnecting from vCenters..." -ForegroundColor Cyan
Disconnect-VIServer -Server * -Confirm:$false
