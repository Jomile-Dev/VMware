# 9. Send email report
Write-Host "`nSending email report..." -ForegroundColor Cyan

# Build email body
$reportTime = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
$emailBody = @"
<html>
<head>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #0078D4; margin-bottom: 10px; }
    .description { color: #555; font-size: 14px; margin-bottom: 20px; line-height: 1.6; }
    .report-info { background-color: #f8f9fa; padding: 15px; border-left: 4px solid #0078D4; margin-bottom: 20px; }
    h2 { color: #0078D4; margin-top: 30px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th { background-color: #0078D4; color: white; padding: 10px; text-align: left; }
    td { border: 1px solid #ddd; padding: 8px; }
    tr:nth-child(even) { background-color: #f2f2f2; }
    .summary { background-color: #e7f3ff; padding: 15px; margin: 10px 0; border-radius: 5px; }
    .no-tags { background-color: #fff3cd; padding: 15px; margin: 10px 0; border-radius: 5px; }
</style>
</head>
<body>
<h1>vCenter VEEAM Tags Report</h1>

<div class="description">
This report provides a comprehensive overview of all virtual machines across connected vCenter servers 
and their associated VEEAM backup tags. It includes summary statistics, tag distribution analysis, 
and identifies VMs without backup tags that may require attention.
</div>

<div class="report-info">
    <strong>Report Time:</strong> $reportTime<br>
    <strong>vCenter Servers:</strong> $($connectedServers.Name -join ', ')
</div>

<div class="summary">
<h2>Summary</h2>
<ul>
    <li><strong>Total VMs:</strong> $totalCount</li>
    <li><strong>VMs with VEEAM tags:</strong> $taggedCount</li>
    <li><strong>VMs without VEEAM tags:</strong> $($totalCount - $taggedCount)</li>
</ul>
</div>

<h2>Breakdown by VEEAM Tag</h2>
<table>
<tr>
    <th>Tag Name</th>
    <th>VM Count</th>
    <th>Percentage</th>
</tr>
"@

# Add tag counts to email with percentages
foreach ($tagCount in $tagCountsSorted) {
    $percentage = [math]::Round(($tagCount.Value / $totalCount) * 100, 1)
    $emailBody += @"
<tr>
    <td>$($tagCount.Key)</td>
    <td>$($tagCount.Value)</td>
    <td>$percentage%</td>
</tr>
"@
}

$emailBody += @"
</table>

<div class="no-tags">
<h2>VMs Without VEEAM Tags</h2>
<p><strong>Count:</strong> $($totalCount - $taggedCount) VMs ($([math]::Round((($totalCount - $taggedCount) / $totalCount) * 100, 1))% of total)</p>
</div>

<p style="margin-top: 20px;"><em>Full details are available in the attached CSV file.</em></p>
</body>
</html>
"@

# Send email
try {
    $mailParams = @{
        SmtpServer = $smtpServer
        Port = $smtpPort
        From = $smtpFrom
        To = $smtpTo
        Subject = $smtpSubject
        Body = $emailBody
        BodyAsHtml = $true
        Attachments = $csvPath
    }
    
    # Add authentication if configured
    # if ($smtpUsername -and $smtpPassword) {
    #     $securePassword = ConvertTo-SecureString $smtpPassword -AsPlainText -Force
    #     $mailParams.Credential = New-Object System.Management.Automation.PSCredential($smtpUsername, $securePassword)
    #     $mailParams.UseSsl = $true
    # }
    
    Send-MailMessage @mailParams
    Write-Host "✅ Email sent successfully to $smtpTo" -ForegroundColor Green
}
catch {
    Write-Host "❌ Failed to send email: $_" -ForegroundColor Red
}
