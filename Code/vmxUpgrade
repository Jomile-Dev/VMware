# VMware VM Compatibility Upgrade Script
# Requires VMware PowerCLI module

#Requires -Modules VMware.VimAutomation.Core

# Configuration
$CsvPath = "C:\VMList.csv"  # Update with your CSV path
$ReportPath = "C:\VM_Upgrade_Report_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"

# ============================================================
# SNAPSHOT CONFIGURATION (DELETE THIS SECTION IF NOT REQUIRED)
# ============================================================
$CreateSnapshots = $true  # Set to $false to disable snapshots
$SnapshotName = "Pre-Compatibility-Upgrade"
$SnapshotDescription = "Snapshot created before VM hardware compatibility upgrade - $(Get-Date)"
# ============================================================
# END SNAPSHOT CONFIGURATION
# ============================================================

# Connect to multiple vCenter Servers
$vCenterServers = @("vc01", "vc02")  # Update with your vCenter servers
$Credential = Get-Credential -Message "Enter vCenter credentials"

Write-Host "Connecting to vCenter servers..." -ForegroundColor Cyan
foreach ($vCenter in $vCenterServers) {
    try {
        Connect-VIServer -Server $vCenter -Credential $Credential -ErrorAction Stop | Out-Null
        Write-Host "  Connected to: $vCenter" -ForegroundColor Green
    }
    catch {
        Write-Host "  Failed to connect to $vCenter : $_" -ForegroundColor Red
    }
}

# Verify we're connected to at least one vCenter
$connectedServers = $global:DefaultVIServers
if ($connectedServers.Count -eq 0) {
    Write-Host "No vCenter connections established. Exiting." -ForegroundColor Red
    exit
}

Write-Host "`nConnected to $($connectedServers.Count) vCenter server(s):" -ForegroundColor Green
$connectedServers | ForEach-Object { Write-Host "  - $($_.Name)" -ForegroundColor Gray }

# Get the latest VM hardware version supported across all vCenters
$latestVersion = ($connectedServers | ForEach-Object { 
    Get-VMHost -Server $_ | Select-Object -First 1 
} | Select-Object -First 1).MaxVMVersion
Write-Host "`nLatest VM hardware version available: $latestVersion" -ForegroundColor Cyan

# Read VMs from CSV
if (-not (Test-Path $CsvPath)) {
    Write-Host "CSV file not found: $CsvPath" -ForegroundColor Red
    Disconnect-VIServer -Confirm:$false
    exit
}

$vmList = Import-Csv $CsvPath
Write-Host "Loaded $($vmList.Count) VMs from CSV" -ForegroundColor Green

# Build VM inventory cache from all vCenters for faster lookups
Write-Host "`nBuilding VM inventory cache from all vCenters (this may take a moment)..." -ForegroundColor Cyan
$allVMs = @{}
$totalVMCount = 0
foreach ($vCenter in $connectedServers) {
    Write-Host "  Retrieving VMs from $($vCenter.Name)..." -ForegroundColor Gray
    $vms = Get-VM -Server $vCenter
    foreach ($vm in $vms) {
        # Create unique key: VMName + vCenter to handle duplicates across vCenters
        $uniqueKey = "$($vm.Name)|$($vCenter.Name)"
        $allVMs[$uniqueKey] = @{
            VM = $vm
            vCenter = $vCenter.Name
            Server = $vCenter
        }
        # Also store by just VM name for initial lookup attempt
        if (-not $allVMs.ContainsKey($vm.Name)) {
            $allVMs[$vm.Name] = @{
                VM = $vm
                vCenter = $vCenter.Name
                Server = $vCenter
            }
        }
    }
    $totalVMCount += $vms.Count
    Write-Host "    Retrieved $($vms.Count) VMs" -ForegroundColor Gray
}
Write-Host "Total VMs in cache: $totalVMCount" -ForegroundColor Green
Write-Host ""

# Initialize results array
$results = @()

foreach ($vmEntry in $vmList) {
    $vmName = $vmEntry.VMName  # Assumes CSV has a column named "VMName"
    
    Write-Host "`nProcessing VM: $vmName" -ForegroundColor Yellow
    
    $result = [PSCustomObject]@{
        VMName = $vmName
        OriginalVersion = ""
        UpgradedToVersion = ""
        SnapshotCreated = "No"
        SnapshotName = ""
        UpgradeScheduled = "No"
        Status = ""
        Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        ErrorMessage = ""
    }
    
    # Search for VM in the pre-built cache (instant lookup)
    $vm = $null
    $foundOnVC = $null
    $vcServer = $null
    
    Write-Host "  Looking up VM in cache..." -ForegroundColor Gray
    if ($allVMs.ContainsKey($vmName)) {
        $vmInfo = $allVMs[$vmName]
        $vm = $vmInfo.VM
        $foundOnVC = $vmInfo.vCenter
        $vcServer = $vmInfo.Server
        Write-Host "  Found VM on: $foundOnVC (Location: $($vm.Folder.Name))" -ForegroundColor Green
    }
    else {
        Write-Host "  Error: VM not found on any connected vCenter server" -ForegroundColor Red
        Write-Host "  Searched: $($connectedServers.Name -join ', ')" -ForegroundColor Gray
        $result.ErrorMessage = "VM not found on any connected vCenter"
        $result.Status = "Failed - VM Not Found"
        $results += $result
        continue
    }
    
    try {
        $result.OriginalVersion = $vm.Version
        
        # Check if VM is already at the latest version
        if ($vm.Version -eq $latestVersion) {
            Write-Host "  VM is already at the latest version ($latestVersion)" -ForegroundColor Cyan
            $result.Status = "Already at latest version"
            $results += $result
            continue
        }
        
        # Check if VM is powered on
        $vmPowerState = $vm.PowerState
        Write-Host "  VM Power State: $vmPowerState" -ForegroundColor Gray
        
        # ============================================================
        # SNAPSHOT SECTION (DELETE THIS SECTION IF NOT REQUIRED)
        # ============================================================
        if ($CreateSnapshots) {
            # Create snapshot
            Write-Host "  Creating snapshot..." -ForegroundColor Cyan
            try {
                $snapshot = New-Snapshot -VM $vm -Name $SnapshotName -Description $SnapshotDescription -ErrorAction Stop
                $result.SnapshotCreated = "Yes"
                $result.SnapshotName = $snapshot.Name
                Write-Host "  Snapshot created successfully: $($snapshot.Name)" -ForegroundColor Green
            }
            catch {
                Write-Host "  Failed to create snapshot: $_" -ForegroundColor Red
                $result.ErrorMessage = "Snapshot failed: $_"
                $result.Status = "Failed - Snapshot Error"
                $results += $result
                continue
            }
        }
        else {
            Write-Host "  Snapshot creation disabled (skipping)" -ForegroundColor Yellow
            $result.SnapshotCreated = "Disabled"
        }
        # ============================================================
        # END SNAPSHOT SECTION
        # ============================================================
        
        # Schedule VM compatibility upgrade
        Write-Host "  Scheduling compatibility upgrade to $latestVersion..." -ForegroundColor Cyan
        try {
            # Use Set-VM to upgrade the VM hardware version
            # Note: This requires the VM to be powered off for the upgrade to take effect
            if ($vmPowerState -eq "PoweredOn") {
                Write-Host "  Note: VM must be powered off and on again for upgrade to apply" -ForegroundColor Yellow
            }
            
            Set-VM -VM $vm -Version $latestVersion -Confirm:$false -ErrorAction Stop
            
            # Verify the upgrade was scheduled by re-querying the VM on the correct vCenter
            $vmUpdated = Get-VM -Name $vmName -Server $vcServer
            $result.UpgradedToVersion = $vmUpdated.Version
            $result.UpgradeScheduled = "Yes"
            $result.Status = "Success - Upgrade Scheduled"
            Write-Host "  Compatibility upgrade scheduled successfully" -ForegroundColor Green
            Write-Host "  Version: $($result.OriginalVersion) -> $($result.UpgradedToVersion)" -ForegroundColor Green
        }
        catch {
            Write-Host "  Failed to schedule upgrade: $_" -ForegroundColor Red
            $result.ErrorMessage = "Upgrade failed: $_"
            $result.Status = "Failed - Upgrade Error"
        }
    }
    catch {
        Write-Host "  Error processing VM: $_" -ForegroundColor Red
        $result.ErrorMessage = "General error: $_"
        $result.Status = "Failed - Processing Error"
    }
    
    $results += $result
}

# Generate report
Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "Generating Report..." -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan

$results | Export-Csv -Path $ReportPath -NoTypeInformation
Write-Host "Report saved to: $ReportPath" -ForegroundColor Green

# Display summary
$successful = ($results | Where-Object { $_.Status -like "*Success*" }).Count
$failed = ($results | Where-Object { $_.Status -like "*Failed*" }).Count
$alreadyUpgraded = ($results | Where-Object { $_.Status -like "*Already*" }).Count

Write-Host "`nSummary:" -ForegroundColor Cyan
Write-Host "  Total VMs processed: $($results.Count)"
Write-Host "  Successful: $successful" -ForegroundColor Green
Write-Host "  Failed: $failed" -ForegroundColor Red
Write-Host "  Already at latest version: $alreadyUpgraded" -ForegroundColor Yellow

# Disconnect from all vCenter servers
Disconnect-VIServer -Confirm:$false
Write-Host "`nDisconnected from all vCenter servers" -ForegroundColor Green
