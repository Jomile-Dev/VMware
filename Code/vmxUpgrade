# VMware VM Compatibility Upgrade Script
# Requires VMware PowerCLI module

#Requires -Modules VMware.VimAutomation.Core

# Configuration
$CsvPath = "C:\VMList.csv"  # Update with your CSV path
$ReportPath = "C:\VM_Upgrade_Report_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"
$SnapshotName = "Pre-Compatibility-Upgrade"
$SnapshotDescription = "Snapshot created before VM hardware compatibility upgrade - $(Get-Date)"

# Connect to vCenter (update with your credentials)
$vCenterServer = Read-Host "Enter vCenter Server"
$Credential = Get-Credential -Message "Enter vCenter credentials"

try {
    Connect-VIServer -Server $vCenterServer -Credential $Credential -ErrorAction Stop
    Write-Host "Connected to vCenter: $vCenterServer" -ForegroundColor Green
}
catch {
    Write-Host "Failed to connect to vCenter: $_" -ForegroundColor Red
    exit
}

# Get the latest VM hardware version supported by the vCenter
$latestVersion = (Get-VMHost | Select-Object -First 1).MaxVMVersion
Write-Host "Latest VM hardware version available: $latestVersion" -ForegroundColor Cyan

# Read VMs from CSV
if (-not (Test-Path $CsvPath)) {
    Write-Host "CSV file not found: $CsvPath" -ForegroundColor Red
    Disconnect-VIServer -Confirm:$false
    exit
}

$vmList = Import-Csv $CsvPath
Write-Host "Loaded $($vmList.Count) VMs from CSV" -ForegroundColor Green

# Initialize results array
$results = @()

foreach ($vmEntry in $vmList) {
    $vmName = $vmEntry.VMName  # Assumes CSV has a column named "VMName"
    
    Write-Host "`nProcessing VM: $vmName" -ForegroundColor Yellow
    
    $result = [PSCustomObject]@{
        VMName = $vmName
        OriginalVersion = ""
        UpgradedToVersion = ""
        SnapshotCreated = "No"
        SnapshotName = ""
        UpgradeScheduled = "No"
        Status = ""
        Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        ErrorMessage = ""
    }
    
    try {
        # Get VM object
        $vm = Get-VM -Name $vmName -ErrorAction Stop
        $result.OriginalVersion = $vm.Version
        
        # Check if VM is already at the latest version
        if ($vm.Version -eq $latestVersion) {
            Write-Host "  VM is already at the latest version ($latestVersion)" -ForegroundColor Cyan
            $result.Status = "Already at latest version"
            $results += $result
            continue
        }
        
        # Check if VM is powered on (snapshots work better when VM is powered on)
        $vmPowerState = $vm.PowerState
        Write-Host "  VM Power State: $vmPowerState" -ForegroundColor Gray
        
        # Create snapshot
        Write-Host "  Creating snapshot..." -ForegroundColor Cyan
        try {
            $snapshot = New-Snapshot -VM $vm -Name $SnapshotName -Description $SnapshotDescription -ErrorAction Stop
            $result.SnapshotCreated = "Yes"
            $result.SnapshotName = $snapshot.Name
            Write-Host "  Snapshot created successfully: $($snapshot.Name)" -ForegroundColor Green
        }
        catch {
            Write-Host "  Failed to create snapshot: $_" -ForegroundColor Red
            $result.ErrorMessage = "Snapshot failed: $_"
            $result.Status = "Failed - Snapshot Error"
            $results += $result
            continue
        }
        
        # Schedule VM compatibility upgrade
        Write-Host "  Scheduling compatibility upgrade to $latestVersion..." -ForegroundColor Cyan
        try {
            # Use Set-VM to upgrade the VM hardware version
            # Note: This requires the VM to be powered off for the upgrade to take effect
            if ($vmPowerState -eq "PoweredOn") {
                Write-Host "  Note: VM must be powered off and on again for upgrade to apply" -ForegroundColor Yellow
            }
            
            Set-VM -VM $vm -Version $latestVersion -Confirm:$false -ErrorAction Stop
            
            # Verify the upgrade was scheduled by re-querying the VM
            $vmUpdated = Get-VM -Name $vmName
            $result.UpgradedToVersion = $vmUpdated.Version
            $result.UpgradeScheduled = "Yes"
            $result.Status = "Success - Upgrade Scheduled"
            Write-Host "  Compatibility upgrade scheduled successfully" -ForegroundColor Green
            Write-Host "  Version: $($result.OriginalVersion) -> $($result.UpgradedToVersion)" -ForegroundColor Green
        }
        catch {
            Write-Host "  Failed to schedule upgrade: $_" -ForegroundColor Red
            $result.ErrorMessage = "Upgrade failed: $_"
            $result.Status = "Failed - Upgrade Error"
        }
    }
    catch {
        Write-Host "  Error processing VM: $_" -ForegroundColor Red
        $result.ErrorMessage = "General error: $_"
        $result.Status = "Failed - VM Not Found or Access Error"
    }
    
    $results += $result
}

# Generate report
Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "Generating Report..." -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan

$results | Export-Csv -Path $ReportPath -NoTypeInformation
Write-Host "Report saved to: $ReportPath" -ForegroundColor Green

# Display summary
$successful = ($results | Where-Object { $_.Status -like "*Success*" }).Count
$failed = ($results | Where-Object { $_.Status -like "*Failed*" }).Count
$alreadyUpgraded = ($results | Where-Object { $_.Status -like "*Already*" }).Count

Write-Host "`nSummary:" -ForegroundColor Cyan
Write-Host "  Total VMs processed: $($results.Count)"
Write-Host "  Successful: $successful" -ForegroundColor Green
Write-Host "  Failed: $failed" -ForegroundColor Red
Write-Host "  Already at latest version: $alreadyUpgraded" -ForegroundColor Yellow

# Disconnect from vCenter
Disconnect-VIServer -Confirm:$false
Write-Host "`nDisconnected from vCenter" -ForegroundColor Green
