# VMware Aria Automation - Bulk Deployment Renamer
# Renames deployments based on CSV input (Name column = server to find, Description = new deployment name)

$vraServer = "vra.yourdomain.com"
$csvPath = "C:\Path\To\Servers.csv"
$logPath = "C:\Logs\DeploymentRename_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"

function Write-Log {
    param($Message, $Color = "White")
    Write-Host $Message -ForegroundColor $Color
    Add-Content -Path $logPath -Value "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $Message"
}

# Configure TLS 1.2
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
[System.Net.ServicePointManager]::ServerCertificateValidationCallback = { $true }

# Import CSV
$servers = @(Import-Csv -Path $csvPath)
Write-Host "Loaded $($servers.Count) servers from CSV`n" -ForegroundColor Green

# Authenticate to VMware Aria
Write-Log "=== AUTHENTICATION ===" -Color Cyan
$credential = Get-Credential -Message "Enter VMware Aria Automation credentials"

$authBody = @{
    username = $credential.UserName
    password = $credential.GetNetworkCredential().Password
} | ConvertTo-Json

$authResponse = Invoke-RestMethod -Uri "https://$vraServer/csp/gateway/am/api/login" `
    -Method Post -Headers @{"Content-Type"="application/json"} -Body $authBody

$headers = @{
    "Authorization" = "Bearer $($authResponse.cspAuthToken)"
    "Content-Type" = "application/json"
}
Write-Log "Authentication successful!`n" -Color Green

# Get all deployments with pagination
function Get-AllDeployments {
    Write-Log "Fetching all deployments..." -Color Cyan
    $allDeployments = @()
    $page = 0
    $size = 100
    
    do {
        $uri = "https://$vraServer/deployment/api/deployments?page=$page&size=$size&expand=resources"
        Write-Log "  Page $($page + 1)..." -Gray
        
        $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $headers
        $deployments = if ($response.content) { $response.content } else { $response }
        $allDeployments += $deployments
        
        $hasMore = ($response.totalPages -and $page -lt $response.totalPages - 1) -or 
                   ($deployments.Count -eq $size)
        $page++
    } while ($hasMore)
    
    Write-Log "Total deployments: $($allDeployments.Count)`n" -Color Cyan
    return $allDeployments
}

# Find deployment containing the specified server
function Find-Deployment {
    param($ServerName, $AllDeployments)
    
    foreach ($dep in $AllDeployments) {
        $machines = @($dep.resources | Where-Object { $_.type -eq "Cloud.vSphere.Machine" })
        
        foreach ($machine in $machines) {
            # Check machine name or hostname properties
            if ($machine.name -eq $ServerName -or 
                $machine.properties.hostname -eq $ServerName -or 
                $machine.properties.resourceName -eq $ServerName) {
                return @{
                    DeploymentId = $dep.id
                    CurrentName = $dep.name
                }
            }
        }
    }
    return $null
}

# Rename deployment via PATCH API
function Rename-Deployment {
    param($DeploymentId, $NewName)
    
    try {
        $body = @{ name = $NewName } | ConvertTo-Json
        Invoke-RestMethod -Uri "https://$vraServer/deployment/api/deployments/$DeploymentId" `
            -Method Patch -Headers $headers -Body $body -ErrorAction Stop | Out-Null
        return $true
    }
    catch {
        Write-Log "    Error: $($_.Exception.Message)" -Color Red
        return $false
    }
}

# Main processing
$allDeployments = Get-AllDeployments
Write-Log "=== PROCESSING SERVERS ===" -Color Cyan
$results = @()

for ($i = 0; $i -lt $servers.Count; $i++) {
    $server = $servers[$i]
    $serverName = $server.Name.Trim()
    $newName = $server.Description.Trim()
    
    Write-Log "`n[$($i+1)/$($servers.Count)] $serverName → $newName" -Color Yellow
    
    $deployment = Find-Deployment -ServerName $serverName -AllDeployments $allDeployments
    
    if (-not $deployment) {
        Write-Log "  ✗ Not found" -Color Red
        $results += [PSCustomObject]@{ ServerName=$serverName; NewName=$newName; Status="Not Found"; OldName="N/A" }
        continue
    }
    
    Write-Log "  Current: $($deployment.CurrentName)" -Gray
    
    if ($deployment.CurrentName -eq $newName) {
        Write-Log "  ℹ Already correct" -Color Cyan
        $results += [PSCustomObject]@{ ServerName=$serverName; NewName=$newName; Status="Already Named"; OldName=$deployment.CurrentName }
        continue
    }
    
    if (Rename-Deployment -DeploymentId $deployment.DeploymentId -NewName $newName) {
        Write-Log "  ✓ Renamed" -Color Green
        $results += [PSCustomObject]@{ ServerName=$serverName; NewName=$newName; Status="Renamed"; OldName=$deployment.CurrentName }
    }
    else {
        Write-Log "  ✗ Failed" -Color Red
        $results += [PSCustomObject]@{ ServerName=$serverName; NewName=$newName; Status="Failed"; OldName=$deployment.CurrentName }
    }
    
    Start-Sleep -Milliseconds 200
}

# Summary
Write-Log "`n=== SUMMARY ===" -Color Cyan
Write-Log "Renamed: $(($results | Where-Object Status -eq 'Renamed').Count)" -Green
Write-Log "Already Named: $(($results | Where-Object Status -eq 'Already Named').Count)" -Cyan
Write-Log "Not Found: $(($results | Where-Object Status -eq 'Not Found').Count)" -Red
Write-Log "Failed: $(($results | Where-Object Status -eq 'Failed').Count)" -Red

$resultsPath = "$(Split-Path $logPath -Parent)\Results_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"
$results | Export-Csv -Path $resultsPath -NoTypeInformation
Write-Log "`nResults: $resultsPath" -White
