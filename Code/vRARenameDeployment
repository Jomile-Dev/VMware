# VMware Aria Automation - Bulk Deployment Renamer
# Renames deployments to match their resource/server names

$vraServer = "vra.yourdomain.com"
$csvPath = "C:\Path\To\Servers.csv"
$logPath = "C:\Logs\DeploymentRename_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"

function Write-Log {
    param($Message, $Color = "White")
    Write-Host $Message -ForegroundColor $Color
    Add-Content -Path $logPath -Value "$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss') - $Message"
}

# Disable SSL validation
if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
    Add-Type @"
    using System.Net;
    using System.Security.Cryptography.X509Certificates;
    public class TrustAllCertsPolicy : ICertificatePolicy {
        public bool CheckValidationResult(
            ServicePoint svcPoint, X509Certificate certificate,
            WebRequest request, int certificateProblem) {
            return true;
        }
    }
"@
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
}
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# Import CSV
$servers = @(Import-Csv -Path $csvPath)
Write-Host "Loaded $($servers.Count) servers from CSV`n" -ForegroundColor Green

# Authenticate
Write-Log "=== AUTHENTICATION ===" -Color Cyan
$credential = Get-Credential -Message "Enter VMware Aria Automation credentials"
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

$uri = "https://$vraServer/csp/gateway/am/api/login"
$body = @{
    username = $username
    password = $password
} | ConvertTo-Json

$authHeaders = @{
    "Content-Type" = "application/json"
    "Accept" = "application/json"
}

$response = Invoke-RestMethod -Uri $uri -Method Post -Headers $authHeaders -Body $body
$token = $response.cspAuthToken
Write-Log "Authentication successful!`n" -Color Green

$headers = @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
}

# Function to get all deployments with pagination
function Get-AllDeployments {
    Write-Log "Fetching all deployments..." -Color Cyan
    
    $uri = "https://$vraServer/deployment/api/deployments"
    $allDeployments = @()
    $page = 0
    $size = 100
    
    do {
        $pagedUri = "$uri`?page=$page&size=$size&expand=resources"
        Write-Log "  Fetching page $($page + 1)..." -Color Gray
        
        $response = Invoke-RestMethod -Uri $pagedUri -Method Get -Headers $headers
        $deployments = if ($response.content) { $response.content } else { $response }
        
        $allDeployments += $deployments
        $page++
        
        # Check if there are more pages
        $hasMore = $false
        if ($response.totalPages) {
            $hasMore = $page -lt $response.totalPages
        }
        elseif ($response.totalElements) {
            $hasMore = $allDeployments.Count -lt $response.totalElements
        }
        else {
            $hasMore = $deployments.Count -eq $size
        }
        
    } while ($hasMore)
    
    Write-Log "Total deployments retrieved: $($allDeployments.Count)" -Color Cyan
    return $allDeployments
}

# Function to find deployment containing the resource/server
function Find-Deployment {
    param($ServerName, $AllDeployments)
    
    Write-Log "  Searching for server: $ServerName" -Color Gray
    
    foreach ($dep in $AllDeployments) {
        $vSphereMachines = @()
        
        # Check if resources exist in the deployment object
        if ($dep.resources -and $dep.resources.Count -gt 0) {
            $vSphereMachines = @($dep.resources | Where-Object { 
                $_.type -eq "Cloud.vSphere.Machine" 
            })
        }
        
        # If not found, try fetching resources separately
        if ($vSphereMachines.Count -eq 0) {
            try {
                $resourceUri = "https://$vraServer/deployment/api/deployments/$($dep.id)/resources"
                $separateResources = Invoke-RestMethod -Uri $resourceUri -Method Get -Headers $headers -ErrorAction Stop
                $resList = if ($separateResources.content) { $separateResources.content } else { $separateResources }
                
                $vSphereMachines = @($resList | Where-Object { 
                    $_.type -eq "Cloud.vSphere.Machine" 
                })
            } catch {
                # Continue if we can't fetch resources
                continue
            }
        }
        
        # Check each vSphere machine for a name match
        foreach ($machine in $vSphereMachines) {
            # Check the resource name property
            if ($machine.name -eq $ServerName) {
                Write-Log "  ✓ Found in deployment: $($dep.name)" -Color Green
                Write-Log "    Matched on resource name: $($machine.name)" -Color Gray
                return @{
                    DeploymentId = $dep.id
                    CurrentName = $dep.name
                    AlreadyNamed = ($dep.name -eq $ServerName)
                }
            }
            
            # Also check properties for additional matching options
            if ($machine.properties) {
                $hostname = $machine.properties.hostname
                $resourceName = $machine.properties.resourceName
                
                if ($hostname -eq $ServerName -or $resourceName -eq $ServerName) {
                    Write-Log "  ✓ Found in deployment: $($dep.name)" -Color Green
                    Write-Log "    Matched on property: hostname=$hostname, resourceName=$resourceName" -Color Gray
                    return @{
                        DeploymentId = $dep.id
                        CurrentName = $dep.name
                        AlreadyNamed = ($dep.name -eq $ServerName)
                    }
                }
            }
        }
    }
    
    Write-Log "  ✗ Server not found in any deployment" -Color Yellow
    return $null
}

# Function to rename deployment
function Rename-Deployment {
    param($DeploymentId, $NewName)
    
    $uri = "https://$vraServer/deployment/api/deployments/$DeploymentId"
    $body = @{ name = $NewName } | ConvertTo-Json
    
    try {
        Invoke-RestMethod -Uri $uri -Method Patch -Headers $headers -Body $body -ErrorAction Stop | Out-Null
        return $true
    }
    catch {
        Write-Log "      Error: $($_.Exception.Message)" -Color Red
        return $false
    }
}

# Get all deployments once at the start
$allDeployments = Get-AllDeployments
Write-Log ""

# Process servers
Write-Log "=== PROCESSING SERVERS ===" -Color Cyan
$results = @()
$counter = 0

foreach ($server in $servers) {
    $counter++
    $serverName = $server.Name.Trim()
    
    Write-Log "`n[$counter/$($servers.Count)] $serverName" -Color Yellow
    
    $deployment = Find-Deployment -ServerName $serverName -AllDeployments $allDeployments
    
    if (-not $deployment) {
        Write-Log "  ✗ Not found" -Color Red
        $results += [PSCustomObject]@{
            ServerName = $serverName
            Status = "Not Found"
            OldName = "N/A"
        }
        continue
    }
    
    Write-Log "  Current deployment name: $($deployment.CurrentName)" -Color Gray
    
    if ($deployment.AlreadyNamed) {
        Write-Log "  ℹ Already correctly named" -Color Cyan
        $results += [PSCustomObject]@{
            ServerName = $serverName
            Status = "Already Named"
            OldName = $deployment.CurrentName
        }
        continue
    }
    
    Write-Log "  Attempting rename: '$($deployment.CurrentName)' → '$serverName'" -Color White
    $success = Rename-Deployment -DeploymentId $deployment.DeploymentId -NewName $serverName
    
    if ($success) {
        Write-Log "  ✓ Successfully renamed!" -Color Green
        $results += [PSCustomObject]@{
            ServerName = $serverName
            Status = "Renamed"
            OldName = $deployment.CurrentName
        }
    }
    else {
        Write-Log "  ✗ Rename failed" -Color Red
        $results += [PSCustomObject]@{
            ServerName = $serverName
            Status = "Failed"
            OldName = $deployment.CurrentName
        }
    }
    
    Start-Sleep -Milliseconds 200
}

# Summary
Write-Log "`n=== SUMMARY ===" -Color Cyan
$renamed = ($results | Where-Object { $_.Status -eq "Renamed" }).Count
$alreadyNamed = ($results | Where-Object { $_.Status -eq "Already Named" }).Count
$notFound = ($results | Where-Object { $_.Status -eq "Not Found" }).Count
$failed = ($results | Where-Object { $_.Status -eq "Failed" }).Count

Write-Log "Renamed: $renamed" -Color Green
Write-Log "Already Named: $alreadyNamed" -Color Cyan
Write-Log "Not Found: $notFound" -Color Red
Write-Log "Failed: $failed" -Color Red
Write-Log "Total Processed: $($servers.Count)" -Color White

$resultsPath = Join-Path (Split-Path $logPath -Parent) "Results_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"
$results | Export-Csv -Path $resultsPath -NoTypeInformation
Write-Log "`nResults exported to: $resultsPath" -Color White
Write-Log "Log file: $logPath" -Color White
