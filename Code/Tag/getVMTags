# Replace section 7 and 9 with this:

# 7. Create CSV in memory
$csvContent = $results | ConvertTo-Csv -NoTypeInformation | Out-String
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$tempCsvPath = [System.IO.Path]::GetTempFileName()
$csvFileName = "VMs_VEEAM_Tags_$timestamp.csv"

# Write CSV content to temp file for email attachment
[System.IO.File]::WriteAllText($tempCsvPath, $csvContent)

# 8. Disconnect from all vCenters
Write-Host "`nDisconnecting from vCenters..." -ForegroundColor Cyan
Disconnect-VIServer -Server * -Confirm:$false

# 9. Send email report with CSV attachment
if ($SendEmail) {
    Write-Host "`nSending email report..." -ForegroundColor Cyan

    $reportTime = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
    
    $emailBody = @"
Report Title: vCenter VEEAM Tags Report

Report Description:
This report provides an overview of all virtual machines across connected vCenter servers and their associated VEEAM backup tags.

Report Time: $reportTime
vCenter Servers: $($connectedServers.Name -join ', ')

Summary:
- Total VMs: $totalCount
- VMs with VEEAM tags: $taggedCount
- VMs without VEEAM tags: $($totalCount - $taggedCount)

Full details are available in the attached CSV file.
"@

    try {
        $mailParams = @{
            SmtpServer = $SMTPServer
            Port = $SMTPPort
            From = $EmailFrom
            To = $EmailTo
            Subject = $EmailSubject
            Body = $emailBody
            Attachments = $tempCsvPath
        }
        
        if ($UseSSL) {
            $mailParams.UseSsl = $true
        }
        
        if ($SMTPCredentials -ne $null) {
            $mailParams.Credential = $SMTPCredentials
        }
        
        Send-MailMessage @mailParams
        Write-Host "✅ Email sent successfully to $EmailTo" -ForegroundColor Green
        
        # Clean up temp file
        Remove-Item -Path $tempCsvPath -Force
    }
    catch {
        Write-Host "❌ Failed to send email: $_" -ForegroundColor Red
        # Clean up temp file even on error
        if (Test-Path $tempCsvPath) {
            Remove-Item -Path $tempCsvPath -Force
        }
    }
} else {
    Write-Host "`nEmail sending is disabled" -ForegroundColor Yellow
    # Clean up temp file if email is disabled
    Remove-Item -Path $tempCsvPath -Force
}
