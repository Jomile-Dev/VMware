# List all deployments with Cloud.vSphere.Machine resources and their properties

$vraServer = "vra.yourdomain.com"

# Disable SSL validation
if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
    Add-Type @"
    using System.Net;
    using System.Security.Cryptography.X509Certificates;
    public class TrustAllCertsPolicy : ICertificatePolicy {
        public bool CheckValidationResult(
            ServicePoint svcPoint, X509Certificate certificate,
            WebRequest request, int certificateProblem) {
            return true;
        }
    }
"@
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
}
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# Authenticate
$credential = Get-Credential -Message "Enter VMware Aria Automation credentials"
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

$uri = "https://$vraServer/csp/gateway/am/api/login"
$body = @{
    username = $username
    password = $password
} | ConvertTo-Json

$authHeaders = @{
    "Content-Type" = "application/json"
    "Accept" = "application/json"
}

$response = Invoke-RestMethod -Uri $uri -Method Post -Headers $authHeaders -Body $body
$token = $response.cspAuthToken
Write-Host "Authenticated`n" -ForegroundColor Green

$headers = @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
}

# Get all deployments with pagination - NOW WITH EXPAND PARAMETER
$uri = "https://$vraServer/deployment/api/deployments"
$allDeployments = @()
$page = 0
$size = 100

do {
    # MODIFIED: Added expand=resources to include resource details
    $pagedUri = "$uri`?page=$page&size=$size&expand=resources"
    Write-Host "Fetching page $($page + 1)..." -ForegroundColor Gray
    
    $response = Invoke-RestMethod -Uri $pagedUri -Method Get -Headers $headers
    $deployments = if ($response.content) { $response.content } else { $response }
    
    $allDeployments += $deployments
    $page++
    
    # Check if there are more pages
    $hasMore = $false
    if ($response.totalPages) {
        $hasMore = $page -lt $response.totalPages
    }
    elseif ($response.totalElements) {
        $hasMore = $allDeployments.Count -lt $response.totalElements
    }
    else {
        $hasMore = $deployments.Count -eq $size
    }
    
} while ($hasMore)

Write-Host "`nTotal deployments retrieved: $($allDeployments.Count)`n" -ForegroundColor Cyan

# DETAILED DIAGNOSTIC: Show structure of first deployment with FULL JSON
Write-Host "============================================" -ForegroundColor Magenta
Write-Host "=== DETAILED FIRST DEPLOYMENT ANALYSIS ===" -ForegroundColor Magenta
Write-Host "============================================`n" -ForegroundColor Magenta

if ($allDeployments.Count -gt 0) {
    $firstDep = $allDeployments[0]
    
    Write-Host "Deployment Name: $($firstDep.name)" -ForegroundColor Yellow
    Write-Host "Deployment ID: $($firstDep.id)" -ForegroundColor Gray
    Write-Host "`nAll Properties Available:" -ForegroundColor Cyan
    
    $firstDep.PSObject.Properties | ForEach-Object {
        $propName = $_.Name
        $propValue = $_.Value
        
        Write-Host "  Property: $propName" -ForegroundColor White
        
        if ($propValue -eq $null) {
            Write-Host "    Value: NULL" -ForegroundColor Red
        }
        elseif ($propValue -is [System.Collections.IEnumerable] -and $propValue -isnot [string]) {
            $count = @($propValue).Count
            Write-Host "    Type: Array/Collection" -ForegroundColor Yellow
            Write-Host "    Count: $count items" -ForegroundColor Yellow
            
            if ($count -gt 0) {
                Write-Host "    First item preview:" -ForegroundColor Gray
                @($propValue)[0] | ConvertTo-Json -Depth 3 | ForEach-Object {
                    $_ -split "`n" | Select-Object -First 20 | ForEach-Object {
                        Write-Host "      $_" -ForegroundColor DarkGray
                    }
                }
            }
        }
        elseif ($propValue -is [PSCustomObject]) {
            Write-Host "    Type: Object" -ForegroundColor Yellow
            Write-Host "    Object properties:" -ForegroundColor Gray
            $propValue.PSObject.Properties | ForEach-Object {
                Write-Host "      - $($_.Name): $($_.Value)" -ForegroundColor DarkGray
            }
        }
        else {
            $displayValue = if ($propValue.ToString().Length -gt 100) {
                $propValue.ToString().Substring(0, 100) + "..."
            } else {
                $propValue.ToString()
            }
            Write-Host "    Value: $displayValue" -ForegroundColor Gray
        }
        Write-Host ""
    }
    
    Write-Host "`n--- FULL JSON OF FIRST DEPLOYMENT ---" -ForegroundColor Magenta
    $firstDep | ConvertTo-Json -Depth 5
    Write-Host "`n"
    
    # Check for resources in first deployment
    if ($firstDep.resources) {
        Write-Host "RESOURCES FOUND IN FIRST DEPLOYMENT: $($firstDep.resources.Count)" -ForegroundColor Green
        Write-Host "`nDetailed Resource Breakdown:" -ForegroundColor Cyan
        
        $firstDep.resources | ForEach-Object {
            Write-Host "`n  Resource:" -ForegroundColor Yellow
            Write-Host "    Type: $($_.type)" -ForegroundColor White
            Write-Host "    Name: $($_.name)" -ForegroundColor White
            Write-Host "    ID: $($_.id)" -ForegroundColor Gray
            
            if ($_.properties) {
                Write-Host "    Properties ($($_.properties.PSObject.Properties.Count) total):" -ForegroundColor Cyan
                $_.properties.PSObject.Properties | ForEach-Object {
                    $value = if ($_.Value -is [string] -and $_.Value.Length -gt 80) {
                        $_.Value.Substring(0, 80) + "..."
                    } else {
                        $_.Value
                    }
                    Write-Host "      - $($_.Name): $value" -ForegroundColor Gray
                }
            } else {
                Write-Host "    Properties: NONE" -ForegroundColor Red
            }
        }
    } else {
        Write-Host "WARNING: No 'resources' property in first deployment!" -ForegroundColor Red
        Write-Host "`nAttempting to fetch resources via separate API call..." -ForegroundColor Yellow
        
        try {
            $resourceUri = "https://$vraServer/deployment/api/deployments/$($firstDep.id)/resources"
            $separateResources = Invoke-RestMethod -Uri $resourceUri -Method Get -Headers $headers
            $resList = if ($separateResources.content) { $separateResources.content } else { $separateResources }
            
            Write-Host "SUCCESS! Found $($resList.Count) resources via separate API call" -ForegroundColor Green
            Write-Host "`nFull JSON of resources:" -ForegroundColor Magenta
            $resList | ConvertTo-Json -Depth 5
        } catch {
            Write-Host "FAILED to fetch resources separately: $_" -ForegroundColor Red
        }
    }
}

Write-Host "`n`n============================================" -ForegroundColor Magenta
Write-Host "=== TOP 150 DEPLOYMENTS SUMMARY ===" -ForegroundColor Magenta
Write-Host "============================================`n" -ForegroundColor Magenta

$top150 = $allDeployments | Select-Object -First 150

foreach ($i in 0..([Math]::Min(149, $top150.Count - 1))) {
    $dep = $top150[$i]
    $num = $i + 1
    
    Write-Host "[$num] Deployment: $($dep.name)" -ForegroundColor Yellow
    Write-Host "    ID: $($dep.id)" -ForegroundColor Gray
    Write-Host "    Status: $($dep.status)" -ForegroundColor $(if ($dep.status -eq "CREATE_SUCCESSFUL") { "Green" } else { "Yellow" })
    
    if ($dep.projectId) {
        Write-Host "    Project ID: $($dep.projectId)" -ForegroundColor Gray
    }
    
    if ($dep.createdAt) {
        Write-Host "    Created: $($dep.createdAt)" -ForegroundColor Gray
    }
    
    if ($dep.createdBy) {
        Write-Host "    Created By: $($dep.createdBy)" -ForegroundColor Gray
    }
    
    # Resource information
    if ($dep.resources) {
        $resourceCount = $dep.resources.Count
        Write-Host "    Resources: $resourceCount" -ForegroundColor Cyan
        
        $resourcesByType = $dep.resources | Group-Object -Property type
        foreach ($group in $resourcesByType) {
            Write-Host "      - $($group.Name): $($group.Count)" -ForegroundColor White
        }
        
        # Show first resource in detail
        if ($resourceCount -gt 0) {
            $firstResource = $dep.resources[0]
            Write-Host "`n      First Resource Details:" -ForegroundColor Cyan
            Write-Host "        Type: $($firstResource.type)" -ForegroundColor White
            Write-Host "        Name: $($firstResource.name)" -ForegroundColor White
            
            if ($firstResource.properties) {
                Write-Host "        Properties (first 15):" -ForegroundColor Yellow
                $firstResource.properties.PSObject.Properties | Select-Object -First 15 | ForEach-Object {
                    $value = if ($_.Value -is [string] -and $_.Value.Length -gt 60) {
                        $_.Value.Substring(0, 60) + "..."
                    } else {
                        $_.Value
                    }
                    Write-Host "          - $($_.Name): $value" -ForegroundColor Gray
                }
                
                $totalProps = ($firstResource.properties.PSObject.Properties | Measure-Object).Count
                if ($totalProps -gt 15) {
                    Write-Host "          ... and $($totalProps - 15) more properties" -ForegroundColor DarkGray
                }
            }
        }
    } else {
        Write-Host "    Resources: NONE or not loaded" -ForegroundColor Red
        
        # Try to fetch resources for this deployment
        Write-Host "    Attempting to fetch resources..." -ForegroundColor Yellow
        try {
            $resourceUri = "https://$vraServer/deployment/api/deployments/$($dep.id)/resources"
            $separateResources = Invoke-RestMethod -Uri $resourceUri -Method Get -Headers $headers
            $resList = if ($separateResources.content) { $separateResources.content } else { $separateResources }
            
            if ($resList.Count -gt 0) {
                Write-Host "    Found $($resList.Count) resources!" -ForegroundColor Green
                
                $resourcesByType = $resList | Group-Object -Property type
                foreach ($group in $resourcesByType) {
                    Write-Host "      - $($group.Name): $($group.Count)" -ForegroundColor White
                }
            }
        } catch {
            Write-Host "    Could not fetch: $($_.Exception.Message)" -ForegroundColor Red
        }
    }
    
    Write-Host ""
}

# Summary statistics
Write-Host "`n============================================" -ForegroundColor Magenta
Write-Host "=== OVERALL STATISTICS ===" -ForegroundColor Magenta
Write-Host "============================================`n" -ForegroundColor Magenta

Write-Host "Total Deployments: $($allDeployments.Count)" -ForegroundColor Cyan
$deploymentsWithResources = $allDeployments | Where-Object { $_.resources -and $_.resources.Count -gt 0 }
Write-Host "Deployments with Resources: $($deploymentsWithResources.Count)" -ForegroundColor Cyan
Write-Host "Deployments without Resources: $($allDeployments.Count - $deploymentsWithResources.Count)" -ForegroundColor Yellow

if ($deploymentsWithResources.Count -gt 0) {
    Write-Host "`nResource Type Summary:" -ForegroundColor Cyan
    $allResourceTypes = $deploymentsWithResources | ForEach-Object { $_.resources } | Group-Object -Property type | Sort-Object Count -Descending
    
    foreach ($type in $allResourceTypes) {
        Write-Host "  $($type.Name): $($type.Count) instances" -ForegroundColor White
    }
    
    # Count Cloud.vSphere.Machine specifically
    $vsphereMachineCount = ($allResourceTypes | Where-Object { $_.Name -eq "Cloud.vSphere.Machine" }).Count
    if ($vsphereMachineCount -gt 0) {
        Write-Host "`nCloud.vSphere.Machine Resources: $vsphereMachineCount" -ForegroundColor Green
    } else {
        Write-Host "`nCloud.vSphere.Machine Resources: 0" -ForegroundColor Red
    }
}

Write-Host "`n============================================" -ForegroundColor Magenta
