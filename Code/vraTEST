# List all deployments with Cloud.vSphere.Machine resources and their properties

$vraServer = "vra.yourdomain.com"

# Disable SSL validation
if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
    Add-Type @"
    using System.Net;
    using System.Security.Cryptography.X509Certificates;
    public class TrustAllCertsPolicy : ICertificatePolicy {
        public bool CheckValidationResult(
            ServicePoint svcPoint, X509Certificate certificate,
            WebRequest request, int certificateProblem) {
            return true;
        }
    }
"@
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
}
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# Authenticate
$credential = Get-Credential -Message "Enter VMware Aria Automation credentials"
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

$uri = "https://$vraServer/csp/gateway/am/api/login"
$body = @{
    username = $username
    password = $password
} | ConvertTo-Json

$authHeaders = @{
    "Content-Type" = "application/json"
    "Accept" = "application/json"
}

$response = Invoke-RestMethod -Uri $uri -Method Post -Headers $authHeaders -Body $body
$token = $response.cspAuthToken
Write-Host "Authenticated`n" -ForegroundColor Green

$headers = @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
}

# Get all deployments with pagination
$uri = "https://$vraServer/deployment/api/deployments"
$allDeployments = @()
$page = 0
$size = 100

Write-Host "Fetching all deployments..." -ForegroundColor Cyan

do {
    $pagedUri = "$uri`?page=$page&size=$size&expand=resources"
    Write-Host "  Fetching page $($page + 1)..." -ForegroundColor Gray
    
    $response = Invoke-RestMethod -Uri $pagedUri -Method Get -Headers $headers
    $deployments = if ($response.content) { $response.content } else { $response }
    
    $allDeployments += $deployments
    $page++
    
    # Check if there are more pages
    $hasMore = $false
    if ($response.totalPages) {
        $hasMore = $page -lt $response.totalPages
    }
    elseif ($response.totalElements) {
        $hasMore = $allDeployments.Count -lt $response.totalElements
    }
    else {
        $hasMore = $deployments.Count -eq $size
    }
    
} while ($hasMore)

Write-Host "`nTotal deployments retrieved: $($allDeployments.Count)`n" -ForegroundColor Cyan

# Filter deployments that have Cloud.vSphere.Machine resources
Write-Host "Filtering for Cloud.vSphere.Machine resources..." -ForegroundColor Cyan

$vSphereDeployments = @()

foreach ($dep in $allDeployments) {
    $hasVSphereMachine = $false
    $vSphereMachines = @()
    
    # Check if resources exist in the deployment object
    if ($dep.resources -and $dep.resources.Count -gt 0) {
        # Filter specifically for Cloud.vSphere.Machine type
        $vSphereMachines = @($dep.resources | Where-Object { 
            $_.type -eq "Cloud.vSphere.Machine" 
        })
        
        if ($vSphereMachines.Count -gt 0) {
            $hasVSphereMachine = $true
            Write-Host "  Found $($vSphereMachines.Count) Cloud.vSphere.Machine in deployment: $($dep.name)" -ForegroundColor Green
        }
    }
    
    # If not found, try fetching resources separately
    if (-not $hasVSphereMachine) {
        try {
            $resourceUri = "https://$vraServer/deployment/api/deployments/$($dep.id)/resources"
            $separateResources = Invoke-RestMethod -Uri $resourceUri -Method Get -Headers $headers
            $resList = if ($separateResources.content) { $separateResources.content } else { $separateResources }
            
            # Explicitly filter for Cloud.vSphere.Machine
            $vSphereMachines = @($resList | Where-Object { 
                $_.type -eq "Cloud.vSphere.Machine" 
            })
            
            if ($vSphereMachines.Count -gt 0) {
                $hasVSphereMachine = $true
                Write-Host "  Found $($vSphereMachines.Count) Cloud.vSphere.Machine via separate call: $($dep.name)" -ForegroundColor Green
                # Add resources to deployment object for consistent handling
                $dep | Add-Member -MemberType NoteProperty -Name "resources" -Value $resList -Force
            }
        } catch {
            # Silently continue if we can't fetch resources
        }
    }
    
    # Only add to results if we found Cloud.vSphere.Machine resources
    if ($hasVSphereMachine -and $vSphereMachines.Count -gt 0) {
        $vSphereDeployments += [PSCustomObject]@{
            Deployment = $dep
            vSphereMachines = $vSphereMachines
        }
    }
}

Write-Host "Found $($vSphereDeployments.Count) deployments with Cloud.vSphere.Machine resources`n" -ForegroundColor Green

if ($vSphereDeployments.Count -eq 0) {
    Write-Host "No Cloud.vSphere.Machine resources found in any deployment!" -ForegroundColor Red
    Write-Host "`nShowing first 5 deployments with their resource types for reference:" -ForegroundColor Yellow
    
    foreach ($dep in $allDeployments | Select-Object -First 5) {
        Write-Host "`nDeployment: $($dep.name)" -ForegroundColor Cyan
        if ($dep.resources) {
            $types = $dep.resources | Select-Object -ExpandProperty type -Unique
            Write-Host "  Resource Types: $($types -join ', ')" -ForegroundColor Gray
        } else {
            Write-Host "  No resources property" -ForegroundColor Red
        }
    }
    
    exit
}

# Display detailed information for each deployment with Cloud.vSphere.Machine
Write-Host "============================================" -ForegroundColor Magenta
Write-Host "=== DEPLOYMENTS WITH Cloud.vSphere.Machine ===" -ForegroundColor Magenta
Write-Host "============================================`n" -ForegroundColor Magenta

$count = 0
foreach ($item in $vSphereDeployments) {
    $count++
    $dep = $item.Deployment
    $machines = $item.vSphereMachines
    
    Write-Host "[$count] DEPLOYMENT: $($dep.name)" -ForegroundColor Yellow
    Write-Host "    Deployment ID: $($dep.id)" -ForegroundColor Gray
    Write-Host "    Status: $($dep.status)" -ForegroundColor $(if ($dep.status -eq "CREATE_SUCCESSFUL") { "Green" } else { "Yellow" })
    
    if ($dep.projectId) {
        Write-Host "    Project ID: $($dep.projectId)" -ForegroundColor Gray
    }
    
    if ($dep.createdAt) {
        Write-Host "    Created: $($dep.createdAt)" -ForegroundColor Gray
    }
    
    if ($dep.createdBy) {
        Write-Host "    Created By: $($dep.createdBy)" -ForegroundColor Gray
    }
    
    Write-Host "    Cloud.vSphere.Machine Count: $($machines.Count)" -ForegroundColor Cyan
    Write-Host ""
    
    # Display each vSphere Machine in detail
    $machineNum = 0
    foreach ($machine in $machines) {
        $machineNum++
        
        Write-Host "    [$machineNum] vSphere Machine Resource" -ForegroundColor Cyan
        Write-Host "        Resource Name: $($machine.name)" -ForegroundColor White
        Write-Host "        Resource ID: $($machine.id)" -ForegroundColor Gray
        
        if ($machine.properties) {
            Write-Host ""
            Write-Host "        === ALL PROPERTIES ===" -ForegroundColor Yellow
            
            $sortedProps = $machine.properties.PSObject.Properties | Sort-Object Name
            
            foreach ($prop in $sortedProps) {
                $propName = $prop.Name
                $propValue = $prop.Value
                
                # Handle different value types
                if ($propValue -eq $null) {
                    Write-Host "        $propName : NULL" -ForegroundColor DarkGray
                }
                elseif ($propValue -is [System.Collections.IEnumerable] -and $propValue -isnot [string]) {
                    $count = @($propValue).Count
                    Write-Host "        $propName : [Array with $count items]" -ForegroundColor Gray
                    
                    # Show array items
                    $itemNum = 0
                    foreach ($item in $propValue) {
                        if ($itemNum -lt 5) { # Show first 5 items
                            if ($item -is [PSCustomObject]) {
                                Write-Host "          [$itemNum] Object:" -ForegroundColor DarkGray
                                $item.PSObject.Properties | ForEach-Object {
                                    Write-Host "            - $($_.Name): $($_.Value)" -ForegroundColor DarkGray
                                }
                            } else {
                                Write-Host "          [$itemNum] $item" -ForegroundColor DarkGray
                            }
                        }
                        $itemNum++
                    }
                    if ($count -gt 5) {
                        Write-Host "          ... and $($count - 5) more items" -ForegroundColor DarkGray
                    }
                }
                elseif ($propValue -is [PSCustomObject]) {
                    Write-Host "        $propName : [Object]" -ForegroundColor Gray
                    $propValue.PSObject.Properties | ForEach-Object {
                        Write-Host "          - $($_.Name): $($_.Value)" -ForegroundColor DarkGray
                    }
                }
                else {
                    # Regular value
                    $displayValue = $propValue.ToString()
                    if ($displayValue.Length -gt 100) {
                        $displayValue = $displayValue.Substring(0, 100) + "..."
                    }
                    Write-Host "        $propName : $displayValue" -ForegroundColor Gray
                }
            }
            
            Write-Host ""
            Write-Host "        Total Properties: $($sortedProps.Count)" -ForegroundColor Cyan
        }
        else {
            Write-Host "        NO PROPERTIES FOUND" -ForegroundColor Red
        }
        
        Write-Host ""
        Write-Host "        --- FULL JSON ---" -ForegroundColor Magenta
        $machine | ConvertTo-Json -Depth 5
        Write-Host ""
    }
    
    Write-Host "----------------------------------------`n" -ForegroundColor DarkGray
}

# Summary
Write-Host "`n============================================" -ForegroundColor Magenta
Write-Host "=== SUMMARY ===" -ForegroundColor Magenta
Write-Host "============================================" -ForegroundColor Magenta

Write-Host "Total Deployments Scanned: $($allDeployments.Count)" -ForegroundColor Cyan
Write-Host "Deployments with Cloud.vSphere.Machine: $($vSphereDeployments.Count)" -ForegroundColor Green

$totalVSphereMachines = ($vSphereDeployments | ForEach-Object { $_.vSphereMachines.Count } | Measure-Object -Sum).Sum
Write-Host "Total Cloud.vSphere.Machine Resources: $totalVSphereMachines" -ForegroundColor Green

# Property analysis across all vSphere machines
Write-Host "`n--- Property Analysis Across All vSphere Machines ---" -ForegroundColor Yellow

$allProperties = @{}
foreach ($item in $vSphereDeployments) {
    foreach ($machine in $item.vSphereMachines) {
        if ($machine.properties) {
            $machine.properties.PSObject.Properties | ForEach-Object {
                $propName = $_.Name
                if (-not $allProperties.ContainsKey($propName)) {
                    $allProperties[$propName] = 0
                }
                $allProperties[$propName]++
            }
        }
    }
}

Write-Host "`nCommon Properties (found in vSphere machines):" -ForegroundColor Cyan
$allProperties.GetEnumerator() | Sort-Object Value -Descending | ForEach-Object {
    Write-Host "  $($_.Key): found in $($_.Value) machines" -ForegroundColor Gray
}

Write-Host "`n============================================" -ForegroundColor Magenta
