# Requires: VMware.PowerCLI

# 1. Ask for credentials
$cred = Get-Credential -Message "Enter vCenter credentials"

# 2. Connect to multiple vCenters
$vcenters = @("vcsa1.example.local", "vcsa2.example.local")
foreach ($vc in $vcenters) {
    Connect-VIServer -Server $vc -Credential $cred -WarningAction SilentlyContinue
}

# 3. Ensure category exists
$categoryName = "General"
if (-not (Get-TagCategory -Name $categoryName -ErrorAction SilentlyContinue)) {
    Write-Host "Creating category '$categoryName'..."
    New-TagCategory -Name $categoryName -Cardinality Multiple -EntityType VirtualMachine
}

# 4. Import CSV
$vmList = Import-Csv -Path ".\vm_tags.csv"

# 5. Process each VM
foreach ($row in $vmList) {
    $vmName = $row.VMName.Trim()
    $tagList = $row.Tags -split "," | ForEach-Object { $_.Trim() }

    $vm = Get-VM -Name $vmName -ErrorAction SilentlyContinue
    if (-not $vm) {
        Write-Warning "‚ùå VM '$vmName' not found. Skipping..."
        continue
    }
    Write-Host "‚úÖ Found VM: $vmName"

    foreach ($tagName in $tagList) {
        if (-not $tagName) { continue }

        $tag = Get-Tag -Name $tagName -ErrorAction SilentlyContinue
        if (-not $tag) {
            Write-Host "üÜï Creating tag '$tagName'..."
            $tag = New-Tag -Name $tagName -Category $categoryName
        }

        Write-Host "üè∑Ô∏è Assigning '$tagName' to '$vmName'..."
        New-TagAssignment -Entity $vm -Tag $tag -ErrorAction SilentlyContinue | Out-Null
    }
}

Write-Host "‚úÖ All done!"
