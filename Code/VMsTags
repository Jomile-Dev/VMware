# Requires: VMware.PowerCLI
# Run in PowerShell 7+ or Windows PowerShell with PowerCLI installed

# 1. Ask for user credentials once
$cred = Get-Credential -Message "Enter vCenter credentials"

# 2. List all vCenters you want to connect to
$vcenters = @(
    "vcsa1.example.local",
    "vcsa2.example.local",
    "vcsa3.example.local"
)

# 3. Connect to each vCenter
foreach ($vc in $vcenters) {
    Write-Host "Connecting to $vc..."
    Connect-VIServer -Server $vc -Credential $cred -WarningAction SilentlyContinue
}

# 4. Collect all VMs and their tags
$results = @()

foreach ($vm in Get-VM) {
    $tags = (Get-TagAssignment -Entity $vm | Select-Object -ExpandProperty Tag).Name -join ", "

    $results += [PSCustomObject]@{
        VMName     = $vm.Name
        PowerState = $vm.PowerState
        vCenter    = $vm.VMHost.Parent.Name
        Tags       = $tags
    }
}

# 5. Display results
$results | Format-Table -AutoSize

# 6. (Optional) Export to CSV
$results | Export-Csv -Path ".\VMs_With_Tags.csv" -NoTypeInformation
Write-Host "Exported VM list to VMs_With_Tags.csv"
