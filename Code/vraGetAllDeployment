# VMware Aria Automation - Export Deployments with vSphere Machines (FAST)
# Exports only deployments that contain Cloud.vSphere.Machine resources

$vraServer = "vra.yourdomain.com"
$outputPath = "C:\Logs\vRA_Deployments_Export_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"

# Disable SSL validation
if (-not ([System.Management.Automation.PSTypeName]'TrustAllCertsPolicy').Type) {
    Add-Type @"
    using System.Net;
    using System.Security.Cryptography.X509Certificates;
    public class TrustAllCertsPolicy : ICertificatePolicy {
        public bool CheckValidationResult(
            ServicePoint svcPoint, X509Certificate certificate,
            WebRequest request, int certificateProblem) {
            return true;
        }
    }
"@
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
}
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

# Authenticate
Write-Host "Authenticating..." -ForegroundColor Cyan
$credential = Get-Credential -Message "Enter VMware Aria Automation credentials"
$username = $credential.UserName
$password = $credential.GetNetworkCredential().Password

$uri = "https://$vraServer/csp/gateway/am/api/login"
$body = @{
    username = $username
    password = $password
} | ConvertTo-Json

$authHeaders = @{
    "Content-Type" = "application/json"
    "Accept" = "application/json"
}

$response = Invoke-RestMethod -Uri $uri -Method Post -Headers $authHeaders -Body $body
$token = $response.cspAuthToken
Write-Host "Authenticated!`n" -ForegroundColor Green

$headers = @{
    "Authorization" = "Bearer $token"
    "Content-Type" = "application/json"
}

# Fetch and process deployments in parallel
Write-Host "Fetching deployments (fast mode)..." -ForegroundColor Cyan
$uri = "https://$vraServer/deployment/api/deployments"
$exportData = [System.Collections.ArrayList]::new()
$page = 0
$size = 1000
$totalProcessed = 0
$foundCount = 0

do {
    $pagedUri = "$uri`?page=$page&size=$size&expand=resources"
    
    $response = Invoke-RestMethod -Uri $pagedUri -Method Get -Headers $headers
    $deployments = if ($response.content) { $response.content } else { $response }
    
    # Filter for Cloud.vSphere.Machine in parallel
    $deploymentsWithVMs = $deployments | Where-Object {
        $_.resources -and ($_.resources | Where-Object { $_.type -eq "Cloud.vSphere.Machine" })
    }
    
    # Process found deployments
    foreach ($dep in $deploymentsWithVMs) {
        $foundCount++
        $vSphereMachines = @($dep.resources | Where-Object { $_.type -eq "Cloud.vSphere.Machine" })
        
        foreach ($machine in $vSphereMachines) {
            $hostname = if ($machine.properties.hostname) { 
                $machine.properties.hostname 
            } elseif ($machine.properties.resourceName) {
                $machine.properties.resourceName
            } elseif ($machine.name) {
                $machine.name
            } else {
                "N/A"
            }
            
            [void]$exportData.Add([PSCustomObject]@{
                DeploymentName = $dep.name
                DeploymentID = $dep.id
                ServerName = $hostname
                ResourceName = $machine.name
                Status = $dep.status
                CreatedBy = $dep.createdBy
                CreatedAt = $dep.createdAt
                ProjectID = $dep.projectId
            })
        }
    }
    
    $totalProcessed += $deployments.Count
    $page++
    
    Write-Host "  Page $page - Processed: $totalProcessed | Found: $foundCount" -ForegroundColor Gray
    
    $hasMore = if ($response.totalPages) { 
        $page -lt $response.totalPages 
    } elseif ($response.totalElements) { 
        $totalProcessed -lt $response.totalElements 
    } else { 
        $deployments.Count -eq $size 
    }
    
} while ($hasMore)

Write-Host "`nScanned: $totalProcessed deployments" -ForegroundColor Cyan
Write-Host "Found: $foundCount with vSphere machines" -ForegroundColor Green
Write-Host "Exporting: $($exportData.Count) server records`n" -ForegroundColor Green

# Export
$exportData | Export-Csv -Path $outputPath -NoTypeInformation
Write-Host "Exported to: $outputPath" -ForegroundColor White
