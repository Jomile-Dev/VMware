#Requires -Modules VMware.VimAutomation.Core

# ============================================================================
# CONFIGURATION
# ============================================================================

$vCenters = @(
    "vcenter1.domain.com",
    "vcenter2.domain.com",
    "vcenter3.domain.com"
)

$vraServer = "vra.domain.com"

$smtpServer = "smtp.domain.com"
$smtpPort = 25
$emailFrom = "snapshots@domain.com"
$emailTo = @("admin@domain.com")
$emailSubject = "vCenter Snapshot Report - $(Get-Date -Format 'yyyy-MM-dd')"

# ============================================================================
# FUNCTIONS
# ============================================================================

function Get-vRAAccessToken {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [System.Management.Automation.PSCredential]$Credential,
        
        [Parameter(Mandatory = $true)]
        [string]$Server
    )
    
    $uri = "https://$Server/csp/gateway/am/api/login?access_token"
    $body = @{
        username = $Credential.UserName
        password = $Credential.GetNetworkCredential().Password
    } | ConvertTo-Json
    
    try {
        $response = Invoke-RestMethod -Uri $uri -Method Post -Body $body -ContentType "application/json" -ErrorAction Stop
        return $response.refresh_token
    }
    catch {
        Write-Warning "Failed to get vRA refresh token: $_"
        return $null
    }
}

function Get-vRABearerToken {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [string]$RefreshToken,
        
        [Parameter(Mandatory = $true)]
        [string]$Server
    )
    
    $uri = "https://$Server/iaas/api/login"
    $body = @{ refreshToken = $RefreshToken } | ConvertTo-Json
    
    try {
        $response = Invoke-RestMethod -Uri $uri -Method Post -Body $body -ContentType "application/json" -ErrorAction Stop
        return $response.token
    }
    catch {
        Write-Warning "Failed to get vRA bearer token: $_"
        return $null
    }
}

function Get-vRACloudMachineByName {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [string]$VMName,
        
        [Parameter(Mandatory = $true)]
        [string]$Server,
        
        [Parameter(Mandatory = $true)]
        [string]$AccessToken
    )
    
    $headers = @{
        "Authorization" = "Bearer $AccessToken"
        "Content-Type"  = "application/json"
    }
    
    $uri = "https://$Server/iaas/api/machines?`$filter=name eq '$VMName'"
    
    try {
        $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $headers -ErrorAction Stop
        if ($response.content -and $response.content.Count -gt 0) {
            return $response.content[0]
        }
        return $null
    }
    catch {
        Write-Warning "Failed to get vRA machine for $VMName : $_"
        return $null
    }
}

function Get-vRADeploymentEvents {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [string]$DeploymentId,
        
        [Parameter(Mandatory = $true)]
        [string]$Server,
        
        [Parameter(Mandatory = $true)]
        [string]$AccessToken
    )
    
    $headers = @{
        "Authorization" = "Bearer $AccessToken"
        "Content-Type"  = "application/json"
    }
    
    $uri = "https://$Server/deployment/api/deployments/$DeploymentId/events"
    
    try {
        $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $headers -ErrorAction Stop
        return $response.content
    }
    catch {
        Write-Warning "Failed to get deployment events for $DeploymentId : $_"
        return $null
    }
}

function Get-SnapshotUserFromvRA {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [string]$VMName,
        
        [Parameter(Mandatory = $true)]
        [string]$SnapshotCreated,
        
        [Parameter(Mandatory = $true)]
        [string]$SnapshotName,
        
        [Parameter(Mandatory = $false)]
        [string]$SnapshotDescription,
        
        [Parameter(Mandatory = $true)]
        [string]$Server,
        
        [Parameter(Mandatory = $true)]
        [string]$AccessToken
    )
    
    # Get the cloud machine resource
    $machine = Get-vRACloudMachineByName -VMName $VMName -Server $Server -AccessToken $AccessToken
    
    if (-not $machine -or -not $machine.deploymentId) {
        return @{
            User = "N/A"
            Date = "N/A"
        }
    }
    
    # Get deployment events
    $events = Get-vRADeploymentEvents -DeploymentId $machine.deploymentId -Server $Server -AccessToken $AccessToken
    
    if (-not $events) {
        return @{
            User = "N/A"
            Date = "N/A"
        }
    }
    
    # Find snapshot create events within 10 minutes of snapshot creation
    $snapshotDate = [DateTime]::Parse($SnapshotCreated)
    $matchingEvents = $events | Where-Object {
        $_.actionId -eq "Cloud.vSphere.Machine.Snapshot.Create" -and
        $_.updatedAt -and
        [Math]::Abs(([DateTime]::Parse($_.updatedAt) - $snapshotDate).TotalMinutes) -lt 10
    }
    
    if (-not $matchingEvents -or $matchingEvents.Count -eq 0) {
        return @{
            User = "N/A"
            Date = "N/A"
        }
    }
    
    # If multiple matches, try to narrow down by snapshot name/description
    if ($matchingEvents.Count -gt 1) {
        # Try exact match first
        $bestMatch = $matchingEvents | Where-Object {
            $_.inputs -and (
                ($_.inputs.name -eq $SnapshotName) -or
                ($SnapshotDescription -and $_.inputs.description -eq $SnapshotDescription)
            )
        } | Select-Object -First 1
        
        # If no exact match, try partial match
        if (-not $bestMatch) {
            $bestMatch = $matchingEvents | Where-Object {
                ($_.message -like "*$SnapshotName*") -or 
                ($SnapshotDescription -and $_.message -like "*$SnapshotDescription*") -or
                ($_.inputs -and (
                    ($_.inputs.name -like "*$SnapshotName*") -or
                    ($SnapshotDescription -and $_.inputs.description -like "*$SnapshotDescription*")
                ))
            } | Select-Object -First 1
        }
        
        # If still no match, use closest by time
        if ($bestMatch) {
            $matchingEvents = @($bestMatch)
        }
        else {
            $matchingEvents = $matchingEvents | 
                Sort-Object { [Math]::Abs(([DateTime]::Parse($_.updatedAt) - $snapshotDate).TotalSeconds) } | 
                Select-Object -First 1
        }
    }
    
    # Extract user information
    $event = $matchingEvents[0]
    $actualUser = $null
    
    # Check requestedBy field (primary location)
    if ($event.requestedBy) {
        $actualUser = $event.requestedBy
    }
    # Check inputs.requestedBy
    elseif ($event.inputs -and $event.inputs.requestedBy) {
        $actualUser = $event.inputs.requestedBy
    }
    # Fallback to user field
    elseif ($event.user) {
        $actualUser = $event.user
    }
    # Fallback to inputs.user
    elseif ($event.inputs -and $event.inputs.user) {
        $actualUser = $event.inputs.user
    }
    
    if ($actualUser) {
        return @{
            User = $actualUser
            Date = ([DateTime]::Parse($event.updatedAt)).ToString("yyyy-MM-dd")
        }
    }
    
    return @{
        User = "N/A"
        Date = "N/A"
    }
}

function Get-AllSnapshots {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [array]$vCenterServers,
        
        [Parameter(Mandatory = $true)]
        [System.Management.Automation.PSCredential]$Credential
    )
    
    $allSnapshots = @()
    
    foreach ($vcServer in $vCenterServers) {
        Write-Host "Processing $vcServer..." -ForegroundColor Cyan
        
        try {
            Connect-VIServer -Server $vcServer -Credential $Credential -ErrorAction Stop | Out-Null
            
            # Get all VMs with snapshots
            $vms = Get-VM | Where-Object { $_.ExtensionData.Snapshot }
            
            foreach ($vm in $vms) {
                $snapshots = Get-Snapshot -VM $vm
                
                foreach ($snap in $snapshots) {
                    $ageDays = [Math]::Round(((Get-Date) - $snap.Created).TotalDays, 2)
                    
                    # Get creator from vCenter events
                    $vcCreator = "Unknown"
                    try {
                        $events = Get-VIEvent -Entity $vm -Types Info -Start $snap.Created.AddMinutes(-1) -Finish $snap.Created.AddMinutes(1) -ErrorAction SilentlyContinue |
                            Where-Object { $_.FullFormattedMessage -match "snapshot" -or $_.GetType().Name -match "Snapshot" } |
                            Sort-Object CreatedTime -Descending |
                            Select-Object -First 1
                        
                        if ($events) {
                            $vcCreator = $events.UserName
                        }
                    }
                    catch {
                        Write-Verbose "Could not retrieve event for snapshot $($snap.Name): $_"
                    }
                    
                    $allSnapshots += [PSCustomObject]@{
                        vCenter      = $vcServer
                        VMName       = $vm.Name
                        SnapshotName = $snap.Name
                        Description  = $snap.Description
                        CreatedDate  = $snap.Created
                        CreatedBy    = $vcCreator
                        SizeGB       = [Math]::Round($snap.SizeGB, 2)
                        AgeDays      = $ageDays
                    }
                }
            }
            
            Disconnect-VIServer -Server $vcServer -Confirm:$false -ErrorAction SilentlyContinue
            Write-Host "Completed $vcServer - Total snapshots: $($allSnapshots.Count)" -ForegroundColor Green
        }
        catch {
            Write-Warning "Error processing $vcServer : $_"
        }
    }
    
    return $allSnapshots | Sort-Object AgeDays -Descending
}

function Invoke-vRAEnrichment {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [array]$Snapshots,
        
        [Parameter(Mandatory = $true)]
        [string]$Server,
        
        [Parameter(Mandatory = $true)]
        [string]$Token
    )
    
    Write-Host "`nEnriching vRA-created snapshots..." -ForegroundColor Yellow
    
    $enrichedSnapshots = @()
    $vraSnapshotCount = ($Snapshots | Where-Object { $_.CreatedBy -like "*vravc*" }).Count
    $processedCount = 0
    
    foreach ($snap in $Snapshots) {
        if ($snap.CreatedBy -like "*vravc*") {
            $processedCount++
            Write-Host "  Processing vRA snapshot $processedCount of $vraSnapshotCount for $($snap.VMName)..." -ForegroundColor Gray
            
            $vraInfo = Get-SnapshotUserFromvRA `
                -VMName $snap.VMName `
                -SnapshotCreated $snap.CreatedDate `
                -SnapshotName $snap.SnapshotName `
                -SnapshotDescription $snap.Description `
                -Server $Server `
                -AccessToken $Token
            
            if ($vraInfo.User -ne "N/A") {
                $snap.CreatedBy = $vraInfo.User
            }
            
            $snap | Add-Member -NotePropertyName "vRAUser" -NotePropertyValue $vraInfo.User -Force
            $snap | Add-Member -NotePropertyName "vRADate" -NotePropertyValue $vraInfo.Date -Force
        }
        else {
            $snap | Add-Member -NotePropertyName "vRAUser" -NotePropertyValue "N/A" -Force
            $snap | Add-Member -NotePropertyName "vRADate" -NotePropertyValue "N/A" -Force
        }
        
        $enrichedSnapshots += $snap
    }
    
    Write-Host "Enrichment complete - Processed $processedCount vRA snapshots" -ForegroundColor Green
    return $enrichedSnapshots
}

function Send-SnapshotReport {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [array]$Snapshots,
        
        [Parameter(Mandatory = $true)]
        [string]$SmtpServer,
        
        [Parameter(Mandatory = $true)]
        [int]$SmtpPort,
        
        [Parameter(Mandatory = $true)]
        [string]$From,
        
        [Parameter(Mandatory = $true)]
        [array]$To,
        
        [Parameter(Mandatory = $true)]
        [string]$Subject
    )
    
    $totalSize = [Math]::Round(($Snapshots | Measure-Object -Property SizeGB -Sum).Sum, 2)
    $oldSnapshots = ($Snapshots | Where-Object { $_.AgeDays -gt 30 }).Count
    
    $html = @"
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; }
        h2 { color: #2c3e50; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th { background-color: #3498db; color: white; padding: 12px; text-align: left; }
        td { border: 1px solid #ddd; padding: 10px; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        tr:hover { background-color: #e8f4f8; }
        .summary { background-color: #ecf0f1; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .old { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>
    <h2>vCenter Snapshot Report</h2>
    <div class="summary">
        <strong>Report Generated:</strong> $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')<br>
        <strong>Total Snapshots:</strong> $($Snapshots.Count)<br>
        <strong>Total Size:</strong> $totalSize GB<br>
        <strong>Snapshots > 30 days:</strong> $oldSnapshots
    </div>
    <table>
        <tr>
            <th>vCenter</th>
            <th>VM Name</th>
            <th>Snapshot Name</th>
            <th>Description</th>
            <th>Created Date</th>
            <th>Created By</th>
            <th>Size (GB)</th>
            <th>Age (Days)</th>
        </tr>
"@
    
    foreach ($snap in $Snapshots) {
        $ageClass = if ($snap.AgeDays -gt 30) { " class='old'" } else { "" }
        $createdBy = if ($snap.vRAUser -ne "N/A") { "$($snap.CreatedBy) (vRA: $($snap.vRADate))" } else { $snap.CreatedBy }
        
        $html += @"
        <tr>
            <td>$($snap.vCenter)</td>
            <td>$($snap.VMName)</td>
            <td>$($snap.SnapshotName)</td>
            <td>$($snap.Description)</td>
            <td>$($snap.CreatedDate.ToString('yyyy-MM-dd HH:mm'))</td>
            <td>$createdBy</td>
            <td>$($snap.SizeGB)</td>
            <td$ageClass>$($snap.AgeDays)</td>
        </tr>
"@
    }
    
    $html += @"
    </table>
</body>
</html>
"@
    
    try {
        Send-MailMessage `
            -To $To `
            -From $From `
            -Subject $Subject `
            -Body $html `
            -BodyAsHtml `
            -SmtpServer $SmtpServer `
            -Port $SmtpPort `
            -ErrorAction Stop
        
        Write-Host "Email sent successfully to $($To -join ', ')" -ForegroundColor Green
    }
    catch {
        Write-Warning "Failed to send email: $_"
    }
}

# ============================================================================
# MAIN EXECUTION
# ============================================================================

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "vCenter Snapshot Report with vRA Integration" -ForegroundColor Cyan
Write-Host "========================================`n" -ForegroundColor Cyan

# Get credentials
$credential = Get-Credential -Message "Enter credentials for vCenter and vRA"

if (-not $credential) {
    Write-Error "Credentials are required to continue."
    exit 1
}

# Authenticate with vRA
Write-Host "Authenticating with vRA..." -ForegroundColor Yellow
$vraRefreshToken = Get-vRAAccessToken -Credential $credential -Server $vraServer

if ($vraRefreshToken) {
    $vraBearerToken = Get-vRABearerToken -RefreshToken $vraRefreshToken -Server $vraServer
    
    if ($vraBearerToken) {
        Write-Host "Successfully authenticated with vRA" -ForegroundColor Green
    }
    else {
        Write-Warning "Failed to get vRA bearer token. Continuing without vRA enrichment."
        $vraBearerToken = $null
    }
}
else {
    Write-Warning "Failed to authenticate with vRA. Continuing without vRA enrichment."
    $vraBearerToken = $null
}

# Collect snapshots from all vCenters
Write-Host "`nCollecting snapshots from vCenters..." -ForegroundColor Yellow
$allSnapshots = Get-AllSnapshots -vCenterServers $vCenters -Credential $credential

if ($allSnapshots.Count -eq 0) {
    Write-Host "No snapshots found." -ForegroundColor Yellow
    exit 0
}

Write-Host "`nTotal snapshots found: $($allSnapshots.Count)" -ForegroundColor Green

# Enrich with vRA data if authentication succeeded
if ($vraBearerToken) {
    $allSnapshots = Invoke-vRAEnrichment -Snapshots $allSnapshots -Server $vraServer -Token $vraBearerToken
}
else {
    # Add empty vRA fields for consistency
    $allSnapshots = $allSnapshots | ForEach-Object {
        $_ | Add-Member -NotePropertyName "vRAUser" -NotePropertyValue "N/A" -Force
        $_ | Add-Member -NotePropertyName "vRADate" -NotePropertyValue "N/A" -Force
        $_
    }
}

# Display summary
$totalSize = [Math]::Round(($allSnapshots | Measure-Object -Property SizeGB -Sum).Sum, 2)
$oldestSnapshot = [Math]::Round(($allSnapshots | Measure-Object -Property AgeDays -Maximum).Maximum, 2)

Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "SUMMARY" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Total Snapshots: $($allSnapshots.Count)"
Write-Host "Total Size: $totalSize GB"
Write-Host "Oldest Snapshot: $oldestSnapshot days"
Write-Host ""

# Display table in console
$allSnapshots | Format-Table -Property vCenter, VMName, SnapshotName, CreatedDate, CreatedBy, SizeGB, AgeDays -AutoSize

# Export to CSV
$csvPath = ".\SnapshotReport_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"
$allSnapshots | Export-Csv -Path $csvPath -NoTypeInformation
Write-Host "CSV exported to: $csvPath" -ForegroundColor Green

# Send email report
Write-Host "`nSending email report..." -ForegroundColor Yellow
Send-SnapshotReport `
    -Snapshots $allSnapshots `
    -SmtpServer $smtpServer `
    -SmtpPort $smtpPort `
    -From $emailFrom `
    -To $emailTo `
    -Subject $emailSubject

Write-Host "`nScript completed successfully!" -ForegroundColor Green
