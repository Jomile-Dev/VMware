function Get-SnapshotUserFromvRA {
    param(
        [string]$VMName,
        [string]$SnapshotCreated,
        [string]$SnapshotName,
        [string]$SnapshotDescription,
        [string]$Server,
        [string]$AccessToken
    )
    
    Write-Host "`n    === DEBUG: vRA Lookup Process ===" -ForegroundColor Cyan
    Write-Host "    VM Name: $VMName" -ForegroundColor Cyan
    Write-Host "    Snapshot Created: $SnapshotCreated" -ForegroundColor Cyan
    Write-Host "    Snapshot Name: $SnapshotName" -ForegroundColor Cyan
    Write-Host "    Snapshot Description: $SnapshotDescription" -ForegroundColor Cyan
    
    # Get the cloud machine resource
    Write-Host "`n    Step 1: Looking up machine in vRA..." -ForegroundColor Yellow
    $machine = Get-vRACloudMachineByName -VMName $VMName -Server $Server -AccessToken $AccessToken
    
    if (-not $machine) {
        Write-Host "    ✗ Machine not found in vRA" -ForegroundColor Red
        return @{
            User = "N/A"
            Date = "N/A"
        }
    }
    
    Write-Host "    ✓ Machine found in vRA" -ForegroundColor Green
    
    $deploymentId = $machine.deploymentId
    
    if (-not $deploymentId) {
        Write-Host "    ✗ No deploymentId found for machine" -ForegroundColor Red
        return @{
            User = "N/A"
            Date = "N/A"
        }
    }
    
    Write-Host "    ✓ Deployment ID: $deploymentId" -ForegroundColor Green
    
    # Get deployment events
    Write-Host "`n    Step 2: Retrieving deployment events..." -ForegroundColor Yellow
    $events = Get-vRADeploymentEvents -DeploymentId $deploymentId -Server $Server -AccessToken $AccessToken
    
    if (-not $events) {
        Write-Host "    ✗ No events found for deployment" -ForegroundColor Red
        return @{
            User = "N/A"
            Date = "N/A"
        }
    }
    
    Write-Host "    ✓ Found $($events.Count) total events" -ForegroundColor Green
    
    # Show all snapshot create events with MORE DETAIL
    Write-Host "`n    Snapshot Create Events:" -ForegroundColor Cyan
    $snapshotCreateEvents = $events | Where-Object { $_.actionId -eq "Cloud.vSphere.Machine.Snapshot.Create" }
    Write-Host "    Found $($snapshotCreateEvents.Count) snapshot create events" -ForegroundColor Yellow
    
    $snapshotCreateEvents | ForEach-Object {
        Write-Host "      - ActionId: $($_.actionId)" -ForegroundColor Gray
        Write-Host "        UpdatedAt: $($_.updatedAt)" -ForegroundColor Gray
        Write-Host "        User: $($_.user)" -ForegroundColor Gray
        Write-Host "        RequestedBy: $($_.requestedBy)" -ForegroundColor Magenta
        Write-Host "        Message: $($_.message)" -ForegroundColor Gray
        
        # Debug: Show ALL properties of the event
        Write-Host "        ALL PROPERTIES:" -ForegroundColor Yellow
        $_ | Get-Member -MemberType Properties | ForEach-Object {
            $propName = $_.Name
            $propValue = $_.$propName
            Write-Host "          $propName : $propValue" -ForegroundColor DarkGray
        }
        Write-Host "" -ForegroundColor Gray
    }
    
    # Convert snapshot created date to comparable format
    $snapshotDate = [DateTime]::Parse($SnapshotCreated)
    Write-Host "`n    Step 3: Matching snapshot event..." -ForegroundColor Yellow
    Write-Host "    Looking for events near: $snapshotDate" -ForegroundColor Yellow
    
    # Find snapshot create events around the creation time
    $matchingEvents = $events | Where-Object {
        $_.actionId -eq "Cloud.vSphere.Machine.Snapshot.Create" -and
        $_.updatedAt -and
        [Math]::Abs(([DateTime]::Parse($_.updatedAt) - $snapshotDate).TotalMinutes) -lt 10
    }
    
    Write-Host "    Found $($matchingEvents.Count) events within 10 minutes" -ForegroundColor Yellow
    
    # If we have multiple matches, try to narrow down by name/description
    if ($matchingEvents.Count -gt 1 -and ($SnapshotName -or $SnapshotDescription)) {
        Write-Host "    Multiple events found, trying to match by name/description..." -ForegroundColor Yellow
        
        $bestMatch = $matchingEvents | Where-Object {
            ($_.message -like "*$SnapshotName*") -or 
            ($_.message -like "*$SnapshotDescription*")
        } | Select-Object -First 1
        
        if ($bestMatch) {
            Write-Host "    ✓ Found match by name/description!" -ForegroundColor Green
            $matchingEvents = @($bestMatch)
        }
        else {
            Write-Host "    No name/description match, using closest by time" -ForegroundColor Yellow
            $matchingEvents = $matchingEvents | Sort-Object { [Math]::Abs(([DateTime]::Parse($_.updatedAt) - $snapshotDate).TotalSeconds) } | Select-Object -First 1
        }
    }
    
    if ($matchingEvents -and $matchingEvents.Count -gt 0) {
        $event = $matchingEvents[0]
        
        # TRY MULTIPLE FIELDS FOR USER - PRIORITIZE requestedBy
        $actualUser = $null
        
        if ($event.requestedBy -and $event.requestedBy -ne "" -and $event.requestedBy -ne $null) {
            $actualUser = $event.requestedBy
            Write-Host "`n    ✓ Match Found! (using requestedBy field)" -ForegroundColor Green
        }
        elseif ($event.user -and $event.user -ne "" -and $event.user -ne $null) {
            $actualUser = $event.user
            Write-Host "`n    ✓ Match Found! (using user field)" -ForegroundColor Green
        }
        elseif ($event.userName -and $event.userName -ne "" -and $event.userName -ne $null) {
            $actualUser = $event.userName
            Write-Host "`n    ✓ Match Found! (using userName field)" -ForegroundColor Green
        }
        elseif ($event.owner -and $event.owner -ne "" -and $event.owner -ne $null) {
            $actualUser = $event.owner
            Write-Host "`n    ✓ Match Found! (using owner field)" -ForegroundColor Green
        }
        else {
            Write-Host "`n    ✗ Match Found but NO USER FIELD available" -ForegroundColor Red
            Write-Host "    Available event properties:" -ForegroundColor Yellow
            $event | Get-Member -MemberType Properties | ForEach-Object {
                Write-Host "      - $($_.Name)" -ForegroundColor Gray
            }
        }
        
        if ($actualUser) {
            Write-Host "      User: $actualUser" -ForegroundColor Green
            Write-Host "      UpdatedAt: $($event.updatedAt)" -ForegroundColor Green
            Write-Host "      Message: $($event.message)" -ForegroundColor Green
            Write-Host "    === END DEBUG ===`n" -ForegroundColor Cyan
            
            return @{
                User = $actualUser
                Date = ([DateTime]::Parse($event.updatedAt)).ToString("yyyy-MM-dd")
            }
        }
    }
    
    Write-Host "    ✗ No matching snapshot events found or no user information available" -ForegroundColor Red
    Write-Host "    === END DEBUG ===`n" -ForegroundColor Cyan
    
    return @{
        User = "N/A"
        Date = "N/A"
    }
}
