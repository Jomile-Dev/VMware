#Requires -Modules VMware.VimAutomation.Core

# ============================================================================
# CONFIGURATION
# ============================================================================

$vCenters = @(
    "vcenter1.domain.com",
    "vcenter2.domain.com",
    "vcenter3.domain.com"
)

$vraServer = "vra.domain.com"

# Email settings
$smtpServer = "smtp.domain.com"
$smtpPort = 587
$emailFrom = "snapshots@domain.com"
$emailTo = @("admin@domain.com")
$emailSubject = "vCenter Snapshot Report - $(Get-Date -Format 'yyyy-MM-dd')"

# ============================================================================
# FUNCTIONS
# ============================================================================

function Get-vRAAccessToken {
    param(
        [Parameter(Mandatory)]
        [PSCredential]$Credential,
        [Parameter(Mandatory)]
        [string]$Server
    )
    
    $uri = "https://$Server/csp/gateway/am/api/login?access_token"
    $body = @{
        username = $Credential.UserName
        password = $Credential.GetNetworkCredential().Password
    } | ConvertTo-Json
    
    try {
        $response = Invoke-RestMethod -Uri $uri -Method Post -Body $body -ContentType "application/json" -ErrorAction Stop
        return $response.refresh_token
    }
    catch {
        Write-Warning "Failed to get vRA refresh token: $_"
        return $null
    }
}

function Get-vRABearerToken {
    param(
        [Parameter(Mandatory)]
        [string]$RefreshToken,
        [Parameter(Mandatory)]
        [string]$Server
    )
    
    $uri = "https://$Server/iaas/api/login"
    $body = @{ refreshToken = $RefreshToken } | ConvertTo-Json
    
    try {
        $response = Invoke-RestMethod -Uri $uri -Method Post -Body $body -ContentType "application/json" -ErrorAction Stop
        return $response.token
    }
    catch {
        Write-Warning "Failed to get vRA bearer token: $_"
        return $null
    }
}

function Get-vRACloudMachineByName {
    param(
        [Parameter(Mandatory)]
        [string]$VMName,
        [Parameter(Mandatory)]
        [string]$Server,
        [Parameter(Mandatory)]
        [string]$AccessToken
    )
    
    $headers = @{
        "Authorization" = "Bearer $AccessToken"
        "Content-Type"  = "application/json"
    }
    
    $uri = "https://$Server/iaas/api/machines?`$filter=name eq '$VMName'"
    
    try {
        $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $headers -ErrorAction Stop
        return $response.content[0]
    }
    catch {
        Write-Warning "Failed to get vRA machine for $VMName : $_"
        return $null
    }
}

function Get-vRADeploymentEvents {
    param(
        [Parameter(Mandatory)]
        [string]$DeploymentId,
        [Parameter(Mandatory)]
        [string]$Server,
        [Parameter(Mandatory)]
        [string]$AccessToken
    )
    
    $headers = @{
        "Authorization" = "Bearer $AccessToken"
        "Content-Type"  = "application/json"
    }
    
    $uri = "https://$Server/deployment/api/deployments/$DeploymentId/events"
    
    try {
        $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $headers -ErrorAction Stop
        return $response.content
    }
    catch {
        Write-Warning "Failed to get deployment events for $DeploymentId : $_"
        return $null
    }
}

function Get-SnapshotUserFromvRA {
    param(
        [Parameter(Mandatory)]
        [string]$VMName,
        [Parameter(Mandatory)]
        [string]$SnapshotCreated,
        [Parameter(Mandatory)]
        [string]$SnapshotName,
        [string]$SnapshotDescription,
        [Parameter(Mandatory)]
        [string]$Server,
        [Parameter(Mandatory)]
        [string]$AccessToken
    )
    
    # Get the VM from vRA
    $machine = Get-vRACloudMachineByName -VMName $VMName -Server $Server -AccessToken $AccessToken
    if (-not $machine -or -not $machine.deploymentId) {
        return @{ User = "N/A"; Date = "N/A" }
    }
    
    # Get deployment events
    $events = Get-vRADeploymentEvents -DeploymentId $machine.deploymentId -Server $Server -AccessToken $AccessToken
    if (-not $events) {
        return @{ User = "N/A"; Date = "N/A" }
    }
    
    # Find snapshot create events within 10 minutes of snapshot creation
    $snapshotDate = [DateTime]::Parse($SnapshotCreated)
    $matchingEvents = $events | Where-Object {
        $_.actionId -eq "Cloud.vSphere.Machine.Snapshot.Create" -and
        $_.updatedAt -and
        [Math]::Abs(([DateTime]::Parse($_.updatedAt) - $snapshotDate).TotalMinutes) -lt 10
    }
    
    if (-not $matchingEvents) {
        return @{ User = "N/A"; Date = "N/A" }
    }
    
    # If multiple matches found, try to match by snapshot name/description
    if ($matchingEvents.Count -gt 1) {
        # Try exact match
        $bestMatch = $matchingEvents | Where-Object {
            $_.inputs -and (
                ($_.inputs.name -eq $SnapshotName) -or
                ($SnapshotDescription -and $_.inputs.description -eq $SnapshotDescription)
            )
        } | Select-Object -First 1
        
        # Try partial match if no exact match
        if (-not $bestMatch) {
            $bestMatch = $matchingEvents | Where-Object {
                ($_.message -like "*$SnapshotName*") -or 
                ($SnapshotDescription -and $_.message -like "*$SnapshotDescription*") -or
                ($_.inputs -and (
                    ($_.inputs.name -like "*$SnapshotName*") -or
                    ($SnapshotDescription -and $_.inputs.description -like "*$SnapshotDescription*")
                ))
            } | Select-Object -First 1
        }
        
        # Use closest by time if still no match
        if ($bestMatch) {
            $matchingEvents = @($bestMatch)
        }
        else {
            $matchingEvents = $matchingEvents | 
                Sort-Object { [Math]::Abs(([DateTime]::Parse($_.updatedAt) - $snapshotDate).TotalSeconds) } | 
                Select-Object -First 1
        }
    }
    
    # Extract user from the event (check multiple possible fields)
    $event = $matchingEvents[0]
    
    # PowerShell 5.1 compatible null-coalescing
    $actualUser = $null
    if ($event.requestedBy) {
        $actualUser = $event.requestedBy
    }
    elseif ($event.inputs -and $event.inputs.requestedBy) {
        $actualUser = $event.inputs.requestedBy
    }
    elseif ($event.user) {
        $actualUser = $event.user
    }
    elseif ($event.inputs -and $event.inputs.user) {
        $actualUser = $event.inputs.user
    }
    
    if ($actualUser) {
        return @{
            User = $actualUser
            Date = ([DateTime]::Parse($event.updatedAt)).ToString("yyyy-MM-dd")
        }
    }
    
    return @{ User = "N/A"; Date = "N/A" }
}

function Get-AllSnapshots {
    param(
        [Parameter(Mandatory)]
        [array]$vCenterServers,
        [Parameter(Mandatory)]
        [PSCredential]$Credential
    )
    
    $allSnapshots = @()
    
    foreach ($vcServer in $vCenterServers) {
        Write-Host "Processing $vcServer..." -ForegroundColor Cyan
        
        try {
            # Connect to vCenter
            Connect-VIServer -Server $vcServer -Credential $Credential -ErrorAction Stop | Out-Null
            
            # Get all VMs that have snapshots
            $vms = Get-VM | Where-Object { $_.ExtensionData.Snapshot }
            
            foreach ($vm in $vms) {
                $snapshots = Get-Snapshot -VM $vm
                
                foreach ($snap in $snapshots) {
                    # Calculate snapshot age
                    $ageDays = [Math]::Round(((Get-Date) - $snap.Created).TotalDays, 0)
                    
                    # Try to get creator from vCenter events
                    $vcCreator = "Unknown"
                    try {
                        $events = Get-VIEvent -Entity $vm -Types Info -Start $snap.Created.AddMinutes(-1) -Finish $snap.Created.AddMinutes(1) -ErrorAction SilentlyContinue |
                            Where-Object { $_.FullFormattedMessage -match "snapshot" -or $_.GetType().Name -match "Snapshot" } |
                            Sort-Object CreatedTime -Descending |
                            Select-Object -First 1
                        
                        if ($events) {
                            $vcCreator = $events.UserName
                        }
                    }
                    catch { }
                    
                    # Add snapshot to collection
                    $allSnapshots += [PSCustomObject]@{
                        vCenter      = $vcServer
                        VMName       = $vm.Name
                        SnapshotName = $snap.Name
                        Description  = $snap.Description
                        CreatedDate  = $snap.Created
                        CreatedBy    = $vcCreator
                        SizeGB       = [Math]::Round($snap.SizeGB, 2)
                        AgeDays      = $ageDays
                    }
                }
            }
            
            Disconnect-VIServer -Server $vcServer -Confirm:$false -ErrorAction SilentlyContinue
            Write-Host "Completed $vcServer" -ForegroundColor Green
        }
        catch {
            Write-Warning "Error processing $vcServer : $_"
        }
    }
    
    # Return snapshots sorted by age (oldest first)
    return $allSnapshots | Sort-Object AgeDays -Descending
}

function Invoke-vRAEnrichment {
    param(
        [Parameter(Mandatory)]
        [array]$Snapshots,
        [Parameter(Mandatory)]
        [string]$Server,
        [Parameter(Mandatory)]
        [string]$Token
    )
    
    Write-Host "`nEnriching vRA-created snapshots..." -ForegroundColor Yellow
    
    $vraSnapshotCount = ($Snapshots | Where-Object { $_.CreatedBy -like "*vravc*" }).Count
    $processedCount = 0
    
    foreach ($snap in $Snapshots) {
        # Check if snapshot was created by vRA (contains "vravc" in username)
        if ($snap.CreatedBy -like "*vravc*") {
            $processedCount++
            Write-Host "  Processing vRA snapshot $processedCount of $vraSnapshotCount..." -ForegroundColor Gray
            
            # Get actual user from vRA API
            $vraInfo = Get-SnapshotUserFromvRA `
                -VMName $snap.VMName `
                -SnapshotCreated $snap.CreatedDate `
                -SnapshotName $snap.SnapshotName `
                -SnapshotDescription $snap.Description `
                -Server $Server `
                -AccessToken $Token
            
            # Replace "vravc" account with actual user if found
            if ($vraInfo.User -ne "N/A") {
                $snap.CreatedBy = $vraInfo.User
            }
            
            # Add vRA metadata
            $snap | Add-Member -NotePropertyName "vRAUser" -NotePropertyValue $vraInfo.User -Force
            $snap | Add-Member -NotePropertyName "vRADate" -NotePropertyValue $vraInfo.Date -Force
        }
        else {
            # Not a vRA snapshot, add empty vRA fields
            $snap | Add-Member -NotePropertyName "vRAUser" -NotePropertyValue "N/A" -Force
            $snap | Add-Member -NotePropertyName "vRADate" -NotePropertyValue "N/A" -Force
        }
    }
    
    Write-Host "Enrichment complete - Processed $processedCount vRA snapshots" -ForegroundColor Green
    return $Snapshots
}

function Send-SnapshotReport {
    param(
        [Parameter(Mandatory)]
        [array]$Snapshots,
        [Parameter(Mandatory)]
        [string]$SmtpServer,
        [Parameter(Mandatory)]
        [int]$SmtpPort,
        [Parameter(Mandatory)]
        [string]$From,
        [Parameter(Mandatory)]
        [array]$To,
        [Parameter(Mandatory)]
        [string]$Subject
    )
    
    # Build HTML email with table
    $html = @"
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th { background-color: #3498db; color: white; padding: 12px; text-align: left; }
        td { border: 1px solid #ddd; padding: 10px; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        tr:hover { background-color: #e8f4f8; }
        .summary { background-color: #ecf0f1; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .old { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>
    <div class="summary">
        <strong>Total Snapshots:</strong> $($Snapshots.Count)
    </div>
    <table>
        <tr>
            <th>VM Name</th>
            <th>Snapshot Name</th>
            <th>Description</th>
            <th>Created Date</th>
            <th>Created By</th>
            <th>Size (GB)</th>
            <th>Age (Days)</th>
        </tr>
"@
    
    # Add each snapshot as a table row
    foreach ($snap in $Snapshots) {
        $ageClass = if ($snap.AgeDays -gt 30) { " class='old'" } else { "" }
        $createdBy = if ($snap.vRAUser -ne "N/A") { "$($snap.CreatedBy) (vRA)" } else { $snap.CreatedBy }
        
        $html += @"
        <tr>
            <td>$($snap.VMName)</td>
            <td>$($snap.SnapshotName)</td>
            <td>$($snap.Description)</td>
            <td>$($snap.CreatedDate.ToString('yyyy-MM-dd HH:mm'))</td>
            <td>$createdBy</td>
            <td>$($snap.SizeGB)</td>
            <td$ageClass>$($snap.AgeDays)</td>
        </tr>
"@
    }
    
    $html += @"
    </table>
</body>
</html>
"@
    
    # Send the email
    try {
        Send-MailMessage `
            -To $To `
            -From $From `
            -Subject $Subject `
            -Body $html `
            -BodyAsHtml `
            -SmtpServer $SmtpServer `
            -Port $SmtpPort `
            -UseSsl `
            -ErrorAction Stop
        
        Write-Host "Email sent successfully to $($To -join ', ')" -ForegroundColor Green
    }
    catch {
        Write-Warning "Failed to send email: $_"
    }
}

# ============================================================================
# MAIN EXECUTION
# ============================================================================

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "vCenter Snapshot Report with vRA Integration" -ForegroundColor Cyan
Write-Host "========================================`n" -ForegroundColor Cyan

# Get credentials for vCenter and vRA
$credential = Get-Credential -Message "Enter credentials for vCenter and vRA"
if (-not $credential) {
    Write-Error "Credentials are required to continue."
    exit 1
}

# Authenticate with vRA
Write-Host "Authenticating with vRA..." -ForegroundColor Yellow
$vraRefreshToken = Get-vRAAccessToken -Credential $credential -Server $vraServer

if ($vraRefreshToken) {
    $vraBearerToken = Get-vRABearerToken -RefreshToken $vraRefreshToken -Server $vraServer
    
    if ($vraBearerToken) {
        Write-Host "Successfully authenticated with vRA" -ForegroundColor Green
    }
    else {
        Write-Warning "Failed to get vRA bearer token. Continuing without vRA enrichment."
        $vraBearerToken = $null
    }
}
else {
    Write-Warning "Failed to authenticate with vRA. Continuing without vRA enrichment."
    $vraBearerToken = $null
}

# Collect snapshots from all vCenters
Write-Host "`nCollecting snapshots from vCenters..." -ForegroundColor Yellow
$allSnapshots = Get-AllSnapshots -vCenterServers $vCenters -Credential $credential

if ($allSnapshots.Count -eq 0) {
    Write-Host "No snapshots found." -ForegroundColor Yellow
    
    # Send email with no snapshots message
    $html = @"
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; }
        .summary { background-color: #ecf0f1; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="summary">
        <strong>No snapshots found</strong>
    </div>
</body>
</html>
"@
    
    try {
        Send-MailMessage `
            -To $emailTo `
            -From $emailFrom `
            -Subject $emailSubject `
            -Body $html `
            -BodyAsHtml `
            -SmtpServer $smtpServer `
            -Port $smtpPort `
            -UseSsl `
            -ErrorAction Stop
        
        Write-Host "Email sent successfully" -ForegroundColor Green
    }
    catch {
        Write-Warning "Failed to send email: $_"
    }
    
    exit 0
}

Write-Host "`nTotal snapshots found: $($allSnapshots.Count)" -ForegroundColor Green

# Enrich vRA snapshots with actual user information
if ($vraBearerToken) {
    $allSnapshots = Invoke-vRAEnrichment -Snapshots $allSnapshots -Server $vraServer -Token $vraBearerToken
}
else {
    # Add empty vRA fields if authentication failed
    $allSnapshots = $allSnapshots | ForEach-Object {
        $_ | Add-Member -NotePropertyName "vRAUser" -NotePropertyValue "N/A" -Force
        $_ | Add-Member -NotePropertyName "vRADate" -NotePropertyValue "N/A" -Force
        $_
    }
}

# Display summary to console
$totalSize = [Math]::Round(($allSnapshots | Measure-Object -Property SizeGB -Sum).Sum, 2)
$oldestSnapshot = [Math]::Round(($allSnapshots | Measure-Object -Property AgeDays -Maximum).Maximum, 0)

Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "SUMMARY" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Total Snapshots: $($allSnapshots.Count)"
Write-Host "Total Size: $totalSize GB"
Write-Host "Oldest Snapshot: $oldestSnapshot days"
Write-Host ""

# Display table in console
$allSnapshots | Format-Table -Property vCenter, VMName, SnapshotName, CreatedDate, CreatedBy, SizeGB, AgeDays -AutoSize

# Export to CSV
$csvPath = ".\SnapshotReport_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"
$allSnapshots | Export-Csv -Path $csvPath -NoTypeInformation
Write-Host "CSV exported to: $csvPath" -ForegroundColor Green

# Send HTML email report
Write-Host "`nSending email report..." -ForegroundColor Yellow
Send-SnapshotReport `
    -Snapshots $allSnapshots `
    -SmtpServer $smtpServer `
    -SmtpPort $smtpPort `
    -From $emailFrom `
    -To $emailTo `
    -Subject $emailSubject

Write-Host "`nScript completed successfully!" -ForegroundColor Green
