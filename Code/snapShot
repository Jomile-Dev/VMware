# Get credentials from user
$credential = Import-Clixml -Path "D:\Working\WROPS Script\getcred.xml"

# VRA Configuration (for unknown snapshot creators)
$vRAEnabled = $true
$vRAServer = "vra.example.com"  # Update with your vRA server
$vRACredential = Import-Clixml -Path "D:\Working\WROPS Script\vracred.xml"
$vRACheckUser = "xyz"  # If creator equals this user, check vRA

# Function to get creator from VRA
function Get-VRASnapshotCreator {
    param(
        [string]$VMName,
        [datetime]$SnapshotTime
    )
    
    try {
        # Connect to vRA API
        $authUrl = "https://$vRAServer/identity/api/tokens"
        $authBody = @{
            username = $vRACredential.UserName
            password = $vRACredential.GetNetworkCredential().Password
            tenant = "vsphere.local"
        } | ConvertTo-Json
        
        $authHeaders = @{
            "Content-Type" = "application/json"
            "Accept" = "application/json"
        }
        
        $authResponse = Invoke-RestMethod -Uri $authUrl -Method Post -Headers $authHeaders -Body $authBody
        $token = $authResponse.id
        
        # Search for snapshot events in User Events
        $eventsUrl = "https://$vRAServer/event-broker/api/events"
        $headers = @{
            "Authorization" = "Bearer $token"
            "Content-Type" = "application/json"
        }
        
        # Search for events around the snapshot creation time (Â±10 minutes)
        $startTime = $SnapshotTime.AddMinutes(-10).ToString("yyyy-MM-ddTHH:mm:ss.fffZ")
        $endTime = $SnapshotTime.AddMinutes(10).ToString("yyyy-MM-ddTHH:mm:ss.fffZ")
        
        $queryUrl = "$eventsUrl`?`$filter=eventTime ge $startTime and eventTime le $endTime"
        $events = Invoke-RestMethod -Uri $queryUrl -Method Get -Headers $headers
        
        # Find matching event with "Create Snapshot" in title and the VM name
        $matchingEvent = $events.content | Where-Object { 
            $_.title -like "*Create Snapshot*" -and $_.title -like "*$VMName*"
        } | Select-Object -First 1
        
        if ($matchingEvent) {
            # Extract username from title - format is usually "Create Snapshot username"
            if ($matchingEvent.title -match "Create Snapshot.*?(\w+)$") {
                return $matches[1]
            }
            # Alternative: check if there's a userName field in the event data
            elseif ($matchingEvent.userName) {
                return $matchingEvent.userName
            }
        }
        
        return $null
    }
    catch {
        Write-Host "  VRA lookup failed for $VMName : $_" -ForegroundColor Yellow
        return $null
    }
}

$snapshotReport = @()

$vCenterServers | ForEach-Object {
    Write-Host "Connecting to $_" -ForegroundColor Green
    Connect-VIServer -Server $_ -Credential $credential
    Write-Host "Retrieving snapshots and events from $_" -ForegroundColor Yellow
    Get-VM | ForEach-Object {
        $vm = $_
        $snapshots = Get-Snapshot -VM $vm
        foreach ($snap in $snapshots) {
            $events = Get-VIEvent -Entity $vm -Start ($snap.Created.AddMinutes(-5)) -Finish ($snap.Created.AddMinutes(5)) |
                Where-Object { $_._FullFormattedMessage -like "*Create virtual machine snapshot*" }
            
            $creator = if ($events) { $events[0].UserName } else { "Unknown" }
            
            # If creator equals the vRACheckUser or is "Unknown", try VRA lookup
            if ($vRAEnabled -and ($creator -eq $vRACheckUser -or $creator -eq "Unknown")) {
                Write-Host "  Checking vRA Deployment User Events for: $($snap.Name) on $($vm.Name)" -ForegroundColor Cyan
                $vraCreator = Get-VRASnapshotCreator -VMName $vm.Name -SnapshotTime $snap.Created
                if ($vraCreator) {
                    $creator = "$vraCreator (vRA)"
                }
            }
            
            $ageDays = [math]::Floor(((Get-Date) - $snap.Created).TotalDays)
            $createdFormatted = $snap.Created.ToString("dd-MM-yyyy")
            
            $snapshotReport += [PSCustomObject]@{
                VMName = $vm.Name
                SnapshotName = $snap.Name
                Description = $snap.Description
                Created = $createdFormatted
                CreatedBy = $creator
                Size = [math]::Round($snap.SizeGB, 2)
                AgeDays = $ageDays
            }
        }
    }
    
    Disconnect-VIServer -Server $_ -Confirm:$false
}

# Sort by AgeDays descending (oldest first)
$snapshotReport = $snapshotReport | Sort-Object -Property AgeDays -Descending

# Generate HTML content
if ($snapshotReport.Count -eq 0) {
    $emailBody = @"
<html>
<head>
<style>
body { font-family: Arial; }
</style>
</head>
<body>
<h2>Snapshot Report</h2>
<p>No old snapshots.</p>
</body>
</html>
"@
} else {
    $htmlTable = $snapshotReport | ConvertTo-Html -Property VMName, SnapshotName, Description, Created, CreatedBy, Size, AgeDays -Fragment
    
    $emailBody = @"
<html>
<head>
<style>
table { border-collapse: collapse; width: 100%; }
th { background-color: #4CAF50; color: white; padding: 8px; text-align: left; }
td { border: 1px solid black; padding: 8px; text-align: left; }
</style>
</head>
<body>
<h2>Snapshot Report</h2>
<p>Report generated: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')</p>
$htmlTable
</body>
</html>
"@
}
