#Requires -Modules VMware.VimAutomation.Core

<#
.SYNOPSIS
    Multi-vCenter snapshot reporting with vRA user enrichment
.DESCRIPTION
    Connects to multiple vCenters, retrieves all snapshots with details,
    enriches vRA-created snapshots with actual user information, and emails a report
#>

# ============================================================================
# CONFIGURATION
# ============================================================================

# vCenter Configuration - ADD YOUR VCENTER SERVERS HERE
$vCenters = @(
    "vcenter1.domain.com",
    "vcenter2.domain.com",
    "vcenter3.domain.com"
)

Write-Host "Configuration loaded:" -ForegroundColor Yellow
Write-Host "  vCenters configured: $($vCenters.Count)" -ForegroundColor Yellow
Write-Host "  vCenter list: $($vCenters -join ', ')" -ForegroundColor Yellow
Write-Host ""

# vRA Configuration
$vraServer = "vra.domain.com"

# Email Configuration
$smtpServer = "smtp.domain.com"
$smtpPort = 25
$emailFrom = "snapshots@domain.com"
$emailTo = @("admin@domain.com")
$emailSubject = "vCenter Snapshot Report - $(Get-Date -Format 'yyyy-MM-dd')"

# ============================================================================
# FUNCTIONS
# ============================================================================

function Get-vRAAccessToken {
    param(
        [System.Management.Automation.PSCredential]$Credential,
        [string]$Server
    )
    
    $uri = "https://$Server/csp/gateway/am/api/login?access_token"
    
    $body = @{
        username = $Credential.UserName
        password = $Credential.GetNetworkCredential().Password
    } | ConvertTo-Json
    
    try {
        $response = Invoke-RestMethod -Uri $uri -Method Post -Body $body -ContentType "application/json"
        return $response.refresh_token
    }
    catch {
        Write-Warning "Failed to get vRA refresh token: $_"
        return $null
    }
}

function Get-vRABearerToken {
    param([string]$RefreshToken, [string]$Server)
    
    $uri = "https://$Server/iaas/api/login"
    $body = @{ refreshToken = $RefreshToken } | ConvertTo-Json
    
    try {
        $response = Invoke-RestMethod -Uri $uri -Method Post -Body $body -ContentType "application/json"
        return $response.token
    }
    catch {
        Write-Warning "Failed to get vRA bearer token: $_"
        return $null
    }
}

function Get-vRACloudMachineByName {
    param([string]$VMName, [string]$Server, [string]$AccessToken)
    
    $headers = @{
        "Authorization" = "Bearer $AccessToken"
        "Content-Type" = "application/json"
    }
    
    $uri = "https://$Server/iaas/api/machines?`$filter=name eq '$VMName'"
    
    try {
        $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $headers
        if ($response.content -and $response.content.Count -gt 0) {
            return $response.content[0]
        }
        return $null
    }
    catch {
        Write-Warning "Failed to get vRA machine for $VMName : $_"
        return $null
    }
}

function Get-vRADeploymentEvents {
    param([string]$DeploymentId, [string]$Server, [string]$AccessToken)
    
    $headers = @{
        "Authorization" = "Bearer $AccessToken"
        "Content-Type" = "application/json"
    }
    
    $uri = "https://$Server/deployment/api/deployments/$DeploymentId/events"
    
    try {
        $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $headers
        return $response.content
    }
    catch {
        Write-Warning "Failed to get deployment events for $DeploymentId : $_"
        return $null
    }
}

function Get-SnapshotUserFromvRA {
    param(
        [string]$VMName,
        [string]$SnapshotCreated,
        [string]$SnapshotName,
        [string]$SnapshotDescription,
        [string]$Server,
        [string]$AccessToken
    )
    
    Write-Host "`n    === DEBUG: vRA Lookup Process ===" -ForegroundColor Cyan
    Write-Host "    VM Name: $VMName" -ForegroundColor Cyan
    Write-Host "    Snapshot Created: $SnapshotCreated" -ForegroundColor Cyan
    Write-Host "    Snapshot Name: $SnapshotName" -ForegroundColor Cyan
    Write-Host "    Snapshot Description: $SnapshotDescription" -ForegroundColor Cyan
    
    # Get the cloud machine resource
    Write-Host "`n    Step 1: Looking up machine in vRA..." -ForegroundColor Yellow
    $machine = Get-vRACloudMachineByName -VMName $VMName -Server $Server -AccessToken $AccessToken
    
    if (-not $machine) {
        Write-Host "    ✗ Machine not found in vRA" -ForegroundColor Red
        return @{
            User = "N/A"
            Date = "N/A"
        }
    }
    
    Write-Host "    ✓ Machine found in vRA" -ForegroundColor Green
    
    $deploymentId = $machine.deploymentId
    
    if (-not $deploymentId) {
        Write-Host "    ✗ No deploymentId found for machine" -ForegroundColor Red
        return @{
            User = "N/A"
            Date = "N/A"
        }
    }
    
    Write-Host "    ✓ Deployment ID: $deploymentId" -ForegroundColor Green
    
    # Get deployment events
    Write-Host "`n    Step 2: Retrieving deployment events..." -ForegroundColor Yellow
    $events = Get-vRADeploymentEvents -DeploymentId $deploymentId -Server $Server -AccessToken $AccessToken
    
    if (-not $events) {
        Write-Host "    ✗ No events found for deployment" -ForegroundColor Red
        return @{
            User = "N/A"
            Date = "N/A"
        }
    }
    
    Write-Host "    ✓ Found $($events.Count) total events" -ForegroundColor Green
    
    # Show all snapshot create events with MORE DETAIL
    Write-Host "`n    Snapshot Create Events:" -ForegroundColor Cyan
    $snapshotCreateEvents = $events | Where-Object { $_.actionId -eq "Cloud.vSphere.Machine.Snapshot.Create" }
    Write-Host "    Found $($snapshotCreateEvents.Count) snapshot create events" -ForegroundColor Yellow
    
    $snapshotCreateEvents | ForEach-Object {
        Write-Host "      - ActionId: $($_.actionId)" -ForegroundColor Gray
        Write-Host "        UpdatedAt: $($_.updatedAt)" -ForegroundColor Gray
        Write-Host "        User: $($_.user)" -ForegroundColor Gray
        Write-Host "        RequestedBy: $($_.requestedBy)" -ForegroundColor Magenta
        Write-Host "        Message: $($_.message)" -ForegroundColor Gray
        
        # Debug: Show ALL properties of the event
        Write-Host "        ALL PROPERTIES:" -ForegroundColor Yellow
        $_.PSObject.Properties | ForEach-Object {
            Write-Host "          $($_.Name) : $($_.Value)" -ForegroundColor DarkGray
        }
        Write-Host "" -ForegroundColor Gray
    }
    
    # Convert snapshot created date to comparable format
    $snapshotDate = [DateTime]::Parse($SnapshotCreated)
    Write-Host "`n    Step 3: Matching snapshot event..." -ForegroundColor Yellow
    Write-Host "    Looking for events near: $snapshotDate" -ForegroundColor Yellow
    
    Write-Host "`n    DEBUG: Filtering events..." -ForegroundColor Magenta
    Write-Host "    Total events to check: $($events.Count)" -ForegroundColor Magenta
    
    # Show what we're checking against
    $debugCount = 0
    $events | ForEach-Object {
        if ($_.actionId -eq "Cloud.vSphere.Machine.Snapshot.Create") {
            $debugCount++
            Write-Host "    Snapshot Event #$debugCount" -ForegroundColor Yellow
            Write-Host "      ActionId: $($_.actionId)" -ForegroundColor Gray
            Write-Host "      UpdatedAt: '$($_.updatedAt)'" -ForegroundColor Gray
            
            if ($_.updatedAt) {
                try {
                    $eventDate = [DateTime]::Parse($_.updatedAt)
                    $timeDiff = ($eventDate - $snapshotDate).TotalMinutes
                    Write-Host "      Time difference: $([Math]::Round($timeDiff, 2)) minutes" -ForegroundColor $(if([Math]::Abs($timeDiff) -lt 10){"Green"}else{"Red"})
                    Write-Host "      Within 10 min window? $([Math]::Abs($timeDiff) -lt 10)" -ForegroundColor $(if([Math]::Abs($timeDiff) -lt 10){"Green"}else{"Red"})
                } catch {
                    Write-Host "      ERROR parsing date: $_" -ForegroundColor Red
                }
            } else {
                Write-Host "      UpdatedAt is NULL or empty!" -ForegroundColor Red
            }
            Write-Host ""
        }
    }
    
    # Find snapshot create events around the creation time
    $matchingEvents = $events | Where-Object {
        $_.actionId -eq "Cloud.vSphere.Machine.Snapshot.Create" -and
        $_.updatedAt -and
        [Math]::Abs(([DateTime]::Parse($_.updatedAt) - $snapshotDate).TotalMinutes) -lt 10
    }
    
    Write-Host "    Found $($matchingEvents.Count) events within 10 minutes" -ForegroundColor Yellow
    
    if ($matchingEvents.Count -eq 0) {
        Write-Host "    ✗ No matching snapshot events found" -ForegroundColor Red
        Write-Host "    === END DEBUG ===`n" -ForegroundColor Cyan
        return @{
            User = "N/A"
            Date = "N/A"
        }
    }
    
    Write-Host "`n    === MATCHED EVENTS DATA ===" -ForegroundColor Cyan
    for ($i = 0; $i -lt $matchingEvents.Count; $i++) {
        $evt = $matchingEvents[$i]
        Write-Host "    Event #$($i+1):" -ForegroundColor Yellow
        Write-Host "      ActionId: $($evt.actionId)" -ForegroundColor Gray
        Write-Host "      UpdatedAt: $($evt.updatedAt)" -ForegroundColor Gray
        Write-Host "      Message: $($evt.message)" -ForegroundColor Gray
        Write-Host "      User: '$($evt.user)'" -ForegroundColor Magenta
        Write-Host "      RequestedBy: '$($evt.requestedBy)'" -ForegroundColor Magenta
        
        if ($evt.inputs) {
            Write-Host "      Inputs object exists:" -ForegroundColor Cyan
            Write-Host "        inputs.name: '$($evt.inputs.name)'" -ForegroundColor DarkCyan
            Write-Host "        inputs.description: '$($evt.inputs.description)'" -ForegroundColor DarkCyan
            Write-Host "        inputs.requestedBy: '$($evt.inputs.requestedBy)'" -ForegroundColor Magenta
            Write-Host "        inputs.user: '$($evt.inputs.user)'" -ForegroundColor Magenta
        } else {
            Write-Host "      No inputs object" -ForegroundColor Red
        }
        Write-Host ""
    }
    Write-Host "    === END MATCHED EVENTS DATA ===`n" -ForegroundColor Cyan
    
    # If we have multiple matches, try to narrow down by name/description
    if ($matchingEvents.Count -gt 1 -and ($SnapshotName -or $SnapshotDescription)) {
        Write-Host "    Multiple events found, trying to match by name/description..." -ForegroundColor Yellow
        Write-Host "    Looking for:" -ForegroundColor Cyan
        Write-Host "      Snapshot Name: '$SnapshotName'" -ForegroundColor Cyan
        Write-Host "      Snapshot Description: '$SnapshotDescription'" -ForegroundColor Cyan
        
        Write-Host "`n    Checking each event:" -ForegroundColor Yellow
        $matchIndex = 0
        $bestMatch = $matchingEvents | Where-Object {
            $matchIndex++
            Write-Host "      Event #$matchIndex" -ForegroundColor Gray
            
            # Check in message
            Write-Host "        Message: '$($_.message)'" -ForegroundColor DarkGray
            $messageMatch = ($_.message -like "*$SnapshotName*") -or ($_.message -like "*$SnapshotDescription*")
            Write-Host "        Message Match: $messageMatch" -ForegroundColor $(if($messageMatch){"Green"}else{"DarkGray"})
            
            # Check in inputs object if it exists
            $inputsMatch = $false
            if ($_.inputs) {
                Write-Host "        Inputs.name: '$($_.inputs.name)'" -ForegroundColor DarkGray
                Write-Host "        Inputs.description: '$($_.inputs.description)'" -ForegroundColor DarkGray
                
                $inputsMatch = ($_.inputs.name -eq $SnapshotName) -or 
                               ($_.inputs.description -eq $SnapshotDescription) -or
                               ($_.inputs.name -like "*$SnapshotName*") -or
                               ($_.inputs.description -like "*$SnapshotDescription*")
                Write-Host "        Inputs Match: $inputsMatch" -ForegroundColor $(if($inputsMatch){"Green"}else{"DarkGray"})
            }
            else {
                Write-Host "        No inputs object found" -ForegroundColor DarkGray
            }
            
            $overallMatch = $messageMatch -or $inputsMatch
            Write-Host "        Overall Match: $overallMatch" -ForegroundColor $(if($overallMatch){"Green"}else{"Red"})
            Write-Host ""
            
            $overallMatch
        } | Select-Object -First 1
        
        if ($bestMatch) {
            Write-Host "    ✓ Found match by name/description!" -ForegroundColor Green
            $matchingEvents = @($bestMatch)
        }
        else {
            Write-Host "    No name/description match, using closest by time" -ForegroundColor Yellow
            $matchingEvents = $matchingEvents | Sort-Object { [Math]::Abs(([DateTime]::Parse($_.updatedAt) - $snapshotDate).TotalSeconds) } | Select-Object -First 1
        }
    }
    
    if ($matchingEvents -and $matchingEvents.Count -gt 0) {
        Write-Host "`n    Step 4: Analyzing matched event(s)..." -ForegroundColor Yellow
        Write-Host "    Found $($matchingEvents.Count) matching event(s)" -ForegroundColor Yellow
        
        # Show details of ALL matching events
        for ($i = 0; $i -lt $matchingEvents.Count; $i++) {
            $event = $matchingEvents[$i]
            Write-Host "`n    === Matched Event #$($i + 1) Details ===" -ForegroundColor Cyan
            Write-Host "    ALL Properties and Values:" -ForegroundColor Yellow
            $event.PSObject.Properties | ForEach-Object {
                $propName = $_.Name
                $propValue = if ($_.Value) { $_.Value } else { "(empty)" }
                Write-Host "      $propName : $propValue" -ForegroundColor Gray
            }
            Write-Host "    =========================" -ForegroundColor Cyan
        }
        
        # Now try to extract user from first matching event
        $event = $matchingEvents[0]
        
        # TRY MULTIPLE FIELDS FOR USER - PRIORITIZE requestedBy
        $actualUser = $null
        $userSource = ""
        
        # Check top-level properties first
        if ($event.requestedBy -and $event.requestedBy -ne "" -and $event.requestedBy -ne $null) {
            $actualUser = $event.requestedBy
            $userSource = "requestedBy (top-level)"
        }
        elseif ($event.user -and $event.user -ne "" -and $event.user -ne $null) {
            $actualUser = $event.user
            $userSource = "user (top-level)"
        }
        elseif ($event.userName -and $event.userName -ne "" -and $event.userName -ne $null) {
            $actualUser = $event.userName
            $userSource = "userName (top-level)"
        }
        elseif ($event.owner -and $event.owner -ne "" -and $event.owner -ne $null) {
            $actualUser = $event.owner
            $userSource = "owner (top-level)"
        }
        # Check inside inputs object
        elseif ($event.inputs -and $event.inputs.requestedBy) {
            $actualUser = $event.inputs.requestedBy
            $userSource = "inputs.requestedBy"
        }
        elseif ($event.inputs -and $event.inputs.user) {
            $actualUser = $event.inputs.user
            $userSource = "inputs.user"
        }
        
        if ($actualUser) {
            Write-Host "`n    ✓ Match Found! (using $userSource field)" -ForegroundColor Green
        }
        else {
            Write-Host "`n    ✗ Match Found but NO USER FIELD available in any known field" -ForegroundColor Red
            Write-Host "    Checked fields: requestedBy, user, userName, owner (top-level and in inputs) - all empty or null" -ForegroundColor Red
        }
        
        if ($actualUser) {
            Write-Host "      User: $actualUser" -ForegroundColor Green
            Write-Host "      UpdatedAt: $($event.updatedAt)" -ForegroundColor Green
            Write-Host "      Message: $($event.message)" -ForegroundColor Green
            Write-Host "    === END DEBUG ===`n" -ForegroundColor Cyan
            
            return @{
                User = $actualUser
                Date = ([DateTime]::Parse($event.updatedAt)).ToString("yyyy-MM-dd")
            }
        }
    }
    
    Write-Host "    ✗ No matching snapshot events found or no user information available" -ForegroundColor Red
    Write-Host "    === END DEBUG ===`n" -ForegroundColor Cyan
    
    return @{
        User = "N/A"
        Date = "N/A"
    }
}

function Get-AllSnapshots {
    param(
        [array]$vCenterServers,
        [System.Management.Automation.PSCredential]$Credential
    )
    
    $allSnapshots = @()
    
    foreach ($vcServer in $vCenterServers) {
        Write-Host "`nConnecting to $vcServer..." -ForegroundColor Cyan
        
        try {
            Connect-VIServer -Server $vcServer -Credential $Credential -ErrorAction Stop | Out-Null
            
            Write-Host "Retrieving snapshots from $vcServer..." -ForegroundColor Yellow
            
            # Get all VMs with snapshots
            $vms = Get-VM | Where-Object { $_.ExtensionData.Snapshot }
            
            foreach ($vm in $vms) {
                Write-Host "  Processing VM: $($vm.Name)" -ForegroundColor Gray
                $snapshots = Get-Snapshot -VM $vm
                Write-Host "    Found $($snapshots.Count) snapshot(s)" -ForegroundColor Gray
                
                foreach ($snap in $snapshots) {
                    $ageDays = [Math]::Round(((Get-Date) - $snap.Created).TotalDays, 2)
                    
                    # Get creator from vCenter events
                    $vcCreator = "Unknown"
                    try {
                        $events = Get-VIEvent -Entity $vm -Types Info -Start $snap.Created.AddMinutes(-1) -Finish $snap.Created.AddMinutes(1) |
                            Where-Object { $_.FullFormattedMessage -match "snapshot" -or $_.GetType().Name -match "Snapshot" } |
                            Sort-Object CreatedTime -Descending |
                            Select-Object -First 1
                        
                        if ($events) {
                            $vcCreator = $events.UserName
                        }
                    }
                    catch {
                        Write-Warning "Could not retrieve event for snapshot $($snap.Name): $_"
                    }
                    
                    $allSnapshots += [PSCustomObject]@{
                        vCenter         = $vcServer
                        VMName          = $vm.Name
                        SnapshotName    = $snap.Name
                        Description     = $snap.Description
                        CreatedDate     = $snap.Created
                        CreatedBy       = $vcCreator
                        SizeGB          = [Math]::Round($snap.SizeGB, 2)
                        AgeDays         = $ageDays
                    }
                }
            }
            
            Disconnect-VIServer -Server $vcServer -Confirm:$false
            Write-Host "Completed processing $vcServer - Found $($allSnapshots.Count) total snapshots so far" -ForegroundColor Green
        }
        catch {
            Write-Warning "Error processing $vcServer : $_"
        }
    }
    
    # Sort by age (oldest first)
    return $allSnapshots | Sort-Object AgeDays -Descending
}

function Enrich-SnapshotsWithvRA {
    param(
        [array]$Snapshots,
        [string]$vraServer,
        [string]$vraToken
    )
    
    Write-Host "`nEnriching vRA-created snapshots with actual user information..." -ForegroundColor Yellow
    
    $enrichedSnapshots = @()
    $vraCount = 0
    
    foreach ($snap in $Snapshots) {
        # Debug output
        Write-Host "`nDEBUG: Checking snapshot - CreatedBy: '$($snap.CreatedBy)'" -ForegroundColor Magenta
        Write-Host "DEBUG: Contains 'vravc'? $($snap.CreatedBy -like '*vravc*')" -ForegroundColor Magenta
        
        # Check if the creator contains "vravc" anywhere in the string
        if ($snap.CreatedBy -like "*vravc*") {
            $vraCount++
            Write-Host "  ✓ MATCHED! Processing vRA snapshot for $($snap.VMName) (Creator: $($snap.CreatedBy))..." -ForegroundColor Yellow
            
            if (-not $vraToken) {
                Write-Host "    WARNING: No vRA token available, skipping vRA lookup" -ForegroundColor Red
                $enrichedSnapshots += [PSCustomObject]@{
                    vCenter         = $snap.vCenter
                    VMName          = $snap.VMName
                    SnapshotName    = $snap.SnapshotName
                    Description     = $snap.Description
                    CreatedDate     = $snap.CreatedDate
                    CreatedBy       = $snap.CreatedBy
                    SizeGB          = $snap.SizeGB
                    AgeDays         = $snap.AgeDays
                    vRAUser         = "N/A (No Token)"
                    vRADate         = "N/A"
                }
                continue
            }
            
            $vraInfo = Get-SnapshotUserFromvRA -VMName $snap.VMName -SnapshotCreated $snap.CreatedDate -SnapshotName $snap.SnapshotName -SnapshotDescription $snap.Description -Server $vraServer -AccessToken $vraToken
            
            Write-Host "    vRA returned - User: '$($vraInfo.User)', Date: '$($vraInfo.Date)'" -ForegroundColor Cyan
            
            # Update CreatedBy if we found the actual user
            if ($vraInfo.User -ne "N/A" -and $vraInfo.User -ne $null -and $vraInfo.User -ne "") {
                Write-Host "    ✓ Found actual user: $($vraInfo.User) - REPLACING vravc account" -ForegroundColor Green
                
                $enrichedSnapshots += [PSCustomObject]@{
                    vCenter         = $snap.vCenter
                    VMName          = $snap.VMName
                    SnapshotName    = $snap.SnapshotName
                    Description     = $snap.Description
                    CreatedDate     = $snap.CreatedDate
                    CreatedBy       = $vraInfo.User
                    SizeGB          = $snap.SizeGB
                    AgeDays         = $snap.AgeDays
                    vRAUser         = $vraInfo.User
                    vRADate         = $vraInfo.Date
                }
            }
            else {
                Write-Host "    ✗ Could not find actual user, keeping vravc account" -ForegroundColor Yellow
                
                $enrichedSnapshots += [PSCustomObject]@{
                    vCenter         = $snap.vCenter
                    VMName          = $snap.VMName
                    SnapshotName    = $snap.SnapshotName
                    Description     = $snap.Description
                    CreatedDate     = $snap.CreatedDate
                    CreatedBy       = $snap.CreatedBy
                    SizeGB          = $snap.SizeGB
                    AgeDays         = $snap.AgeDays
                    vRAUser         = "N/A"
                    vRADate         = "N/A"
                }
            }
        }
        else {
            Write-Host "  Regular snapshot (not vRA) - keeping as-is" -ForegroundColor Gray
            # Add non-vRA snapshot as-is with N/A fields
            $enrichedSnapshots += [PSCustomObject]@{
                vCenter         = $snap.vCenter
                VMName          = $snap.VMName
                SnapshotName    = $snap.SnapshotName
                Description     = $snap.Description
                CreatedDate     = $snap.CreatedDate
                CreatedBy       = $snap.CreatedBy
                SizeGB          = $snap.SizeGB
                AgeDays         = $snap.AgeDays
                vRAUser         = "N/A"
                vRADate         = "N/A"
            }
        }
    }
    
    Write-Host "`n=== Enrichment Summary ===" -ForegroundColor Green
    Write-Host "Total snapshots processed: $($Snapshots.Count)" -ForegroundColor Green
    Write-Host "vRA snapshots found: $vraCount" -ForegroundColor Green
    Write-Host "========================`n" -ForegroundColor Green
    
    return $enrichedSnapshots
}

function Send-SnapshotReport {
    param(
        [array]$Snapshots,
        [string]$SmtpServer,
        [int]$SmtpPort,
        [string]$From,
        [array]$To,
        [string]$Subject
    )
    
    # Build HTML email
    $html = @"
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; }
        h2 { color: #2c3e50; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th { background-color: #3498db; color: white; padding: 12px; text-align: left; }
        td { border: 1px solid #ddd; padding: 10px; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        tr:hover { background-color: #e8f4f8; }
        .summary { background-color: #ecf0f1; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .old { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>
    <h2>vCenter Snapshot Report</h2>
    <div class="summary">
        <strong>Report Generated:</strong> $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')<br>
        <strong>Total Snapshots:</strong> $($Snapshots.Count)<br>
        <strong>Total Size:</strong> $([Math]::Round(($Snapshots | Measure-Object -Property SizeGB -Sum).Sum, 2)) GB<br>
        <strong>Snapshots > 30 days:</strong> $(($Snapshots | Where-Object { $_.AgeDays -gt 30 }).Count)
    </div>
    
    <table>
        <tr>
            <th>vCenter</th>
            <th>VM Name</th>
            <th>Snapshot Name</th>
            <th>Description</th>
            <th>Created Date</th>
            <th>Created By</th>
            <th>Size (GB)</th>
            <th>Age (Days)</th>
        </tr>
"@
    
    foreach ($snap in $Snapshots) {
        $ageClass = if ($snap.AgeDays -gt 30) { " class='old'" } else { "" }
        $createdBy = if ($snap.vRAUser -ne "N/A") { "$($snap.vRAUser) (vRA: $($snap.vRADate))" } else { $snap.CreatedBy }
        
        $html += @"
        <tr>
            <td>$($snap.vCenter)</td>
            <td>$($snap.VMName)</td>
            <td>$($snap.SnapshotName)</td>
            <td>$($snap.Description)</td>
            <td>$($snap.CreatedDate.ToString('yyyy-MM-dd HH:mm'))</td>
            <td>$createdBy</td>
            <td>$($snap.SizeGB)</td>
            <td$ageClass>$($snap.AgeDays)</td>
        </tr>
"@
    }
    
    $html += @"
    </table>
</body>
</html>
"@
    
    # Send email
    try {
        Send-MailMessage `
            -To $To `
            -From $From `
            -Subject $Subject `
            -Body $html `
            -BodyAsHtml `
            -SmtpServer $SmtpServer `
            -Port $SmtpPort `
            -ErrorAction Stop
        
        Write-Host "`nEmail sent successfully to $($To -join ', ')" -ForegroundColor Green
    }
    catch {
        Write-Warning "Failed to send email: $_"
    }
}

# ============================================================================
# MAIN EXECUTION
# ============================================================================

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "vCenter Snapshot Report with vRA Integration" -ForegroundColor Cyan
Write-Host "========================================`n" -ForegroundColor Cyan

# Get credentials (used for both vCenter and vRA)
Write-Host "Please enter credentials (used for both vCenter and vRA):" -ForegroundColor Yellow
$credential = Get-Credential

if (-not $credential) {
    Write-Error "Credentials are required to continue."
    exit
}

# Get vRA refresh token
Write-Host "`nAuthenticating with vRA and generating refresh token..." -ForegroundColor Yellow
$vraRefreshToken = Get-vRAAccessToken -Credential $credential -Server $vraServer

if (-not $vraRefreshToken) {
    Write-Warning "Failed to authenticate with vRA. Continuing without vRA user enrichment."
    $vraBearerToken = $null
}
else {
    Write-Host "Successfully obtained vRA refresh token" -ForegroundColor Green
    
    # Get bearer token from refresh token
    $vraBearerToken = Get-vRABearerToken -RefreshToken $vraRefreshToken -Server $vraServer
    
    if ($vraBearerToken) {
        Write-Host "Successfully obtained vRA bearer token" -ForegroundColor Green
    }
    else {
        Write-Warning "Failed to get vRA bearer token. Continuing without vRA user enrichment."
    }
}

# Collect all snapshots
Write-Host "`nStarting snapshot collection from all vCenters..." -ForegroundColor Yellow
$allSnapshots = Get-AllSnapshots -vCenterServers $vCenters -Credential $credential

Write-Host "`nSnapshot collection completed." -ForegroundColor Green
Write-Host "Total snapshots found: $($allSnapshots.Count)" -ForegroundColor Green

# Enrich with vRA data if we have a token
if ($vraBearerToken) {
    $allSnapshots = Enrich-SnapshotsWithvRA -Snapshots $allSnapshots -vraServer $vraServer -vraToken $vraBearerToken
}
else {
    Write-Host "`nSkipping vRA enrichment (no bearer token available)" -ForegroundColor Yellow
    # Add empty vRA fields for consistency
    $allSnapshots = $allSnapshots | ForEach-Object {
        $_ | Add-Member -NotePropertyName "vRAUser" -NotePropertyValue "N/A" -Force
        $_ | Add-Member -NotePropertyName "vRADate" -NotePropertyValue "N/A" -Force
        $_
    }
}

Write-Host "`nProcessing completed." -ForegroundColor Green

# Display summary
Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "SUMMARY" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Total Snapshots: $($allSnapshots.Count)"
Write-Host "Total Size: $([Math]::Round(($allSnapshots | Measure-Object -Property SizeGB -Sum).Sum, 2)) GB"
Write-Host "Oldest Snapshot: $([Math]::Round(($allSnapshots | Measure-Object -Property AgeDays -Maximum).Maximum, 2)) days"
Write-Host ""

# Display table in console
$allSnapshots | Format-Table -Property vCenter, VMName, SnapshotName, CreatedDate, CreatedBy, SizeGB, AgeDays -AutoSize

# Export to CSV (optional)
$csvPath = ".\SnapshotReport_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"
$allSnapshots | Export-Csv -Path $csvPath -NoTypeInformation
Write-Host "CSV exported to: $csvPath" -ForegroundColor Green

# Send email report
Write-Host "`nSending email report..." -ForegroundColor Yellow
Send-SnapshotReport -Snapshots $allSnapshots -SmtpServer $smtpServer -SmtpPort $smtpPort `
    -From $emailFrom -To $emailTo -Subject $emailSubject

Write-Host "`nScript completed!" -ForegroundColor Green
