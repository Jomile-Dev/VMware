#Requires -Modules VMware.VimAutomation.Core

<#
.SYNOPSIS
    Multi-vCenter snapshot reporting with vRA user enrichment
.DESCRIPTION
    Connects to multiple vCenters, retrieves all snapshots with details,
    enriches vRA-created snapshots with actual user information, and emails a report
#>

# ============================================================================
# CONFIGURATION
# ============================================================================

# vCenter Configuration - ADD YOUR VCENTER SERVERS HERE
$vCenters = @(
    "vcenter1.domain.com",
    "vcenter2.domain.com",
    "vcenter3.domain.com"
)

Write-Host "Configuration loaded:" -ForegroundColor Yellow
Write-Host "  vCenters configured: $($vCenters.Count)" -ForegroundColor Yellow
Write-Host "  vCenter list: $($vCenters -join ', ')" -ForegroundColor Yellow
Write-Host ""

# vRA Configuration
$vraServer = "vra.domain.com"

# Email Configuration
$smtpServer = "smtp.domain.com"
$smtpPort = 25
$emailFrom = "snapshots@domain.com"
$emailTo = @("admin@domain.com")
$emailSubject = "vCenter Snapshot Report - $(Get-Date -Format 'yyyy-MM-dd')"

# ============================================================================
# FUNCTIONS
# ============================================================================

function Get-vRAAccessToken {
    param(
        [System.Management.Automation.PSCredential]$Credential,
        [string]$Server
    )
    
    $uri = "https://$Server/csp/gateway/am/api/login?access_token"
    
    $body = @{
        username = $Credential.UserName
        password = $Credential.GetNetworkCredential().Password
    } | ConvertTo-Json
    
    try {
        $response = Invoke-RestMethod -Uri $uri -Method Post -Body $body -ContentType "application/json"
        return $response.refresh_token
    }
    catch {
        Write-Warning "Failed to get vRA refresh token: $_"
        return $null
    }
}

function Get-vRABearerToken {
    param([string]$RefreshToken, [string]$Server)
    
    $uri = "https://$Server/iaas/api/login"
    $body = @{ refreshToken = $RefreshToken } | ConvertTo-Json
    
    try {
        $response = Invoke-RestMethod -Uri $uri -Method Post -Body $body -ContentType "application/json"
        return $response.token
    }
    catch {
        Write-Warning "Failed to get vRA bearer token: $_"
        return $null
    }
}

function Get-vRACloudMachineByName {
    param([string]$VMName, [string]$Server, [string]$AccessToken)
    
    $headers = @{
        "Authorization" = "Bearer $AccessToken"
        "Content-Type" = "application/json"
    }
    
    $uri = "https://$Server/iaas/api/machines?`$filter=name eq '$VMName'"
    
    try {
        $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $headers
        if ($response.content -and $response.content.Count -gt 0) {
            return $response.content[0]
        }
        return $null
    }
    catch {
        Write-Warning "Failed to get vRA machine for $VMName : $_"
        return $null
    }
}

function Get-vRADeploymentEvents {
    param([string]$DeploymentId, [string]$Server, [string]$AccessToken)
    
    $headers = @{
        "Authorization" = "Bearer $AccessToken"
        "Content-Type" = "application/json"
    }
    
    $uri = "https://$Server/deployment/api/deployments/$DeploymentId/events"
    
    try {
        $response = Invoke-RestMethod -Uri $uri -Method Get -Headers $headers
        return $response.content
    }
    catch {
        Write-Warning "Failed to get deployment events for $DeploymentId : $_"
        return $null
    }
}

function Get-SnapshotUserFromvRA {
    param(
        [string]$VMName,
        [string]$SnapshotCreated,
        [string]$Server,
        [string]$AccessToken
    )
    
    # Get the cloud machine resource
    $machine = Get-vRACloudMachineByName -VMName $VMName -Server $Server -AccessToken $AccessToken
    
    if (-not $machine) {
        return @{
            User = "N/A"
            Date = "N/A"
        }
    }
    
    $deploymentId = $machine.deploymentId
    
    if (-not $deploymentId) {
        return @{
            User = "N/A"
            Date = "N/A"
        }
    }
    
    # Get deployment events
    $events = Get-vRADeploymentEvents -DeploymentId $deploymentId -Server $Server -AccessToken $AccessToken
    
    if (-not $events) {
        return @{
            User = "N/A"
            Date = "N/A"
        }
    }
    
    # Convert snapshot created date to comparable format
    $snapshotDate = [DateTime]::Parse($SnapshotCreated)
    
    # Find USER events related to snapshots around the creation time (within 5 minutes)
    $snapshotEvent = $events | Where-Object {
        $_.eventType -eq "USER" -and
        $_.message -match "snapshot" -and
        [Math]::Abs(([DateTime]::Parse($_.eventLogTime) - $snapshotDate).TotalMinutes) -lt 5
    } | Sort-Object eventLogTime -Descending | Select-Object -First 1
    
    if ($snapshotEvent) {
        return @{
            User = $snapshotEvent.userName
            Date = ([DateTime]::Parse($snapshotEvent.eventLogTime)).ToString("yyyy-MM-dd")
        }
    }
    
    return @{
        User = "N/A"
        Date = "N/A"
    }
}

function Get-AllSnapshots {
    param(
        [array]$vCenterServers,
        [System.Management.Automation.PSCredential]$Credential
    )
    
    $allSnapshots = @()
    
    foreach ($vcServer in $vCenterServers) {
        Write-Host "`nConnecting to $vcServer..." -ForegroundColor Cyan
        
        try {
            Connect-VIServer -Server $vcServer -Credential $Credential -ErrorAction Stop | Out-Null
            
            Write-Host "Retrieving snapshots from $vcServer..." -ForegroundColor Yellow
            
            # Get all VMs with snapshots
            $vms = Get-VM | Where-Object { $_.ExtensionData.Snapshot }
            
            foreach ($vm in $vms) {
                Write-Host "  Processing VM: $($vm.Name)" -ForegroundColor Gray
                $snapshots = Get-Snapshot -VM $vm
                Write-Host "    Found $($snapshots.Count) snapshot(s)" -ForegroundColor Gray
                
                foreach ($snap in $snapshots) {
                    $ageDays = [Math]::Round(((Get-Date) - $snap.Created).TotalDays, 2)
                    
                    # Get creator from vCenter events
                    $vcCreator = "Unknown"
                    try {
                        $events = Get-VIEvent -Entity $vm -Types Info -Start $snap.Created.AddMinutes(-1) -Finish $snap.Created.AddMinutes(1) |
                            Where-Object { $_.FullFormattedMessage -match "snapshot" -or $_.GetType().Name -match "Snapshot" } |
                            Sort-Object CreatedTime -Descending |
                            Select-Object -First 1
                        
                        if ($events) {
                            $vcCreator = $events.UserName
                        }
                    }
                    catch {
                        Write-Warning "Could not retrieve event for snapshot $($snap.Name): $_"
                    }
                    
                    $allSnapshots += [PSCustomObject]@{
                        vCenter         = $vcServer
                        VMName          = $vm.Name
                        SnapshotName    = $snap.Name
                        Description     = $snap.Description
                        CreatedDate     = $snap.Created
                        CreatedBy       = $vcCreator
                        SizeGB          = [Math]::Round($snap.SizeGB, 2)
                        AgeDays         = $ageDays
                    }
                }
            }
            
            Disconnect-VIServer -Server $vcServer -Confirm:$false
            Write-Host "Completed processing $vcServer - Found $($allSnapshots.Count) total snapshots so far" -ForegroundColor Green
        }
        catch {
            Write-Warning "Error processing $vcServer : $_"
        }
    }
    
    # Sort by age (oldest first)
    return $allSnapshots | Sort-Object AgeDays -Descending
}

function Enrich-SnapshotsWithvRA {
    param(
        [array]$Snapshots,
        [string]$vraServer,
        [string]$vraToken
    )
    
    Write-Host "`nEnriching vRA-created snapshots with actual user information..." -ForegroundColor Yellow
    
    $enrichedSnapshots = @()
    $vraCount = 0
    
    foreach ($snap in $Snapshots) {
        $enrichedSnap = $snap.PSObject.Copy()
        
        # Check if the creator contains "vravc"
        if ($snap.CreatedBy -match "vravc") {
            $vraCount++
            Write-Host "  Processing vRA snapshot for $($snap.VMName)..." -ForegroundColor Gray
            
            $vraInfo = Get-SnapshotUserFromvRA -VMName $snap.VMName -SnapshotCreated $snap.CreatedDate -Server $vraServer -AccessToken $vraToken
            
            # Add vRA info as new properties
            $enrichedSnap | Add-Member -NotePropertyName "vRAUser" -NotePropertyValue $vraInfo.User -Force
            $enrichedSnap | Add-Member -NotePropertyName "vRADate" -NotePropertyValue $vraInfo.Date -Force
            
            # Update CreatedBy if we found the actual user
            if ($vraInfo.User -ne "N/A") {
                $enrichedSnap.CreatedBy = $vraInfo.User
                Write-Host "    Found actual user: $($vraInfo.User)" -ForegroundColor Green
            }
            else {
                $enrichedSnap | Add-Member -NotePropertyName "vRAUser" -NotePropertyValue "N/A" -Force
                $enrichedSnap | Add-Member -NotePropertyName "vRADate" -NotePropertyValue "N/A" -Force
            }
        }
        else {
            # Add N/A for non-vRA snapshots
            $enrichedSnap | Add-Member -NotePropertyName "vRAUser" -NotePropertyValue "N/A" -Force
            $enrichedSnap | Add-Member -NotePropertyName "vRADate" -NotePropertyValue "N/A" -Force
        }
        
        $enrichedSnapshots += $enrichedSnap
    }
    
    Write-Host "Enriched $vraCount vRA-created snapshots" -ForegroundColor Green
    return $enrichedSnapshots
}

function Send-SnapshotReport {
    param(
        [array]$Snapshots,
        [string]$SmtpServer,
        [int]$SmtpPort,
        [string]$From,
        [array]$To,
        [string]$Subject
    )
    
    # Build HTML email
    $html = @"
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; }
        h2 { color: #2c3e50; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th { background-color: #3498db; color: white; padding: 12px; text-align: left; }
        td { border: 1px solid #ddd; padding: 10px; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        tr:hover { background-color: #e8f4f8; }
        .summary { background-color: #ecf0f1; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .old { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>
    <h2>vCenter Snapshot Report</h2>
    <div class="summary">
        <strong>Report Generated:</strong> $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')<br>
        <strong>Total Snapshots:</strong> $($Snapshots.Count)<br>
        <strong>Total Size:</strong> $([Math]::Round(($Snapshots | Measure-Object -Property SizeGB -Sum).Sum, 2)) GB<br>
        <strong>Snapshots > 30 days:</strong> $(($Snapshots | Where-Object { $_.AgeDays -gt 30 }).Count)
    </div>
    
    <table>
        <tr>
            <th>vCenter</th>
            <th>VM Name</th>
            <th>Snapshot Name</th>
            <th>Description</th>
            <th>Created Date</th>
            <th>Created By</th>
            <th>Size (GB)</th>
            <th>Age (Days)</th>
        </tr>
"@
    
    foreach ($snap in $Snapshots) {
        $ageClass = if ($snap.AgeDays -gt 30) { " class='old'" } else { "" }
        $createdBy = if ($snap.vRAUser -ne "N/A") { "$($snap.vRAUser) (vRA: $($snap.vRADate))" } else { $snap.CreatedBy }
        
        $html += @"
        <tr>
            <td>$($snap.vCenter)</td>
            <td>$($snap.VMName)</td>
            <td>$($snap.SnapshotName)</td>
            <td>$($snap.Description)</td>
            <td>$($snap.CreatedDate.ToString('yyyy-MM-dd HH:mm'))</td>
            <td>$createdBy</td>
            <td>$($snap.SizeGB)</td>
            <td$ageClass>$($snap.AgeDays)</td>
        </tr>
"@
    }
    
    $html += @"
    </table>
</body>
</html>
"@
    
    # Send email
    try {
        Send-MailMessage `
            -To $To `
            -From $From `
            -Subject $Subject `
            -Body $html `
            -BodyAsHtml `
            -SmtpServer $SmtpServer `
            -Port $SmtpPort `
            -ErrorAction Stop
        
        Write-Host "`nEmail sent successfully to $($To -join ', ')" -ForegroundColor Green
    }
    catch {
        Write-Warning "Failed to send email: $_"
    }
}

# ============================================================================
# MAIN EXECUTION
# ============================================================================

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "vCenter Snapshot Report with vRA Integration" -ForegroundColor Cyan
Write-Host "========================================`n" -ForegroundColor Cyan

# Get credentials (used for both vCenter and vRA)
Write-Host "Please enter credentials (used for both vCenter and vRA):" -ForegroundColor Yellow
$credential = Get-Credential

if (-not $credential) {
    Write-Error "Credentials are required to continue."
    exit
}

# Get vRA refresh token
Write-Host "`nAuthenticating with vRA and generating refresh token..." -ForegroundColor Yellow
$vraRefreshToken = Get-vRAAccessToken -Credential $credential -Server $vraServer

if (-not $vraRefreshToken) {
    Write-Warning "Failed to authenticate with vRA. Continuing without vRA user enrichment."
    $vraBearerToken = $null
}
else {
    Write-Host "Successfully obtained vRA refresh token" -ForegroundColor Green
    
    # Get bearer token from refresh token
    $vraBearerToken = Get-vRABearerToken -RefreshToken $vraRefreshToken -Server $vraServer
    
    if ($vraBearerToken) {
        Write-Host "Successfully obtained vRA bearer token" -ForegroundColor Green
    }
    else {
        Write-Warning "Failed to get vRA bearer token. Continuing without vRA user enrichment."
    }
}

# Collect all snapshots
Write-Host "`nStarting snapshot collection from all vCenters..." -ForegroundColor Yellow
$allSnapshots = Get-AllSnapshots -vCenterServers $vCenters -Credential $credential

Write-Host "`nSnapshot collection completed." -ForegroundColor Green
Write-Host "Total snapshots found: $($allSnapshots.Count)" -ForegroundColor Green

# Enrich with vRA data if we have a token
if ($vraBearerToken) {
    $allSnapshots = Enrich-SnapshotsWithvRA -Snapshots $allSnapshots -vraServer $vraServer -vraToken $vraBearerToken
}
else {
    Write-Host "`nSkipping vRA enrichment (no bearer token available)" -ForegroundColor Yellow
    # Add empty vRA fields for consistency
    $allSnapshots = $allSnapshots | ForEach-Object {
        $_ | Add-Member -NotePropertyName "vRAUser" -NotePropertyValue "N/A" -Force
        $_ | Add-Member -NotePropertyName "vRADate" -NotePropertyValue "N/A" -Force
        $_
    }
}

Write-Host "`nProcessing completed." -ForegroundColor Green

# Display summary
Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "SUMMARY" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Total Snapshots: $($allSnapshots.Count)"
Write-Host "Total Size: $([Math]::Round(($allSnapshots | Measure-Object -Property SizeGB -Sum).Sum, 2)) GB"
Write-Host "Oldest Snapshot: $([Math]::Round(($allSnapshots | Measure-Object -Property AgeDays -Maximum).Maximum, 2)) days"
Write-Host ""

# Display table in console
$allSnapshots | Format-Table -Property vCenter, VMName, SnapshotName, CreatedDate, CreatedBy, SizeGB, AgeDays -AutoSize

# Export to CSV (optional)
$csvPath = ".\SnapshotReport_$(Get-Date -Format 'yyyyMMdd_HHmmss').csv"
$allSnapshots | Export-Csv -Path $csvPath -NoTypeInformation
Write-Host "CSV exported to: $csvPath" -ForegroundColor Green

# Send email report
Write-Host "`nSending email report..." -ForegroundColor Yellow
Send-SnapshotReport -Snapshots $allSnapshots -SmtpServer $smtpServer -SmtpPort $smtpPort `
    -From $emailFrom -To $emailTo -Subject $emailSubject

Write-Host "`nScript completed!" -ForegroundColor Green
