# Get credentials from user
$credential = Import-Clixml -Path "D:\XXXXX\getcred.xml"

# VRA Configuration (for unknown snapshot creators)
$vRAServer = "vra.example.com"
$vRAEnabled = $true
$vRACredential = Import-Clixml -Path "D:\Working\WROPS Script\vracred.xml"

# Email Configuration
$SendEmail = $true
$EmailTo = "admin@example.com"
$EmailFrom = "vcenter-reports@example.com"
$EmailSubject = "vCenter Snapshot Report - $(Get-Date -Format 'yyyy-MM-dd')"
$SMTPServer = "smtp.example.com"
$SMTPPort = 25

# Function to get creator from VRA
function Get-VRASnapshotCreator {
    param(
        [string]$VMName,
        [datetime]$SnapshotTime
    )
    
    try {
        # Connect to vRA API
        $authUrl = "https://$vRAServer/identity/api/tokens"
        $authBody = @{
            username = $vRACredential.UserName
            password = $vRACredential.GetNetworkCredential().Password
            tenant = "vsphere.local"
        } | ConvertTo-Json
        
        $authHeaders = @{
            "Content-Type" = "application/json"
            "Accept" = "application/json"
        }
        
        $authResponse = Invoke-RestMethod -Uri $authUrl -Method Post -Headers $authHeaders -Body $authBody
        $token = $authResponse.id
        
        # Search for snapshot events in User Events
        $eventsUrl = "https://$vRAServer/event-broker/api/events"
        $headers = @{
            "Authorization" = "Bearer $token"
            "Content-Type" = "application/json"
        }
        
        # Search for events around the snapshot creation time (Â±10 minutes)
        $startTime = $SnapshotTime.AddMinutes(-10).ToString("yyyy-MM-ddTHH:mm:ss.fffZ")
        $endTime = $SnapshotTime.AddMinutes(10).ToString("yyyy-MM-ddTHH:mm:ss.fffZ")
        
        $queryUrl = "$eventsUrl`?`$filter=eventTime ge $startTime and eventTime le $endTime"
        $events = Invoke-RestMethod -Uri $queryUrl -Method Get -Headers $headers
        
        # Find matching event with "Create Snapshot" in title
        $matchingEvent = $events.content | Where-Object { 
            $_.title -like "*Create Snapshot*" -and $_.title -like "*$VMName*"
        } | Select-Object -First 1
        
        if ($matchingEvent -and $matchingEvent.title -match "Create Snapshot.*?(\w+)$") {
            return $matches[1]
        }
        
        return $null
    }
    catch {
        Write-Host "  VRA lookup failed: $_" -ForegroundColor Yellow
        return $null
    }
}

$snapshotReport = @()

$vCenterServers | ForEach-Object {
    Write-Host "Connecting to $_" -ForegroundColor Green
    Connect-VIServer -Server $_ -Credential $credential
    Write-Host "Retrieving snapshots and events from $_" -ForegroundColor Yellow
    Get-VM | ForEach-Object {
        $vm = $_
        $snapshots = Get-Snapshot -VM $vm
        foreach ($snap in $snapshots) {
            $events = Get-VIEvent -Entity $vm -Start ($snap.Created.AddMinutes(-5)) -Finish ($snap.Created.AddMinutes(5)) |
                Where-Object { $_._FullFormattedMessage -like "*Create virtual machine snapshot*" }
            
            $creator = if ($events) { $events[0].UserName } else { "Unknown" }
            
            # If creator contains "xyz" or is "Unknown", try VRA lookup
            if ($vRAEnabled -and ($creator -like "*xyz*" -or $creator -eq "Unknown")) {
                Write-Host "  Looking up creator in vRA for snapshot: $($snap.Name) on $($vm.Name)" -ForegroundColor Cyan
                $vraCreator = Get-VRASnapshotCreator -VMName $vm.Name -SnapshotTime $snap.Created
                if ($vraCreator) {
                    $creator = "$vraCreator (from vRA)"
                }
            }
            
            $ageDays = [math]::Floor(((Get-Date) - $snap.Created).TotalDays)
            $createdFormatted = $snap.Created.ToString("dd-MM-yyyy")
            
            $snapshotReport += [PSCustomObject]@{
                VMName          = $vm.Name
                SnapshotName    = $snap.Name
                Description     = $snap.Description
                Created         = $createdFormatted
                CreatedBy       = $creator
                Size            = [math]::Round($snap.SizeGB, 2)
                AgeDays         = $ageDays
            }
        }
    }
    
    Disconnect-VIServer -Server $_ -Confirm:$false
}

# Sort by AgeDays descending (oldest first)
$snapshotReport = $snapshotReport | Sort-Object -Property AgeDays -Descending

# Generate HTML content
if ($snapshotReport.Count -eq 0) {
    $htmlBody = @"
<html>
<head>
<style>
body { font-family: Arial; }
</style>
</head>
<body>
<h2>Snapshot Report</h2>
<p>No old snapshots.</p>
</body>
</html>
"@
} else {
    $htmlTable = $snapshotReport | ConvertTo-Html -Property VMName, SnapshotName, Description, Created, CreatedBy, Size, AgeDays -Fragment
    
    $htmlBody = @"
<html>
<head>
<style>
table { border-collapse: collapse; width: 100%; }
th { background-color: #4CAF50; color: white; padding: 8px; text-align: left; }
td { border: 1px solid black; padding: 8px; text-align: left; }
</style>
</head>
<body>
<h2>Snapshot Report</h2>
<p>Report generated: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')</p>
$htmlTable
</body>
</html>
"@
}

# Export to CSV with timestamp
$timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
$csvPath = ".\VM_Snapshots_$timestamp.csv"
$snapshotReport | Export-Csv -Path $csvPath -NoTypeInformation
Write-Host "`nExported to $csvPath" -ForegroundColor Green

# Save HTML report
$htmlPath = ".\VM_Snapshots_$timestamp.html"
$htmlBody | Out-File -FilePath $htmlPath -Encoding UTF8
Write-Host "HTML report saved to $htmlPath" -ForegroundColor Green

# Send email report
if ($SendEmail) {
    Write-Host "`nSending email report..." -ForegroundColor Cyan

    $reportTime = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
    $totalSnapshots = $snapshotReport.Count
    $oldSnapshots = ($snapshotReport | Where-Object { $_.AgeDays -gt 7 }).Count
    
    $emailBody = @"
Report Title: vCenter Snapshot Report

Report Description:
This report provides an overview of all VM snapshots across connected vCenter servers.

Report Time: $reportTime

Summary:
- Total Snapshots: $totalSnapshots
- Snapshots > 7 days old: $oldSnapshots

Full details are available in the attached CSV file.
"@

    try {
        Send-MailMessage -SmtpServer $SMTPServer -Port $SMTPPort -From $EmailFrom -To $EmailTo -Subject $EmailSubject -Body $emailBody -Attachments $csvPath
        Write-Host "Email sent successfully to $EmailTo" -ForegroundColor Green
    }
    catch {
        Write-Host "Failed to send email: $_" -ForegroundColor Red
    }
} else {
    Write-Host "`nEmail sending is disabled" -ForegroundColor Yellow
}
